(()=>{function Et(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function ee(e,t=""){if(!Number.isSafeInteger(e)||e<0){let n=t&&`"${t}" `;throw new Error(`${n}expected integer >= 0, got ${e}`)}}function q(e,t,n=""){let r=Et(e),o=e?.length,s=t!==void 0;if(!r||s&&o!==t){let i=n&&`"${n}" `,a=s?` of length ${t}`:"",c=r?`length=${o}`:`type=${typeof e}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return e}function Oe(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash must wrapped by utils.createHasher");ee(e.outputLen),ee(e.blockLen)}function it(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function ko(e,t){q(e,void 0,"digestInto() output");let n=t.outputLen;if(e.length<n)throw new Error('"digestInto() output" expected to be of length >='+n)}function qt(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function we(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function at(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function Ae(e,t){return e<<32-t|e>>>t}function $(e,t){return e<<t|e>>>32-t>>>0}var fa=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function da(e){return e<<24&4278190080|e<<8&16711680|e>>>8&65280|e>>>24&255}function ha(e){for(let t=0;t<e.length;t++)e[t]=da(e[t]);return e}var Nn=fa?e=>e:ha,_o=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",pa=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function H(e){if(q(e),_o)return e.toHex();let t="";for(let n=0;n<e.length;n++)t+=pa[e[n]];return t}var Ce={_0:48,_9:57,A:65,F:70,a:97,f:102};function Eo(e){if(e>=Ce._0&&e<=Ce._9)return e-Ce._0;if(e>=Ce.A&&e<=Ce.F)return e-(Ce.A-10);if(e>=Ce.a&&e<=Ce.f)return e-(Ce.a-10)}function M(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);if(_o)return Uint8Array.fromHex(e);let t=e.length,n=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);let r=new Uint8Array(n);for(let o=0,s=0;o<n;o++,s+=2){let i=Eo(e.charCodeAt(s)),a=Eo(e.charCodeAt(s+1));if(i===void 0||a===void 0){let c=e[s]+e[s+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+s)}r[o]=i*16+a}return r}function ya(e){if(typeof e!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(e))}function Mn(e,t=""){return typeof e=="string"?ya(e):q(e,void 0,t)}function G(...e){let t=0;for(let r=0;r<e.length;r++){let o=e[r];q(o),t+=o.length}let n=new Uint8Array(t);for(let r=0,o=0;r<e.length;r++){let s=e[r];n.set(s,o),o+=s.length}return n}function $t(e,t){if(t!==void 0&&{}.toString.call(t)!=="[object Object]")throw new Error("options must be object or undefined");return Object.assign(e,t)}function Bo(e,t={}){let n=(o,s)=>e(s).update(o).digest(),r=e(void 0);return n.outputLen=r.outputLen,n.blockLen=r.blockLen,n.create=o=>e(o),Object.assign(n,t),Object.freeze(n)}function fe(e=32){let t=typeof globalThis=="object"?globalThis.crypto:null;if(typeof t?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return t.getRandomValues(new Uint8Array(e))}var So=e=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,e])});function Ao(e,t,n){return e&t^~e&n}function Ro(e,t,n){return e&t^e&n^t&n}var Vt=class{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(t,n,r,o){this.blockLen=t,this.outputLen=n,this.padOffset=r,this.isLE=o,this.buffer=new Uint8Array(t),this.view=at(this.buffer)}update(t){it(this),q(t);let{view:n,buffer:r,blockLen:o}=this,s=t.length;for(let i=0;i<s;){let a=Math.min(o-this.pos,s-i);if(a===o){let c=at(t);for(;o<=s-i;i+=o)this.process(c,i);continue}r.set(t.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===o&&(this.process(n,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){it(this),ko(t,this),this.finished=!0;let{buffer:n,view:r,blockLen:o,isLE:s}=this,{pos:i}=this;n[i++]=128,we(this.buffer.subarray(i)),this.padOffset>o-i&&(this.process(r,0),i=0);for(let f=i;f<o;f++)n[f]=0;r.setBigUint64(o-8,BigInt(this.length*8),s),this.process(r,0);let a=at(t),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");let l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,u[f],s)}digest(){let{buffer:t,outputLen:n}=this;this.digestInto(t);let r=t.slice(0,n);return this.destroy(),r}_cloneInto(t){t||=new this.constructor,t.set(...this.get());let{blockLen:n,buffer:r,length:o,finished:s,destroyed:i,pos:a}=this;return t.destroyed=i,t.finished=s,t.length=o,t.pos=a,o%n&&t.buffer.set(r),t}clone(){return this._cloneInto()}},Ne=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var ga=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),$e=new Uint32Array(64),Dn=class extends Vt{constructor(t){super(64,t,8,!1)}get(){let{A:t,B:n,C:r,D:o,E:s,F:i,G:a,H:c}=this;return[t,n,r,o,s,i,a,c]}set(t,n,r,o,s,i,a,c){this.A=t|0,this.B=n|0,this.C=r|0,this.D=o|0,this.E=s|0,this.F=i|0,this.G=a|0,this.H=c|0}process(t,n){for(let f=0;f<16;f++,n+=4)$e[f]=t.getUint32(n,!1);for(let f=16;f<64;f++){let h=$e[f-15],d=$e[f-2],p=Ae(h,7)^Ae(h,18)^h>>>3,y=Ae(d,17)^Ae(d,19)^d>>>10;$e[f]=y+$e[f-7]+p+$e[f-16]|0}let{A:r,B:o,C:s,D:i,E:a,F:c,G:l,H:u}=this;for(let f=0;f<64;f++){let h=Ae(a,6)^Ae(a,11)^Ae(a,25),d=u+h+Ao(a,c,l)+ga[f]+$e[f]|0,y=(Ae(r,2)^Ae(r,13)^Ae(r,22))+Ro(r,o,s)|0;u=l,l=c,c=a,a=i+d|0,i=s,s=o,o=r,r=d+y|0}r=r+this.A|0,o=o+this.B|0,s=s+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(r,o,s,i,a,c,l,u)}roundClean(){we($e)}destroy(){this.set(0,0,0,0,0,0,0,0),we(this.buffer)}},Hn=class extends Dn{A=Ne[0]|0;B=Ne[1]|0;C=Ne[2]|0;D=Ne[3]|0;E=Ne[4]|0;F=Ne[5]|0;G=Ne[6]|0;H=Ne[7]|0;constructor(){super(32)}};var te=Bo(()=>new Hn,So(1));var qn=BigInt(0),Kn=BigInt(1);function kt(e,t=""){if(typeof e!="boolean"){let n=t&&`"${t}" `;throw new Error(n+"expected boolean, got type="+typeof e)}return e}function Lo(e){if(typeof e=="bigint"){if(!Wt(e))throw new Error("positive bigint expected, got "+e)}else ee(e);return e}function _t(e){let t=Lo(e).toString(16);return t.length&1?"0"+t:t}function To(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);return e===""?qn:BigInt("0x"+e)}function Ve(e){return To(H(e))}function $n(e){return To(H(wa(q(e)).reverse()))}function zt(e,t){ee(t),e=Lo(e);let n=M(e.toString(16).padStart(t*2,"0"));if(n.length!==t)throw new Error("number too large");return n}function Vn(e,t){return zt(e,t).reverse()}function wa(e){return Uint8Array.from(e)}function Io(e){return Uint8Array.from(e,(t,n)=>{let r=t.charCodeAt(0);if(t.length!==1||r>127)throw new Error(`string contains non-ASCII character "${e[n]}" with code ${r} at position ${n}`);return r})}var Wt=e=>typeof e=="bigint"&&qn<=e;function ba(e,t,n){return Wt(e)&&Wt(t)&&Wt(n)&&t<=e&&e<n}function Uo(e,t,n,r){if(!ba(t,n,r))throw new Error("expected valid "+e+": "+n+" <= n < "+r+", got "+t)}function Wn(e){let t;for(t=0;e>qn;e>>=Kn,t+=1);return t}var Bt=e=>(Kn<<BigInt(e))-Kn;function Po(e,t,n){if(ee(e,"hashLen"),ee(t,"qByteLen"),typeof n!="function")throw new Error("hmacFn must be a function");let r=w=>new Uint8Array(w),o=Uint8Array.of(),s=Uint8Array.of(0),i=Uint8Array.of(1),a=1e3,c=r(e),l=r(e),u=0,f=()=>{c.fill(1),l.fill(0),u=0},h=(...w)=>n(l,G(c,...w)),d=(w=o)=>{l=h(s,w),c=h(),w.length!==0&&(l=h(i,w),c=h())},p=()=>{if(u++>=a)throw new Error("drbg: tried max amount of iterations");let w=0,b=[];for(;w<t;){c=h();let S=c.slice();b.push(S),w+=c.length}return G(...b)};return(w,b)=>{f(),d(w);let S;for(;!(S=b(p()));)d();return f(),S}}function St(e,t={},n={}){if(!e||typeof e!="object")throw new Error("expected valid options object");function r(s,i,a){let c=e[s];if(a&&c===void 0)return;let l=typeof c;if(l!==i||c===null)throw new Error(`param "${s}" is invalid: expected ${i}, got ${l}`)}let o=(s,i)=>Object.entries(s).forEach(([a,c])=>r(a,c,i));o(t,!1),o(n,!0)}function zn(e){let t=new WeakMap;return(n,...r)=>{let o=t.get(n);if(o!==void 0)return o;let s=e(n,...r);return t.set(n,s),s}}var he=BigInt(0),de=BigInt(1),Je=BigInt(2),No=BigInt(3),Mo=BigInt(4),Do=BigInt(5),ma=BigInt(7),Ho=BigInt(8),xa=BigInt(9),Ko=BigInt(16);function Re(e,t){let n=e%t;return n>=he?n:t+n}function be(e,t,n){let r=e;for(;t-- >he;)r*=r,r%=n;return r}function Co(e,t){if(e===he)throw new Error("invert: expected non-zero number");if(t<=he)throw new Error("invert: expected positive modulus, got "+t);let n=Re(e,t),r=t,o=he,s=de,i=de,a=he;for(;n!==he;){let l=r/n,u=r%n,f=o-i*l,h=s-a*l;r=n,n=u,o=i,s=a,i=f,a=h}if(r!==de)throw new Error("invert: does not exist");return Re(o,t)}function Zn(e,t,n){if(!e.eql(e.sqr(t),n))throw new Error("Cannot find square root")}function qo(e,t){let n=(e.ORDER+de)/Mo,r=e.pow(t,n);return Zn(e,r,t),r}function va(e,t){let n=(e.ORDER-Do)/Ho,r=e.mul(t,Je),o=e.pow(r,n),s=e.mul(t,o),i=e.mul(e.mul(s,Je),o),a=e.mul(s,e.sub(i,e.ONE));return Zn(e,a,t),a}function Ea(e){let t=ct(e),n=$o(e),r=n(t,t.neg(t.ONE)),o=n(t,r),s=n(t,t.neg(r)),i=(e+ma)/Ko;return(a,c)=>{let l=a.pow(c,i),u=a.mul(l,r),f=a.mul(l,o),h=a.mul(l,s),d=a.eql(a.sqr(u),c),p=a.eql(a.sqr(f),c);l=a.cmov(l,u,d),u=a.cmov(h,f,p);let y=a.eql(a.sqr(u),c),w=a.cmov(l,u,y);return Zn(a,w,c),w}}function $o(e){if(e<No)throw new Error("sqrt is not defined for small field");let t=e-de,n=0;for(;t%Je===he;)t/=Je,n++;let r=Je,o=ct(e);for(;Oo(o,r)===1;)if(r++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(n===1)return qo;let s=o.pow(r,t),i=(t+de)/Je;return function(c,l){if(c.is0(l))return l;if(Oo(c,l)!==1)throw new Error("Cannot find square root");let u=n,f=c.mul(c.ONE,s),h=c.pow(l,t),d=c.pow(l,i);for(;!c.eql(h,c.ONE);){if(c.is0(h))return c.ZERO;let p=1,y=c.sqr(h);for(;!c.eql(y,c.ONE);)if(p++,y=c.sqr(y),p===u)throw new Error("Cannot find square root");let w=de<<BigInt(u-p-1),b=c.pow(f,w);u=p,f=c.sqr(b),h=c.mul(h,f),d=c.mul(d,b)}return d}}function ka(e){return e%Mo===No?qo:e%Ho===Do?va:e%Ko===xa?Ea(e):$o(e)}var _a=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Fn(e){let t={ORDER:"bigint",BYTES:"number",BITS:"number"},n=_a.reduce((r,o)=>(r[o]="function",r),t);return St(e,n),e}function Ba(e,t,n){if(n<he)throw new Error("invalid exponent, negatives unsupported");if(n===he)return e.ONE;if(n===de)return t;let r=e.ONE,o=t;for(;n>he;)n&de&&(r=e.mul(r,o)),o=e.sqr(o),n>>=de;return r}function jt(e,t,n=!1){let r=new Array(t.length).fill(n?e.ZERO:void 0),o=t.reduce((i,a,c)=>e.is0(a)?i:(r[c]=i,e.mul(i,a)),e.ONE),s=e.inv(o);return t.reduceRight((i,a,c)=>e.is0(a)?i:(r[c]=e.mul(i,r[c]),e.mul(i,a)),s),r}function Oo(e,t){let n=(e.ORDER-de)/Je,r=e.pow(t,n),o=e.eql(r,e.ONE),s=e.eql(r,e.ZERO),i=e.eql(r,e.neg(e.ONE));if(!o&&!s&&!i)throw new Error("invalid Legendre symbol result");return o?1:s?0:-1}function Sa(e,t){t!==void 0&&ee(t);let n=t!==void 0?t:e.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}var jn=class{ORDER;BITS;BYTES;isLE;ZERO=he;ONE=de;_lengths;_sqrt;_mod;constructor(t,n={}){if(t<=he)throw new Error("invalid field: expected ORDER > 0, got "+t);let r;this.isLE=!1,n!=null&&typeof n=="object"&&(typeof n.BITS=="number"&&(r=n.BITS),typeof n.sqrt=="function"&&(this.sqrt=n.sqrt),typeof n.isLE=="boolean"&&(this.isLE=n.isLE),n.allowedLengths&&(this._lengths=n.allowedLengths?.slice()),typeof n.modFromBytes=="boolean"&&(this._mod=n.modFromBytes));let{nBitLength:o,nByteLength:s}=Sa(t,r);if(s>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=t,this.BITS=o,this.BYTES=s,this._sqrt=void 0,Object.preventExtensions(this)}create(t){return Re(t,this.ORDER)}isValid(t){if(typeof t!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof t);return he<=t&&t<this.ORDER}is0(t){return t===he}isValidNot0(t){return!this.is0(t)&&this.isValid(t)}isOdd(t){return(t&de)===de}neg(t){return Re(-t,this.ORDER)}eql(t,n){return t===n}sqr(t){return Re(t*t,this.ORDER)}add(t,n){return Re(t+n,this.ORDER)}sub(t,n){return Re(t-n,this.ORDER)}mul(t,n){return Re(t*n,this.ORDER)}pow(t,n){return Ba(this,t,n)}div(t,n){return Re(t*Co(n,this.ORDER),this.ORDER)}sqrN(t){return t*t}addN(t,n){return t+n}subN(t,n){return t-n}mulN(t,n){return t*n}inv(t){return Co(t,this.ORDER)}sqrt(t){return this._sqrt||(this._sqrt=ka(this.ORDER)),this._sqrt(this,t)}toBytes(t){return this.isLE?Vn(t,this.BYTES):zt(t,this.BYTES)}fromBytes(t,n=!1){q(t);let{_lengths:r,BYTES:o,isLE:s,ORDER:i,_mod:a}=this;if(r){if(!r.includes(t.length)||t.length>o)throw new Error("Field.fromBytes: expected "+r+" bytes, got "+t.length);let l=new Uint8Array(o);l.set(t,s?0:l.length-t.length),t=l}if(t.length!==o)throw new Error("Field.fromBytes: expected "+o+" bytes, got "+t.length);let c=s?$n(t):Ve(t);if(a&&(c=Re(c,i)),!n&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(t){return jt(this,t)}cmov(t,n,r){return r?n:t}};function ct(e,t={}){return new jn(e,t)}function Vo(e){if(typeof e!="bigint")throw new Error("field order must be bigint");let t=e.toString(2).length;return Math.ceil(t/8)}function Gn(e){let t=Vo(e);return t+Math.ceil(t/2)}function Zt(e,t,n=!1){q(e);let r=e.length,o=Vo(t),s=Gn(t);if(r<16||r<s||r>1024)throw new Error("expected "+s+"-1024 bytes of input, got "+r);let i=n?$n(e):Ve(e),a=Re(i,t-de)+de;return n?Vn(a,o):zt(a,o)}var lt=BigInt(0),Xe=BigInt(1);function At(e,t){let n=t.negate();return e?n:t}function Qn(e,t){let n=jt(e.Fp,t.map(r=>r.Z));return t.map((r,o)=>e.fromAffine(r.toAffine(n[o])))}function Zo(e,t){if(!Number.isSafeInteger(e)||e<=0||e>t)throw new Error("invalid window size, expected [1.."+t+"], got W="+e)}function Jn(e,t){Zo(e,t);let n=Math.ceil(t/e)+1,r=2**(e-1),o=2**e,s=Bt(e),i=BigInt(e);return{windows:n,windowSize:r,mask:s,maxNumber:o,shiftBy:i}}function Wo(e,t,n){let{windowSize:r,mask:o,maxNumber:s,shiftBy:i}=n,a=Number(e&o),c=e>>i;a>r&&(a-=s,c+=Xe);let l=t*r,u=l+Math.abs(a)-1,f=a===0,h=a<0,d=t%2!==0;return{nextN:c,offset:u,isZero:f,isNeg:h,isNegF:d,offsetF:l}}var Xn=new WeakMap,Fo=new WeakMap;function Yn(e){return Fo.get(e)||1}function zo(e){if(e!==lt)throw new Error("invalid wNAF")}var Ft=class{BASE;ZERO;Fn;bits;constructor(t,n){this.BASE=t.BASE,this.ZERO=t.ZERO,this.Fn=t.Fn,this.bits=n}_unsafeLadder(t,n,r=this.ZERO){let o=t;for(;n>lt;)n&Xe&&(r=r.add(o)),o=o.double(),n>>=Xe;return r}precomputeWindow(t,n){let{windows:r,windowSize:o}=Jn(n,this.bits),s=[],i=t,a=i;for(let c=0;c<r;c++){a=i,s.push(a);for(let l=1;l<o;l++)a=a.add(i),s.push(a);i=a.double()}return s}wNAF(t,n,r){if(!this.Fn.isValid(r))throw new Error("invalid scalar");let o=this.ZERO,s=this.BASE,i=Jn(t,this.bits);for(let a=0;a<i.windows;a++){let{nextN:c,offset:l,isZero:u,isNeg:f,isNegF:h,offsetF:d}=Wo(r,a,i);r=c,u?s=s.add(At(h,n[d])):o=o.add(At(f,n[l]))}return zo(r),{p:o,f:s}}wNAFUnsafe(t,n,r,o=this.ZERO){let s=Jn(t,this.bits);for(let i=0;i<s.windows&&r!==lt;i++){let{nextN:a,offset:c,isZero:l,isNeg:u}=Wo(r,i,s);if(r=a,!l){let f=n[c];o=o.add(u?f.negate():f)}}return zo(r),o}getPrecomputes(t,n,r){let o=Xn.get(n);return o||(o=this.precomputeWindow(n,t),t!==1&&(typeof r=="function"&&(o=r(o)),Xn.set(n,o))),o}cached(t,n,r){let o=Yn(t);return this.wNAF(o,this.getPrecomputes(o,t,r),n)}unsafe(t,n,r,o){let s=Yn(t);return s===1?this._unsafeLadder(t,n,o):this.wNAFUnsafe(s,this.getPrecomputes(s,t,r),n,o)}createCache(t,n){Zo(n,this.bits),Fo.set(t,n),Xn.delete(t)}hasCache(t){return Yn(t)!==1}};function Go(e,t,n,r){let o=t,s=e.ZERO,i=e.ZERO;for(;n>lt||r>lt;)n&Xe&&(s=s.add(o)),r&Xe&&(i=i.add(o)),o=o.double(),n>>=Xe,r>>=Xe;return{p1:s,p2:i}}function jo(e,t,n){if(t){if(t.ORDER!==e)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Fn(t),t}else return ct(e,{isLE:n})}function Jo(e,t,n={},r){if(r===void 0&&(r=e==="edwards"),!t||typeof t!="object")throw new Error(`expected valid ${e} CURVE object`);for(let c of["p","n","h"]){let l=t[c];if(!(typeof l=="bigint"&&l>lt))throw new Error(`CURVE.${c} must be positive bigint`)}let o=jo(t.p,n.Fp,r),s=jo(t.n,n.Fn,r),a=["Gx","Gy","a",e==="weierstrass"?"b":"d"];for(let c of a)if(!o.isValid(t[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return t=Object.freeze(Object.assign({},t)),{CURVE:t,Fp:o,Fn:s}}function Gt(e,t){return function(r){let o=e(r);return{secretKey:o,publicKey:t(o)}}}var Jt=class{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(t,n){if(Oe(t),q(n,void 0,"key"),this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let r=this.blockLen,o=new Uint8Array(r);o.set(n.length>r?t.create().update(n).digest():n);for(let s=0;s<o.length;s++)o[s]^=54;this.iHash.update(o),this.oHash=t.create();for(let s=0;s<o.length;s++)o[s]^=106;this.oHash.update(o),we(o)}update(t){return it(this),this.iHash.update(t),this}digestInto(t){it(this),q(t,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){let t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||=Object.create(Object.getPrototypeOf(this),{});let{oHash:n,iHash:r,finished:o,destroyed:s,blockLen:i,outputLen:a}=this;return t=t,t.finished=o,t.destroyed=s,t.blockLen=i,t.outputLen=a,t.oHash=n._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},ve=(e,t,n)=>new Jt(e,t).update(n).digest();ve.create=(e,t)=>new Jt(e,t);var Xo=(e,t)=>(e+(e>=0?t:-t)/Yo)/t;function Aa(e,t,n){let[[r,o],[s,i]]=t,a=Xo(i*e,n),c=Xo(-o*e,n),l=e-a*r-c*s,u=-a*o-c*i,f=l<Me,h=u<Me;f&&(l=-l),h&&(u=-u);let d=Bt(Math.ceil(Wn(n)/2))+ut;if(l<Me||l>=d||u<Me||u>=d)throw new Error("splitScalar (endomorphism): failed, k="+e);return{k1neg:f,k1:l,k2neg:h,k2:u}}function tr(e){if(!["compact","recovered","der"].includes(e))throw new Error('Signature format must be "compact", "recovered", or "der"');return e}function er(e,t){let n={};for(let r of Object.keys(t))n[r]=e[r]===void 0?t[r]:e[r];return kt(n.lowS,"lowS"),kt(n.prehash,"prehash"),n.format!==void 0&&tr(n.format),n}var nr=class extends Error{constructor(t=""){super(t)}},We={Err:nr,_tlv:{encode:(e,t)=>{let{Err:n}=We;if(e<0||e>256)throw new n("tlv.encode: wrong tag");if(t.length&1)throw new n("tlv.encode: unpadded data");let r=t.length/2,o=_t(r);if(o.length/2&128)throw new n("tlv.encode: long form length too big");let s=r>127?_t(o.length/2|128):"";return _t(e)+s+o+t},decode(e,t){let{Err:n}=We,r=0;if(e<0||e>256)throw new n("tlv.encode: wrong tag");if(t.length<2||t[r++]!==e)throw new n("tlv.decode: wrong tlv");let o=t[r++],s=!!(o&128),i=0;if(!s)i=o;else{let c=o&127;if(!c)throw new n("tlv.decode(long): indefinite length not supported");if(c>4)throw new n("tlv.decode(long): byte length is too big");let l=t.subarray(r,r+c);if(l.length!==c)throw new n("tlv.decode: length bytes not complete");if(l[0]===0)throw new n("tlv.decode(long): zero leftmost byte");for(let u of l)i=i<<8|u;if(r+=c,i<128)throw new n("tlv.decode(long): not minimal encoding")}let a=t.subarray(r,r+i);if(a.length!==i)throw new n("tlv.decode: wrong value length");return{v:a,l:t.subarray(r+i)}}},_int:{encode(e){let{Err:t}=We;if(e<Me)throw new t("integer: negative integers are not allowed");let n=_t(e);if(Number.parseInt(n[0],16)&8&&(n="00"+n),n.length&1)throw new t("unexpected DER parsing assertion: unpadded hex");return n},decode(e){let{Err:t}=We;if(e[0]&128)throw new t("invalid signature integer: negative");if(e[0]===0&&!(e[1]&128))throw new t("invalid signature integer: unnecessary leading zero");return Ve(e)}},toSig(e){let{Err:t,_int:n,_tlv:r}=We,o=q(e,void 0,"signature"),{v:s,l:i}=r.decode(48,o);if(i.length)throw new t("invalid signature: left bytes after parsing");let{v:a,l:c}=r.decode(2,s),{v:l,l:u}=r.decode(2,c);if(u.length)throw new t("invalid signature: left bytes after parsing");return{r:n.decode(a),s:n.decode(l)}},hexFromSig(e){let{_tlv:t,_int:n}=We,r=t.encode(2,n.encode(e.r)),o=t.encode(2,n.encode(e.s)),s=r+o;return t.encode(48,s)}},Me=BigInt(0),ut=BigInt(1),Yo=BigInt(2),Xt=BigInt(3),Ra=BigInt(4);function Qo(e,t={}){let n=Jo("weierstrass",e,t),{Fp:r,Fn:o}=n,s=n.CURVE,{h:i,n:a}=s;St(t,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});let{endo:c}=t;if(c&&(!r.is0(s.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');let l=ts(r,o);function u(){if(!r.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function f(I,x,m){let{x:g,y:E}=x.toAffine(),_=r.toBytes(g);if(kt(m,"isCompressed"),m){u();let B=!r.isOdd(E);return G(es(B),_)}else return G(Uint8Array.of(4),_,r.toBytes(E))}function h(I){q(I,void 0,"Point");let{publicKey:x,publicKeyUncompressed:m}=l,g=I.length,E=I[0],_=I.subarray(1);if(g===x&&(E===2||E===3)){let B=r.fromBytes(_);if(!r.isValid(B))throw new Error("bad point: is not on curve, wrong x");let v=y(B),k;try{k=r.sqrt(v)}catch(j){let W=j instanceof Error?": "+j.message:"";throw new Error("bad point: is not on curve, sqrt error"+W)}u();let A=r.isOdd(k);return(E&1)===1!==A&&(k=r.neg(k)),{x:B,y:k}}else if(g===m&&E===4){let B=r.BYTES,v=r.fromBytes(_.subarray(0,B)),k=r.fromBytes(_.subarray(B,B*2));if(!w(v,k))throw new Error("bad point: is not on curve");return{x:v,y:k}}else throw new Error(`bad point: got length ${g}, expected compressed=${x} or uncompressed=${m}`)}let d=t.toBytes||f,p=t.fromBytes||h;function y(I){let x=r.sqr(I),m=r.mul(x,I);return r.add(r.add(m,r.mul(I,s.a)),s.b)}function w(I,x){let m=r.sqr(x),g=y(I);return r.eql(m,g)}if(!w(s.Gx,s.Gy))throw new Error("bad curve params: generator point");let b=r.mul(r.pow(s.a,Xt),Ra),S=r.mul(r.sqr(s.b),BigInt(27));if(r.is0(r.add(b,S)))throw new Error("bad curve params: a or b");function U(I,x,m=!1){if(!r.isValid(x)||m&&r.is0(x))throw new Error(`bad point coordinate ${I}`);return x}function P(I){if(!(I instanceof T))throw new Error("Weierstrass Point expected")}function Y(I){if(!c||!c.basises)throw new Error("no endo");return Aa(I,c.basises,o.ORDER)}let O=zn((I,x)=>{let{X:m,Y:g,Z:E}=I;if(r.eql(E,r.ONE))return{x:m,y:g};let _=I.is0();x==null&&(x=_?r.ONE:r.inv(E));let B=r.mul(m,x),v=r.mul(g,x),k=r.mul(E,x);if(_)return{x:r.ZERO,y:r.ZERO};if(!r.eql(k,r.ONE))throw new Error("invZ was invalid");return{x:B,y:v}}),z=zn(I=>{if(I.is0()){if(t.allowInfinityPoint&&!r.is0(I.Y))return;throw new Error("bad point: ZERO")}let{x,y:m}=I.toAffine();if(!r.isValid(x)||!r.isValid(m))throw new Error("bad point: x or y not field elements");if(!w(x,m))throw new Error("bad point: equation left != right");if(!I.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function V(I,x,m,g,E){return m=new T(r.mul(m.X,I),m.Y,m.Z),x=At(g,x),m=At(E,m),x.add(m)}class T{static BASE=new T(s.Gx,s.Gy,r.ONE);static ZERO=new T(r.ZERO,r.ONE,r.ZERO);static Fp=r;static Fn=o;X;Y;Z;constructor(x,m,g){this.X=U("x",x),this.Y=U("y",m,!0),this.Z=U("z",g),Object.freeze(this)}static CURVE(){return s}static fromAffine(x){let{x:m,y:g}=x||{};if(!x||!r.isValid(m)||!r.isValid(g))throw new Error("invalid affine point");if(x instanceof T)throw new Error("projective point not allowed");return r.is0(m)&&r.is0(g)?T.ZERO:new T(m,g,r.ONE)}static fromBytes(x){let m=T.fromAffine(p(q(x,void 0,"point")));return m.assertValidity(),m}static fromHex(x){return T.fromBytes(M(x))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(x=8,m=!0){return N.createCache(this,x),m||this.multiply(Xt),this}assertValidity(){z(this)}hasEvenY(){let{y:x}=this.toAffine();if(!r.isOdd)throw new Error("Field doesn't support isOdd");return!r.isOdd(x)}equals(x){P(x);let{X:m,Y:g,Z:E}=this,{X:_,Y:B,Z:v}=x,k=r.eql(r.mul(m,v),r.mul(_,E)),A=r.eql(r.mul(g,v),r.mul(B,E));return k&&A}negate(){return new T(this.X,r.neg(this.Y),this.Z)}double(){let{a:x,b:m}=s,g=r.mul(m,Xt),{X:E,Y:_,Z:B}=this,v=r.ZERO,k=r.ZERO,A=r.ZERO,R=r.mul(E,E),j=r.mul(_,_),W=r.mul(B,B),D=r.mul(E,_);return D=r.add(D,D),A=r.mul(E,B),A=r.add(A,A),v=r.mul(x,A),k=r.mul(g,W),k=r.add(v,k),v=r.sub(j,k),k=r.add(j,k),k=r.mul(v,k),v=r.mul(D,v),A=r.mul(g,A),W=r.mul(x,W),D=r.sub(R,W),D=r.mul(x,D),D=r.add(D,A),A=r.add(R,R),R=r.add(A,R),R=r.add(R,W),R=r.mul(R,D),k=r.add(k,R),W=r.mul(_,B),W=r.add(W,W),R=r.mul(W,D),v=r.sub(v,R),A=r.mul(W,j),A=r.add(A,A),A=r.add(A,A),new T(v,k,A)}add(x){P(x);let{X:m,Y:g,Z:E}=this,{X:_,Y:B,Z:v}=x,k=r.ZERO,A=r.ZERO,R=r.ZERO,j=s.a,W=r.mul(s.b,Xt),D=r.mul(m,_),Z=r.mul(g,B),Q=r.mul(E,v),ae=r.add(m,g),F=r.add(_,B);ae=r.mul(ae,F),F=r.add(D,Z),ae=r.sub(ae,F),F=r.add(m,E);let ue=r.add(_,v);return F=r.mul(F,ue),ue=r.add(D,Q),F=r.sub(F,ue),ue=r.add(g,E),k=r.add(B,v),ue=r.mul(ue,k),k=r.add(Z,Q),ue=r.sub(ue,k),R=r.mul(j,F),k=r.mul(W,Q),R=r.add(k,R),k=r.sub(Z,R),R=r.add(Z,R),A=r.mul(k,R),Z=r.add(D,D),Z=r.add(Z,D),Q=r.mul(j,Q),F=r.mul(W,F),Z=r.add(Z,Q),Q=r.sub(D,Q),Q=r.mul(j,Q),F=r.add(F,Q),D=r.mul(Z,F),A=r.add(A,D),D=r.mul(ue,F),k=r.mul(ae,k),k=r.sub(k,D),D=r.mul(ae,Z),R=r.mul(ue,R),R=r.add(R,D),new T(k,A,R)}subtract(x){return this.add(x.negate())}is0(){return this.equals(T.ZERO)}multiply(x){let{endo:m}=t;if(!o.isValidNot0(x))throw new Error("invalid scalar: out of range");let g,E,_=B=>N.cached(this,B,v=>Qn(T,v));if(m){let{k1neg:B,k1:v,k2neg:k,k2:A}=Y(x),{p:R,f:j}=_(v),{p:W,f:D}=_(A);E=j.add(D),g=V(m.beta,R,W,B,k)}else{let{p:B,f:v}=_(x);g=B,E=v}return Qn(T,[g,E])[0]}multiplyUnsafe(x){let{endo:m}=t,g=this;if(!o.isValid(x))throw new Error("invalid scalar: out of range");if(x===Me||g.is0())return T.ZERO;if(x===ut)return g;if(N.hasCache(this))return this.multiply(x);if(m){let{k1neg:E,k1:_,k2neg:B,k2:v}=Y(x),{p1:k,p2:A}=Go(T,g,_,v);return V(m.beta,k,A,E,B)}else return N.unsafe(g,x)}toAffine(x){return O(this,x)}isTorsionFree(){let{isTorsionFree:x}=t;return i===ut?!0:x?x(T,this):N.unsafe(this,a).is0()}clearCofactor(){let{clearCofactor:x}=t;return i===ut?this:x?x(T,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(x=!0){return kt(x,"isCompressed"),this.assertValidity(),d(T,this,x)}toHex(x=!0){return H(this.toBytes(x))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}let K=o.BITS,N=new Ft(T,t.endo?Math.ceil(K/2):K);return T.BASE.precompute(8),T}function es(e){return Uint8Array.of(e?2:3)}function ts(e,t){return{secretKey:t.BYTES,publicKey:1+e.BYTES,publicKeyUncompressed:1+2*e.BYTES,publicKeyHasPrefix:!0,signature:2*t.BYTES}}function La(e,t={}){let{Fn:n}=e,r=t.randomBytes||fe,o=Object.assign(ts(e.Fp,n),{seed:Gn(n.ORDER)});function s(d){try{let p=n.fromBytes(d);return n.isValidNot0(p)}catch{return!1}}function i(d,p){let{publicKey:y,publicKeyUncompressed:w}=o;try{let b=d.length;return p===!0&&b!==y||p===!1&&b!==w?!1:!!e.fromBytes(d)}catch{return!1}}function a(d=r(o.seed)){return Zt(q(d,o.seed,"seed"),n.ORDER)}function c(d,p=!0){return e.BASE.multiply(n.fromBytes(d)).toBytes(p)}function l(d){let{secretKey:p,publicKey:y,publicKeyUncompressed:w}=o;if(!Et(d)||"_lengths"in n&&n._lengths||p===y)return;let b=q(d,void 0,"key").length;return b===y||b===w}function u(d,p,y=!0){if(l(d)===!0)throw new Error("first arg must be private key");if(l(p)===!1)throw new Error("second arg must be public key");let w=n.fromBytes(d);return e.fromBytes(p).multiply(w).toBytes(y)}let f={isValidSecretKey:s,isValidPublicKey:i,randomSecretKey:a},h=Gt(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:u,keygen:h,Point:e,utils:f,lengths:o})}function ns(e,t,n={}){Oe(t),St(n,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),n=Object.assign({},n);let r=n.randomBytes||fe,o=n.hmac||((m,g)=>ve(t,m,g)),{Fp:s,Fn:i}=e,{ORDER:a,BITS:c}=i,{keygen:l,getPublicKey:u,getSharedSecret:f,utils:h,lengths:d}=La(e,n),p={prehash:!0,lowS:typeof n.lowS=="boolean"?n.lowS:!0,format:"compact",extraEntropy:!1},y=a*Yo<s.ORDER;function w(m){let g=a>>ut;return m>g}function b(m,g){if(!i.isValidNot0(g))throw new Error(`invalid signature ${m}: out of range 1..Point.Fn.ORDER`);return g}function S(){if(y)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function U(m,g){tr(g);let E=d.signature,_=g==="compact"?E:g==="recovered"?E+1:void 0;return q(m,_)}class P{r;s;recovery;constructor(g,E,_){if(this.r=b("r",g),this.s=b("s",E),_!=null){if(S(),![0,1,2,3].includes(_))throw new Error("invalid recovery id");this.recovery=_}Object.freeze(this)}static fromBytes(g,E=p.format){U(g,E);let _;if(E==="der"){let{r:A,s:R}=We.toSig(q(g));return new P(A,R)}E==="recovered"&&(_=g[0],E="compact",g=g.subarray(1));let B=d.signature/2,v=g.subarray(0,B),k=g.subarray(B,B*2);return new P(i.fromBytes(v),i.fromBytes(k),_)}static fromHex(g,E){return this.fromBytes(M(g),E)}assertRecovery(){let{recovery:g}=this;if(g==null)throw new Error("invalid recovery id: must be present");return g}addRecoveryBit(g){return new P(this.r,this.s,g)}recoverPublicKey(g){let{r:E,s:_}=this,B=this.assertRecovery(),v=B===2||B===3?E+a:E;if(!s.isValid(v))throw new Error("invalid recovery id: sig.r+curve.n != R.x");let k=s.toBytes(v),A=e.fromBytes(G(es((B&1)===0),k)),R=i.inv(v),j=O(q(g,void 0,"msgHash")),W=i.create(-j*R),D=i.create(_*R),Z=e.BASE.multiplyUnsafe(W).add(A.multiplyUnsafe(D));if(Z.is0())throw new Error("invalid recovery: point at infinify");return Z.assertValidity(),Z}hasHighS(){return w(this.s)}toBytes(g=p.format){if(tr(g),g==="der")return M(We.hexFromSig(this));let{r:E,s:_}=this,B=i.toBytes(E),v=i.toBytes(_);return g==="recovered"?(S(),G(Uint8Array.of(this.assertRecovery()),B,v)):G(B,v)}toHex(g){return H(this.toBytes(g))}}let Y=n.bits2int||function(g){if(g.length>8192)throw new Error("input is too large");let E=Ve(g),_=g.length*8-c;return _>0?E>>BigInt(_):E},O=n.bits2int_modN||function(g){return i.create(Y(g))},z=Bt(c);function V(m){return Uo("num < 2^"+c,m,Me,z),i.toBytes(m)}function T(m,g){return q(m,void 0,"message"),g?q(t(m),void 0,"prehashed message"):m}function K(m,g,E){let{lowS:_,prehash:B,extraEntropy:v}=er(E,p);m=T(m,B);let k=O(m),A=i.fromBytes(g);if(!i.isValidNot0(A))throw new Error("invalid private key");let R=[V(A),V(k)];if(v!=null&&v!==!1){let Z=v===!0?r(d.secretKey):v;R.push(q(Z,void 0,"extraEntropy"))}let j=G(...R),W=k;function D(Z){let Q=Y(Z);if(!i.isValidNot0(Q))return;let ae=i.inv(Q),F=e.BASE.multiply(Q).toAffine(),ue=i.create(F.x);if(ue===Me)return;let Kt=i.create(ae*i.create(W+ue*A));if(Kt===Me)return;let xo=(F.x===ue?0:2)|Number(F.y&ut),vo=Kt;return _&&w(Kt)&&(vo=i.neg(Kt),xo^=1),new P(ue,vo,y?void 0:xo)}return{seed:j,k2sig:D}}function N(m,g,E={}){let{seed:_,k2sig:B}=K(m,g,E);return Po(t.outputLen,i.BYTES,o)(_,B).toBytes(E.format)}function I(m,g,E,_={}){let{lowS:B,prehash:v,format:k}=er(_,p);if(E=q(E,void 0,"publicKey"),g=T(g,v),!Et(m)){let A=m instanceof P?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+A)}U(m,k);try{let A=P.fromBytes(m,k),R=e.fromBytes(E);if(B&&A.hasHighS())return!1;let{r:j,s:W}=A,D=O(g),Z=i.inv(W),Q=i.create(D*Z),ae=i.create(j*Z),F=e.BASE.multiplyUnsafe(Q).add(R.multiplyUnsafe(ae));return F.is0()?!1:i.create(F.x)===j}catch{return!1}}function x(m,g,E={}){let{prehash:_}=er(E,p);return g=T(g,_),P.fromBytes(m,"recovered").recoverPublicKey(g).toBytes()}return Object.freeze({keygen:l,getPublicKey:u,getSharedSecret:f,utils:h,lengths:d,Point:e,sign:N,verify:I,recoverPublicKey:x,Signature:P,hash:t})}var en={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Ta={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Ia=BigInt(0),rr=BigInt(2);function Ua(e){let t=en.p,n=BigInt(3),r=BigInt(6),o=BigInt(11),s=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),l=e*e*e%t,u=l*l*e%t,f=be(u,n,t)*u%t,h=be(f,n,t)*u%t,d=be(h,rr,t)*l%t,p=be(d,o,t)*d%t,y=be(p,s,t)*p%t,w=be(y,a,t)*y%t,b=be(w,c,t)*w%t,S=be(b,a,t)*y%t,U=be(S,n,t)*u%t,P=be(U,i,t)*p%t,Y=be(P,r,t)*l%t,O=be(Y,rr,t);if(!Yt.eql(Yt.sqr(O),e))throw new Error("Cannot find square root");return O}var Yt=ct(en.p,{sqrt:Ua}),Ye=Qo(en,{Fp:Yt,endo:Ta}),Qe=ns(Ye,te),rs={};function Qt(e,...t){let n=rs[e];if(n===void 0){let r=te(Io(e));n=G(r,r),rs[e]=n}return te(G(n,...t))}var sr=e=>e.toBytes(!0).slice(1),ir=e=>e%rr===Ia;function or(e){let{Fn:t,BASE:n}=Ye,r=t.fromBytes(e),o=n.multiply(r);return{scalar:ir(o.y)?r:t.neg(r),bytes:sr(o)}}function ss(e){let t=Yt;if(!t.isValidNot0(e))throw new Error("invalid x: Fail if x \u2265 p");let n=t.create(e*e),r=t.create(n*e+BigInt(7)),o=t.sqrt(r);ir(o)||(o=t.neg(o));let s=Ye.fromAffine({x:e,y:o});return s.assertValidity(),s}var Rt=Ve;function is(...e){return Ye.Fn.create(Rt(Qt("BIP0340/challenge",...e)))}function os(e){return or(e).bytes}function Pa(e,t,n=fe(32)){let{Fn:r}=Ye,o=q(e,void 0,"message"),{bytes:s,scalar:i}=or(t),a=q(n,32,"auxRand"),c=r.toBytes(i^Rt(Qt("BIP0340/aux",a))),l=Qt("BIP0340/nonce",c,s,o),{bytes:u,scalar:f}=or(l),h=is(u,s,o),d=new Uint8Array(64);if(d.set(u,0),d.set(r.toBytes(r.create(f+h*i)),32),!as(d,o,s))throw new Error("sign: Invalid signature produced");return d}function as(e,t,n){let{Fp:r,Fn:o,BASE:s}=Ye,i=q(e,64,"signature"),a=q(t,void 0,"message"),c=q(n,32,"publicKey");try{let l=ss(Rt(c)),u=Rt(i.subarray(0,32));if(!r.isValidNot0(u))return!1;let f=Rt(i.subarray(32,64));if(!o.isValidNot0(f))return!1;let h=is(o.toBytes(u),sr(l),a),d=s.multiplyUnsafe(f).add(l.multiplyUnsafe(o.neg(h))),{x:p,y}=d.toAffine();return!(d.is0()||!ir(y)||p!==u)}catch{return!1}}var ft=(()=>{let n=(r=fe(48))=>Zt(r,en.n);return{keygen:Gt(n,os),getPublicKey:os,sign:Pa,verify:as,Point:Ye,utils:{randomSecretKey:n,taggedHash:Qt,lift_x:ss,pointToBytes:sr},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:32*2,seed:48}}})();function ur(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function Ca(e){if(!ur(e))throw new Error("Uint8Array expected")}function fs(e,t){return Array.isArray(t)?t.length===0?!0:e?t.every(n=>typeof n=="string"):t.every(n=>Number.isSafeInteger(n)):!1}function Oa(e){if(typeof e!="function")throw new Error("function expected");return!0}function et(e,t){if(typeof t!="string")throw new Error(`${e}: string expected`);return!0}function fr(e){if(!Number.isSafeInteger(e))throw new Error(`invalid integer: ${e}`)}function ar(e){if(!Array.isArray(e))throw new Error("array expected")}function nn(e,t){if(!fs(!0,t))throw new Error(`${e}: array of strings expected`)}function ds(e,t){if(!fs(!1,t))throw new Error(`${e}: array of numbers expected`)}function hs(...e){let t=s=>s,n=(s,i)=>a=>s(i(a)),r=e.map(s=>s.encode).reduceRight(n,t),o=e.map(s=>s.decode).reduce(n,t);return{encode:r,decode:o}}function ps(e){let t=typeof e=="string"?e.split(""):e,n=t.length;nn("alphabet",t);let r=new Map(t.map((o,s)=>[o,s]));return{encode:o=>(ar(o),o.map(s=>{if(!Number.isSafeInteger(s)||s<0||s>=n)throw new Error(`alphabet.encode: digit index outside alphabet "${s}". Allowed: ${e}`);return t[s]})),decode:o=>(ar(o),o.map(s=>{et("alphabet.decode",s);let i=r.get(s);if(i===void 0)throw new Error(`Unknown letter: "${s}". Allowed: ${e}`);return i}))}}function ys(e=""){return et("join",e),{encode:t=>(nn("join.decode",t),t.join(e)),decode:t=>(et("join.decode",t),t.split(e))}}function Na(e,t="="){return fr(e),et("padding",t),{encode(n){for(nn("padding.encode",n);n.length*e%8;)n.push(t);return n},decode(n){nn("padding.decode",n);let r=n.length;if(r*e%8)throw new Error("padding: invalid, string should have whole number of bytes");for(;r>0&&n[r-1]===t;r--)if((r-1)*e%8===0)throw new Error("padding: invalid, string has too much padding");return n.slice(0,r)}}}var gs=(e,t)=>t===0?e:gs(t,e%t),rn=(e,t)=>e+(t-gs(e,t)),tn=(()=>{let e=[];for(let t=0;t<40;t++)e.push(2**t);return e})();function cr(e,t,n,r){if(ar(e),t<=0||t>32)throw new Error(`convertRadix2: wrong from=${t}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(rn(t,n)>32)throw new Error(`convertRadix2: carry overflow from=${t} to=${n} carryBits=${rn(t,n)}`);let o=0,s=0,i=tn[t],a=tn[n]-1,c=[];for(let l of e){if(fr(l),l>=i)throw new Error(`convertRadix2: invalid data word=${l} from=${t}`);if(o=o<<t|l,s+t>32)throw new Error(`convertRadix2: carry overflow pos=${s} from=${t}`);for(s+=t;s>=n;s-=n)c.push((o>>s-n&a)>>>0);let u=tn[s];if(u===void 0)throw new Error("invalid carry");o&=u-1}if(o=o<<n-s&a,!r&&s>=t)throw new Error("Excess padding");if(!r&&o>0)throw new Error(`Non-zero padding: ${o}`);return r&&s>0&&c.push(o>>>0),c}function ws(e,t=!1){if(fr(e),e<=0||e>32)throw new Error("radix2: bits should be in (0..32]");if(rn(8,e)>32||rn(e,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!ur(n))throw new Error("radix2.encode input should be Uint8Array");return cr(Array.from(n),8,e,!t)},decode:n=>(ds("radix2.decode",n),Uint8Array.from(cr(n,e,8,t)))}}function cs(e){return Oa(e),function(...t){try{return e.apply(null,t)}catch{}}}var Ma=typeof Uint8Array.from([]).toBase64=="function"&&typeof Uint8Array.fromBase64=="function",Da=(e,t)=>{et("base64",e);let n=t?/^[A-Za-z0-9=_-]+$/:/^[A-Za-z0-9=+/]+$/,r=t?"base64url":"base64";if(e.length>0&&!n.test(e))throw new Error("invalid base64");return Uint8Array.fromBase64(e,{alphabet:r,lastChunkHandling:"strict"})},pe=Ma?{encode(e){return Ca(e),e.toBase64()},decode(e){return Da(e,!1)}}:hs(ws(6),ps("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),Na(6),ys(""));var lr=hs(ps("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),ys("")),ls=[996825010,642813549,513874426,1027748829,705979059];function Lt(e){let t=e>>25,n=(e&33554431)<<5;for(let r=0;r<ls.length;r++)(t>>r&1)===1&&(n^=ls[r]);return n}function us(e,t,n=1){let r=e.length,o=1;for(let s=0;s<r;s++){let i=e.charCodeAt(s);if(i<33||i>126)throw new Error(`Invalid prefix (${e})`);o=Lt(o)^i>>5}o=Lt(o);for(let s=0;s<r;s++)o=Lt(o)^e.charCodeAt(s)&31;for(let s of t)o=Lt(o)^s;for(let s=0;s<6;s++)o=Lt(o);return o^=n,lr.encode(cr([o%tn[30]],30,5,!1))}function Ha(e){let t=e==="bech32"?1:734539939,n=ws(5),r=n.decode,o=n.encode,s=cs(r);function i(f,h,d=90){et("bech32.encode prefix",f),ur(h)&&(h=Array.from(h)),ds("bech32.encode",h);let p=f.length;if(p===0)throw new TypeError(`Invalid prefix length ${p}`);let y=p+7+h.length;if(d!==!1&&y>d)throw new TypeError(`Length ${y} exceeds limit ${d}`);let w=f.toLowerCase(),b=us(w,h,t);return`${w}1${lr.encode(h)}${b}`}function a(f,h=90){et("bech32.decode input",f);let d=f.length;if(d<8||h!==!1&&d>h)throw new TypeError(`invalid string length: ${d} (${f}). Expected (8..${h})`);let p=f.toLowerCase();if(f!==p&&f!==f.toUpperCase())throw new Error("String must be lowercase or uppercase");let y=p.lastIndexOf("1");if(y===0||y===-1)throw new Error('Letter "1" must be present between prefix and data only');let w=p.slice(0,y),b=p.slice(y+1);if(b.length<6)throw new Error("Data must be at least 6 characters long");let S=lr.decode(b).slice(0,-6),U=us(w,S,t);if(!b.endsWith(U))throw new Error(`Invalid checksum in ${f}: expected "${U}"`);return{prefix:w,words:S}}let c=cs(a);function l(f){let{prefix:h,words:d}=a(f,!1);return{prefix:h,words:d,bytes:r(d)}}function u(f,h){return i(f,o(h))}return{encode:i,decode:a,encodeFromBytes:u,decodeToBytes:l,decodeUnsafe:c,fromWords:r,fromWordsUnsafe:s,toWords:o}}var ye=Ha("bech32");function Ka(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function on(e){if(typeof e!="boolean")throw new Error(`boolean expected, not ${e}`)}function Tt(e){if(!Number.isSafeInteger(e)||e<0)throw new Error("positive integer expected, got "+e)}function J(e,t,n=""){let r=Ka(e),o=e?.length,s=t!==void 0;if(!r||s&&o!==t){let i=n&&`"${n}" `,a=s?` of length ${t}`:"",c=r?`length=${o}`:`type=${typeof e}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return e}function dr(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function bs(e,t){J(e,void 0,"output");let n=t.outputLen;if(e.length<n)throw new Error("digestInto() expects output buffer of length at least "+n)}function ne(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function ce(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function ms(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}var qa=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function xs(e,t){return e.buffer===t.buffer&&e.byteOffset<t.byteOffset+t.byteLength&&t.byteOffset<e.byteOffset+e.byteLength}function hr(e,t){if(xs(e,t)&&e.byteOffset<t.byteOffset)throw new Error("complex overlap of input and output is not supported")}function vs(e,t){if(t==null||typeof t!="object")throw new Error("options must be defined");return Object.assign(e,t)}function tt(e,t){if(e.length!==t.length)return!1;let n=0;for(let r=0;r<e.length;r++)n|=e[r]^t[r];return n===0}var It=(e,t)=>{function n(r,...o){if(J(r,void 0,"key"),!qa)throw new Error("Non little-endian hardware is not yet supported");if(e.nonceLength!==void 0){let u=o[0];J(u,e.varSizeNonce?void 0:e.nonceLength,"nonce")}let s=e.tagLength;s&&o[1]!==void 0&&J(o[1],void 0,"AAD");let i=t(r,...o),a=(u,f)=>{if(f!==void 0){if(u!==2)throw new Error("cipher output not supported");J(f,void 0,"output")}},c=!1;return{encrypt(u,f){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,J(u),a(i.encrypt.length,f),i.encrypt(u,f)},decrypt(u,f){if(J(u),s&&u.length<s)throw new Error('"ciphertext" expected length bigger than tagLength='+s);return a(i.decrypt.length,f),i.decrypt(u,f)}}}return Object.assign(n,e),n};function dt(e,t,n=!0){if(t===void 0)return new Uint8Array(e);if(t.length!==e)throw new Error('"output" expected Uint8Array of length '+e+", got: "+t.length);if(n&&!nt(t))throw new Error("invalid output, must be aligned");return t}function pr(e,t,n){on(n);let r=new Uint8Array(16),o=ms(r);return o.setBigUint64(0,BigInt(t),n),o.setBigUint64(8,BigInt(e),n),r}function nt(e){return e.byteOffset%4===0}function Ee(e){return Uint8Array.from(e)}var oe=16;var Va=283;function ks(e){if(![16,24,32].includes(e.length))throw new Error('"aes key" expected Uint8Array of length 16/24/32, got length='+e.length)}function mr(e){return e<<1^Va&-(e>>7)}function ht(e,t){let n=0;for(;t>0;t>>=1)n^=e&-(t&1),e=mr(e);return n}var wr=(()=>{let e=new Uint8Array(256);for(let n=0,r=1;n<256;n++,r^=mr(r))e[n]=r;let t=new Uint8Array(256);t[0]=99;for(let n=0;n<255;n++){let r=e[255-n];r|=r<<8,t[e[n]]=(r^r>>4^r>>5^r>>6^r>>7^99)&255}return ce(e),t})(),Wa=wr.map((e,t)=>wr.indexOf(t)),za=e=>e<<24|e>>>8,yr=e=>e<<8|e>>>24;function _s(e,t){if(e.length!==256)throw new Error("Wrong sbox length");let n=new Uint32Array(256).map((l,u)=>t(e[u])),r=n.map(yr),o=r.map(yr),s=o.map(yr),i=new Uint32Array(256*256),a=new Uint32Array(256*256),c=new Uint16Array(256*256);for(let l=0;l<256;l++)for(let u=0;u<256;u++){let f=l*256+u;i[f]=n[l]^r[u],a[f]=o[l]^s[u],c[f]=e[l]<<8|e[u]}return{sbox:e,sbox2:c,T0:n,T1:r,T2:o,T3:s,T01:i,T23:a}}var xr=_s(wr,e=>ht(e,3)<<24|e<<16|e<<8|ht(e,2)),Bs=_s(Wa,e=>ht(e,11)<<24|ht(e,13)<<16|ht(e,9)<<8|ht(e,14)),ja=(()=>{let e=new Uint8Array(16);for(let t=0,n=1;t<16;t++,n=mr(n))e[t]=n;return e})();function vr(e){J(e);let t=e.length;ks(e);let{sbox2:n}=xr,r=[];nt(e)||r.push(e=Ee(e));let o=ne(e),s=o.length,i=c=>Te(n,c,c,c,c),a=new Uint32Array(t+28);a.set(o);for(let c=s;c<a.length;c++){let l=a[c-1];c%s===0?l=i(za(l))^ja[c/s-1]:s>6&&c%s===4&&(l=i(l)),a[c]=a[c-s]^l}return ce(...r),a}function Za(e){let t=vr(e),n=t.slice(),r=t.length,{sbox2:o}=xr,{T0:s,T1:i,T2:a,T3:c}=Bs;for(let l=0;l<r;l+=4)for(let u=0;u<4;u++)n[l+u]=t[r-l-4+u];ce(t);for(let l=4;l<r-4;l++){let u=n[l],f=Te(o,u,u,u,u);n[l]=s[f&255]^i[f>>>8&255]^a[f>>>16&255]^c[f>>>24]}return n}function ze(e,t,n,r,o,s){return e[n<<8&65280|r>>>8&255]^t[o>>>8&65280|s>>>24&255]}function Te(e,t,n,r,o){return e[t&255|n&65280]|e[r>>>16&255|o>>>16&65280]<<16}function br(e,t,n,r,o){let{sbox2:s,T01:i,T23:a}=xr,c=0;t^=e[c++],n^=e[c++],r^=e[c++],o^=e[c++];let l=e.length/4-2;for(let p=0;p<l;p++){let y=e[c++]^ze(i,a,t,n,r,o),w=e[c++]^ze(i,a,n,r,o,t),b=e[c++]^ze(i,a,r,o,t,n),S=e[c++]^ze(i,a,o,t,n,r);t=y,n=w,r=b,o=S}let u=e[c++]^Te(s,t,n,r,o),f=e[c++]^Te(s,n,r,o,t),h=e[c++]^Te(s,r,o,t,n),d=e[c++]^Te(s,o,t,n,r);return{s0:u,s1:f,s2:h,s3:d}}function Fa(e,t,n,r,o){let{sbox2:s,T01:i,T23:a}=Bs,c=0;t^=e[c++],n^=e[c++],r^=e[c++],o^=e[c++];let l=e.length/4-2;for(let p=0;p<l;p++){let y=e[c++]^ze(i,a,t,o,r,n),w=e[c++]^ze(i,a,n,t,o,r),b=e[c++]^ze(i,a,r,n,t,o),S=e[c++]^ze(i,a,o,r,n,t);t=y,n=w,r=b,o=S}let u=e[c++]^Te(s,t,o,r,n),f=e[c++]^Te(s,n,t,o,r),h=e[c++]^Te(s,r,n,t,o),d=e[c++]^Te(s,o,r,n,t);return{s0:u,s1:f,s2:h,s3:d}}function Ga(e){if(J(e),e.length%oe!==0)throw new Error("aes-(cbc/ecb).decrypt ciphertext should consist of blocks with size "+oe)}function Ja(e,t,n){J(e);let r=e.length,o=r%oe;if(!t&&o!==0)throw new Error("aec/(cbc-ecb): unpadded plaintext with disabled padding");nt(e)||(e=Ee(e));let s=ne(e);if(t){let a=oe-o;a||(a=oe),r=r+a}n=dt(r,n),hr(e,n);let i=ne(n);return{b:s,o:i,out:n}}function Xa(e,t){if(!t)return e;let n=e.length;if(!n)throw new Error("aes/pcks5: empty ciphertext not allowed");let r=e[n-1];if(r<=0||r>16)throw new Error("aes/pcks5: wrong padding");let o=e.subarray(0,-r);for(let s=0;s<r;s++)if(e[n-s-1]!==r)throw new Error("aes/pcks5: wrong padding");return o}function Ya(e){let t=new Uint8Array(16),n=ne(t);t.set(e);let r=oe-e.length;for(let o=oe-r;o<oe;o++)t[o]=r;return n}var Er=It({blockSize:16,nonceLength:16},function(t,n,r={}){let o=!r.disablePadding;return{encrypt(s,i){let a=vr(t),{b:c,o:l,out:u}=Ja(s,o,i),f=n,h=[a];nt(f)||h.push(f=Ee(f));let d=ne(f),p=d[0],y=d[1],w=d[2],b=d[3],S=0;for(;S+4<=c.length;)p^=c[S+0],y^=c[S+1],w^=c[S+2],b^=c[S+3],{s0:p,s1:y,s2:w,s3:b}=br(a,p,y,w,b),l[S++]=p,l[S++]=y,l[S++]=w,l[S++]=b;if(o){let U=Ya(s.subarray(S*4));p^=U[0],y^=U[1],w^=U[2],b^=U[3],{s0:p,s1:y,s2:w,s3:b}=br(a,p,y,w,b),l[S++]=p,l[S++]=y,l[S++]=w,l[S++]=b}return ce(...h),u},decrypt(s,i){Ga(s);let a=Za(t),c=n,l=[a];nt(c)||l.push(c=Ee(c));let u=ne(c);i=dt(s.length,i),nt(s)||l.push(s=Ee(s)),hr(s,i);let f=ne(s),h=ne(i),d=u[0],p=u[1],y=u[2],w=u[3];for(let b=0;b+4<=f.length;){let S=d,U=p,P=y,Y=w;d=f[b+0],p=f[b+1],y=f[b+2],w=f[b+3];let{s0:O,s1:z,s2:V,s3:T}=Fa(a,d,p,y,w);h[b++]=O^S,h[b++]=z^U,h[b++]=V^P,h[b++]=T^Y}return ce(...l),Xa(i,o)}}});function Qa(e){return e instanceof Uint32Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint32Array"}function gr(e,t){if(J(t,16,"block"),!Qa(e))throw new Error("_encryptBlock accepts result of expandKeyLE");let n=ne(t),{s0:r,s1:o,s2:s,s3:i}=br(e,n[0],n[1],n[2],n[3]);return n[0]=r,n[1]=o,n[2]=s,n[3]=i,t}function Es(e){let t=0;for(let n=oe-1;n>=0;n--){let r=(e[n]&128)>>>7;e[n]=e[n]<<1|t,t=r}return t&&(e[oe-1]^=135),e}function sn(e,t){if(e.length!==t.length)throw new Error("xorBlock: blocks must have same length");for(let n=0;n<e.length;n++)e[n]=e[n]^t[n];return e}var an=class{buffer;destroyed;k1;k2;xk;constructor(t){J(t),ks(t),this.xk=vr(t),this.buffer=new Uint8Array(0),this.destroyed=!1;let n=new Uint8Array(oe);gr(this.xk,n),this.k1=Es(n),this.k2=Es(new Uint8Array(this.k1))}update(t){let{destroyed:n,buffer:r}=this;if(n)throw new Error("CMAC instance was destroyed");J(t);let o=new Uint8Array(r.length+t.length);return o.set(r),o.set(t,r.length),this.buffer=o,this}digest(){if(this.destroyed)throw new Error("CMAC instance was destroyed");let{buffer:t}=this,n=t.length,r=Math.ceil(n/oe),o;r===0?(r=1,o=!1):o=n%oe===0;let s=(r-1)*oe,i=t.subarray(s),a;if(o)a=sn(new Uint8Array(i),this.k1);else{let l=new Uint8Array(oe);l.set(i),l[i.length]=128,a=sn(l,this.k2)}let c=new Uint8Array(oe);for(let l=0;l<r-1;l++){let u=t.subarray(l*oe,(l+1)*oe);sn(c,u),gr(this.xk,c)}return sn(c,a),gr(this.xk,c),ce(a),c}destroy(){let{buffer:t,destroyed:n,xk:r,k1:o,k2:s}=this;n||(this.destroyed=!0,ce(t,r,o,s))}},ec=(e,t)=>new an(e).update(t).digest();ec.create=e=>new an(e);var As=e=>Uint8Array.from(e.split(""),t=>t.charCodeAt(0)),tc=As("expand 16-byte k"),nc=As("expand 32-byte k"),rc=ne(tc),oc=ne(nc);function L(e,t){return e<<t|e>>>32-t}function kr(e){return e.byteOffset%4===0}var cn=64,sc=16,Rs=2**32-1,Ss=Uint32Array.of();function ic(e,t,n,r,o,s,i,a){let c=o.length,l=new Uint8Array(cn),u=ne(l),f=kr(o)&&kr(s),h=f?ne(o):Ss,d=f?ne(s):Ss;for(let p=0;p<c;i++){if(e(t,n,r,u,i,a),i>=Rs)throw new Error("arx: counter overflow");let y=Math.min(cn,c-p);if(f&&y===cn){let w=p/4;if(p%4!==0)throw new Error("arx: invalid block position");for(let b=0,S;b<sc;b++)S=w+b,d[S]=h[S]^u[b];p+=cn;continue}for(let w=0,b;w<y;w++)b=p+w,s[b]=o[b]^l[w];p+=y}}function _r(e,t){let{allowShortKeys:n,extendNonceFn:r,counterLength:o,counterRight:s,rounds:i}=vs({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t);if(typeof e!="function")throw new Error("core must be a function");return Tt(o),Tt(i),on(s),on(n),(a,c,l,u,f=0)=>{J(a,void 0,"key"),J(c,void 0,"nonce"),J(l,void 0,"data");let h=l.length;if(u===void 0&&(u=new Uint8Array(h)),J(u,void 0,"output"),Tt(f),f<0||f>=Rs)throw new Error("arx: counter overflow");if(u.length<h)throw new Error(`arx: output (${u.length}) is shorter than data (${h})`);let d=[],p=a.length,y,w;if(p===32)d.push(y=Ee(a)),w=oc;else if(p===16&&n)y=new Uint8Array(32),y.set(a),y.set(a,16),w=rc,d.push(y);else throw J(a,32,"arx key"),new Error("invalid key size");kr(c)||d.push(c=Ee(c));let b=ne(y);if(r){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(w,b,ne(c.subarray(0,16)),b),c=c.subarray(16)}let S=16-o;if(S!==c.length)throw new Error(`arx: nonce must be ${S} or 16 bytes`);if(S!==12){let P=new Uint8Array(12);P.set(c,s?0:12-c.length),c=P,d.push(c)}let U=ne(c);return ic(e,w,b,U,l,u,f,i),ce(...d),u}}function le(e,t){return e[t++]&255|(e[t++]&255)<<8}var Br=class{blockLen=16;outputLen=16;buffer=new Uint8Array(16);r=new Uint16Array(10);h=new Uint16Array(10);pad=new Uint16Array(8);pos=0;finished=!1;constructor(t){t=Ee(J(t,32,"key"));let n=le(t,0),r=le(t,2),o=le(t,4),s=le(t,6),i=le(t,8),a=le(t,10),c=le(t,12),l=le(t,14);this.r[0]=n&8191,this.r[1]=(n>>>13|r<<3)&8191,this.r[2]=(r>>>10|o<<6)&7939,this.r[3]=(o>>>7|s<<9)&8191,this.r[4]=(s>>>4|i<<12)&255,this.r[5]=i>>>1&8190,this.r[6]=(i>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=le(t,16+2*u)}process(t,n,r=!1){let o=r?0:2048,{h:s,r:i}=this,a=i[0],c=i[1],l=i[2],u=i[3],f=i[4],h=i[5],d=i[6],p=i[7],y=i[8],w=i[9],b=le(t,n+0),S=le(t,n+2),U=le(t,n+4),P=le(t,n+6),Y=le(t,n+8),O=le(t,n+10),z=le(t,n+12),V=le(t,n+14),T=s[0]+(b&8191),K=s[1]+((b>>>13|S<<3)&8191),N=s[2]+((S>>>10|U<<6)&8191),I=s[3]+((U>>>7|P<<9)&8191),x=s[4]+((P>>>4|Y<<12)&8191),m=s[5]+(Y>>>1&8191),g=s[6]+((Y>>>14|O<<2)&8191),E=s[7]+((O>>>11|z<<5)&8191),_=s[8]+((z>>>8|V<<8)&8191),B=s[9]+(V>>>5|o),v=0,k=v+T*a+K*(5*w)+N*(5*y)+I*(5*p)+x*(5*d);v=k>>>13,k&=8191,k+=m*(5*h)+g*(5*f)+E*(5*u)+_*(5*l)+B*(5*c),v+=k>>>13,k&=8191;let A=v+T*c+K*a+N*(5*w)+I*(5*y)+x*(5*p);v=A>>>13,A&=8191,A+=m*(5*d)+g*(5*h)+E*(5*f)+_*(5*u)+B*(5*l),v+=A>>>13,A&=8191;let R=v+T*l+K*c+N*a+I*(5*w)+x*(5*y);v=R>>>13,R&=8191,R+=m*(5*p)+g*(5*d)+E*(5*h)+_*(5*f)+B*(5*u),v+=R>>>13,R&=8191;let j=v+T*u+K*l+N*c+I*a+x*(5*w);v=j>>>13,j&=8191,j+=m*(5*y)+g*(5*p)+E*(5*d)+_*(5*h)+B*(5*f),v+=j>>>13,j&=8191;let W=v+T*f+K*u+N*l+I*c+x*a;v=W>>>13,W&=8191,W+=m*(5*w)+g*(5*y)+E*(5*p)+_*(5*d)+B*(5*h),v+=W>>>13,W&=8191;let D=v+T*h+K*f+N*u+I*l+x*c;v=D>>>13,D&=8191,D+=m*a+g*(5*w)+E*(5*y)+_*(5*p)+B*(5*d),v+=D>>>13,D&=8191;let Z=v+T*d+K*h+N*f+I*u+x*l;v=Z>>>13,Z&=8191,Z+=m*c+g*a+E*(5*w)+_*(5*y)+B*(5*p),v+=Z>>>13,Z&=8191;let Q=v+T*p+K*d+N*h+I*f+x*u;v=Q>>>13,Q&=8191,Q+=m*l+g*c+E*a+_*(5*w)+B*(5*y),v+=Q>>>13,Q&=8191;let ae=v+T*y+K*p+N*d+I*h+x*f;v=ae>>>13,ae&=8191,ae+=m*u+g*l+E*c+_*a+B*(5*w),v+=ae>>>13,ae&=8191;let F=v+T*w+K*y+N*p+I*d+x*h;v=F>>>13,F&=8191,F+=m*f+g*u+E*l+_*c+B*a,v+=F>>>13,F&=8191,v=(v<<2)+v|0,v=v+k|0,k=v&8191,v=v>>>13,A+=v,s[0]=k,s[1]=A,s[2]=R,s[3]=j,s[4]=W,s[5]=D,s[6]=Z,s[7]=Q,s[8]=ae,s[9]=F}finalize(){let{h:t,pad:n}=this,r=new Uint16Array(10),o=t[1]>>>13;t[1]&=8191;for(let a=2;a<10;a++)t[a]+=o,o=t[a]>>>13,t[a]&=8191;t[0]+=o*5,o=t[0]>>>13,t[0]&=8191,t[1]+=o,o=t[1]>>>13,t[1]&=8191,t[2]+=o,r[0]=t[0]+5,o=r[0]>>>13,r[0]&=8191;for(let a=1;a<10;a++)r[a]=t[a]+o,o=r[a]>>>13,r[a]&=8191;r[9]-=8192;let s=(o^1)-1;for(let a=0;a<10;a++)r[a]&=s;s=~s;for(let a=0;a<10;a++)t[a]=t[a]&s|r[a];t[0]=(t[0]|t[1]<<13)&65535,t[1]=(t[1]>>>3|t[2]<<10)&65535,t[2]=(t[2]>>>6|t[3]<<7)&65535,t[3]=(t[3]>>>9|t[4]<<4)&65535,t[4]=(t[4]>>>12|t[5]<<1|t[6]<<14)&65535,t[5]=(t[6]>>>2|t[7]<<11)&65535,t[6]=(t[7]>>>5|t[8]<<8)&65535,t[7]=(t[8]>>>8|t[9]<<5)&65535;let i=t[0]+n[0];t[0]=i&65535;for(let a=1;a<8;a++)i=(t[a]+n[a]|0)+(i>>>16)|0,t[a]=i&65535;ce(r)}update(t){dr(this),J(t),t=Ee(t);let{buffer:n,blockLen:r}=this,o=t.length;for(let s=0;s<o;){let i=Math.min(r-this.pos,o-s);if(i===r){for(;r<=o-s;s+=r)this.process(t,s);continue}n.set(t.subarray(s,s+i),this.pos),this.pos+=i,s+=i,this.pos===r&&(this.process(n,0,!1),this.pos=0)}return this}destroy(){ce(this.h,this.r,this.buffer,this.pad)}digestInto(t){dr(this),bs(t,this),this.finished=!0;let{buffer:n,h:r}=this,{pos:o}=this;if(o){for(n[o++]=1;o<16;o++)n[o]=0;this.process(n,0,!0)}this.finalize();let s=0;for(let i=0;i<8;i++)t[s++]=r[i]>>>0,t[s++]=r[i]>>>8;return t}digest(){let{buffer:t,outputLen:n}=this;this.digestInto(t);let r=t.slice(0,n);return this.destroy(),r}};function ac(e){let t=(r,o)=>e(o).update(r).digest(),n=e(new Uint8Array(32));return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=r=>e(r),t}var Ls=ac(e=>new Br(e));function Us(e,t,n,r,o,s=20){let i=e[0],a=e[1],c=e[2],l=e[3],u=t[0],f=t[1],h=t[2],d=t[3],p=t[4],y=t[5],w=t[6],b=t[7],S=o,U=n[0],P=n[1],Y=n[2],O=i,z=a,V=c,T=l,K=u,N=f,I=h,x=d,m=p,g=y,E=w,_=b,B=S,v=U,k=P,A=Y;for(let j=0;j<s;j+=2)O=O+K|0,B=L(B^O,16),m=m+B|0,K=L(K^m,12),O=O+K|0,B=L(B^O,8),m=m+B|0,K=L(K^m,7),z=z+N|0,v=L(v^z,16),g=g+v|0,N=L(N^g,12),z=z+N|0,v=L(v^z,8),g=g+v|0,N=L(N^g,7),V=V+I|0,k=L(k^V,16),E=E+k|0,I=L(I^E,12),V=V+I|0,k=L(k^V,8),E=E+k|0,I=L(I^E,7),T=T+x|0,A=L(A^T,16),_=_+A|0,x=L(x^_,12),T=T+x|0,A=L(A^T,8),_=_+A|0,x=L(x^_,7),O=O+N|0,A=L(A^O,16),E=E+A|0,N=L(N^E,12),O=O+N|0,A=L(A^O,8),E=E+A|0,N=L(N^E,7),z=z+I|0,B=L(B^z,16),_=_+B|0,I=L(I^_,12),z=z+I|0,B=L(B^z,8),_=_+B|0,I=L(I^_,7),V=V+x|0,v=L(v^V,16),m=m+v|0,x=L(x^m,12),V=V+x|0,v=L(v^V,8),m=m+v|0,x=L(x^m,7),T=T+K|0,k=L(k^T,16),g=g+k|0,K=L(K^g,12),T=T+K|0,k=L(k^T,8),g=g+k|0,K=L(K^g,7);let R=0;r[R++]=i+O|0,r[R++]=a+z|0,r[R++]=c+V|0,r[R++]=l+T|0,r[R++]=u+K|0,r[R++]=f+N|0,r[R++]=h+I|0,r[R++]=d+x|0,r[R++]=p+m|0,r[R++]=y+g|0,r[R++]=w+E|0,r[R++]=b+_|0,r[R++]=S+B|0,r[R++]=U+v|0,r[R++]=P+k|0,r[R++]=Y+A|0}function cc(e,t,n,r){let o=e[0],s=e[1],i=e[2],a=e[3],c=t[0],l=t[1],u=t[2],f=t[3],h=t[4],d=t[5],p=t[6],y=t[7],w=n[0],b=n[1],S=n[2],U=n[3];for(let Y=0;Y<20;Y+=2)o=o+c|0,w=L(w^o,16),h=h+w|0,c=L(c^h,12),o=o+c|0,w=L(w^o,8),h=h+w|0,c=L(c^h,7),s=s+l|0,b=L(b^s,16),d=d+b|0,l=L(l^d,12),s=s+l|0,b=L(b^s,8),d=d+b|0,l=L(l^d,7),i=i+u|0,S=L(S^i,16),p=p+S|0,u=L(u^p,12),i=i+u|0,S=L(S^i,8),p=p+S|0,u=L(u^p,7),a=a+f|0,U=L(U^a,16),y=y+U|0,f=L(f^y,12),a=a+f|0,U=L(U^a,8),y=y+U|0,f=L(f^y,7),o=o+l|0,U=L(U^o,16),p=p+U|0,l=L(l^p,12),o=o+l|0,U=L(U^o,8),p=p+U|0,l=L(l^p,7),s=s+u|0,w=L(w^s,16),y=y+w|0,u=L(u^y,12),s=s+u|0,w=L(w^s,8),y=y+w|0,u=L(u^y,7),i=i+f|0,b=L(b^i,16),h=h+b|0,f=L(f^h,12),i=i+f|0,b=L(b^i,8),h=h+b|0,f=L(f^h,7),a=a+c|0,S=L(S^a,16),d=d+S|0,c=L(c^d,12),a=a+c|0,S=L(S^a,8),d=d+S|0,c=L(c^d,7);let P=0;r[P++]=o,r[P++]=s,r[P++]=i,r[P++]=a,r[P++]=w,r[P++]=b,r[P++]=S,r[P++]=U}var rt=_r(Us,{counterRight:!1,counterLength:4,allowShortKeys:!1}),lc=_r(Us,{counterRight:!1,counterLength:8,extendNonceFn:cc,allowShortKeys:!1});var uc=new Uint8Array(16),Ts=(e,t)=>{e.update(t);let n=t.length%16;n&&e.update(uc.subarray(n))},fc=new Uint8Array(32);function Is(e,t,n,r,o){o!==void 0&&J(o,void 0,"AAD");let s=e(t,n,fc),i=pr(r.length,o?o.length:0,!0),a=Ls.create(s);o&&Ts(a,o),Ts(a,r),a.update(i);let c=a.digest();return ce(s,i),c}var Ps=e=>(t,n,r)=>({encrypt(s,i){let a=s.length;i=dt(a+16,i,!1),i.set(s);let c=i.subarray(0,-16);e(t,n,c,c,1);let l=Is(e,t,n,c,r);return i.set(l,a),ce(l),i},decrypt(s,i){i=dt(s.length-16,i,!1);let a=s.subarray(0,-16),c=s.subarray(-16),l=Is(e,t,n,a,r);if(!tt(c,l))throw new Error("invalid tag");return i.set(s.subarray(0,-16)),e(t,n,i,i,1),ce(l),i}}),xh=It({blockSize:64,nonceLength:12,tagLength:16},Ps(rt)),Sr=It({blockSize:64,nonceLength:24,tagLength:16},Ps(lc));function ln(e,t,n){return Oe(e),n===void 0&&(n=new Uint8Array(e.outputLen)),ve(e,n,t)}var Ar=Uint8Array.of(0),Cs=Uint8Array.of();function un(e,t,n,r=32){Oe(e),ee(r,"length");let o=e.outputLen;if(r>255*o)throw new Error("Length must be <= 255*HashLen");let s=Math.ceil(r/o);n===void 0?n=Cs:q(n,void 0,"info");let i=new Uint8Array(s*o),a=ve.create(e,t),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let u=0;u<s;u++)Ar[0]=u+1,c.update(u===0?Cs:l).update(n).update(Ar).digestInto(l),i.set(l,o*u),a._cloneInto(c);return a.destroy(),c.destroy(),we(l,Ar),i.slice(0,r)}var dc=Object.defineProperty,X=(e,t)=>{for(var n in t)dc(e,n,{get:t[n],enumerable:!0})},pt=Symbol("verified"),hc=e=>e instanceof Object;function Ur(e){if(!hc(e)||typeof e.kind!="number"||typeof e.content!="string"||typeof e.created_at!="number"||typeof e.pubkey!="string"||!e.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(e.tags))return!1;for(let t=0;t<e.tags.length;t++){let n=e.tags[t];if(!Array.isArray(n))return!1;for(let r=0;r<n.length;r++)if(typeof n[r]!="string")return!1}return!0}var pc={};X(pc,{binarySearch:()=>Pr,bytesToHex:()=>H,hexToBytes:()=>M,insertEventIntoAscendingList:()=>wc,insertEventIntoDescendingList:()=>gc,mergeReverseSortedLists:()=>bc,normalizeURL:()=>yc,utf8Decoder:()=>Ke,utf8Encoder:()=>ke});var Ke=new TextDecoder("utf-8"),ke=new TextEncoder;function yc(e){try{e.indexOf("://")===-1&&(e="wss://"+e);let t=new URL(e);return t.protocol==="http:"?t.protocol="ws:":t.protocol==="https:"&&(t.protocol="wss:"),t.pathname=t.pathname.replace(/\/+/g,"/"),t.pathname.endsWith("/")&&(t.pathname=t.pathname.slice(0,-1)),(t.port==="80"&&t.protocol==="ws:"||t.port==="443"&&t.protocol==="wss:")&&(t.port=""),t.searchParams.sort(),t.hash="",t.toString()}catch{throw new Error(`Invalid URL: ${e}`)}}function gc(e,t){let[n,r]=Pr(e,o=>t.id===o.id?0:t.created_at===o.created_at?-1:o.created_at-t.created_at);return r||e.splice(n,0,t),e}function wc(e,t){let[n,r]=Pr(e,o=>t.id===o.id?0:t.created_at===o.created_at?-1:t.created_at-o.created_at);return r||e.splice(n,0,t),e}function Pr(e,t){let n=0,r=e.length-1;for(;n<=r;){let o=Math.floor((n+r)/2),s=t(e[o]);if(s===0)return[o,!0];s<0?r=o-1:n=o+1}return[n,!1]}function bc(e,t){let n=new Array(e.length+t.length);n.length=0;let r=0,o=0,s=[];for(;r<e.length&&o<t.length;){let i;if(e[r]?.created_at>t[o]?.created_at?(i=e[r],r++):(i=t[o],o++),n.length>0&&n[n.length-1].created_at===i.created_at){if(s.includes(i.id))continue}else s.length=0;n.push(i),s.push(i.id)}for(;r<e.length;){let i=e[r];if(r++,n.length>0&&n[n.length-1].created_at===i.created_at){if(s.includes(i.id))continue}else s.length=0;n.push(i),s.push(i.id)}for(;o<t.length;){let i=t[o];if(o++,n.length>0&&n[n.length-1].created_at===i.created_at){if(s.includes(i.id))continue}else s.length=0;n.push(i),s.push(i.id)}return n}var mc=class{generateSecretKey(){return ft.utils.randomSecretKey()}getPublicKey(e){return H(ft.getPublicKey(e))}finalizeEvent(e,t){let n=e;return n.pubkey=H(ft.getPublicKey(t)),n.id=dn(n),n.sig=H(ft.sign(M(dn(n)),t)),n[pt]=!0,n}verifyEvent(e){if(typeof e[pt]=="boolean")return e[pt];let t=dn(e);if(t!==e.id)return e[pt]=!1,!1;try{let n=ft.verify(M(e.sig),M(t),M(e.pubkey));return e[pt]=n,n}catch{return e[pt]=!1,!1}}};function xc(e){if(!Ur(e))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content])}function dn(e){let t=te(ke.encode(xc(e)));return H(t)}var yn=new mc,Ut=yn.generateSecretKey,qe=yn.getPublicKey,se=yn.finalizeEvent,Cr=yn.verifyEvent,vc={};X(vc,{Application:()=>Pl,BadgeAward:()=>Lc,BadgeDefinition:()=>Sl,BlockedRelaysList:()=>cl,BlossomServerList:()=>yl,BookmarkList:()=>sl,Bookmarksets:()=>kl,Calendar:()=>Kl,CalendarEventRSVP:()=>ql,ChannelCreation:()=>$s,ChannelHideMessage:()=>zs,ChannelMessage:()=>Ws,ChannelMetadata:()=>Vs,ChannelMuteUser:()=>js,ChatMessage:()=>Tc,ClassifiedListing:()=>Nl,ClientAuth:()=>Fs,Comment:()=>Hc,CommunitiesList:()=>il,CommunityDefinition:()=>zl,CommunityPostApproval:()=>Zc,Contacts:()=>Sc,CreateOrUpdateProduct:()=>Ll,CreateOrUpdateStall:()=>Rl,Curationsets:()=>_l,Date:()=>Dl,DirectMessageRelaysList:()=>hl,DraftClassifiedListing:()=>Ml,DraftLong:()=>Il,Emojisets:()=>Ul,EncryptedDirectMessage:()=>Ac,EventDeletion:()=>Rc,FavoriteRelays:()=>ul,FileMessage:()=>Uc,FileMetadata:()=>Dc,FileServerPreference:()=>pl,Followsets:()=>xl,ForumThread:()=>Ic,GenericRepost:()=>Hr,Genericlists:()=>vl,GiftWrap:()=>Zs,GroupMetadata:()=>jl,HTTPAuth:()=>Kr,Handlerinformation:()=>Wl,Handlerrecommendation:()=>Vl,Highlights:()=>el,InterestsList:()=>fl,Interestsets:()=>Al,JobFeedback:()=>Jc,JobRequest:()=>Fc,JobResult:()=>Gc,Label:()=>jc,LightningPubRPC:()=>wl,LiveChatMessage:()=>Kc,LiveEvent:()=>Cl,LongFormArticle:()=>Tl,Metadata:()=>_c,Mutelist:()=>nl,NWCWalletInfo:()=>gl,NWCWalletRequest:()=>Gs,NWCWalletResponse:()=>bl,NormalVideo:()=>Cc,NostrConnect:()=>ml,OpenTimestamps:()=>Nc,Photo:()=>Pc,Pinlist:()=>rl,Poll:()=>Mc,PollResponse:()=>tl,PrivateDirectMessage:()=>qs,ProblemTracker:()=>Vc,ProfileBadges:()=>Bl,PublicChatsList:()=>al,Reaction:()=>Dr,RecommendRelay:()=>Bc,RelayList:()=>ol,RelayReview:()=>$l,Relaysets:()=>El,Report:()=>Wc,Reporting:()=>zc,Repost:()=>Mr,Seal:()=>Ks,SearchRelaysList:()=>ll,ShortTextNote:()=>Hs,ShortVideo:()=>Oc,Time:()=>Hl,UserEmojiList:()=>dl,UserStatuses:()=>Ol,Voice:()=>qc,VoiceComment:()=>$c,Zap:()=>Qc,ZapGoal:()=>Xc,ZapRequest:()=>Yc,classifyKind:()=>Ec,isAddressableKind:()=>Nr,isEphemeralKind:()=>Ds,isKind:()=>kc,isRegularKind:()=>Ms,isReplaceableKind:()=>Or});function Ms(e){return e<1e4&&e!==0&&e!==3}function Or(e){return e===0||e===3||1e4<=e&&e<2e4}function Ds(e){return 2e4<=e&&e<3e4}function Nr(e){return 3e4<=e&&e<4e4}function Ec(e){return Ms(e)?"regular":Or(e)?"replaceable":Ds(e)?"ephemeral":Nr(e)?"parameterized":"unknown"}function kc(e,t){let n=t instanceof Array?t:[t];return Ur(e)&&n.includes(e.kind)||!1}var _c=0,Hs=1,Bc=2,Sc=3,Ac=4,Rc=5,Mr=6,Dr=7,Lc=8,Tc=9,Ic=11,Ks=13,qs=14,Uc=15,Hr=16,Pc=20,Cc=21,Oc=22,$s=40,Vs=41,Ws=42,zs=43,js=44,Nc=1040,Zs=1059,Mc=1068,Dc=1063,Hc=1111,Kc=1311,qc=1222,$c=1244,Vc=1971,Wc=1984,zc=1984,jc=1985,Zc=4550,Fc=5999,Gc=6999,Jc=7e3,Xc=9041,Yc=9734,Qc=9735,el=9802,tl=1018,nl=1e4,rl=10001,ol=10002,sl=10003,il=10004,al=10005,cl=10006,ll=10007,ul=10012,fl=10015,dl=10030,hl=10050,pl=10096,yl=10063,gl=13194,wl=21e3,Fs=22242,Gs=23194,bl=23195,ml=24133,Kr=27235,xl=3e4,vl=30001,El=30002,kl=30003,_l=30004,Bl=30008,Sl=30009,Al=30015,Rl=30017,Ll=30018,Tl=30023,Il=30024,Ul=30030,Pl=30078,Cl=30311,Ol=30315,Nl=30402,Ml=30403,Dl=31922,Hl=31923,Kl=31924,ql=31925,$l=31987,Vl=31989,Wl=31990,zl=34550,jl=39e3;var Zl={};X(Zl,{getHex64:()=>qr,getInt:()=>Js,getSubscriptionId:()=>Fl,matchEventId:()=>Gl,matchEventKind:()=>Xl,matchEventPubkey:()=>Jl});function qr(e,t){let n=t.length+3,r=e.indexOf(`"${t}":`)+n,o=e.slice(r).indexOf('"')+r+1;return e.slice(o,o+64)}function Js(e,t){let n=t.length,r=e.indexOf(`"${t}":`)+n+3,o=e.slice(r),s=Math.min(o.indexOf(","),o.indexOf("}"));return parseInt(o.slice(0,s),10)}function Fl(e){let t=e.slice(0,22).indexOf('"EVENT"');if(t===-1)return null;let n=e.slice(t+7+1).indexOf('"');if(n===-1)return null;let r=t+7+1+n,o=e.slice(r+1,80).indexOf('"');if(o===-1)return null;let s=r+1+o;return e.slice(r+1,s)}function Gl(e,t){return t===qr(e,"id")}function Jl(e,t){return t===qr(e,"pubkey")}function Xl(e,t){return t===Js(e,"kind")}var Yl={};X(Yl,{makeAuthEvent:()=>Ql});function Ql(e,t){return{kind:Fs,created_at:Math.floor(Date.now()/1e3),tags:[["relay",e],["challenge",t]],content:""}}var eu;try{eu=WebSocket}catch{}var tu;try{tu=WebSocket}catch{}var je={};X(je,{BECH32_REGEX:()=>Xs,Bech32MaxSize:()=>$r,NostrTypeGuard:()=>nu,decode:()=>gn,decodeNostrURI:()=>ou,encodeBytes:()=>bn,naddrEncode:()=>uu,neventEncode:()=>lu,noteEncode:()=>au,nprofileEncode:()=>cu,npubEncode:()=>iu,nsecEncode:()=>su});var nu={isNProfile:e=>/^nprofile1[a-z\d]+$/.test(e||""),isNEvent:e=>/^nevent1[a-z\d]+$/.test(e||""),isNAddr:e=>/^naddr1[a-z\d]+$/.test(e||""),isNSec:e=>/^nsec1[a-z\d]{58}$/.test(e||""),isNPub:e=>/^npub1[a-z\d]{58}$/.test(e||""),isNote:e=>/^note1[a-z\d]+$/.test(e||""),isNcryptsec:e=>/^ncryptsec1[a-z\d]+$/.test(e||"")},$r=5e3,Xs=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function ru(e){let t=new Uint8Array(4);return t[0]=e>>24&255,t[1]=e>>16&255,t[2]=e>>8&255,t[3]=e&255,t}function ou(e){try{return e.startsWith("nostr:")&&(e=e.substring(6)),gn(e)}catch{return{type:"invalid",data:null}}}function gn(e){let{prefix:t,words:n}=ye.decode(e,$r),r=new Uint8Array(ye.fromWords(n));switch(t){case"nprofile":{let o=Rr(r);if(!o[0]?.[0])throw new Error("missing TLV 0 for nprofile");if(o[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:H(o[0][0]),relays:o[1]?o[1].map(s=>Ke.decode(s)):[]}}}case"nevent":{let o=Rr(r);if(!o[0]?.[0])throw new Error("missing TLV 0 for nevent");if(o[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(o[2]&&o[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(o[3]&&o[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:H(o[0][0]),relays:o[1]?o[1].map(s=>Ke.decode(s)):[],author:o[2]?.[0]?H(o[2][0]):void 0,kind:o[3]?.[0]?parseInt(H(o[3][0]),16):void 0}}}case"naddr":{let o=Rr(r);if(!o[0]?.[0])throw new Error("missing TLV 0 for naddr");if(!o[2]?.[0])throw new Error("missing TLV 2 for naddr");if(o[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!o[3]?.[0])throw new Error("missing TLV 3 for naddr");if(o[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:Ke.decode(o[0][0]),pubkey:H(o[2][0]),kind:parseInt(H(o[3][0]),16),relays:o[1]?o[1].map(s=>Ke.decode(s)):[]}}}case"nsec":return{type:t,data:r};case"npub":case"note":return{type:t,data:H(r)};default:throw new Error(`unknown prefix ${t}`)}}function Rr(e){let t={},n=e;for(;n.length>0;){let r=n[0],o=n[1],s=n.slice(2,2+o);if(n=n.slice(2+o),s.length<o)throw new Error(`not enough data to read on TLV ${r}`);t[r]=t[r]||[],t[r].push(s)}return t}function su(e){return bn("nsec",e)}function iu(e){return bn("npub",M(e))}function au(e){return bn("note",M(e))}function wn(e,t){let n=ye.toWords(t);return ye.encode(e,n,$r)}function bn(e,t){return wn(e,t)}function cu(e){let t=Vr({0:[M(e.pubkey)],1:(e.relays||[]).map(n=>ke.encode(n))});return wn("nprofile",t)}function lu(e){let t;e.kind!==void 0&&(t=ru(e.kind));let n=Vr({0:[M(e.id)],1:(e.relays||[]).map(r=>ke.encode(r)),2:e.author?[M(e.author)]:[],3:t?[new Uint8Array(t)]:[]});return wn("nevent",n)}function uu(e){let t=new ArrayBuffer(4);new DataView(t).setUint32(0,e.kind,!1);let n=Vr({0:[ke.encode(e.identifier)],1:(e.relays||[]).map(r=>ke.encode(r)),2:[M(e.pubkey)],3:[new Uint8Array(t)]});return wn("naddr",n)}function Vr(e){let t=[];return Object.entries(e).reverse().forEach(([n,r])=>{r.forEach(o=>{let s=new Uint8Array(o.length+2);s.set([parseInt(n)],0),s.set([o.length],1),s.set(o,2),t.push(s)})}),G(...t)}var mn={};X(mn,{decrypt:()=>fu,encrypt:()=>Ys});function Ys(e,t,n){let r=e instanceof Uint8Array?e:M(e),o=Qe.getSharedSecret(r,M("02"+t)),s=Qs(o),i=Uint8Array.from(fe(16)),a=ke.encode(n),c=Er(s,i).encrypt(a),l=pe.encode(new Uint8Array(c)),u=pe.encode(new Uint8Array(i.buffer));return`${l}?iv=${u}`}function fu(e,t,n){let r=e instanceof Uint8Array?e:M(e),[o,s]=n.split("?iv="),i=Qe.getSharedSecret(r,M("02"+t)),a=Qs(i),c=pe.decode(s),l=pe.decode(o),u=Er(a,c).decrypt(l);return Ke.decode(u)}function Qs(e){return e.slice(1,33)}var du={};X(du,{NIP05_REGEX:()=>Wr,isNip05:()=>hu,isValid:()=>gu,queryProfile:()=>ei,searchDomain:()=>yu,useFetchImplementation:()=>pu});var Wr=/^(?:([\w.+-]+)@)?([\w_-]+(\.[\w_-]+)+)$/,hu=e=>Wr.test(e||""),xn;try{xn=fetch}catch{}function pu(e){xn=e}async function yu(e,t=""){try{let n=`https://${e}/.well-known/nostr.json?name=${t}`,r=await xn(n,{redirect:"manual"});if(r.status!==200)throw Error("Wrong response code");return(await r.json()).names}catch{return{}}}async function ei(e){let t=e.match(Wr);if(!t)return null;let[,n="_",r]=t;try{let o=`https://${r}/.well-known/nostr.json?name=${n}`,s=await xn(o,{redirect:"manual"});if(s.status!==200)throw Error("Wrong response code");let i=await s.json(),a=i.names[n];return a?{pubkey:a,relays:i.relays?.[a]}:null}catch{return null}}async function gu(e,t){let n=await ei(t);return n?n.pubkey===e:!1}var wu={};X(wu,{parse:()=>bu});function bu(e){let t={reply:void 0,root:void 0,mentions:[],profiles:[],quotes:[]},n,r;for(let o=e.tags.length-1;o>=0;o--){let s=e.tags[o];if(s[0]==="e"&&s[1]){let[i,a,c,l,u]=s,f={id:a,relays:c?[c]:[],author:u};if(l==="root"){t.root=f;continue}if(l==="reply"){t.reply=f;continue}if(l==="mention"){t.mentions.push(f);continue}n?r=f:n=f,t.mentions.push(f);continue}if(s[0]==="q"&&s[1]){let[i,a,c]=s;t.quotes.push({id:a,relays:c?[c]:[]})}if(s[0]==="p"&&s[1]){t.profiles.push({pubkey:s[1],relays:s[2]?[s[2]]:[]});continue}}return t.root||(t.root=r||n||t.reply),t.reply||(t.reply=n||t.root),[t.reply,t.root].forEach(o=>{if(!o)return;let s=t.mentions.indexOf(o);if(s!==-1&&t.mentions.splice(s,1),o.author){let i=t.profiles.find(a=>a.pubkey===o.author);i&&i.relays&&(o.relays||(o.relays=[]),i.relays.forEach(a=>{o.relays?.indexOf(a)===-1&&o.relays.push(a)}),i.relays=o.relays)}}),t.mentions.forEach(o=>{if(o.author){let s=t.profiles.find(i=>i.pubkey===o.author);s&&s.relays&&(o.relays||(o.relays=[]),s.relays.forEach(i=>{o.relays.indexOf(i)===-1&&o.relays.push(i)}),s.relays=o.relays)}}),t}var mu={};X(mu,{fetchRelayInformation:()=>vu,useFetchImplementation:()=>xu});var ti;try{ti=fetch}catch{}function xu(e){ti=e}async function vu(e){return await(await fetch(e.replace("ws://","http://").replace("wss://","https://"),{headers:{Accept:"application/nostr+json"}})).json()}var Eu={};X(Eu,{getPow:()=>ku,minePow:()=>Bu});function ku(e){let t=0;for(let n=0;n<64;n+=8){let r=parseInt(e.substring(n,n+8),16);if(r===0)t+=32;else{t+=Math.clz32(r);break}}return t}function _u(e){let t=0;for(let n=0;n<e.length;n++){let r=e[n];if(r===0)t+=8;else{t+=Math.clz32(r)-24;break}}return t}function Bu(e,t){let n=0,r=e,o=["nonce",n.toString(),t.toString()];for(r.tags.push(o);;){let s=Math.floor(new Date().getTime()/1e3);s!==r.created_at&&(n=0,r.created_at=s),o[1]=(++n).toString();let i=te(ke.encode(JSON.stringify([0,r.pubkey,r.created_at,r.kind,r.tags,r.content])));if(_u(i)>=t){r.id=H(i);break}}return r}var Su={};X(Su,{unwrapEvent:()=>Mu,unwrapManyEvents:()=>Du,wrapEvent:()=>pi,wrapManyEvents:()=>Nu});var Au={};X(Au,{createRumor:()=>ui,createSeal:()=>fi,createWrap:()=>di,unwrapEvent:()=>Gr,unwrapManyEvents:()=>hi,wrapEvent:()=>pn,wrapManyEvents:()=>Cu});var gt={};X(gt,{decrypt:()=>Fr,encrypt:()=>Zr,getConversationKey:()=>zr,v2:()=>Uu});var ni=1,ri=65535;function zr(e,t){let n=Qe.getSharedSecret(e,M("02"+t)).subarray(1,33);return ln(te,n,ke.encode("nip44-v2"))}function oi(e,t){let n=un(te,e,t,76);return{chacha_key:n.subarray(0,32),chacha_nonce:n.subarray(32,44),hmac_key:n.subarray(44,76)}}function jr(e){if(!Number.isSafeInteger(e)||e<1)throw new Error("expected positive integer");if(e<=32)return 32;let t=1<<Math.floor(Math.log2(e-1))+1,n=t<=256?32:t/8;return n*(Math.floor((e-1)/n)+1)}function Ru(e){if(!Number.isSafeInteger(e)||e<ni||e>ri)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");let t=new Uint8Array(2);return new DataView(t.buffer).setUint16(0,e,!1),t}function Lu(e){let t=ke.encode(e),n=t.length,r=Ru(n),o=new Uint8Array(jr(n)-n);return G(r,t,o)}function Tu(e){let t=new DataView(e.buffer).getUint16(0),n=e.subarray(2,2+t);if(t<ni||t>ri||n.length!==t||e.length!==2+jr(t))throw new Error("invalid padding");return Ke.decode(n)}function si(e,t,n){if(n.length!==32)throw new Error("AAD associated data must be 32 bytes");let r=G(n,t);return ve(te,e,r)}function Iu(e){if(typeof e!="string")throw new Error("payload must be a valid string");let t=e.length;if(t<132||t>87472)throw new Error("invalid payload length: "+t);if(e[0]==="#")throw new Error("unknown encryption version");let n;try{n=pe.decode(e)}catch(s){throw new Error("invalid base64: "+s.message)}let r=n.length;if(r<99||r>65603)throw new Error("invalid data length: "+r);let o=n[0];if(o!==2)throw new Error("unknown encryption version "+o);return{nonce:n.subarray(1,33),ciphertext:n.subarray(33,-32),mac:n.subarray(-32)}}function Zr(e,t,n=fe(32)){let{chacha_key:r,chacha_nonce:o,hmac_key:s}=oi(t,n),i=Lu(e),a=rt(r,o,i),c=si(s,a,n);return pe.encode(G(new Uint8Array([2]),n,a,c))}function Fr(e,t){let{nonce:n,ciphertext:r,mac:o}=Iu(e),{chacha_key:s,chacha_nonce:i,hmac_key:a}=oi(t,n),c=si(a,r,n);if(!tt(c,o))throw new Error("invalid MAC");let l=rt(s,i,r);return Tu(l)}var Uu={utils:{getConversationKey:zr,calcPaddedLen:jr},encrypt:Zr,decrypt:Fr},Pu=2*24*60*60,ii=()=>Math.round(Date.now()/1e3),ai=()=>Math.round(ii()-Math.random()*Pu),ci=(e,t)=>zr(e,t),li=(e,t,n)=>Zr(JSON.stringify(e),ci(t,n)),Os=(e,t)=>JSON.parse(Fr(e.content,ci(t,e.pubkey)));function ui(e,t){let n={created_at:ii(),content:"",tags:[],...e,pubkey:qe(t)};return n.id=dn(n),n}function fi(e,t,n){return se({kind:Ks,content:li(e,t,n),created_at:ai(),tags:[]},t)}function di(e,t){let n=Ut();return se({kind:Zs,content:li(e,n,t),created_at:ai(),tags:[["p",t]]},n)}function pn(e,t,n){let r=ui(e,t),o=fi(r,t,n);return di(o,n)}function Cu(e,t,n){if(!n||n.length===0)throw new Error("At least one recipient is required.");let r=qe(t),o=[pn(e,t,r)];return n.forEach(s=>{o.push(pn(e,t,s))}),o}function Gr(e,t){let n=Os(e,t);return Os(n,t)}function hi(e,t){let n=[];return e.forEach(r=>{n.push(Gr(r,t))}),n.sort((r,o)=>r.created_at-o.created_at),n}function Ou(e,t,n,r){let o={created_at:Math.ceil(Date.now()/1e3),kind:qs,tags:[],content:t};return(Array.isArray(e)?e:[e]).forEach(({publicKey:i,relayUrl:a})=>{o.tags.push(a?["p",i,a]:["p",i])}),r&&o.tags.push(["e",r.eventId,r.relayUrl||"","reply"]),n&&o.tags.push(["subject",n]),o}function pi(e,t,n,r,o){let s=Ou(t,n,r,o);return pn(s,e,t.publicKey)}function Nu(e,t,n,r,o){if(!t||t.length===0)throw new Error("At least one recipient is required.");return[{publicKey:qe(e)},...t].map(i=>pi(e,i,n,r,o))}var Mu=Gr,Du=hi,Hu={};X(Hu,{finishRepostEvent:()=>Ku,getRepostedEvent:()=>qu,getRepostedEventPointer:()=>yi});function Ku(e,t,n,r){let o,s=[...e.tags??[],["e",t.id,n],["p",t.pubkey]];return t.kind===Hs?o=Mr:(o=Hr,s.push(["k",String(t.kind)])),se({kind:o,tags:s,content:e.content===""||t.tags?.find(i=>i[0]==="-")?"":JSON.stringify(t),created_at:e.created_at},r)}function yi(e){if(![Mr,Hr].includes(e.kind))return;let t,n;for(let r=e.tags.length-1;r>=0&&(t===void 0||n===void 0);r--){let o=e.tags[r];o.length>=2&&(o[0]==="e"&&t===void 0?t=o:o[0]==="p"&&n===void 0&&(n=o))}if(t!==void 0)return{id:t[1],relays:[t[2],n?.[2]].filter(r=>typeof r=="string"),author:n?.[1]}}function qu(e,{skipVerification:t}={}){let n=yi(e);if(n===void 0||e.content==="")return;let r;try{r=JSON.parse(e.content)}catch{return}if(r.id===n.id&&!(!t&&!Cr(r)))return r}var $u={};X($u,{NOSTR_URI_REGEX:()=>Jr,parse:()=>Wu,test:()=>Vu});var Jr=new RegExp(`nostr:(${Xs.source})`);function Vu(e){return typeof e=="string"&&new RegExp(`^${Jr.source}$`).test(e)}function Wu(e){let t=e.match(new RegExp(`^${Jr.source}$`));if(!t)throw new Error(`Invalid Nostr URI: ${e}`);return{uri:t[0],value:t[1],decoded:gn(t[1])}}var zu={};X(zu,{finishReactionEvent:()=>ju,getReactedEventPointer:()=>Zu});function ju(e,t,n){let r=t.tags.filter(o=>o.length>=2&&(o[0]==="e"||o[0]==="p"));return se({...e,kind:Dr,tags:[...e.tags??[],...r,["e",t.id],["p",t.pubkey]],content:e.content??"+"},n)}function Zu(e){if(e.kind!==Dr)return;let t,n;for(let r=e.tags.length-1;r>=0&&(t===void 0||n===void 0);r--){let o=e.tags[r];o.length>=2&&(o[0]==="e"&&t===void 0?t=o:o[0]==="p"&&n===void 0&&(n=o))}if(!(t===void 0||n===void 0))return{id:t[1],relays:[t[2],n[2]].filter(r=>r!==void 0),author:n[1]}}var Fu={};X(Fu,{parse:()=>Ju});var Lr=/\W/m,Ns=/[^\w\/] |[^\w\/]$|$|,| /m,Gu=42;function*Ju(e){let t=[];if(typeof e!="string"){for(let s=0;s<e.tags.length;s++){let i=e.tags[s];i[0]==="emoji"&&i.length>=3&&t.push({type:"emoji",shortcode:i[1],url:i[2]})}e=e.content}let n=e.length,r=0,o=0;e:for(;o<n;){let s=e.indexOf(":",o),i=e.indexOf("#",o);if(s===-1&&i===-1)break e;if(s===-1||i>=0&&i<s){if(i===0||e[i-1].match(Lr)){let a=e.slice(i+1,i+Gu).match(Lr),c=a?i+1+a.index:n;yield{type:"text",text:e.slice(r,i)},yield{type:"hashtag",value:e.slice(i+1,c)},o=c,r=o;continue e}o=i+1;continue e}if(e.slice(s-5,s)==="nostr"){let a=e.slice(s+60).match(Lr),c=a?s+60+a.index:n;try{let l,{data:u,type:f}=gn(e.slice(s+1,c));switch(f){case"npub":l={pubkey:u};break;case"note":l={id:u};break;case"nsec":o=c+1;continue;default:l=u}r!==s-5&&(yield{type:"text",text:e.slice(r,s-5)}),yield{type:"reference",pointer:l},o=c,r=o;continue e}catch{o=s+1;continue e}}else if(e.slice(s-5,s)==="https"||e.slice(s-4,s)==="http"){let a=e.slice(s+4).match(Ns),c=a?s+4+a.index:n,l=e[s-1]==="s"?5:4;try{let u=new URL(e.slice(s-l,c));if(u.hostname.indexOf(".")===-1)throw new Error("invalid url");if(r!==s-l&&(yield{type:"text",text:e.slice(r,s-l)}),/\.(png|jpe?g|gif|webp|heic|svg)$/i.test(u.pathname)){yield{type:"image",url:u.toString()},o=c,r=o;continue e}if(/\.(mp4|avi|webm|mkv|mov)$/i.test(u.pathname)){yield{type:"video",url:u.toString()},o=c,r=o;continue e}if(/\.(mp3|aac|ogg|opus|wav|flac)$/i.test(u.pathname)){yield{type:"audio",url:u.toString()},o=c,r=o;continue e}yield{type:"url",url:u.toString()},o=c,r=o;continue e}catch{o=c+1;continue e}}else if(e.slice(s-3,s)==="wss"||e.slice(s-2,s)==="ws"){let a=e.slice(s+4).match(Ns),c=a?s+4+a.index:n,l=e[s-1]==="s"?3:2;try{let u=new URL(e.slice(s-l,c));if(u.hostname.indexOf(".")===-1)throw new Error("invalid ws url");r!==s-l&&(yield{type:"text",text:e.slice(r,s-l)}),yield{type:"relay",url:u.toString()},o=c,r=o;continue e}catch{o=c+1;continue e}}else{for(let a=0;a<t.length;a++){let c=t[a];if(e[s+c.shortcode.length+1]===":"&&e.slice(s+1,s+c.shortcode.length+1)===c.shortcode){r!==s&&(yield{type:"text",text:e.slice(r,s)}),yield c,o=s+c.shortcode.length+2,r=o;continue e}}o=s+1;continue e}}r!==n&&(yield{type:"text",text:e.slice(r)})}var Xu={};X(Xu,{channelCreateEvent:()=>Yu,channelHideMessageEvent:()=>tf,channelMessageEvent:()=>ef,channelMetadataEvent:()=>Qu,channelMuteUserEvent:()=>nf});var Yu=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return se({kind:$s,tags:[...e.tags??[]],content:n,created_at:e.created_at},t)},Qu=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return se({kind:Vs,tags:[["e",e.channel_create_event_id],...e.tags??[]],content:n,created_at:e.created_at},t)},ef=(e,t)=>{let n=[["e",e.channel_create_event_id,e.relay_url,"root"]];return e.reply_to_channel_message_event_id&&n.push(["e",e.reply_to_channel_message_event_id,e.relay_url,"reply"]),se({kind:Ws,tags:[...n,...e.tags??[]],content:e.content,created_at:e.created_at},t)},tf=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return se({kind:zs,tags:[["e",e.channel_message_event_id],...e.tags??[]],content:n,created_at:e.created_at},t)},nf=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return se({kind:js,tags:[["p",e.pubkey_to_mute],...e.tags??[]],content:n,created_at:e.created_at},t)},rf={};X(rf,{EMOJI_SHORTCODE_REGEX:()=>gi,matchAll:()=>of,regex:()=>Xr,replaceAll:()=>sf});var gi=/:(\w+):/,Xr=()=>new RegExp(`\\B${gi.source}\\B`,"g");function*of(e){let t=e.matchAll(Xr());for(let n of t)try{let[r,o]=n;yield{shortcode:r,name:o,start:n.index,end:n.index+r.length}}catch{}}function sf(e,t){return e.replaceAll(Xr(),(n,r)=>t({shortcode:n,name:r}))}var af={};X(af,{useFetchImplementation:()=>cf,validateGithub:()=>lf});var Yr;try{Yr=fetch}catch{}function cf(e){Yr=e}async function lf(e,t,n){try{return await(await Yr(`https://gist.github.com/${t}/${n}/raw`)).text()===`Verifying that I control the following Nostr public key: ${e}`}catch{return!1}}var uf={};X(uf,{makeNwcRequestEvent:()=>df,parseConnectionString:()=>ff});function ff(e){let{host:t,pathname:n,searchParams:r}=new URL(e),o=n||t,s=r.get("relay"),i=r.get("secret");if(!o||!s||!i)throw new Error("invalid connection string");return{pubkey:o,relay:s,secret:i}}async function df(e,t,n){let o=Ys(t,e,JSON.stringify({method:"pay_invoice",params:{invoice:n}})),s={kind:Gs,created_at:Math.round(Date.now()/1e3),content:o,tags:[["p",e]]};return se(s,t)}var hf={};X(hf,{normalizeIdentifier:()=>pf});function pf(e){return e=e.trim().toLowerCase(),e=e.normalize("NFKC"),Array.from(e).map(t=>/\p{Letter}/u.test(t)||/\p{Number}/u.test(t)?t:"-").join("")}var yf={};X(yf,{getSatoshisAmountFromBolt11:()=>vf,getZapEndpoint:()=>wf,makeZapReceipt:()=>xf,makeZapRequest:()=>bf,useFetchImplementation:()=>gf,validateZapRequest:()=>mf});var Qr;try{Qr=fetch}catch{}function gf(e){Qr=e}async function wf(e){try{let t="",{lud06:n,lud16:r}=JSON.parse(e.content);if(r){let[i,a]=r.split("@");t=new URL(`/.well-known/lnurlp/${i}`,`https://${a}`).toString()}else if(n){let{words:i}=ye.decode(n,1e3),a=ye.fromWords(i);t=Ke.decode(a)}else return null;let s=await(await Qr(t)).json();if(s.allowsNostr&&s.nostrPubkey)return s.callback}catch{}return null}function bf(e){let t={kind:9734,created_at:Math.round(Date.now()/1e3),content:e.comment||"",tags:[["p","pubkey"in e?e.pubkey:e.event.pubkey],["amount",e.amount.toString()],["relays",...e.relays]]};if("event"in e){if(t.tags.push(["e",e.event.id]),Or(e.event.kind)){let n=["a",`${e.event.kind}:${e.event.pubkey}:`];t.tags.push(n)}else if(Nr(e.event.kind)){let n=e.event.tags.find(([o,s])=>o==="d"&&s);if(!n)throw new Error("d tag not found or is empty");let r=["a",`${e.event.kind}:${e.event.pubkey}:${n[1]}`];t.tags.push(r)}t.tags.push(["k",e.event.kind.toString()])}return t}function mf(e){let t;try{t=JSON.parse(e)}catch{return"Invalid zap request JSON."}if(!Ur(t))return"Zap request is not a valid Nostr event.";if(!Cr(t))return"Invalid signature on zap request.";let n=t.tags.find(([s,i])=>s==="p"&&i);if(!n)return"Zap request doesn't have a 'p' tag.";if(!n[1].match(/^[a-f0-9]{64}$/))return"Zap request 'p' tag is not valid hex.";let r=t.tags.find(([s,i])=>s==="e"&&i);return r&&!r[1].match(/^[a-f0-9]{64}$/)?"Zap request 'e' tag is not valid hex.":t.tags.find(([s,i])=>s==="relays"&&i)?null:"Zap request doesn't have a 'relays' tag."}function xf({zapRequest:e,preimage:t,bolt11:n,paidAt:r}){let o=JSON.parse(e),s=o.tags.filter(([a])=>a==="e"||a==="p"||a==="a"),i={kind:9735,created_at:Math.round(r.getTime()/1e3),content:"",tags:[...s,["P",o.pubkey],["bolt11",n],["description",e]]};return t&&i.tags.push(["preimage",t]),i}function vf(e){if(e.length<50)return 0;e=e.substring(0,50);let t=e.lastIndexOf("1");if(t===-1)return 0;let n=e.substring(0,t);if(!n.startsWith("lnbc"))return 0;let r=n.substring(4);if(r.length<1)return 0;let o=r[r.length-1],s=o.charCodeAt(0)-48,i=s>=0&&s<=9,a=r.length-1;if(i&&a++,a<1)return 0;let c=parseInt(r.substring(0,a));switch(o){case"m":return c*1e5;case"u":return c*100;case"n":return c/10;case"p":return c/1e4;default:return c*1e8}}var Ef={};X(Ef,{Negentropy:()=>bi,NegentropyStorageVector:()=>Bf,NegentropySync:()=>Sf});var Tr=97,yt=32,wi=16,ot={Skip:0,Fingerprint:1,IdList:2},He=class{_raw;length;constructor(e){typeof e=="number"?(this._raw=new Uint8Array(e),this.length=0):e instanceof Uint8Array?(this._raw=new Uint8Array(e),this.length=e.length):(this._raw=new Uint8Array(512),this.length=0)}unwrap(){return this._raw.subarray(0,this.length)}get capacity(){return this._raw.byteLength}extend(e){if(e instanceof He&&(e=e.unwrap()),typeof e.length!="number")throw Error("bad length");let t=e.length+this.length;if(this.capacity<t){let n=this._raw,r=Math.max(this.capacity*2,t);this._raw=new Uint8Array(r),this._raw.set(n)}this._raw.set(e,this.length),this.length+=e.length}shift(){let e=this._raw[0];return this._raw=this._raw.subarray(1),this.length--,e}shiftN(e=1){let t=this._raw.subarray(0,e);return this._raw=this._raw.subarray(e),this.length-=e,t}};function fn(e){let t=0;for(;;){if(e.length===0)throw Error("parse ends prematurely");let n=e.shift();if(t=t<<7|n&127,!(n&128))break}return t}function De(e){if(e===0)return new He(new Uint8Array([0]));let t=[];for(;e!==0;)t.push(e&127),e>>>=7;t.reverse();for(let n=0;n<t.length-1;n++)t[n]|=128;return new He(new Uint8Array(t))}function kf(e){return hn(e,1)[0]}function hn(e,t){if(e.length<t)throw Error("parse ends prematurely");return e.shiftN(t)}var _f=class{buf;constructor(){this.setToZero()}setToZero(){this.buf=new Uint8Array(yt)}add(e){let t=0,n=0,r=new DataView(this.buf.buffer),o=new DataView(e.buffer);for(let s=0;s<8;s++){let i=s*4,a=r.getUint32(i,!0),c=o.getUint32(i,!0),l=a;l+=t,l+=c,l>4294967295&&(n=1),r.setUint32(i,l&4294967295,!0),t=n,n=0}}negate(){let e=new DataView(this.buf.buffer);for(let n=0;n<8;n++){let r=n*4;e.setUint32(r,~e.getUint32(r,!0))}let t=new Uint8Array(yt);t[0]=1,this.add(t)}getFingerprint(e){let t=new He;return t.extend(this.buf),t.extend(De(e)),te(t.unwrap()).subarray(0,wi)}},Bf=class{items;sealed;constructor(){this.items=[],this.sealed=!1}insert(e,t){if(this.sealed)throw Error("already sealed");let n=M(t);if(n.byteLength!==yt)throw Error("bad id size for added item");this.items.push({timestamp:e,id:n})}seal(){if(this.sealed)throw Error("already sealed");this.sealed=!0,this.items.sort(Ir);for(let e=1;e<this.items.length;e++)if(Ir(this.items[e-1],this.items[e])===0)throw Error("duplicate item inserted")}unseal(){this.sealed=!1}size(){return this._checkSealed(),this.items.length}getItem(e){if(this._checkSealed(),e>=this.items.length)throw Error("out of range");return this.items[e]}iterate(e,t,n){this._checkSealed(),this._checkBounds(e,t);for(let r=e;r<t&&n(this.items[r],r);++r);}findLowerBound(e,t,n){return this._checkSealed(),this._checkBounds(e,t),this._binarySearch(this.items,e,t,r=>Ir(r,n)<0)}fingerprint(e,t){let n=new _f;return n.setToZero(),this.iterate(e,t,r=>(n.add(r.id),!0)),n.getFingerprint(t-e)}_checkSealed(){if(!this.sealed)throw Error("not sealed")}_checkBounds(e,t){if(e>t||t>this.items.length)throw Error("bad range")}_binarySearch(e,t,n,r){let o=n-t;for(;o>0;){let s=t,i=Math.floor(o/2);s+=i,r(e[s])?(t=++s,o-=i+1):o=i}return t}},bi=class{storage;frameSizeLimit;lastTimestampIn;lastTimestampOut;constructor(e,t=6e4){if(t<4096)throw Error("frameSizeLimit too small");this.storage=e,this.frameSizeLimit=t,this.lastTimestampIn=0,this.lastTimestampOut=0}_bound(e,t){return{timestamp:e,id:t||new Uint8Array(0)}}initiate(){let e=new He;return e.extend(new Uint8Array([Tr])),this.splitRange(0,this.storage.size(),this._bound(Number.MAX_VALUE),e),H(e.unwrap())}reconcile(e,t,n){let r=new He(M(e));this.lastTimestampIn=this.lastTimestampOut=0;let o=new He;o.extend(new Uint8Array([Tr]));let s=kf(r);if(s<96||s>111)throw Error("invalid negentropy protocol version byte");if(s!==Tr)throw Error("unsupported negentropy protocol version requested: "+(s-96));let i=this.storage.size(),a=this._bound(0),c=0,l=!1;for(;r.length!==0;){let u=new He,f=()=>{l&&(l=!1,u.extend(this.encodeBound(a)),u.extend(De(ot.Skip)))},h=this.decodeBound(r),d=fn(r),p=c,y=this.storage.findLowerBound(c,i,h);if(d===ot.Skip)l=!0;else if(d===ot.Fingerprint){let w=hn(r,wi),b=this.storage.fingerprint(p,y);mi(w,b)!==0?(f(),this.splitRange(p,y,h,u)):l=!0}else if(d===ot.IdList){let w=fn(r),b={};for(let S=0;S<w;S++){let U=hn(r,yt);b[H(U)]=U}if(l=!0,this.storage.iterate(p,y,S=>{let U=S.id,P=H(U);return b[P]?delete b[H(U)]:t?.(P),!0}),n)for(let S of Object.values(b))n(H(S))}else throw Error("unexpected mode");if(this.exceededFrameSizeLimit(o.length+u.length)){let w=this.storage.fingerprint(y,i);o.extend(this.encodeBound(this._bound(Number.MAX_VALUE))),o.extend(De(ot.Fingerprint)),o.extend(w);break}else o.extend(u);c=y,a=h}return o.length===1?null:H(o.unwrap())}splitRange(e,t,n,r){let o=t-e,s=16;if(o<s*2)r.extend(this.encodeBound(n)),r.extend(De(ot.IdList)),r.extend(De(o)),this.storage.iterate(e,t,i=>(r.extend(i.id),!0));else{let i=Math.floor(o/s),a=o%s,c=e;for(let l=0;l<s;l++){let u=i+(l<a?1:0),f=this.storage.fingerprint(c,c+u);c+=u;let h;if(c===t)h=n;else{let d,p;this.storage.iterate(c-1,c+1,(y,w)=>(w===c-1?d=y:p=y,!0)),h=this.getMinimalBound(d,p)}r.extend(this.encodeBound(h)),r.extend(De(ot.Fingerprint)),r.extend(f)}}}exceededFrameSizeLimit(e){return e>this.frameSizeLimit-200}decodeTimestampIn(e){let t=fn(e);return t=t===0?Number.MAX_VALUE:t-1,this.lastTimestampIn===Number.MAX_VALUE||t===Number.MAX_VALUE?(this.lastTimestampIn=Number.MAX_VALUE,Number.MAX_VALUE):(t+=this.lastTimestampIn,this.lastTimestampIn=t,t)}decodeBound(e){let t=this.decodeTimestampIn(e),n=fn(e);if(n>yt)throw Error("bound key too long");let r=hn(e,n);return{timestamp:t,id:r}}encodeTimestampOut(e){if(e===Number.MAX_VALUE)return this.lastTimestampOut=Number.MAX_VALUE,De(0);let t=e;return e-=this.lastTimestampOut,this.lastTimestampOut=t,De(e+1)}encodeBound(e){let t=new He;return t.extend(this.encodeTimestampOut(e.timestamp)),t.extend(De(e.id.length)),t.extend(e.id),t}getMinimalBound(e,t){if(t.timestamp!==e.timestamp)return this._bound(t.timestamp);{let n=0,r=t.id,o=e.id;for(let s=0;s<yt&&r[s]===o[s];s++)n++;return this._bound(t.timestamp,t.id.subarray(0,n+1))}}};function mi(e,t){for(let n=0;n<e.byteLength;n++){if(e[n]<t[n])return-1;if(e[n]>t[n])return 1}return e.byteLength>t.byteLength?1:e.byteLength<t.byteLength?-1:0}function Ir(e,t){return e.timestamp===t.timestamp?mi(e.id,t.id):e.timestamp-t.timestamp}var Sf=class{relay;storage;neg;filter;subscription;onhave;onneed;constructor(e,t,n,r={}){this.relay=e,this.storage=t,this.neg=new bi(t),this.onhave=r.onhave,this.onneed=r.onneed,this.filter=n,this.subscription=this.relay.prepareSubscription([{}],{label:r.label||"negentropy"}),this.subscription.oncustom=o=>{switch(o[0]){case"NEG-MSG":{o.length<3;try{let s=this.neg.reconcile(o[2],this.onhave,this.onneed);s?this.relay.send(`["NEG-MSG", "${this.subscription.id}", "${s}"]`):(this.close(),r.onclose?.())}catch(s){r?.onclose?.(`reconcile error: ${s}`)}break}case"NEG-CLOSE":{let s=o[2];r.onclose?.(s);break}case"NEG-ERR":r.onclose?.()}}}async start(){let e=this.neg.initiate();this.relay.send(`["NEG-OPEN","${this.subscription.id}",${JSON.stringify(this.filter)},"${e}"]`)}close(){this.relay.send(`["NEG-CLOSE","${this.subscription.id}"]`),this.subscription.close()}},Af={};X(Af,{getToken:()=>Rf,hashPayload:()=>eo,unpackEventFromToken:()=>vi,validateEvent:()=>Ai,validateEventKind:()=>ki,validateEventMethodTag:()=>Bi,validateEventPayloadTag:()=>Si,validateEventTimestamp:()=>Ei,validateEventUrlTag:()=>_i,validateToken:()=>Lf});var xi="Nostr ";async function Rf(e,t,n,r=!1,o){let s={kind:Kr,tags:[["u",e],["method",t]],created_at:Math.round(new Date().getTime()/1e3),content:""};o&&s.tags.push(["payload",eo(o)]);let i=await n(s);return(r?xi:"")+pe.encode(ke.encode(JSON.stringify(i)))}async function Lf(e,t,n){let r=await vi(e).catch(s=>{throw s});return await Ai(r,t,n).catch(s=>{throw s})}async function vi(e){if(!e)throw new Error("Missing token");e=e.replace(xi,"");let t=Ke.decode(pe.decode(e));if(!t||t.length===0||!t.startsWith("{"))throw new Error("Invalid token");return JSON.parse(t)}function Ei(e){return e.created_at?Math.round(new Date().getTime()/1e3)-e.created_at<60:!1}function ki(e){return e.kind===Kr}function _i(e,t){let n=e.tags.find(r=>r[0]==="u");return n?n.length>0&&n[1]===t:!1}function Bi(e,t){let n=e.tags.find(r=>r[0]==="method");return n?n.length>0&&n[1].toLowerCase()===t.toLowerCase():!1}function eo(e){let t=te(ke.encode(JSON.stringify(e)));return H(t)}function Si(e,t){let n=e.tags.find(o=>o[0]==="payload");if(!n)return!1;let r=eo(t);return n.length>0&&n[1]===r}async function Ai(e,t,n,r){if(!Cr(e))throw new Error("Invalid nostr event, signature invalid");if(!ki(e))throw new Error("Invalid nostr event, kind invalid");if(!Ei(e))throw new Error("Invalid nostr event, created_at timestamp invalid");if(!_i(e,t))throw new Error("Invalid nostr event, url tag invalid");if(!Bi(e,n))throw new Error("Invalid nostr event, method tag invalid");if(r&&typeof r=="object"&&Object.keys(r).length>0&&!Si(e,r))throw new Error("Invalid nostr event, payload tag does not match request body hash");return!0}function If(e,t,n,r){Oe(e);let o=$t({dkLen:32,asyncTick:10},r),{c:s,dkLen:i,asyncTick:a}=o;if(ee(s,"c"),ee(i,"dkLen"),ee(a,"asyncTick"),s<1)throw new Error("iterations (c) must be >= 1");let c=Mn(t,"password"),l=Mn(n,"salt"),u=new Uint8Array(i),f=ve.create(e,c),h=f._cloneInto().update(l);return{c:s,dkLen:i,asyncTick:a,DK:u,PRF:f,PRFSalt:h}}function Uf(e,t,n,r,o){return e.destroy(),t.destroy(),r&&r.destroy(),we(o),n}function to(e,t,n,r){let{c:o,dkLen:s,DK:i,PRF:a,PRFSalt:c}=If(e,t,n,r),l,u=new Uint8Array(4),f=at(u),h=new Uint8Array(a.outputLen);for(let d=1,p=0;p<s;d++,p+=a.outputLen){let y=i.subarray(p,p+a.outputLen);f.setInt32(0,d,!1),(l=c._cloneInto(l)).update(u).digestInto(h),y.set(h.subarray(0,y.length));for(let w=1;w<o;w++){a._cloneInto(l).update(h).digestInto(h);for(let b=0;b<y.length;b++)y[b]^=h[b]}}return Uf(a,c,i,l,h)}function Ri(e,t,n,r,o,s){let i=e[t++]^n[r++],a=e[t++]^n[r++],c=e[t++]^n[r++],l=e[t++]^n[r++],u=e[t++]^n[r++],f=e[t++]^n[r++],h=e[t++]^n[r++],d=e[t++]^n[r++],p=e[t++]^n[r++],y=e[t++]^n[r++],w=e[t++]^n[r++],b=e[t++]^n[r++],S=e[t++]^n[r++],U=e[t++]^n[r++],P=e[t++]^n[r++],Y=e[t++]^n[r++],O=i,z=a,V=c,T=l,K=u,N=f,I=h,x=d,m=p,g=y,E=w,_=b,B=S,v=U,k=P,A=Y;for(let R=0;R<8;R+=2)K^=$(O+B|0,7),m^=$(K+O|0,9),B^=$(m+K|0,13),O^=$(B+m|0,18),g^=$(N+z|0,7),v^=$(g+N|0,9),z^=$(v+g|0,13),N^=$(z+v|0,18),k^=$(E+I|0,7),V^=$(k+E|0,9),I^=$(V+k|0,13),E^=$(I+V|0,18),T^=$(A+_|0,7),x^=$(T+A|0,9),_^=$(x+T|0,13),A^=$(_+x|0,18),z^=$(O+T|0,7),V^=$(z+O|0,9),T^=$(V+z|0,13),O^=$(T+V|0,18),I^=$(N+K|0,7),x^=$(I+N|0,9),K^=$(x+I|0,13),N^=$(K+x|0,18),_^=$(E+g|0,7),m^=$(_+E|0,9),g^=$(m+_|0,13),E^=$(g+m|0,18),B^=$(A+k|0,7),v^=$(B+A|0,9),k^=$(v+B|0,13),A^=$(k+v|0,18);o[s++]=i+O|0,o[s++]=a+z|0,o[s++]=c+V|0,o[s++]=l+T|0,o[s++]=u+K|0,o[s++]=f+N|0,o[s++]=h+I|0,o[s++]=d+x|0,o[s++]=p+m|0,o[s++]=y+g|0,o[s++]=w+E|0,o[s++]=b+_|0,o[s++]=S+B|0,o[s++]=U+v|0,o[s++]=P+k|0,o[s++]=Y+A|0}function no(e,t,n,r,o){let s=r+0,i=r+16*o;for(let a=0;a<16;a++)n[i+a]=e[t+(2*o-1)*16+a];for(let a=0;a<o;a++,s+=16,t+=16)Ri(n,i,e,t,n,s),a>0&&(i+=16),Ri(n,s,e,t+=16,n,i)}function Pf(e,t,n){let r=$t({dkLen:32,asyncTick:10,maxmem:1073742848},n),{N:o,r:s,p:i,dkLen:a,asyncTick:c,maxmem:l,onProgress:u}=r;if(ee(o,"N"),ee(s,"r"),ee(i,"p"),ee(a,"dkLen"),ee(c,"asyncTick"),ee(l,"maxmem"),u!==void 0&&typeof u!="function")throw new Error("progressCb must be a function");let f=128*s,h=f/4,d=Math.pow(2,32);if(o<=1||o&o-1||o>d)throw new Error('"N" expected a power of 2, and 2^1 <= N <= 2^32');if(i<1||i>(d-1)*32/f)throw new Error('"p" expected integer 1..((2^32 - 1) * 32) / (128 * r)');if(a<1||a>(d-1)*32)throw new Error('"dkLen" expected integer 1..(2^32 - 1) * 32');if(f*(o+i)>l)throw new Error('"maxmem" limit was hit, expected 128*r*(N+p) <= "maxmem"='+l);let y=to(te,e,t,{c:1,dkLen:f*i}),w=qt(y),b=qt(new Uint8Array(f*o)),S=qt(new Uint8Array(f)),U=()=>{};if(u){let P=2*o*i,Y=Math.max(Math.floor(P/1e4),1),O=0;U=()=>{O++,u&&(!(O%Y)||O===P)&&u(O/P)}}return{N:o,r:s,p:i,dkLen:a,blockSize32:h,V:b,B32:w,B:y,tmp:S,blockMixCb:U,asyncTick:c}}function Cf(e,t,n,r,o){let s=to(te,e,n,{c:1,dkLen:t});return we(n,r,o),s}function ro(e,t,n){let{N:r,r:o,p:s,dkLen:i,blockSize32:a,V:c,B32:l,B:u,tmp:f,blockMixCb:h}=Pf(e,t,n);Nn(l);for(let d=0;d<s;d++){let p=a*d;for(let y=0;y<a;y++)c[y]=l[p+y];for(let y=0,w=0;y<r-1;y++)no(c,w,c,w+=a,o),h();no(c,(r-1)*a,l,p,o),h();for(let y=0;y<r;y++){let w=(l[p+a-16]&r-1)>>>0;for(let b=0;b<a;b++)f[b]=l[p+b]^c[w*a+b];no(f,0,l,p,o),h()}}return Nn(l),Cf(e,i,u,c,f)}var Li=5e3;function Of(e,t){let n=ye.toWords(t);return ye.encode(e,n,Li)}function Nf(e,t){return Of(e,t)}function Ti(e,t,n=16,r=2){let o=fe(16),s=2**n,i=ro(t.normalize("NFKC"),o,{N:s,r:8,p:1,dkLen:32}),a=fe(24),c=Uint8Array.from([r]),u=Sr(i,a,c).encrypt(e),f=G(Uint8Array.from([2]),Uint8Array.from([n]),o,a,c,u);return Nf("ncryptsec",f)}function Ii(e,t){let{prefix:n,words:r}=ye.decode(e,Li);if(n!=="ncryptsec")throw new Error(`invalid prefix ${n}, expected 'ncryptsec'`);let o=new Uint8Array(ye.fromWords(r)),s=o[0];if(s!==2)throw new Error(`invalid version ${s}, expected 0x02`);let a=2**o[1],c=o.slice(2,18),l=o.slice(18,42),u=o[42],f=Uint8Array.from([u]),h=o.slice(43),d=ro(t.normalize("NFKC"),c,{N:a,r:8,p:1,dkLen:32});return Sr(d,l,f).decrypt(h)}var w0=new Error("timeout while waiting for mutex to become available"),b0=new Error("mutex already locked"),Mf=new Error("request for lock canceled"),Df=function(e,t,n,r){function o(s){return s instanceof n?s:new n(function(i){i(s)})}return new(n||(n=Promise))(function(s,i){function a(u){try{l(r.next(u))}catch(f){i(f)}}function c(u){try{l(r.throw(u))}catch(f){i(f)}}function l(u){u.done?s(u.value):o(u.value).then(a,c)}l((r=r.apply(e,t||[])).next())})},oo=class{constructor(t,n=Mf){this._value=t,this._cancelError=n,this._queue=[],this._weightedWaiters=[]}acquire(t=1,n=0){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);return new Promise((r,o)=>{let s={resolve:r,reject:o,weight:t,priority:n},i=Ui(this._queue,a=>n<=a.priority);i===-1&&t<=this._value?this._dispatchItem(s):this._queue.splice(i+1,0,s)})}runExclusive(t){return Df(this,arguments,void 0,function*(n,r=1,o=0){let[s,i]=yield this.acquire(r,o);try{return yield n(s)}finally{i()}})}waitForUnlock(t=1,n=0){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);return this._couldLockImmediately(t,n)?Promise.resolve():new Promise(r=>{this._weightedWaiters[t-1]||(this._weightedWaiters[t-1]=[]),Hf(this._weightedWaiters[t-1],{resolve:r,priority:n})})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(t){this._value=t,this._dispatchQueue()}release(t=1){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);this._value+=t,this._dispatchQueue()}cancel(){this._queue.forEach(t=>t.reject(this._cancelError)),this._queue=[]}_dispatchQueue(){for(this._drainUnlockWaiters();this._queue.length>0&&this._queue[0].weight<=this._value;)this._dispatchItem(this._queue.shift()),this._drainUnlockWaiters()}_dispatchItem(t){let n=this._value;this._value-=t.weight,t.resolve([n,this._newReleaser(t.weight)])}_newReleaser(t){let n=!1;return()=>{n||(n=!0,this.release(t))}}_drainUnlockWaiters(){if(this._queue.length===0)for(let t=this._value;t>0;t--){let n=this._weightedWaiters[t-1];n&&(n.forEach(r=>r.resolve()),this._weightedWaiters[t-1]=[])}else{let t=this._queue[0].priority;for(let n=this._value;n>0;n--){let r=this._weightedWaiters[n-1];if(!r)continue;let o=r.findIndex(s=>s.priority<=t);(o===-1?r:r.splice(0,o)).forEach(s=>s.resolve())}}}_couldLockImmediately(t,n){return(this._queue.length===0||this._queue[0].priority<n)&&t<=this._value}};function Hf(e,t){let n=Ui(e,r=>t.priority<=r.priority);e.splice(n+1,0,t)}function Ui(e,t){for(let n=e.length-1;n>=0;n--)if(t(e[n]))return n;return-1}var Kf=function(e,t,n,r){function o(s){return s instanceof n?s:new n(function(i){i(s)})}return new(n||(n=Promise))(function(s,i){function a(u){try{l(r.next(u))}catch(f){i(f)}}function c(u){try{l(r.throw(u))}catch(f){i(f)}}function l(u){u.done?s(u.value):o(u.value).then(a,c)}l((r=r.apply(e,t||[])).next())})},vn=class{constructor(t){this._semaphore=new oo(1,t)}acquire(){return Kf(this,arguments,void 0,function*(t=0){let[,n]=yield this._semaphore.acquire(1,t);return n})}runExclusive(t,n=0){return this._semaphore.runExclusive(()=>t(),1,n)}isLocked(){return this._semaphore.isLocked()}waitForUnlock(t=0){return this._semaphore.waitForUnlock(1,t)}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}};var C=typeof browser<"u"?browser:typeof chrome<"u"?chrome:null;if(!C)throw new Error("browser-polyfill: No extension API namespace found (neither browser nor chrome).");var _e=typeof browser>"u"&&typeof chrome<"u";function Be(e,t){return(...n)=>{try{let r=t.apply(e,n);if(r&&typeof r.then=="function")return r}catch{}return new Promise((r,o)=>{t.apply(e,[...n,(...s)=>{C.runtime&&C.runtime.lastError?o(new Error(C.runtime.lastError.message)):r(s.length<=1?s[0]:s)}])})}}var ge={};ge.runtime={sendMessage(...e){return _e?Be(C.runtime,C.runtime.sendMessage)(...e):C.runtime.sendMessage(...e)},onMessage:C.runtime.onMessage,getURL(e){return C.runtime.getURL(e)},openOptionsPage(){return _e?Be(C.runtime,C.runtime.openOptionsPage)():C.runtime.openOptionsPage()},get id(){return C.runtime.id}};ge.storage={local:{get(...e){return _e?Be(C.storage.local,C.storage.local.get)(...e):C.storage.local.get(...e)},set(...e){return _e?Be(C.storage.local,C.storage.local.set)(...e):C.storage.local.set(...e)},clear(...e){return _e?Be(C.storage.local,C.storage.local.clear)(...e):C.storage.local.clear(...e)},remove(...e){return _e?Be(C.storage.local,C.storage.local.remove)(...e):C.storage.local.remove(...e)}}};ge.tabs={create(...e){return _e?Be(C.tabs,C.tabs.create)(...e):C.tabs.create(...e)},query(...e){return _e?Be(C.tabs,C.tabs.query)(...e):C.tabs.query(...e)},remove(...e){return _e?Be(C.tabs,C.tabs.remove)(...e):C.tabs.remove(...e)},update(...e){return _e?Be(C.tabs,C.tabs.update)(...e):C.tabs.update(...e)},get(...e){return _e?Be(C.tabs,C.tabs.get)(...e):C.tabs.get(...e)},getCurrent(...e){return _e?Be(C.tabs,C.tabs.getCurrent)(...e):C.tabs.getCurrent(...e)}};function Pt(e){let t=new Uint8Array(e),n="";for(let r=0;r<t.length;r++)n+=String.fromCharCode(t[r]);return btoa(n)}function En(e){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return n.buffer}async function Pi(e,t){let n=new TextEncoder,r=await crypto.subtle.importKey("raw",n.encode(e),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t instanceof Uint8Array?t:new Uint8Array(t),iterations:6e5,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function Ct(e,t){let n=crypto.getRandomValues(new Uint8Array(16)),r=crypto.getRandomValues(new Uint8Array(12)),o=await Pi(t,n),s=new TextEncoder,i=await crypto.subtle.encrypt({name:"AES-GCM",iv:r},o,s.encode(e));return JSON.stringify({salt:Pt(n),iv:Pt(r),ciphertext:Pt(i)})}async function kn(e,t){let{salt:n,iv:r,ciphertext:o}=JSON.parse(e),s=new Uint8Array(En(n)),i=new Uint8Array(En(r)),a=En(o),c=await Pi(t,s),l=await crypto.subtle.decrypt({name:"AES-GCM",iv:i},c,a);return new TextDecoder().decode(l)}async function _n(e,t){t?typeof t=="string"&&(t=new Uint8Array(En(t))):t=crypto.getRandomValues(new Uint8Array(16));let n=new TextEncoder,r=await crypto.subtle.importKey("raw",n.encode(e),"PBKDF2",!1,["deriveBits"]),o=await crypto.subtle.deriveBits({name:"PBKDF2",salt:t,iterations:6e5,hash:"SHA-256"},r,256);return{hash:Pt(o),salt:Pt(t)}}async function Ci(e,t,n){let{hash:r}=await _n(e,n);return r===t}var Ie=ge.storage.local,_0=[new URL("wss://relay.damus.io"),new URL("wss://relay.primal.net"),new URL("wss://relay.snort.social"),new URL("wss://relay.getalby.com/v1"),new URL("wss://nos.lol"),new URL("wss://brb.io"),new URL("wss://nostr.orangepill.dev")];async function Ze(){return(await Ie.get({profiles:[]})).profiles}async function ie(e){return(await Ze())[e]}async function re(){return(await Ie.get({profileIndex:0})).profileIndex}async function Bn(e){return(await Ie.get(e))[e]}async function Oi(e,t){let n=await re();return(await ie(n)).hosts?.[e]?.[t]||"ask"}async function so(e,t,n,r=null){let o=await Ze();r||(r=await re());let s=o[r],i=s.hosts[e]||{};i={...i,[t]:n},s.hosts[e]=i,o[r]=s,await Ie.set({profiles:o})}async function Sn(){return(await Ie.get({isEncrypted:!1})).isEncrypted}async function qf(e){let{hash:t,salt:n}=await _n(e);await Ie.set({passwordHash:t,passwordSalt:n,isEncrypted:!0})}async function An(e){let t=await Ie.get({passwordHash:null,passwordSalt:null});return!t.passwordHash||!t.passwordSalt?!1:Ci(e,t.passwordHash,t.passwordSalt)}async function Ni(e){if(!await An(e))throw new Error("Invalid password");let n=await Ze();for(let r=0;r<n.length;r++)n[r].type!=="bunker"&&wt(n[r].privKey)&&(n[r].privKey=await kn(n[r].privKey,e));await Ie.set({profiles:n,isEncrypted:!1,passwordHash:null,passwordSalt:null})}async function Mi(e){let t=await Ze();for(let n=0;n<t.length;n++)t[n].type!=="bunker"&&(wt(t[n].privKey)||(t[n].privKey=await Ct(t[n].privKey,e)));await qf(e),await Ie.set({profiles:t})}async function Di(e,t){let n=await Ze();for(let s=0;s<n.length;s++){if(n[s].type==="bunker")continue;let i=n[s].privKey;wt(i)&&(i=await kn(i,e)),n[s].privKey=await Ct(i,t)}let{hash:r,salt:o}=await _n(t);await Ie.set({profiles:n,passwordHash:r,passwordSalt:o,isEncrypted:!0})}async function Hi(e,t){return e.type==="bunker"?"":wt(e.privKey)?kn(e.privKey,t):e.privKey}function wt(e){if(typeof e!="string")return!1;try{let t=JSON.parse(e);return!!(t.salt&&t.iv&&t.ciphertext)}catch{return!1}}var co=(e,t)=>t.some(n=>e instanceof n),Ki,qi;function $f(){return Ki||(Ki=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Vf(){return qi||(qi=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var lo=new WeakMap,io=new WeakMap,Rn=new WeakMap;function Wf(e){let t=new Promise((n,r)=>{let o=()=>{e.removeEventListener("success",s),e.removeEventListener("error",i)},s=()=>{n(st(e.result)),o()},i=()=>{r(e.error),o()};e.addEventListener("success",s),e.addEventListener("error",i)});return Rn.set(t,e),t}function zf(e){if(lo.has(e))return;let t=new Promise((n,r)=>{let o=()=>{e.removeEventListener("complete",s),e.removeEventListener("error",i),e.removeEventListener("abort",i)},s=()=>{n(),o()},i=()=>{r(e.error||new DOMException("AbortError","AbortError")),o()};e.addEventListener("complete",s),e.addEventListener("error",i),e.addEventListener("abort",i)});lo.set(e,t)}var uo={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return lo.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return st(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function zi(e){uo=e(uo)}function jf(e){return Vf().includes(e)?function(...t){return e.apply(fo(this),t),st(this.request)}:function(...t){return st(e.apply(fo(this),t))}}function Zf(e){return typeof e=="function"?jf(e):(e instanceof IDBTransaction&&zf(e),co(e,$f())?new Proxy(e,uo):e)}function st(e){if(e instanceof IDBRequest)return Wf(e);if(io.has(e))return io.get(e);let t=Zf(e);return t!==e&&(io.set(e,t),Rn.set(t,e)),t}var fo=e=>Rn.get(e);function ji(e,t,{blocked:n,upgrade:r,blocking:o,terminated:s}={}){let i=indexedDB.open(e,t),a=st(i);return r&&i.addEventListener("upgradeneeded",c=>{r(st(i.result),c.oldVersion,c.newVersion,st(i.transaction),c)}),n&&i.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),a.then(c=>{s&&c.addEventListener("close",()=>s()),o&&c.addEventListener("versionchange",l=>o(l.oldVersion,l.newVersion,l))}).catch(()=>{}),a}var Ff=["get","getKey","getAll","getAllKeys","count"],Gf=["put","add","delete","clear"],ao=new Map;function $i(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(ao.get(t))return ao.get(t);let n=t.replace(/FromIndex$/,""),r=t!==n,o=Gf.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(o||Ff.includes(n)))return;let s=async function(i,...a){let c=this.transaction(i,o?"readwrite":"readonly"),l=c.store;return r&&(l=l.index(a.shift())),(await Promise.all([l[n](...a),o&&c.done]))[0]};return ao.set(t,s),s}zi(e=>({...e,get:(t,n,r)=>$i(t,n)||e.get(t,n,r),has:(t,n)=>!!$i(t,n)||e.has(t,n)}));var Jf=["continue","continuePrimaryKey","advance"],Vi={},ho=new WeakMap,Zi=new WeakMap,Xf={get(e,t){if(!Jf.includes(t))return e[t];let n=Vi[t];return n||(n=Vi[t]=function(...r){ho.set(this,Zi.get(this)[t](...r))}),n}};async function*Yf(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;let n=new Proxy(t,Xf);for(Zi.set(n,t),Rn.set(n,fo(t));t;)yield n,t=await(ho.get(n)||t.continue()),ho.delete(n)}function Wi(e,t){return t===Symbol.asyncIterator&&co(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&co(e,[IDBIndex,IDBObjectStore])}zi(e=>({...e,get(t,n,r){return Wi(t,n)?Yf:e.get(t,n,r)},has(t,n){return Wi(t,n)||e.has(t,n)}}));async function Qf(){return await ji("events",1,{upgrade(e){let t=e.createObjectStore("events",{keyPath:"event.id"});t.createIndex("pubkey","event.pubkey"),t.createIndex("created_at","event.created_at"),t.createIndex("kind","event.kind"),t.createIndex("host","metadata.host")}})}async function Fi(e){return(await Qf()).put("events",e)}var ed=new TextDecoder("utf-8"),Gi=new TextEncoder,Ji=1,Xi=65535;function td(e,t){let n=Qe.getSharedSecret(e,M("02"+t)).subarray(1,33);return ln(te,n,Gi.encode("nip44-v2"))}function Yi(e,t){let n=un(te,e,t,76);return{chacha_key:n.subarray(0,32),chacha_nonce:n.subarray(32,44),hmac_key:n.subarray(44,76)}}function po(e){if(!Number.isSafeInteger(e)||e<1)throw new Error("expected positive integer");if(e<=32)return 32;let t=1<<Math.floor(Math.log2(e-1))+1,n=t<=256?32:t/8;return n*(Math.floor((e-1)/n)+1)}function nd(e){if(!Number.isSafeInteger(e)||e<Ji||e>Xi)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");let t=new Uint8Array(2);return new DataView(t.buffer).setUint16(0,e,!1),t}function rd(e){let t=Gi.encode(e),n=t.length,r=nd(n),o=new Uint8Array(po(n)-n);return G(r,t,o)}function od(e){let t=new DataView(e.buffer).getUint16(0),n=e.subarray(2,2+t);if(t<Ji||t>Xi||n.length!==t||e.length!==2+po(t))throw new Error("invalid padding");return ed.decode(n)}function Qi(e,t,n){if(n.length!==32)throw new Error("AAD associated data must be 32 bytes");let r=G(n,t);return ve(te,e,r)}function sd(e){if(typeof e!="string")throw new Error("payload must be a valid string");let t=e.length;if(t<132||t>87472)throw new Error("invalid payload length: "+t);if(e[0]==="#")throw new Error("unknown encryption version");let n;try{n=pe.decode(e)}catch(s){throw new Error("invalid base64: "+s.message)}let r=n.length;if(r<99||r>65603)throw new Error("invalid data length: "+r);let o=n[0];if(o!==2)throw new Error("unknown encryption version "+o);return{nonce:n.subarray(1,33),ciphertext:n.subarray(33,-32),mac:n.subarray(-32)}}function id(e,t,n=fe(32)){let{chacha_key:r,chacha_nonce:o,hmac_key:s}=Yi(t,n),i=rd(e),a=rt(r,o,i),c=Qi(s,a,n);return pe.encode(G(new Uint8Array([2]),n,a,c))}function ad(e,t){let{nonce:n,ciphertext:r,mac:o}=sd(e),{chacha_key:s,chacha_nonce:i,hmac_key:a}=Yi(t,n),c=Qi(a,r,n);if(!tt(c,o))throw new Error("invalid MAC");let l=rt(s,i,r);return od(l)}var Ot={utils:{getConversationKey:td,calcPaddedLen:po},encrypt:id,decrypt:ad};var Nt=ge.storage.local,me=e=>{},xe=new Map;function ea(e){if(!e.startsWith("bunker://"))throw new Error("Invalid bunker URL: must start with bunker://");let t=new URL(e),n=t.hostname||t.pathname.replace("//","");if(!/^[0-9a-f]{64}$/i.test(n))throw new Error("Invalid bunker URL: pubkey must be 64 hex characters");let r=t.searchParams.getAll("relay");if(r.length===0)throw new Error("Invalid bunker URL: at least one relay is required");for(let s of r)try{let i=new URL(s);if(i.protocol!=="wss:"&&i.protocol!=="ws:")throw new Error(`Invalid relay protocol: ${i.protocol}`)}catch{throw new Error(`Invalid relay URL: ${s}`)}let o=t.searchParams.get("secret")||null;return{remotePubkey:n,relays:r,secret:o}}var Mt=class{constructor(t){this.url=t,this.ws=null,this.subscriptions=new Map,this.eoseCallbacks=new Map,this.connected=!1,this.reconnectTimer=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5}connect(){return new Promise((t,n)=>{try{this.ws=new WebSocket(this.url)}catch(o){n(new Error(`Failed to create WebSocket: ${o.message}`));return}let r=setTimeout(()=>{this.ws?.close(),n(new Error(`Connection timeout: ${this.url}`))},1e4);this.ws.onopen=()=>{clearTimeout(r),this.connected=!0,this.reconnectAttempts=0,me(`Connected to ${this.url}`),t()},this.ws.onerror=o=>{clearTimeout(r),me(`WebSocket error: ${this.url}`),n(new Error(`WebSocket error: ${this.url}`))},this.ws.onclose=()=>{this.connected=!1,me(`Disconnected from ${this.url}`),this.scheduleReconnect()},this.ws.onmessage=o=>{try{let s=JSON.parse(o.data);this.handleMessage(s)}catch(s){me(`Failed to parse message: ${s.message}`)}}})}handleMessage(t){let[n,r,...o]=t;if(n==="EVENT"&&r&&o[0]){let s=o[0],i=this.subscriptions.get(r);i&&i(s)}else if(n==="EOSE"&&r){let s=this.eoseCallbacks.get(r);s&&(this.eoseCallbacks.delete(r),s())}else n==="OK"||n==="NOTICE"&&me(`Relay notice: ${o[0]}`)}subscribe(t,n,r,o=null){if(!this.connected||!this.ws)throw new Error("Not connected");this.subscriptions.set(t,r),o&&this.eoseCallbacks.set(t,o),this.ws.send(JSON.stringify(["REQ",t,...n]))}unsubscribe(t){this.ws&&this.connected&&this.ws.send(JSON.stringify(["CLOSE",t])),this.subscriptions.delete(t),this.eoseCallbacks.delete(t)}publish(t){if(!this.connected||!this.ws)throw new Error("Not connected");this.ws.send(JSON.stringify(["EVENT",t]))}scheduleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){me(`Max reconnect attempts reached for ${this.url}`);return}let t=Math.min(1e3*Math.pow(2,this.reconnectAttempts),3e4);this.reconnectAttempts++,this.reconnectTimer=setTimeout(()=>{me(`Reconnecting to ${this.url} (attempt ${this.reconnectAttempts})`),this.connect().catch(()=>{})},t)}close(){clearTimeout(this.reconnectTimer),this.maxReconnectAttempts=0,this.subscriptions.clear(),this.eoseCallbacks.clear(),this.ws&&(this.ws.close(),this.ws=null),this.connected=!1}},Ln=class{constructor({remotePubkey:t,relays:n,secret:r}){this.remotePubkey=t,this.relayUrls=n,this.secret=r,this.sessionPrivkey=Ut(),this.sessionPubkey=qe(this.sessionPrivkey),this.conversationKey=Ot.utils.getConversationKey(this.sessionPrivkey,this.remotePubkey),this.relays=[],this.pendingRequests=new Map,this.connected=!1,this.subId=`nostrkey-${crypto.randomUUID().slice(0,8)}`}async connect(){let t=this.relayUrls.map(o=>{let s=new Mt(o);return s.connect().then(()=>(this.relays.push(s),s))}),r=(await Promise.allSettled(t)).filter(o=>o.status==="fulfilled");if(r.length===0)throw new Error("Failed to connect to any relay");me(`Connected to ${r.length}/${this.relayUrls.length} relays`);for(let o of this.relays)o.subscribe(this.subId,[{kinds:[24133],"#p":[this.sessionPubkey]}],s=>this.handleResponse(s));this.connected=!0,this.secret?await this.sendRequest("connect",[this.remotePubkey,this.secret]):await this.sendRequest("connect",[this.remotePubkey])}handleResponse(t){if(t.pubkey!==this.remotePubkey){me(`Ignoring event from unknown pubkey: ${t.pubkey}`);return}try{let n=Ot.decrypt(t.content,this.conversationKey),r=JSON.parse(n);me(`Response: ${r.id} -> ${r.result?"ok":r.error}`);let o=this.pendingRequests.get(r.id);o&&(this.pendingRequests.delete(r.id),r.error?o.reject(new Error(r.error)):o.resolve(r.result))}catch(n){me(`Failed to handle response: ${n.message}`)}}async sendRequest(t,n=[]){if(!this.connected&&t!=="connect")throw new Error("Not connected to bunker");let r=crypto.randomUUID(),o=JSON.stringify({id:r,method:t,params:n}),s=Ot.encrypt(o,this.conversationKey),i=se({kind:24133,content:s,tags:[["p",this.remotePubkey]],created_at:Math.floor(Date.now()/1e3)},this.sessionPrivkey);for(let a of this.relays)try{a.publish(i)}catch(c){me(`Failed to publish to ${a.url}: ${c.message}`)}return new Promise((a,c)=>{let l=setTimeout(()=>{this.pendingRequests.delete(r),c(new Error(`Request timeout: ${t}`))},3e4);this.pendingRequests.set(r,{resolve:u=>{clearTimeout(l),a(u)},reject:u=>{clearTimeout(l),c(u)}})})}async getPublicKey(){return await this.sendRequest("get_public_key")}async signEvent(t){let n=await this.sendRequest("sign_event",[JSON.stringify(t)]);return JSON.parse(n)}async nip04Encrypt(t,n){return await this.sendRequest("nip04_encrypt",[t,n])}async nip04Decrypt(t,n){return await this.sendRequest("nip04_decrypt",[t,n])}async nip44Encrypt(t,n){return await this.sendRequest("nip44_encrypt",[t,n])}async nip44Decrypt(t,n){return await this.sendRequest("nip44_decrypt",[t,n])}async ping(){return await this.sendRequest("ping")}getSessionInfo(){return{remotePubkey:this.remotePubkey,relayUrls:this.relayUrls,secret:this.secret,sessionPrivkey:H(this.sessionPrivkey),sessionPubkey:this.sessionPubkey}}disconnect(){for(let t of this.relays)t.unsubscribe(this.subId),t.close();this.relays=[],this.pendingRequests.clear(),this.connected=!1,me("Disconnected from bunker")}};function ld(e){let t=new Ln({remotePubkey:e.remotePubkey,relays:e.relayUrls,secret:e.secret});return t.sessionPrivkey=M(e.sessionPrivkey),t.sessionPubkey=e.sessionPubkey,t.conversationKey=Ot.utils.getConversationKey(t.sessionPrivkey,t.remotePubkey),t}async function Se(e){if(xe.has(e)){let o=xe.get(e);if(o.connected)return o;o.disconnect(),xe.delete(e)}let n=(await Nt.get({bunkerSessions:{}})).bunkerSessions?.[e];if(!n)throw new Error("No bunker session configured for this profile");let r=ld(n);return await r.connect(),xe.set(e,r),r}async function ta(e,t){xe.has(e)&&(xe.get(e).disconnect(),xe.delete(e));let n=ea(t),r=new Ln(n);await r.connect();let s=(await Nt.get({bunkerSessions:{}})).bunkerSessions||{};return s[e]=r.getSessionInfo(),await Nt.set({bunkerSessions:s}),xe.set(e,r),r}async function na(e){xe.has(e)&&(xe.get(e).disconnect(),xe.delete(e));let n=(await Nt.get({bunkerSessions:{}})).bunkerSessions||{};delete n[e],await Nt.set({bunkerSessions:n})}function ra(e){return xe.has(e)&&xe.get(e).connected}function oa(e){try{return ea(e),{valid:!0,error:null}}catch(t){return{valid:!1,error:t.message}}}var Tn="nostrkey:",ud="nostrkey";function yo(e,t){return{kind:30078,content:t,tags:[["d",`${Tn}${e}`],["client",ud]],created_at:Math.floor(Date.now()/1e3)}}function go(e,t){return{kind:5,content:"vault document deleted",tags:[["e",e],["a",`30078::${Tn}${t}`]],created_at:Math.floor(Date.now()/1e3)}}function sa(e){return{kinds:[30078],authors:[e]}}function ia(e){if(e.kind!==30078)return null;let t=e.tags?.find(r=>r[0]==="d");if(!t||!t[1]?.startsWith(Tn))return null;let n=t[1].slice(Tn.length);return n?{path:n,content:e.content,createdAt:e.created_at,eventId:e.id}:null}var Pn=ge.storage.local,Ht=e=>{},Ue={},Le={mutex:new vn,release:null,tabId:null},wo=new Map,fd=5,dd=1e4;function hd(e){let t=Date.now(),n=wo.get(e)||[];return n=n.filter(r=>t-r<dd),n.length>=fd?(wo.set(e,n),!0):(n.push(t),wo.set(e,n),!1)}var xt=new Map,Dt=null,vt=!0,aa=15*60*1e3,mt=null;function Ge(){mt&&clearTimeout(mt),vt||(mt=setTimeout(()=>{ca()},aa))}function ca(){xt.clear(),Dt=null,vt=!0,mt&&(clearTimeout(mt),mt=null),Ht("Session locked.")}async function bo(e){if(!await An(e))return{success:!1,error:"Invalid password"};let n=await Ze();for(let r=0;r<n.length;r++){if(n[r].type==="bunker")continue;let o=await Hi(n[r],e);xt.set(r,o)}return Dt=e,vt=!1,Ge(),Ht("Session unlocked."),{success:!0}}async function la(){return await Sn()?vt:(vt=!1,!1)}ge.runtime.onMessage.addListener((e,t,n)=>{Ht(e);let r=crypto.randomUUID(),o;switch(e.kind){case"closePrompt":return Le.release?.(),Promise.resolve(!0);case"allowed":return Ge(),ua(e),Promise.resolve(!0);case"denied":return mo(e),Promise.resolve(!0);case"generatePrivateKey":return Promise.resolve(yd());case"savePrivateKey":return Ge(),wd(e.payload);case"getNpub":return Ge(),md(e.payload);case"getNsec":return Ge(),bd(e.payload);case"calcPubKey":return Promise.resolve(qe(e.payload));case"npubEncode":return Promise.resolve(je.npubEncode(e.payload));case"copy":return typeof navigator<"u"&&navigator.clipboard?.writeText?navigator.clipboard.writeText(e.payload):Promise.resolve(!1);case"isLocked":return la();case"isEncrypted":return Sn();case"unlock":return bo(e.payload);case"lock":return ca(),Promise.resolve(!0);case"setPassword":return(async()=>(await Mi(e.payload),bo(e.payload)))();case"changePassword":return(async()=>{let{oldPassword:s,newPassword:i}=e.payload;return await An(s)?(await Di(s,i),bo(i)):{success:!1,error:"Invalid current password"}})();case"removePassword":return(async()=>{try{return await Ni(e.payload),xt.clear(),Dt=null,vt=!1,{success:!0}}catch(s){return{success:!1,error:s.message}}})();case"setAutoLockTimeout":return aa=e.payload*60*1e3,Ge(),Promise.resolve(!0);case"resetAutoLock":return Ge(),Promise.resolve(!0);case"ncryptsec.decrypt":return(async()=>{try{let{ncryptsec:s,password:i}=e.payload;return{success:!0,hexKey:H(Ii(s,i))}}catch(s){return{success:!1,error:s.message||"Decryption failed"}}})();case"ncryptsec.encrypt":return(async()=>{try{let{profileIndex:s,password:i}=e.payload,a=await ie(s);if(a?.type==="bunker")return{success:!1,error:"Cannot export bunker profile as ncryptsec"};let c=await Cn(s,a);return{success:!0,ncryptsec:Ti(M(c),i)}}catch(s){return{success:!1,error:s.message||"Encryption failed"}}})();case"getProfileType":return(async()=>{let s=e.payload??await re();return(await ie(s))?.type||"local"})();case"bunker.connect":return(async()=>{try{let{profileIndex:s,bunkerUrl:i}=e.payload,c=await(await ta(s,i)).getPublicKey(),l=await Ze();return l[s].remotePubkey=c,l[s].bunkerUrl=i,await Pn.set({profiles:l}),{success:!0,remotePubkey:c}}catch(s){return{success:!1,error:s.message}}})();case"bunker.disconnect":return(async()=>{try{let s=e.payload;return await na(s),{success:!0}}catch(s){return{success:!1,error:s.message}}})();case"bunker.status":return(async()=>{let s=e.payload??await re();return{connected:ra(s)}})();case"bunker.ping":return(async()=>{try{let s=e.payload??await re();return{success:!0,result:await(await Se(s)).ping()}}catch(s){return{success:!1,error:s.message}}})();case"bunker.validateUrl":return Promise.resolve(oa(e.payload));case"vault.publish":return(async()=>{try{let{path:s,content:i}=e.payload,a=await Fe(),c=await In({pubKey:a,plainText:i}),l=yo(s,c),u=await re(),f=await ie(u),h;if(f.type==="bunker")h=await(await Se(u)).signEvent(l);else{let d=await Pe();h=se(l,d)}return await bt("write",async d=>{for(let p of d)try{p.publish(h)}catch{}}),{success:!0,eventId:h.id,createdAt:h.created_at}}catch(s){return{success:!1,error:s.message}}})();case"vault.fetch":return(async()=>{try{let s=await Fe(),i=sa(s),a=[];await bt("read",async f=>{let h=f.map(d=>new Promise(p=>{let y=`vault-${crypto.randomUUID().slice(0,8)}`,w=setTimeout(()=>{try{d.unsubscribe(y)}catch{}p()},15e3);d.subscribe(y,[i],b=>{a.push(b)},()=>{clearTimeout(w);try{d.unsubscribe(y)}catch{}p()})}));await Promise.all(h)});let c=new Map;for(let f of a){let h=ia(f);if(!h)continue;let d=c.get(h.path);(!d||h.createdAt>d.createdAt)&&c.set(h.path,{event:f,parsed:h})}let l=[],u=await Fe();for(let{event:f,parsed:h}of c.values())try{let d=await Un({pubKey:u,cipherText:f.content});l.push({path:h.path,content:d,createdAt:h.createdAt,eventId:h.eventId})}catch{}return{success:!0,documents:l}}catch(s){return{success:!1,error:s.message}}})();case"vault.delete":return(async()=>{try{let{path:s,eventId:i}=e.payload,a=go(i,s),c=await re(),l=await ie(c),u;if(l.type==="bunker")u=await(await Se(c)).signEvent(a);else{let f=await Pe();u=se(a,f)}return await bt("write",async f=>{for(let h of f)try{h.publish(u)}catch{}}),{success:!0}}catch(s){return{success:!1,error:s.message}}})();case"vault.getRelays":return(async()=>{try{let i=(await On()).relays||[],a=i.filter(l=>l.read).map(l=>l.url),c=i.filter(l=>l.write).map(l=>l.url);return{read:a,write:c}}catch{return{read:[],write:[]}}})();case"apikeys.publish":return(async()=>{try{let{keys:s}=e.payload,i=await Fe(),a=JSON.stringify(s),c=await In({pubKey:i,plainText:a}),l=yo("vault/api-keys",c),u=await re(),f=await ie(u),h;if(f.type==="bunker")h=await(await Se(u)).signEvent(l);else{let d=await Pe();h=se(l,d)}return await bt("write",async d=>{for(let p of d)try{p.publish(h)}catch{}}),{success:!0,eventId:h.id,createdAt:h.created_at}}catch(s){return{success:!1,error:s.message}}})();case"apikeys.fetch":return(async()=>{try{let s=await Fe(),i={kinds:[30078],authors:[s],"#d":["nostrkey:vault/api-keys"]},a=[];await bt("read",async f=>{let h=f.map(d=>new Promise(p=>{let y=`apikeys-${crypto.randomUUID().slice(0,8)}`,w=setTimeout(()=>{try{d.unsubscribe(y)}catch{}p()},15e3);d.subscribe(y,[i],b=>{a.push(b)},()=>{clearTimeout(w);try{d.unsubscribe(y)}catch{}p()})}));await Promise.all(h)});let c=null;for(let f of a)(!c||f.created_at>c.created_at)&&(c=f);if(!c)return{success:!0,keys:null,eventId:null,createdAt:null};let l=await Un({pubKey:s,cipherText:c.content});return{success:!0,keys:JSON.parse(l),eventId:c.id,createdAt:c.created_at}}catch(s){return{success:!1,error:s.message}}})();case"apikeys.delete":return(async()=>{try{let{eventId:s}=e.payload,i=go(s,"vault/api-keys"),a=await re(),c=await ie(a),l;if(c.type==="bunker")l=await(await Se(a)).signEvent(i);else{let u=await Pe();l=se(i,u)}return await bt("write",async u=>{for(let f of u)try{f.publish(l)}catch{}}),{success:!0}}catch(s){return{success:!1,error:s.message}}})();case"apikeys.encrypt":return(async()=>{try{let{plainText:s}=e.payload,i=await Fe();return{success:!0,cipherText:await In({pubKey:i,plainText:s})}}catch(s){return{success:!1,error:s.message}}})();case"apikeys.decrypt":return(async()=>{try{let{cipherText:s}=e.payload,i=await Fe();return{success:!0,plainText:await Un({pubKey:i,cipherText:s})}}catch(s){return{success:!1,error:s.message}}})();case"replaceURL":return(async()=>{let{protocol_handler:s}=await Pn.get(["protocol_handler"]);if(!s)return!1;let{url:i}=e.payload,a=i.split("nostr:")[1];if(!a)return!1;try{let{type:c,data:l}=je.decode(a),u={raw:a,hrp:c,hex:c==="npub"||c==="note"?l:c==="nprofile"?l.pubkey:c==="nevent"?l.id:c==="naddr"?l.pubkey:a,p_or_e:{npub:"p",note:"e",nprofile:"p",nevent:"e",naddr:"a"}[c]||"",u_or_n:{npub:"u",note:"n",nprofile:"u",nevent:"n",naddr:"n"}[c]||"",relay0:l?.relays?.[0]||"",relay1:l?.relays?.[1]||"",relay2:l?.relays?.[2]||""},f=s;for(let[h,d]of Object.entries(u))f=f.replace(new RegExp(`\\{ *${h} *\\}`,"g"),d);return f}catch{return!1}})();case"getPubKey":case"signEvent":case"nip04.encrypt":case"nip04.decrypt":case"nip44.encrypt":case"nip44.decrypt":case"getRelays":return Ue[r]=n,gd(r,e),setTimeout(()=>{Ue[r]&&mo({payload:r,origKind:e.kind,host:e.host}),Le.release?.()},1e4),!0;default:return Promise.resolve()}});async function pd(){if(Le.tabId!==null)try{await ge.tabs.get(Le.tabId)}catch{Le.release?.(),Le.tabId=null}}async function yd(){let e=Ut();return H(e)}async function gd(e,{kind:t,host:n,payload:r}){let o=await re();if(!((await ie(o))?.type==="bunker")&&await la()){let d=Ue[e];delete Ue[e],d?.({error:"locked",message:"Extension is locked. Please unlock with your master password."});return}if(hd(n)){let h=Ue[e];delete Ue[e],h?.({error:"rate_limited",message:"Too many requests. Please wait."}),Ht(`Rate limited: ${n}`);return}Ge(),await pd(),Le.release=await Le.mutex.acquire();let a=t==="signEvent"?`signEvent:${r.kind}`:t,c=await Oi(n,a);if(c==="allow"){ua({payload:e,origKind:t,event:r,remember:!1,host:n}),Le.release();return}if(c==="deny"){mo({payload:e,origKind:t,host:n}),Le.release();return}let l=new URLSearchParams({uuid:e,kind:t,host:n,payload:JSON.stringify(r||!1)}),u=await ge.tabs.getCurrent(),f=await ge.tabs.create({url:ge.runtime.getURL(`permission/permission.html?${l.toString()}`),openerTabId:u?.id});return Le.tabId=f.id,!0}function ua({payload:e,origKind:t,event:n,remember:r,host:o}){let s=Ue[e];if(delete Ue[e],r){let i=t==="signEvent"?`signEvent:${n.kind}`:t;so(o,i,"allow")}if(s){let i=a=>{Ht(`Error in ${t}: ${a.message}`),s({error:"bunker_error",message:a.message})};switch(t){case"getPubKey":Fe().then(a=>s(a)).catch(i);break;case"signEvent":xd(n,o).then(a=>s(a)).catch(i);break;case"nip04.encrypt":vd(n).then(a=>s(a)).catch(i);break;case"nip04.decrypt":Ed(n).then(a=>s(a)).catch(i);break;case"nip44.encrypt":In(n).then(a=>s(a)).catch(i);break;case"nip44.decrypt":Un(n).then(a=>s(a)).catch(i);break;case"getRelays":kd().then(a=>s(a)).catch(i);break}}}function mo({origKind:e,host:t,payload:n,remember:r,event:o}){let s=Ue[n];if(delete Ue[n],r){let i=e==="signEvent"?`signEvent:${o.kind}`:e;so(t,i,"deny")}return s?.(void 0),!1}async function wd([e,t]){if((await ie(e))?.type==="bunker")throw new Error("Cannot set private key on a bunker profile");if(typeof t!="string"||t.length===0)throw new Error("Invalid private key: must be a non-empty string");if(t.startsWith("nsec"))try{t=je.decode(t).data}catch{throw new Error("Invalid nsec key")}let r=H(t);if(!/^[0-9a-f]{64}$/i.test(r))throw new Error("Invalid private key: must be 64 hex characters or valid nsec");let o=await Bn("profiles");if(!o||e<0||e>=o.length)throw new Error("Invalid profile index");return await Sn()&&Dt?(o[e].privKey=await Ct(r,Dt),xt.set(e,r)):o[e].privKey=r,await Pn.set({profiles:o}),!0}async function bd(e){let t=await ie(e);if(t.type==="bunker")return null;let n=await Cn(e,t);return je.nsecEncode(M(n))}async function md(e){let t=await ie(e);if(t.type==="bunker")return t.remotePubkey?je.npubEncode(t.remotePubkey):null;let n=await Cn(e,t),r=qe(M(n));return je.npubEncode(r)}async function Cn(e,t){if(wt(t.privKey)){if(xt.has(e))return xt.get(e);throw new Error("Extension is locked \u2014 cannot access private key")}return t.privKey}async function Pe(){let e=await re(),t=await On(),n=await Cn(e,t);return M(n)}async function Fe(){let e=await re(),t=await ie(e);if(t.type==="bunker"){if(t.remotePubkey)return t.remotePubkey;let s=await(await Se(e)).getPublicKey(),i=await Bn("profiles");return i[e].remotePubkey=s,await Pn.set({profiles:i}),s}let n=await Pe();return qe(n)}async function On(){let e=await re();return(await Bn("profiles"))[e]}async function xd(e,t){e=JSON.parse(JSON.stringify(e));let n=await re();if((await ie(n)).type==="bunker")e=await(await Se(n)).signEvent(e);else{let o=await Pe();e=se(e,o)}return Fi({event:e,metadata:{host:t,signed_at:Math.round(Date.now()/1e3)}}),e}async function vd({pubKey:e,plainText:t}){let n=await re();if((await ie(n)).type==="bunker")return(await Se(n)).nip04Encrypt(e,t);let o=await Pe();return mn.encrypt(o,e,t)}async function Ed({pubKey:e,cipherText:t}){let n=await re();if((await ie(n)).type==="bunker")return(await Se(n)).nip04Decrypt(e,t);let o=await Pe();return mn.decrypt(o,e,t)}async function In({pubKey:e,plainText:t}){let n=await re();if((await ie(n)).type==="bunker")return(await Se(n)).nip44Encrypt(e,t);let o=await Pe(),s=gt.v2.utils.getConversationKey(o,e);return gt.v2.encrypt(t,s)}async function Un({pubKey:e,cipherText:t}){let n=await re();if((await ie(n)).type==="bunker")return(await Se(n)).nip44Decrypt(e,t);let o=await Pe(),s=gt.v2.utils.getConversationKey(o,e);return gt.v2.decrypt(t,s)}async function kd(){let t=(await On()).relays,n={};return t.forEach(r=>{let{url:o,read:s,write:i}=r;n[o]={read:s,write:i}}),n}async function bt(e,t){let o=((await On()).relays||[]).filter(a=>e==="read"?a.read:a.write).map(a=>a.url);if(o.length===0)throw new Error("No relays configured");let s=[],i=o.map(async a=>{let c=new Mt(a);try{await c.connect(),s.push(c)}catch{}});if(await Promise.allSettled(i),s.length===0)throw new Error("Failed to connect to any relay");try{await t(s)}finally{for(let a of s)a.close()}}})();
/*! Bundled license information:

@noble/hashes/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/utils.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/abstract/modular.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/abstract/curve.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/abstract/weierstrass.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@scure/base/index.js:
  (*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/ciphers/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)
*/
