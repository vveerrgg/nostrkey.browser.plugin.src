(()=>{var r=typeof browser<"u"?browser:typeof chrome<"u"?chrome:null;if(!r)throw new Error("browser-polyfill: No extension API namespace found (neither browser nor chrome).");var d=typeof browser>"u"&&typeof chrome<"u";function y(e,n){return(...o)=>{try{let s=n.apply(e,o);if(s&&typeof s.then=="function")return s}catch{}return new Promise((s,a)=>{n.apply(e,[...o,(...c)=>{r.runtime&&r.runtime.lastError?a(new Error(r.runtime.lastError.message)):s(c.length<=1?c[0]:c)}])})}}var u={};u.runtime={sendMessage(...e){return d?y(r.runtime,r.runtime.sendMessage)(...e):r.runtime.sendMessage(...e)},onMessage:r.runtime.onMessage,getURL(e){return r.runtime.getURL(e)},openOptionsPage(){return d?y(r.runtime,r.runtime.openOptionsPage)():r.runtime.openOptionsPage()},get id(){return r.runtime.id}};u.storage={local:{get(...e){return d?y(r.storage.local,r.storage.local.get)(...e):r.storage.local.get(...e)},set(...e){return d?y(r.storage.local,r.storage.local.set)(...e):r.storage.local.set(...e)},clear(...e){return d?y(r.storage.local,r.storage.local.clear)(...e):r.storage.local.clear(...e)},remove(...e){return d?y(r.storage.local,r.storage.local.remove)(...e):r.storage.local.remove(...e)}},sync:r.storage?.sync?{get(...e){return d?y(r.storage.sync,r.storage.sync.get)(...e):r.storage.sync.get(...e)},set(...e){return d?y(r.storage.sync,r.storage.sync.set)(...e):r.storage.sync.set(...e)},remove(...e){return d?y(r.storage.sync,r.storage.sync.remove)(...e):r.storage.sync.remove(...e)},clear(...e){return d?y(r.storage.sync,r.storage.sync.clear)(...e):r.storage.sync.clear(...e)},getBytesInUse(...e){return r.storage.sync.getBytesInUse?d?y(r.storage.sync,r.storage.sync.getBytesInUse)(...e):r.storage.sync.getBytesInUse(...e):Promise.resolve(0)}}:null,onChanged:r.storage?.onChanged||null};u.tabs={create(...e){return d?y(r.tabs,r.tabs.create)(...e):r.tabs.create(...e)},query(...e){return d?y(r.tabs,r.tabs.query)(...e):r.tabs.query(...e)},remove(...e){return d?y(r.tabs,r.tabs.remove)(...e):r.tabs.remove(...e)},update(...e){return d?y(r.tabs,r.tabs.update)(...e):r.tabs.update(...e)},get(...e){return d?y(r.tabs,r.tabs.get)(...e):r.tabs.get(...e)},getCurrent(...e){return d?y(r.tabs,r.tabs.getCurrent)(...e):r.tabs.getCurrent(...e)},sendMessage(...e){return d?y(r.tabs,r.tabs.sendMessage)(...e):r.tabs.sendMessage(...e)}};var D=102400,J=8192,ee=512,te="_chunk:",V="_sync_meta",_="platformSyncEnabled";var E={P1_PROFILES:1,P2_SETTINGS:2,P3_APIKEYS:3,P4_VAULT:4},B=u.storage.local,K=null;function ne(e,n){let o=[];for(let a=0;a<n.length;a+=J-100)o.push(n.slice(a,a+J-100));if(o.length===1)return[{key:e,value:n}];let s=[];for(let a=0;a<o.length;a++)s.push({key:`${te}${e}:${a}`,value:o[a]});return s.push({key:e,value:JSON.stringify({__chunked:!0,count:o.length})}),s}async function re(){let e=await B.get(null),n=[];if(e.profiles){let s=e.profiles.map(c=>{let{hosts:m,...f}=c;return f}),a=JSON.stringify(s);n.push({key:"profiles",jsonString:a,priority:E.P1_PROFILES,size:a.length})}if(e.profileIndex!=null){let s=JSON.stringify(e.profileIndex);n.push({key:"profileIndex",jsonString:s,priority:E.P1_PROFILES,size:s.length})}if(e.isEncrypted!=null){let s=JSON.stringify(e.isEncrypted);n.push({key:"isEncrypted",jsonString:s,priority:E.P1_PROFILES,size:s.length})}let o=["autoLockMinutes","version","protocol_handler",_];for(let s of o)if(e[s]!=null){let a=JSON.stringify(e[s]);n.push({key:s,jsonString:a,priority:E.P2_SETTINGS,size:a.length})}for(let s of Object.keys(e))if(s.startsWith("feature:")){let a=JSON.stringify(e[s]);n.push({key:s,jsonString:a,priority:E.P2_SETTINGS,size:a.length})}if(e.apiKeyVault){let s=JSON.stringify(e.apiKeyVault);n.push({key:"apiKeyVault",jsonString:s,priority:E.P3_APIKEYS,size:s.length})}if(e.vaultDocs&&typeof e.vaultDocs=="object"){let s=Object.values(e.vaultDocs).sort((a,c)=>(c.updatedAt||0)-(a.updatedAt||0));for(let a of s){let c=`vaultDoc:${a.path}`,m=JSON.stringify(a);n.push({key:c,jsonString:m,priority:E.P4_VAULT,size:m.length})}}return n}async function se(){if(!(!u.storage.sync||!await oe()))try{let n=await re();n.sort((S,g)=>S.priority-g.priority);let o=0,s=0,a={},c=[],m=!1;for(let S of n){if(m)break;let g=ne(S.key,S.jsonString),k=0;for(let b of g)k+=b.key.length+(typeof b.value=="string"?b.value.length:JSON.stringify(b.value).length);if((o+k>D-500||s+g.length>ee-5)&&!(S.priority<=E.P3_APIKEYS)){m=!0;break}for(let b of g)a[b.key]=b.value,c.push(b.key);o+=k,s+=g.length}let f={lastWrittenAt:Date.now(),keys:c};a[V]=JSON.stringify(f),await u.storage.sync.set(a);try{let S=await u.storage.sync.get(null),g=Object.keys(S).filter(k=>k!==V&&!c.includes(k));g.length>0&&await u.storage.sync.remove(g)}catch{}}catch{}}function q(){u.storage.sync&&(K&&clearTimeout(K),K=setTimeout(()=>{K=null,se()},2e3))}async function oe(){return(await B.get({[_]:!0}))[_]}var Y=u.storage.local,C="apiKeyVault",F={keys:{},syncEnabled:!0,eventId:null,relayCreatedAt:null,syncStatus:"synced"};async function w(){let e=await Y.get({[C]:F});return{...F,...e[C]}}async function I(e){await Y.set({[C]:e}),q()}async function P(){return w()}async function j(e,n,o){let s=await w(),a=Math.floor(Date.now()/1e3),c=s.keys[e];return s.keys[e]={id:e,label:n,secret:o,createdAt:c?.createdAt||a,updatedAt:a,profileScope:c?.profileScope??null},await I(s),s.keys[e]}async function z(e){let n=await w();delete n.keys[e],await I(n)}async function x(){let e=await w();return Object.values(e.keys).sort((n,o)=>n.label.toLowerCase().localeCompare(o.label.toLowerCase()))}async function H(e){let n=await w();n.syncEnabled=e,await I(n)}async function G(){return(await w()).syncEnabled}async function A(e,n=null,o=null){let s=await w();s.syncStatus=e,n!==null&&(s.eventId=n),o!==null&&(s.relayCreatedAt=o),await I(s)}async function W(){return(await w()).keys}async function O(e){let n=await w();for(let[o,s]of Object.entries(e))n.keys[o]=s;await I(n)}var t={keys:[],newLabel:"",newSecret:"",editingId:null,editLabel:"",editSecret:"",copiedId:null,revealedId:null,syncEnabled:!0,globalSyncStatus:"idle",syncError:"",saving:!1,toast:"",relayInfo:{read:[],write:[]}};function l(e){return document.getElementById(e)}function L(){return t.relayInfo.read.length>0||t.relayInfo.write.length>0}function ae(){return[...t.keys].sort((e,n)=>e.label.toLowerCase().localeCompare(n.label.toLowerCase()))}function ie(e){return e?e.length<=8?"\u2022".repeat(e.length):e.slice(0,4)+"\u2022".repeat(4)+e.slice(-4):""}function v(e){t.toast=e,p(),setTimeout(()=>{t.toast="",p()},2e3)}function ce(e){return e==="idle"?"bg-green-500":e==="syncing"?"bg-yellow-500 animate-pulse":"bg-red-500"}function le(){return t.globalSyncStatus==="syncing"?"Syncing...":t.globalSyncStatus==="error"?t.syncError:t.syncEnabled?"Synced":"Local only"}function p(){let e=l("sync-dot"),n=l("sync-text"),o=l("sync-btn"),s=l("sync-toggle"),a=l("key-count");e&&(e.className=`inline-block w-3 h-3 rounded-full ${ce(t.globalSyncStatus)}`),n&&(n.textContent=le()),o&&(o.disabled=t.globalSyncStatus==="syncing"||!L()||!t.syncEnabled),s&&(s.checked=t.syncEnabled),a&&(a.textContent=t.keys.length+" key"+(t.keys.length!==1?"s":""));let c=l("key-table-container"),m=l("no-keys"),f=l("key-table-body");if(c&&(c.style.display=t.keys.length>0?"block":"none"),m&&(m.style.display=t.keys.length===0?"block":"none"),f){let Q=ae();f.innerHTML=Q.map(i=>{if(t.editingId===i.id)return`
                    <tr class="border-b border-monokai-bg-lighter hover:bg-monokai-bg-lighter">
                        <td class="p-2">
                            <input
                                type="text"
                                class="input text-sm w-full"
                                autocomplete="off"
                                data-edit-label="${i.id}"
                                value="${X(t.editLabel)}"
                            />
                        </td>
                        <td class="p-2 font-mono text-xs">
                            <input
                                type="text"
                                class="input text-xs font-mono w-full"
                                autocomplete="off"
                                spellcheck="false"
                                data-edit-secret="${i.id}"
                                value="${X(t.editSecret)}"
                            />
                        </td>
                        <td class="p-2 text-right whitespace-nowrap">
                            <button class="button text-xs" data-action="save-edit">Save</button>
                            <button class="button text-xs" data-action="cancel-edit">Cancel</button>
                        </td>
                    </tr>
                `;let h=t.revealedId===i.id?N(i.secret):N(ie(i.secret)),Z=t.copiedId===i.id?"Copied!":"Copy";return`
                <tr class="border-b border-monokai-bg-lighter hover:bg-monokai-bg-lighter">
                    <td class="p-2">
                        <span class="cursor-pointer hover:underline" data-action="start-edit" data-key-id="${i.id}">${N(i.label)}</span>
                    </td>
                    <td class="p-2 font-mono text-xs">
                        <span class="cursor-pointer" data-action="toggle-reveal" data-key-id="${i.id}">${h}</span>
                    </td>
                    <td class="p-2 text-right whitespace-nowrap">
                        <button class="button text-xs" data-action="copy-secret" data-key-id="${i.id}">${Z}</button>
                        <button class="button text-xs" data-action="delete-key" data-key-id="${i.id}">Del</button>
                    </td>
                </tr>
            `}).join(""),f.querySelectorAll('[data-action="start-edit"]').forEach(i=>{i.addEventListener("click",()=>de(i.dataset.keyId))}),f.querySelectorAll('[data-action="toggle-reveal"]').forEach(i=>{i.addEventListener("click",()=>{t.revealedId=t.revealedId===i.dataset.keyId?null:i.dataset.keyId,p()})}),f.querySelectorAll('[data-action="copy-secret"]').forEach(i=>{i.addEventListener("click",()=>fe(i.dataset.keyId))}),f.querySelectorAll('[data-action="delete-key"]').forEach(i=>{i.addEventListener("click",()=>ye(i.dataset.keyId))}),f.querySelectorAll('[data-action="save-edit"]').forEach(i=>{i.addEventListener("click",$)}),f.querySelectorAll('[data-action="cancel-edit"]').forEach(i=>{i.addEventListener("click",R)}),f.querySelectorAll("[data-edit-label]").forEach(i=>{i.addEventListener("input",h=>{t.editLabel=h.target.value}),i.addEventListener("keyup",h=>{h.key==="Enter"&&$(),h.key==="Escape"&&R()})}),f.querySelectorAll("[data-edit-secret]").forEach(i=>{i.addEventListener("input",h=>{t.editSecret=h.target.value}),i.addEventListener("keyup",h=>{h.key==="Enter"&&$(),h.key==="Escape"&&R()})})}let S=l("new-label"),g=l("new-secret"),k=l("add-key-btn");S&&document.activeElement!==S&&(S.value=t.newLabel),g&&document.activeElement!==g&&(g.value=t.newSecret),k&&(k.disabled=t.saving||t.newLabel.trim().length===0||t.newSecret.trim().length===0,k.textContent=t.saving?"Saving...":"Save");let b=l("toast");b&&(b.textContent=t.toast,b.style.display=t.toast?"block":"none")}function N(e){let n=document.createElement("div");return n.textContent=e,n.innerHTML}function X(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}async function ue(){let e=t.newLabel.trim(),n=t.newSecret.trim();if(!e||!n)return;t.saving=!0,p();let o=crypto.randomUUID();await j(o,e,n),t.keys=await x(),t.newLabel="",t.newSecret="",t.syncEnabled&&L()&&await M(),t.saving=!1,v("Key added")}function de(e){let n=t.keys.find(o=>o.id===e);n&&(t.editingId=n.id,t.editLabel=n.label,t.editSecret=n.secret,p())}async function $(){if(!t.editingId)return;let e=t.editLabel.trim(),n=t.editSecret.trim();!e||!n||(await j(t.editingId,e,n),t.keys=await x(),t.editingId=null,t.editLabel="",t.editSecret="",t.syncEnabled&&L()&&await M(),v("Key updated"))}function R(){t.editingId=null,t.editLabel="",t.editSecret="",p()}async function ye(e){let n=t.keys.find(o=>o.id===e);n&&confirm(`Delete "${n.label}"?`)&&(await z(e),t.keys=await x(),t.syncEnabled&&L()&&await M(),v("Key deleted"))}async function fe(e){let n=t.keys.find(o=>o.id===e);n&&(await navigator.clipboard.writeText(n.secret),t.copiedId=e,p(),setTimeout(()=>{t.copiedId=null,p()},2e3),setTimeout(()=>{navigator.clipboard.writeText("").catch(()=>{})},3e4))}async function M(){try{let e=await P(),n=await u.runtime.sendMessage({kind:"apikeys.publish",payload:{keys:e.keys}});return n.success&&await A("synced",n.eventId,n.createdAt),n}catch(e){return await A("local-only"),{success:!1,error:e.message}}}async function U(){t.globalSyncStatus="syncing",t.syncError="",p();try{let e=await u.runtime.sendMessage({kind:"apikeys.fetch"});if(!e.success){t.globalSyncStatus="error",t.syncError=e.error||"Sync failed",p();return}if(e.keys){let n=await P(),o=n.keys;Object.keys(o).length===0?await O(e.keys):(!n.relayCreatedAt||e.createdAt>n.relayCreatedAt)&&await O(e.keys),await A("synced",e.eventId,e.createdAt),t.keys=await x()}t.globalSyncStatus="idle"}catch(e){t.globalSyncStatus="error",t.syncError=e.message||"Sync failed"}p()}async function pe(){await H(t.syncEnabled),t.syncEnabled&&L()&&await U()}async function ge(){let e=await W(),n=JSON.stringify(e,null,2),o=await u.runtime.sendMessage({kind:"apikeys.encrypt",payload:{plainText:n}});if(!o.success){v("Export failed: "+(o.error||"unknown"));return}let s=new Blob([JSON.stringify({encrypted:!0,data:o.cipherText})],{type:"application/json"}),a=URL.createObjectURL(s),c=document.createElement("a");c.href=a,c.download="nostrkey-api-keys-backup.json",c.click(),URL.revokeObjectURL(a),v("Exported")}async function be(e){let n=e.target.files?.[0];if(n){try{let o=await n.text(),s=JSON.parse(o),a;if(s.encrypted&&s.data){let c=await u.runtime.sendMessage({kind:"apikeys.decrypt",payload:{cipherText:s.data}});if(!c.success){v("Decrypt failed: "+(c.error||"unknown"));return}a=JSON.parse(c.plainText)}else a=s;await O(a),t.keys=await x(),t.syncEnabled&&L()&&await M(),v("Imported "+Object.keys(a).length+" keys")}catch(o){v("Import failed: "+o.message)}e.target.value=""}}function Se(){l("sync-btn")?.addEventListener("click",U),l("add-key-btn")?.addEventListener("click",ue),l("export-btn")?.addEventListener("click",ge),l("import-file")?.addEventListener("change",be),l("close-btn")?.addEventListener("click",()=>window.close()),l("sync-toggle")?.addEventListener("change",e=>{t.syncEnabled=e.target.checked,pe()}),l("new-label")?.addEventListener("input",e=>{t.newLabel=e.target.value,p()}),l("new-secret")?.addEventListener("input",e=>{t.newSecret=e.target.value,p()})}async function he(){let e=await u.runtime.sendMessage({kind:"isEncrypted"}),n=l("vault-locked-gate"),o=l("vault-main-content");if(!e){n&&(n.style.display="block"),o&&(o.style.display="none"),l("gate-security-btn")?.addEventListener("click",()=>{let a=u.runtime.getURL("security/security.html");window.open(a,"nostrkey-options")});return}n&&(n.style.display="none"),o&&(o.style.display="block");let s=await u.runtime.sendMessage({kind:"vault.getRelays"});t.relayInfo=s||{read:[],write:[]},t.syncEnabled=await G(),t.keys=await x(),Se(),p(),t.syncEnabled&&L()&&await U()}document.addEventListener("DOMContentLoaded",he);})();
