(()=>{var n=typeof browser<"u"?browser:typeof chrome<"u"?chrome:null;if(!n)throw new Error("browser-polyfill: No extension API namespace found (neither browser nor chrome).");var u=typeof browser>"u"&&typeof chrome<"u";function d(e,s){return(...r)=>{try{let o=s.apply(e,r);if(o&&typeof o.then=="function")return o}catch{}return new Promise((o,i)=>{s.apply(e,[...r,(...c)=>{n.runtime&&n.runtime.lastError?i(new Error(n.runtime.lastError.message)):o(c.length<=1?c[0]:c)}])})}}var l={};l.runtime={sendMessage(...e){return u?d(n.runtime,n.runtime.sendMessage)(...e):n.runtime.sendMessage(...e)},onMessage:n.runtime.onMessage,getURL(e){return n.runtime.getURL(e)},openOptionsPage(){return u?d(n.runtime,n.runtime.openOptionsPage)():n.runtime.openOptionsPage()},get id(){return n.runtime.id}};l.storage={local:{get(...e){return u?d(n.storage.local,n.storage.local.get)(...e):n.storage.local.get(...e)},set(...e){return u?d(n.storage.local,n.storage.local.set)(...e):n.storage.local.set(...e)},clear(...e){return u?d(n.storage.local,n.storage.local.clear)(...e):n.storage.local.clear(...e)},remove(...e){return u?d(n.storage.local,n.storage.local.remove)(...e):n.storage.local.remove(...e)}},sync:n.storage?.sync?{get(...e){return u?d(n.storage.sync,n.storage.sync.get)(...e):n.storage.sync.get(...e)},set(...e){return u?d(n.storage.sync,n.storage.sync.set)(...e):n.storage.sync.set(...e)},remove(...e){return u?d(n.storage.sync,n.storage.sync.remove)(...e):n.storage.sync.remove(...e)},clear(...e){return u?d(n.storage.sync,n.storage.sync.clear)(...e):n.storage.sync.clear(...e)},getBytesInUse(...e){return n.storage.sync.getBytesInUse?u?d(n.storage.sync,n.storage.sync.getBytesInUse)(...e):n.storage.sync.getBytesInUse(...e):Promise.resolve(0)}}:null,onChanged:n.storage?.onChanged||null};l.tabs={create(...e){return u?d(n.tabs,n.tabs.create)(...e):n.tabs.create(...e)},query(...e){return u?d(n.tabs,n.tabs.query)(...e):n.tabs.query(...e)},remove(...e){return u?d(n.tabs,n.tabs.remove)(...e):n.tabs.remove(...e)},update(...e){return u?d(n.tabs,n.tabs.update)(...e):n.tabs.update(...e)},get(...e){return u?d(n.tabs,n.tabs.get)(...e):n.tabs.get(...e)},getCurrent(...e){return u?d(n.tabs,n.tabs.getCurrent)(...e):n.tabs.getCurrent(...e)},sendMessage(...e){return u?d(n.tabs,n.tabs.sendMessage)(...e):n.tabs.sendMessage(...e)}};var Y=102400,j=8192,z=512,Q="_chunk:",V="_sync_meta",M="platformSyncEnabled";var v={P1_PROFILES:1,P2_SETTINGS:2,P3_APIKEYS:3,P4_VAULT:4},$=l.storage.local,P=null;function q(e,s){let r=[];for(let i=0;i<s.length;i+=j-100)r.push(s.slice(i,i+j-100));if(r.length===1)return[{key:e,value:s}];let o=[];for(let i=0;i<r.length;i++)o.push({key:`${Q}${e}:${i}`,value:r[i]});return o.push({key:e,value:JSON.stringify({__chunked:!0,count:r.length})}),o}async function G(){let e=await $.get(null),s=[];if(e.profiles){let o=e.profiles.map(c=>{let{hosts:g,...w}=c;return w}),i=JSON.stringify(o);s.push({key:"profiles",jsonString:i,priority:v.P1_PROFILES,size:i.length})}if(e.profileIndex!=null){let o=JSON.stringify(e.profileIndex);s.push({key:"profileIndex",jsonString:o,priority:v.P1_PROFILES,size:o.length})}if(e.isEncrypted!=null){let o=JSON.stringify(e.isEncrypted);s.push({key:"isEncrypted",jsonString:o,priority:v.P1_PROFILES,size:o.length})}let r=["autoLockMinutes","version","protocol_handler",M];for(let o of r)if(e[o]!=null){let i=JSON.stringify(e[o]);s.push({key:o,jsonString:i,priority:v.P2_SETTINGS,size:i.length})}for(let o of Object.keys(e))if(o.startsWith("feature:")){let i=JSON.stringify(e[o]);s.push({key:o,jsonString:i,priority:v.P2_SETTINGS,size:i.length})}if(e.apiKeyVault){let o=JSON.stringify(e.apiKeyVault);s.push({key:"apiKeyVault",jsonString:o,priority:v.P3_APIKEYS,size:o.length})}if(e.vaultDocs&&typeof e.vaultDocs=="object"){let o=Object.values(e.vaultDocs).sort((i,c)=>(c.updatedAt||0)-(i.updatedAt||0));for(let i of o){let c=`vaultDoc:${i.path}`,g=JSON.stringify(i);s.push({key:c,jsonString:g,priority:v.P4_VAULT,size:g.length})}}return s}async function W(){if(!(!l.storage.sync||!await H()))try{let s=await G();s.sort((m,y)=>m.priority-y.priority);let r=0,o=0,i={},c=[],g=!1;for(let m of s){if(g)break;let y=q(m.key,m.jsonString),S=0;for(let p of y)S+=p.key.length+(typeof p.value=="string"?p.value.length:JSON.stringify(p.value).length);if((r+S>Y-500||o+y.length>z-5)&&!(m.priority<=v.P3_APIKEYS)){g=!0;break}for(let p of y)i[p.key]=p.value,c.push(p.key);r+=S,o+=y.length}let w={lastWrittenAt:Date.now(),keys:c};i[V]=JSON.stringify(w),await l.storage.sync.set(i);try{let m=await l.storage.sync.get(null),y=Object.keys(m).filter(S=>S!==V&&!c.includes(S));y.length>0&&await l.storage.sync.remove(y)}catch{}}catch{}}function R(){l.storage.sync&&(P&&clearTimeout(P),P=setTimeout(()=>{P=null,W()},2e3))}async function H(){return(await $.get({[M]:!0}))[M]}var J=l.storage.local,_="vaultDocs";async function E(){return(await J.get({[_]:{}}))[_]||{}}async function x(e){await J.set({[_]:e}),R()}async function B(){return E()}async function O(e){return(await E())[e]||null}async function k(e,s,r,o=null,i=null){let c=await E(),g=c[e];return c[e]={path:e,content:s,updatedAt:Math.floor(Date.now()/1e3),syncStatus:r,eventId:o,relayCreatedAt:i,profileScope:g?.profileScope??null},await x(c),c[e]}async function C(e){let s=await E();delete s[e],await x(s)}async function b(){let e=await E();return Object.values(e).sort((s,r)=>r.updatedAt-s.updatedAt)}async function D(e,s,r=null,o=null){let i=await E();return i[e]?(i[e].syncStatus=s,r!==null&&(i[e].eventId=r),o!==null&&(i[e].relayCreatedAt=o),await x(i),i[e]):null}var t={documents:[],searchQuery:"",selectedPath:null,editorTitle:"",editorContent:"",pristineTitle:"",pristineContent:"",globalSyncStatus:"idle",syncError:"",saving:!1,isNew:!1,toast:"",relayInfo:{read:[],write:[]}};function a(e){return document.getElementById(e)}function F(){return t.relayInfo.read.length>0||t.relayInfo.write.length>0}function X(){if(!t.searchQuery)return t.documents;let e=t.searchQuery.toLowerCase();return t.documents.filter(s=>s.path.toLowerCase().includes(e))}function Z(){return t.editorContent!==t.pristineContent||t.editorTitle!==t.pristineTitle}function I(e){t.toast=e,f(),setTimeout(()=>{t.toast="",f()},2e3)}function ee(e){return e==="idle"?"bg-green-500":e==="syncing"?"bg-yellow-500 animate-pulse":"bg-red-500"}function te(){return t.globalSyncStatus==="syncing"?"Syncing...":t.globalSyncStatus==="error"?t.syncError:"Synced"}function ne(e){return e==="synced"?"bg-green-500":e==="local-only"?"bg-yellow-500":"bg-red-500"}function f(){let e=a("sync-dot"),s=a("sync-text"),r=a("sync-btn"),o=a("doc-count");e&&(e.className=`inline-block w-3 h-3 rounded-full ${ee(t.globalSyncStatus)}`),s&&(s.textContent=te()),r&&(r.disabled=t.globalSyncStatus==="syncing"||!F()),o&&(o.textContent=t.documents.length+" doc"+(t.documents.length!==1?"s":""));let i=a("file-list"),c=a("no-documents"),g=X();i&&(i.innerHTML=g.map(h=>`
            <div
                class="p-2 cursor-pointer rounded text-sm border border-transparent hover:border-monokai-accent ${t.selectedPath===h.path?"bg-monokai-bg-lighter border-monokai-accent":""}"
                data-doc-path="${h.path}"
            >
                <div class="font-bold truncate">${h.path}</div>
                <div class="flex items-center gap-1 text-xs text-gray-500">
                    <span class="inline-block w-2 h-2 rounded-full ${ne(h.syncStatus)}"></span>
                    <span>${h.syncStatus}</span>
                </div>
            </div>
        `).join(""),i.querySelectorAll("[data-doc-path]").forEach(h=>{h.addEventListener("click",()=>se(h.dataset.docPath))})),c&&(c.style.display=g.length===0?"block":"none");let w=a("editor-panel"),m=a("editor-empty"),y=t.selectedPath!==null||t.isNew;if(w&&(w.style.display=y?"block":"none"),m&&(m.style.display=y?"none":"block"),y){let h=a("editor-title"),N=a("editor-content"),T=a("save-doc-btn"),A=a("delete-doc-btn"),K=a("dirty-label");h&&(h.value=t.editorTitle),N&&(N.value=t.editorContent),T&&(T.disabled=t.saving||t.editorTitle.trim().length===0,T.textContent=t.saving?"Saving...":"Save"),A&&(A.style.display=t.selectedPath!==null&&!t.isNew?"inline-block":"none"),K&&(K.style.display=Z()?"inline":"none")}let S=a("search-input");S&&document.activeElement!==S&&(S.value=t.searchQuery);let p=a("toast");p&&(p.textContent=t.toast,p.style.display=t.toast?"block":"none")}function oe(){t.isNew=!0,t.selectedPath=null,t.editorTitle="",t.editorContent="",t.pristineTitle="",t.pristineContent="",f()}async function se(e){let s=await O(e);s&&(t.isNew=!1,t.selectedPath=e,t.editorTitle=s.path,t.editorContent=s.content,t.pristineTitle=s.path,t.pristineContent=s.content,f())}async function re(){let e=t.editorTitle.trim();if(e){t.saving=!0,f();try{let s=await l.runtime.sendMessage({kind:"vault.publish",payload:{path:e,content:t.editorContent}});s.success?(t.selectedPath&&t.selectedPath!==e&&await C(t.selectedPath),await k(e,t.editorContent,"synced",s.eventId,s.createdAt),t.selectedPath=e,t.isNew=!1,t.pristineTitle=e,t.pristineContent=t.editorContent,t.documents=await b(),I("Saved")):(await k(e,t.editorContent,"local-only"),t.selectedPath&&t.selectedPath!==e&&await C(t.selectedPath),t.selectedPath=e,t.isNew=!1,t.pristineTitle=e,t.pristineContent=t.editorContent,t.documents=await b(),I("Saved locally (relay error: "+(s.error||"unknown")+")"))}catch{await k(t.editorTitle.trim(),t.editorContent,"local-only"),t.selectedPath=t.editorTitle.trim(),t.isNew=!1,t.pristineTitle=t.editorTitle,t.pristineContent=t.editorContent,t.documents=await b(),I("Saved locally (offline)")}t.saving=!1,f()}}async function ie(){if(!t.selectedPath||!confirm(`Delete "${t.selectedPath}"?`))return;let e=await O(t.selectedPath);if(e?.eventId)try{await l.runtime.sendMessage({kind:"vault.delete",payload:{path:t.selectedPath,eventId:e.eventId}})}catch{}await C(t.selectedPath),t.selectedPath=null,t.isNew=!1,t.editorTitle="",t.editorContent="",t.pristineTitle="",t.pristineContent="",t.documents=await b(),I("Deleted"),f()}async function U(){t.globalSyncStatus="syncing",t.syncError="",f();try{let e=await l.runtime.sendMessage({kind:"vault.fetch"});if(!e.success){t.globalSyncStatus="error",t.syncError=e.error||"Sync failed",f();return}let s=await B();for(let r of e.documents){let o=s[r.path];o?o.syncStatus==="local-only"?o.content!==r.content&&await D(r.path,"conflict",r.eventId,r.createdAt):(!o.relayCreatedAt||r.createdAt>o.relayCreatedAt)&&(await k(r.path,r.content,"synced",r.eventId,r.createdAt),t.selectedPath===r.path&&(t.editorContent=r.content,t.pristineContent=r.content)):await k(r.path,r.content,"synced",r.eventId,r.createdAt)}t.documents=await b(),t.globalSyncStatus="idle"}catch(e){t.globalSyncStatus="error",t.syncError=e.message||"Sync failed"}f()}function ae(){a("new-doc-btn")?.addEventListener("click",oe),a("sync-btn")?.addEventListener("click",U),a("save-doc-btn")?.addEventListener("click",re),a("delete-doc-btn")?.addEventListener("click",ie),a("search-input")?.addEventListener("input",e=>{t.searchQuery=e.target.value,f()}),a("editor-title")?.addEventListener("input",e=>{t.editorTitle=e.target.value,f()}),a("editor-content")?.addEventListener("input",e=>{t.editorContent=e.target.value,f()}),a("close-btn")?.addEventListener("click",()=>window.close())}async function ce(){let e=await l.runtime.sendMessage({kind:"isEncrypted"}),s=a("vault-locked-gate"),r=a("vault-main-content");if(!e){s&&(s.style.display="block"),r&&(r.style.display="none"),a("gate-security-btn")?.addEventListener("click",()=>{let o=l.runtime.getURL("security/security.html");window.open(o,"nostrkey-options")});return}s&&(s.style.display="none"),r&&(r.style.display="block");try{let o=await l.runtime.sendMessage({kind:"vault.getRelays"});t.relayInfo=o||{read:[],write:[]}}catch{t.relayInfo={read:[],write:[]}}try{t.documents=await b()}catch{t.documents=[]}if(ae(),f(),F())try{await U()}catch{}}document.addEventListener("DOMContentLoaded",ce);})();
