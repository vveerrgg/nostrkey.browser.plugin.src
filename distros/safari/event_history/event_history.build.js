(()=>{var S=(t,e)=>e.some(n=>t instanceof n),$,F;function et(){return $||($=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function nt(){return F||(F=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var B=new WeakMap,C=new WeakMap,k=new WeakMap;function ot(t){let e=new Promise((n,s)=>{let u=()=>{t.removeEventListener("success",c),t.removeEventListener("error",l)},c=()=>{n(w(t.result)),u()},l=()=>{s(t.error),u()};t.addEventListener("success",c),t.addEventListener("error",l)});return k.set(e,t),e}function rt(t){if(B.has(t))return;let e=new Promise((n,s)=>{let u=()=>{t.removeEventListener("complete",c),t.removeEventListener("error",l),t.removeEventListener("abort",l)},c=()=>{n(),u()},l=()=>{s(t.error||new DOMException("AbortError","AbortError")),u()};t.addEventListener("complete",c),t.addEventListener("error",l),t.addEventListener("abort",l)});B.set(t,e)}var L={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return B.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return w(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function V(t){L=t(L)}function st(t){return nt().includes(t)?function(...e){return t.apply(A(this),e),w(this.request)}:function(...e){return w(t.apply(A(this),e))}}function at(t){return typeof t=="function"?st(t):(t instanceof IDBTransaction&&rt(t),S(t,et())?new Proxy(t,L):t)}function w(t){if(t instanceof IDBRequest)return ot(t);if(C.has(t))return C.get(t);let e=at(t);return e!==t&&(C.set(t,e),k.set(e,t)),e}var A=t=>k.get(t);function W(t,e,{blocked:n,upgrade:s,blocking:u,terminated:c}={}){let l=indexedDB.open(t,e),h=w(l);return s&&l.addEventListener("upgradeneeded",p=>{s(w(l.result),p.oldVersion,p.newVersion,w(l.transaction),p)}),n&&l.addEventListener("blocked",p=>n(p.oldVersion,p.newVersion,p)),h.then(p=>{c&&p.addEventListener("close",()=>c()),u&&p.addEventListener("versionchange",y=>u(y.oldVersion,y.newVersion,y))}).catch(()=>{}),h}function J(t,{blocked:e}={}){let n=indexedDB.deleteDatabase(t);return e&&n.addEventListener("blocked",s=>e(s.oldVersion,s)),w(n).then(()=>{})}var it=["get","getKey","getAll","getAllKeys","count"],ct=["put","add","delete","clear"],K=new Map;function _(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(K.get(e))return K.get(e);let n=e.replace(/FromIndex$/,""),s=e!==n,u=ct.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!(u||it.includes(n)))return;let c=async function(l,...h){let p=this.transaction(l,u?"readwrite":"readonly"),y=p.store;return s&&(y=y.index(h.shift())),(await Promise.all([y[n](...h),u&&p.done]))[0]};return K.set(e,c),c}V(t=>({...t,get:(e,n,s)=>_(e,n)||t.get(e,n,s),has:(e,n)=>!!_(e,n)||t.has(e,n)}));var lt=["continue","continuePrimaryKey","advance"],q={},M=new WeakMap,Y=new WeakMap,ut={get(t,e){if(!lt.includes(e))return t[e];let n=q[e];return n||(n=q[e]=function(...s){M.set(this,Y.get(this)[e](...s))}),n}};async function*pt(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;let n=new Proxy(e,ut);for(Y.set(n,e),k.set(n,A(e));e;)yield n,e=await(M.get(n)||e.continue()),M.delete(n)}function j(t,e){return e===Symbol.asyncIterator&&S(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&S(t,[IDBIndex,IDBObjectStore])}V(t=>({...t,get(e,n,s){return j(e,n)?pt:t.get(e,n,s)},has(e,n){return j(e,n)||t.has(e,n)}}));async function R(){return await W("events",1,{upgrade(t){let e=t.createObjectStore("events",{keyPath:"event.id"});e.createIndex("pubkey","event.pubkey"),e.createIndex("created_at","event.created_at"),e.createIndex("kind","event.kind"),e.createIndex("host","metadata.host")}})}async function z(t,e,n,s){let u=await R(),c=[],l=await u.transaction("events").store.index(t).openCursor(e,n?"next":"prev");for(;l&&(c.push(l.value),!(c.length>=s));)l=await l.continue();return c}async function G(){let t=await R(),e=new Set,n=await t.transaction("events").store.openCursor();for(;n;)e.add(n.value.metadata.host),n=await n.continue();return[...e]}async function Z(){let t=await R(),e=[],n=await t.transaction("events").store.openCursor();for(;n;)e.push(n.value.event),n=await n.continue();e=e.map(c=>JSON.stringify(c)),e=e.join(`
`);let s=new File([e],"events.jsonl",{type:"application/octet-stream"});return new Blob([e],{type:"plain/text"})}var r=typeof browser<"u"?browser:typeof chrome<"u"?chrome:null;if(!r)throw new Error("browser-polyfill: No extension API namespace found (neither browser nor chrome).");var m=typeof browser>"u"&&typeof chrome<"u";function b(t,e){return(...n)=>{try{let s=e.apply(t,n);if(s&&typeof s.then=="function")return s}catch{}return new Promise((s,u)=>{e.apply(t,[...n,(...c)=>{r.runtime&&r.runtime.lastError?u(new Error(r.runtime.lastError.message)):s(c.length<=1?c[0]:c)}])})}}var v={};v.runtime={sendMessage(...t){return m?b(r.runtime,r.runtime.sendMessage)(...t):r.runtime.sendMessage(...t)},onMessage:r.runtime.onMessage,getURL(t){return r.runtime.getURL(t)},openOptionsPage(){return m?b(r.runtime,r.runtime.openOptionsPage)():r.runtime.openOptionsPage()},get id(){return r.runtime.id}};v.storage={local:{get(...t){return m?b(r.storage.local,r.storage.local.get)(...t):r.storage.local.get(...t)},set(...t){return m?b(r.storage.local,r.storage.local.set)(...t):r.storage.local.set(...t)},clear(...t){return m?b(r.storage.local,r.storage.local.clear)(...t):r.storage.local.clear(...t)},remove(...t){return m?b(r.storage.local,r.storage.local.remove)(...t):r.storage.local.remove(...t)}}};v.tabs={create(...t){return m?b(r.tabs,r.tabs.create)(...t):r.tabs.create(...t)},query(...t){return m?b(r.tabs,r.tabs.query)(...t):r.tabs.query(...t)},remove(...t){return m?b(r.tabs,r.tabs.remove)(...t):r.tabs.remove(...t)},update(...t){return m?b(r.tabs,r.tabs.update)(...t):r.tabs.update(...t)},get(...t){return m?b(r.tabs,r.tabs.get)(...t):r.tabs.get(...t)},getCurrent(...t){return m?b(r.tabs,r.tabs.getCurrent)(...t):r.tabs.getCurrent(...t)}};var dt=v.storage.local,Nt=[new URL("wss://relay.damus.io"),new URL("wss://relay.primal.net"),new URL("wss://relay.snort.social"),new URL("wss://relay.getalby.com/v1"),new URL("wss://nos.lol"),new URL("wss://brb.io"),new URL("wss://nostr.orangepill.dev")],T=[[0,"Metadata","https://github.com/nostr-protocol/nips/blob/master/01.md"],[1,"Text","https://github.com/nostr-protocol/nips/blob/master/01.md"],[2,"Recommend Relay","https://github.com/nostr-protocol/nips/blob/master/01.md"],[3,"Contacts","https://github.com/nostr-protocol/nips/blob/master/02.md"],[4,"Encrypted Direct Messages","https://github.com/nostr-protocol/nips/blob/master/04.md"],[5,"Event Deletion","https://github.com/nostr-protocol/nips/blob/master/09.md"],[6,"Repost","https://github.com/nostr-protocol/nips/blob/master/18.md"],[7,"Reaction","https://github.com/nostr-protocol/nips/blob/master/25.md"],[8,"Badge Award","https://github.com/nostr-protocol/nips/blob/master/58.md"],[16,"Generic Repost","https://github.com/nostr-protocol/nips/blob/master/18.md"],[40,"Channel Creation","https://github.com/nostr-protocol/nips/blob/master/28.md"],[41,"Channel Metadata","https://github.com/nostr-protocol/nips/blob/master/28.md"],[42,"Channel Message","https://github.com/nostr-protocol/nips/blob/master/28.md"],[43,"Channel Hide Message","https://github.com/nostr-protocol/nips/blob/master/28.md"],[44,"Channel Mute User","https://github.com/nostr-protocol/nips/blob/master/28.md"],[1063,"File Metadata","https://github.com/nostr-protocol/nips/blob/master/94.md"],[1311,"Live Chat Message","https://github.com/nostr-protocol/nips/blob/master/53.md"],[1984,"Reporting","https://github.com/nostr-protocol/nips/blob/master/56.md"],[1985,"Label","https://github.com/nostr-protocol/nips/blob/master/32.md"],[4550,"Community Post Approval","https://github.com/nostr-protocol/nips/blob/master/72.md"],[7e3,"Job Feedback","https://github.com/nostr-protocol/nips/blob/master/90.md"],[9041,"Zap Goal","https://github.com/nostr-protocol/nips/blob/master/75.md"],[9734,"Zap Request","https://github.com/nostr-protocol/nips/blob/master/57.md"],[9735,"Zap","https://github.com/nostr-protocol/nips/blob/master/57.md"],[1e4,"Mute List","https://github.com/nostr-protocol/nips/blob/master/51.md"],[10001,"Pin List","https://github.com/nostr-protocol/nips/blob/master/51.md"],[10002,"Relay List Metadata","https://github.com/nostr-protocol/nips/blob/master/65.md"],[13194,"Wallet Info","https://github.com/nostr-protocol/nips/blob/master/47.md"],[22242,"Client Authentication","https://github.com/nostr-protocol/nips/blob/master/42.md"],[23194,"Wallet Request","https://github.com/nostr-protocol/nips/blob/master/47.md"],[23195,"Wallet Response","https://github.com/nostr-protocol/nips/blob/master/47.md"],[24133,"Nostr Connect","https://github.com/nostr-protocol/nips/blob/master/46.md"],[27235,"HTTP Auth","https://github.com/nostr-protocol/nips/blob/master/98.md"],[3e4,"Categorized People List","https://github.com/nostr-protocol/nips/blob/master/51.md"],[30001,"Categorized Bookmark List","https://github.com/nostr-protocol/nips/blob/master/51.md"],[30008,"Profile Badges","https://github.com/nostr-protocol/nips/blob/master/58.md"],[30009,"Badge Definition","https://github.com/nostr-protocol/nips/blob/master/58.md"],[30017,"Create or update a stall","https://github.com/nostr-protocol/nips/blob/master/15.md"],[30018,"Create or update a product","https://github.com/nostr-protocol/nips/blob/master/15.md"],[30023,"Long-Form Content","https://github.com/nostr-protocol/nips/blob/master/23.md"],[30024,"Draft Long-form Content","https://github.com/nostr-protocol/nips/blob/master/23.md"],[30078,"Application-specific Data","https://github.com/nostr-protocol/nips/blob/master/78.md"],[30311,"Live Event","https://github.com/nostr-protocol/nips/blob/master/53.md"],[30315,"User Statuses","https://github.com/nostr-protocol/nips/blob/master/38.md"],[30402,"Classified Listing","https://github.com/nostr-protocol/nips/blob/master/99.md"],[30403,"Draft Classified Listing","https://github.com/nostr-protocol/nips/blob/master/99.md"],[31922,"Date-Based Calendar Event","https://github.com/nostr-protocol/nips/blob/master/52.md"],[31923,"Time-Based Calendar Event","https://github.com/nostr-protocol/nips/blob/master/52.md"],[31924,"Calendar","https://github.com/nostr-protocol/nips/blob/master/52.md"],[31925,"Calendar Event RSVP","https://github.com/nostr-protocol/nips/blob/master/52.md"],[31989,"Handler recommendation","https://github.com/nostr-protocol/nips/blob/master/89.md"],[31990,"Handler information","https://github.com/nostr-protocol/nips/blob/master/89.md"],[34550,"Community Definition","https://github.com/nostr-protocol/nips/blob/master/72.md"]];async function Q(){return(await dt.get({profiles:[]})).profiles}var N=new Date;N.setDate(N.getDate()+1);var o={events:[],view:"created_at",max:100,sort:"asc",allHosts:[],host:"",allProfiles:[],profile:"",pubkey:"",selected:null,copied:!1,fromCreatedAt:"2008-10-31",toCreatedAt:N.toISOString().split("T")[0],quickKind:"",fromKind:0,toKind:5e4};function a(t){return document.getElementById(t)}function ft(){let t=new Date(o.fromCreatedAt);return Math.floor(t.getTime()/1e3)}function mt(){let t=new Date(o.toCreatedAt);return Math.floor(t.getTime()/1e3)}function bt(){switch(o.view){case"created_at":return IDBKeyRange.bound(ft(),mt());case"kind":return IDBKeyRange.bound(o.fromKind,o.toKind);case"host":return o.host.length===0?null:IDBKeyRange.only(o.host);case"pubkey":return o.pubkey.length===0?null:IDBKeyRange.only(o.pubkey);default:return null}}function yt(t){return new Date(t*1e3).toUTCString()}function ht(t){let e=T.find(([n])=>n===t);return e?`${e[1]} (${t})`:`Unknown (${t})`}function g(t){let e=document.createElement("div");return e.textContent=t,e.innerHTML}function x(){let t=a("view"),e=a("sort"),n=a("max");t&&document.activeElement!==t&&(t.value=o.view),e&&document.activeElement!==e&&(e.value=o.sort),n&&document.activeElement!==n&&(n.value=o.max);let s=document.querySelectorAll('[data-filter="created_at"]'),u=document.querySelectorAll('[data-filter="kind"]'),c=document.querySelectorAll('[data-filter="host"]'),l=document.querySelectorAll('[data-filter="pubkey"]');s.forEach(i=>i.style.display=o.view==="created_at"?"":"none"),u.forEach(i=>i.style.display=o.view==="kind"?"":"none"),c.forEach(i=>i.style.display=o.view==="host"?"":"none"),l.forEach(i=>i.style.display=o.view==="pubkey"?"":"none");let h=a("fromCreatedAt"),p=a("toCreatedAt");h&&document.activeElement!==h&&(h.value=o.fromCreatedAt),p&&document.activeElement!==p&&(p.value=o.toCreatedAt);let y=a("fromKind"),P=a("toKind");y&&document.activeElement!==y&&(y.value=o.fromKind),P&&document.activeElement!==P&&(P.value=o.toKind);let I=a("kindShortcut");I&&document.activeElement!==I&&(I.value=o.quickKind);let O=a("host");O&&(O.innerHTML='<option value=""></option>'+o.allHosts.map(i=>`<option value="${g(i)}" ${o.host===i?"selected":""}>${g(i)}</option>`).join(""));let U=a("profiles");if(U){let i=o.allProfiles.map(d=>d.name);U.innerHTML='<option value=""></option>'+i.map(d=>`<option value="${g(d)}" ${o.profile===d?"selected":""}>${g(d)}</option>`).join("")}let D=a("pubkey");D&&document.activeElement!==D&&(D.value=o.pubkey);let E=a("event-list");E&&(E.innerHTML=o.events.map((i,d)=>`
            <div class="mt-3 border-solid border border-monokai-bg-lighter rounded-lg">
                <div
                    class="select-none flex cursor-pointer text-sm md:text-xl"
                    data-action="toggle-event"
                    data-index="${d}"
                >
                    <div class="flex-none w-14 p-4 font-extrabold">${o.selected===d?"-":"+"}</div>
                    <div class="flex-1 w-64 p-4">${g(yt(i.metadata.signed_at))}</div>
                    <div class="flex-1 w-64 p-4">${g(i.metadata.host)}</div>
                    <div class="flex-1 w-64 p-4">${g(ht(i.event.kind))}</div>
                </div>
                <div data-action="copy-event" data-index="${d}" class="cursor-pointer">
                    <pre
                        class="rounded-b-lg bg-monokai-bg-lighter text-sm md:text-base p-4 overflow-x-auto"
                        style="display:${o.selected===d?"block":"none"};"
                    >${g(JSON.stringify(i,null,2))}</pre>
                </div>
            </div>
        `).join(""),E.querySelectorAll('[data-action="toggle-event"]').forEach(i=>{i.addEventListener("click",()=>{let d=parseInt(i.dataset.index);o.selected=o.selected===d?null:d,x()})}),E.querySelectorAll('[data-action="copy-event"]').forEach(i=>{i.addEventListener("click",async()=>{let d=parseInt(i.dataset.index);await Et(d)})}));let H=a("copied-toast");H&&(H.style.display=o.copied?"block":"none")}async function f(){let t=await z(o.view,bt(),o.sort==="asc",o.max);o.events=t.map(n=>({...n,copied:!1})),G().then(n=>{o.allHosts=n,x()});let e=await Q();o.allProfiles=await Promise.all(e.map(async(n,s)=>({name:n.name,pubkey:await v.runtime.sendMessage({kind:"getNpub",payload:s})}))),x()}async function gt(){let t=await Z();v.tabs.create({url:URL.createObjectURL(t),active:!0})}async function wt(){confirm("Are you sure you want to delete ALL events?")&&(await J("events"),await f())}function vt(){if(o.quickKind==="")return;let t=parseInt(o.quickKind);o.fromKind=t,o.toKind=t,f()}function xt(){let t=o.allProfiles.find(({name:e})=>e===o.profile);t&&(o.pubkey=t.pubkey,f())}async function Et(t){let e=JSON.stringify(o.events[t]);o.copied=!0,x(),setTimeout(()=>{o.copied=!1,x()},1e3),await navigator.clipboard.writeText(e)}var X=null,tt=null;function kt(){a("view")?.addEventListener("change",t=>{o.view=t.target.value,f()}),a("sort")?.addEventListener("change",t=>{o.sort=t.target.value,f()}),a("max")?.addEventListener("input",t=>{o.max=parseInt(t.target.value)||100,clearTimeout(X),X=setTimeout(()=>f(),750)}),a("fromCreatedAt")?.addEventListener("change",t=>{o.fromCreatedAt=t.target.value,f()}),a("toCreatedAt")?.addEventListener("change",t=>{o.toCreatedAt=t.target.value,f()}),a("kindShortcut")?.addEventListener("change",t=>{o.quickKind=t.target.value,vt()}),a("fromKind")?.addEventListener("change",t=>{o.fromKind=parseInt(t.target.value)||0,f()}),a("toKind")?.addEventListener("change",t=>{o.toKind=parseInt(t.target.value)||5e4,f()}),a("host")?.addEventListener("change",t=>{o.host=t.target.value,f()}),a("profiles")?.addEventListener("change",t=>{o.profile=t.target.value,xt()}),a("pubkey")?.addEventListener("input",t=>{o.pubkey=t.target.value,clearTimeout(tt),tt=setTimeout(()=>f(),500)}),a("save-all-btn")?.addEventListener("click",gt),a("delete-all-btn")?.addEventListener("click",wt),a("close-btn")?.addEventListener("click",()=>window.close())}async function Pt(){let t=a("kindShortcut");t&&(t.innerHTML="<option></option>"+T.map(([e,n])=>`<option value="${e}">${g(n)}</option>`).join("")),kt(),await f()}document.addEventListener("DOMContentLoaded",Pt);})();
