(()=>{function At(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function ee(e,t=""){if(!Number.isSafeInteger(e)||e<0){let n=t&&`"${t}" `;throw new Error(`${n}expected integer >= 0, got ${e}`)}}function q(e,t,n=""){let r=At(e),s=e?.length,o=t!==void 0;if(!r||o&&s!==t){let i=n&&`"${n}" `,a=o?` of length ${t}`:"",c=r?`length=${s}`:`type=${typeof e}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return e}function qe(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash must wrapped by utils.createHasher");ee(e.outputLen),ee(e.blockLen)}function pt(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Ao(e,t){q(e,void 0,"digestInto() output");let n=t.outputLen;if(e.length<n)throw new Error('"digestInto() output" expected to be of length >='+n)}function Vt(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function xe(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function yt(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function Ue(e,t){return e<<32-t|e>>>t}function $(e,t){return e<<t|e>>>32-t>>>0}var ha=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function pa(e){return e<<24&4278190080|e<<8&16711680|e>>>8&65280|e>>>24&255}function ya(e){for(let t=0;t<e.length;t++)e[t]=pa(e[t]);return e}var Dn=ha?e=>e:ya,To=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",ga=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function N(e){if(q(e),To)return e.toHex();let t="";for(let n=0;n<e.length;n++)t+=ga[e[n]];return t}var Ke={_0:48,_9:57,A:65,F:70,a:97,f:102};function Bo(e){if(e>=Ke._0&&e<=Ke._9)return e-Ke._0;if(e>=Ke.A&&e<=Ke.F)return e-(Ke.A-10);if(e>=Ke.a&&e<=Ke.f)return e-(Ke.a-10)}function C(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);if(To)return Uint8Array.fromHex(e);let t=e.length,n=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);let r=new Uint8Array(n);for(let s=0,o=0;s<n;s++,o+=2){let i=Bo(e.charCodeAt(o)),a=Bo(e.charCodeAt(o+1));if(i===void 0||a===void 0){let c=e[o]+e[o+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+o)}r[s]=i*16+a}return r}function wa(e){if(typeof e!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(e))}function Kn(e,t=""){return typeof e=="string"?wa(e):q(e,void 0,t)}function G(...e){let t=0;for(let r=0;r<e.length;r++){let s=e[r];q(s),t+=s.length}let n=new Uint8Array(t);for(let r=0,s=0;r<e.length;r++){let o=e[r];n.set(o,s),s+=o.length}return n}function Wt(e,t){if(t!==void 0&&{}.toString.call(t)!=="[object Object]")throw new Error("options must be object or undefined");return Object.assign(e,t)}function Lo(e,t={}){let n=(s,o)=>e(o).update(s).digest(),r=e(void 0);return n.outputLen=r.outputLen,n.blockLen=r.blockLen,n.create=s=>e(s),Object.assign(n,t),Object.freeze(n)}function ae(e=32){let t=typeof globalThis=="object"?globalThis.crypto:null;if(typeof t?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return t.getRandomValues(new Uint8Array(e))}var Io=e=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,e])});function Ro(e,t,n){return e&t^~e&n}function Uo(e,t,n){return e&t^e&n^t&n}var zt=class{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(t,n,r,s){this.blockLen=t,this.outputLen=n,this.padOffset=r,this.isLE=s,this.buffer=new Uint8Array(t),this.view=yt(this.buffer)}update(t){pt(this),q(t);let{view:n,buffer:r,blockLen:s}=this,o=t.length;for(let i=0;i<o;){let a=Math.min(s-this.pos,o-i);if(a===s){let c=yt(t);for(;s<=o-i;i+=s)this.process(c,i);continue}r.set(t.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){pt(this),Ao(t,this),this.finished=!0;let{buffer:n,view:r,blockLen:s,isLE:o}=this,{pos:i}=this;n[i++]=128,xe(this.buffer.subarray(i)),this.padOffset>s-i&&(this.process(r,0),i=0);for(let f=i;f<s;f++)n[f]=0;r.setBigUint64(s-8,BigInt(this.length*8),o),this.process(r,0);let a=yt(t),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");let l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,u[f],o)}digest(){let{buffer:t,outputLen:n}=this;this.digestInto(t);let r=t.slice(0,n);return this.destroy(),r}_cloneInto(t){t||=new this.constructor,t.set(...this.get());let{blockLen:n,buffer:r,length:s,finished:o,destroyed:i,pos:a}=this;return t.destroyed=i,t.finished=o,t.length=s,t.pos=a,s%n&&t.buffer.set(r),t}clone(){return this._cloneInto()}},$e=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var ba=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Je=new Uint32Array(64),qn=class extends zt{constructor(t){super(64,t,8,!1)}get(){let{A:t,B:n,C:r,D:s,E:o,F:i,G:a,H:c}=this;return[t,n,r,s,o,i,a,c]}set(t,n,r,s,o,i,a,c){this.A=t|0,this.B=n|0,this.C=r|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=c|0}process(t,n){for(let f=0;f<16;f++,n+=4)Je[f]=t.getUint32(n,!1);for(let f=16;f<64;f++){let h=Je[f-15],d=Je[f-2],p=Ue(h,7)^Ue(h,18)^h>>>3,y=Ue(d,17)^Ue(d,19)^d>>>10;Je[f]=y+Je[f-7]+p+Je[f-16]|0}let{A:r,B:s,C:o,D:i,E:a,F:c,G:l,H:u}=this;for(let f=0;f<64;f++){let h=Ue(a,6)^Ue(a,11)^Ue(a,25),d=u+h+Ro(a,c,l)+ba[f]+Je[f]|0,y=(Ue(r,2)^Ue(r,13)^Ue(r,22))+Uo(r,s,o)|0;u=l,l=c,c=a,a=i+d|0,i=o,o=s,s=r,r=d+y|0}r=r+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(r,s,o,i,a,c,l,u)}roundClean(){xe(Je)}destroy(){this.set(0,0,0,0,0,0,0,0),xe(this.buffer)}},$n=class extends qn{A=$e[0]|0;B=$e[1]|0;C=$e[2]|0;D=$e[3]|0;E=$e[4]|0;F=$e[5]|0;G=$e[6]|0;H=$e[7]|0;constructor(){super(32)}};var te=Lo(()=>new $n,Io(1));var Wn=BigInt(0),Vn=BigInt(1);function Tt(e,t=""){if(typeof e!="boolean"){let n=t&&`"${t}" `;throw new Error(n+"expected boolean, got type="+typeof e)}return e}function Po(e){if(typeof e=="bigint"){if(!jt(e))throw new Error("positive bigint expected, got "+e)}else ee(e);return e}function Lt(e){let t=Po(e).toString(16);return t.length&1?"0"+t:t}function Co(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);return e===""?Wn:BigInt("0x"+e)}function Xe(e){return Co(N(e))}function zn(e){return Co(N(ma(q(e)).reverse()))}function Zt(e,t){ee(t),e=Po(e);let n=C(e.toString(16).padStart(t*2,"0"));if(n.length!==t)throw new Error("number too large");return n}function jn(e,t){return Zt(e,t).reverse()}function ma(e){return Uint8Array.from(e)}function Oo(e){return Uint8Array.from(e,(t,n)=>{let r=t.charCodeAt(0);if(t.length!==1||r>127)throw new Error(`string contains non-ASCII character "${e[n]}" with code ${r} at position ${n}`);return r})}var jt=e=>typeof e=="bigint"&&Wn<=e;function xa(e,t,n){return jt(e)&&jt(t)&&jt(n)&&t<=e&&e<n}function No(e,t,n,r){if(!xa(t,n,r))throw new Error("expected valid "+e+": "+n+" <= n < "+r+", got "+t)}function Zn(e){let t;for(t=0;e>Wn;e>>=Vn,t+=1);return t}var It=e=>(Vn<<BigInt(e))-Vn;function Mo(e,t,n){if(ee(e,"hashLen"),ee(t,"qByteLen"),typeof n!="function")throw new Error("hmacFn must be a function");let r=w=>new Uint8Array(w),s=Uint8Array.of(),o=Uint8Array.of(0),i=Uint8Array.of(1),a=1e3,c=r(e),l=r(e),u=0,f=()=>{c.fill(1),l.fill(0),u=0},h=(...w)=>n(l,G(c,...w)),d=(w=s)=>{l=h(o,w),c=h(),w.length!==0&&(l=h(i,w),c=h())},p=()=>{if(u++>=a)throw new Error("drbg: tried max amount of iterations");let w=0,b=[];for(;w<t;){c=h();let B=c.slice();b.push(B),w+=c.length}return G(...b)};return(w,b)=>{f(),d(w);let B;for(;!(B=b(p()));)d();return f(),B}}function Rt(e,t={},n={}){if(!e||typeof e!="object")throw new Error("expected valid options object");function r(o,i,a){let c=e[o];if(a&&c===void 0)return;let l=typeof c;if(l!==i||c===null)throw new Error(`param "${o}" is invalid: expected ${i}, got ${l}`)}let s=(o,i)=>Object.entries(o).forEach(([a,c])=>r(a,c,i));s(t,!1),s(n,!0)}function Fn(e){let t=new WeakMap;return(n,...r)=>{let s=t.get(n);if(s!==void 0)return s;let o=e(n,...r);return t.set(n,o),o}}var we=BigInt(0),ye=BigInt(1),rt=BigInt(2),Ko=BigInt(3),qo=BigInt(4),$o=BigInt(5),va=BigInt(7),Vo=BigInt(8),Ea=BigInt(9),Wo=BigInt(16);function Pe(e,t){let n=e%t;return n>=we?n:t+n}function ve(e,t,n){let r=e;for(;t-- >we;)r*=r,r%=n;return r}function Ho(e,t){if(e===we)throw new Error("invert: expected non-zero number");if(t<=we)throw new Error("invert: expected positive modulus, got "+t);let n=Pe(e,t),r=t,s=we,o=ye,i=ye,a=we;for(;n!==we;){let l=r/n,u=r%n,f=s-i*l,h=o-a*l;r=n,n=u,s=i,o=a,i=f,a=h}if(r!==ye)throw new Error("invert: does not exist");return Pe(s,t)}function Jn(e,t,n){if(!e.eql(e.sqr(t),n))throw new Error("Cannot find square root")}function zo(e,t){let n=(e.ORDER+ye)/qo,r=e.pow(t,n);return Jn(e,r,t),r}function ka(e,t){let n=(e.ORDER-$o)/Vo,r=e.mul(t,rt),s=e.pow(r,n),o=e.mul(t,s),i=e.mul(e.mul(o,rt),s),a=e.mul(o,e.sub(i,e.ONE));return Jn(e,a,t),a}function _a(e){let t=gt(e),n=jo(e),r=n(t,t.neg(t.ONE)),s=n(t,r),o=n(t,t.neg(r)),i=(e+va)/Wo;return(a,c)=>{let l=a.pow(c,i),u=a.mul(l,r),f=a.mul(l,s),h=a.mul(l,o),d=a.eql(a.sqr(u),c),p=a.eql(a.sqr(f),c);l=a.cmov(l,u,d),u=a.cmov(h,f,p);let y=a.eql(a.sqr(u),c),w=a.cmov(l,u,y);return Jn(a,w,c),w}}function jo(e){if(e<Ko)throw new Error("sqrt is not defined for small field");let t=e-ye,n=0;for(;t%rt===we;)t/=rt,n++;let r=rt,s=gt(e);for(;Do(s,r)===1;)if(r++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(n===1)return zo;let o=s.pow(r,t),i=(t+ye)/rt;return function(c,l){if(c.is0(l))return l;if(Do(c,l)!==1)throw new Error("Cannot find square root");let u=n,f=c.mul(c.ONE,o),h=c.pow(l,t),d=c.pow(l,i);for(;!c.eql(h,c.ONE);){if(c.is0(h))return c.ZERO;let p=1,y=c.sqr(h);for(;!c.eql(y,c.ONE);)if(p++,y=c.sqr(y),p===u)throw new Error("Cannot find square root");let w=ye<<BigInt(u-p-1),b=c.pow(f,w);u=p,f=c.sqr(b),h=c.mul(h,f),d=c.mul(d,b)}return d}}function Sa(e){return e%qo===Ko?zo:e%Vo===$o?ka:e%Wo===Ea?_a(e):jo(e)}var Ba=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Xn(e){let t={ORDER:"bigint",BYTES:"number",BITS:"number"},n=Ba.reduce((r,s)=>(r[s]="function",r),t);return Rt(e,n),e}function Aa(e,t,n){if(n<we)throw new Error("invalid exponent, negatives unsupported");if(n===we)return e.ONE;if(n===ye)return t;let r=e.ONE,s=t;for(;n>we;)n&ye&&(r=e.mul(r,s)),s=e.sqr(s),n>>=ye;return r}function Ft(e,t,n=!1){let r=new Array(t.length).fill(n?e.ZERO:void 0),s=t.reduce((i,a,c)=>e.is0(a)?i:(r[c]=i,e.mul(i,a)),e.ONE),o=e.inv(s);return t.reduceRight((i,a,c)=>e.is0(a)?i:(r[c]=e.mul(i,r[c]),e.mul(i,a)),o),r}function Do(e,t){let n=(e.ORDER-ye)/rt,r=e.pow(t,n),s=e.eql(r,e.ONE),o=e.eql(r,e.ZERO),i=e.eql(r,e.neg(e.ONE));if(!s&&!o&&!i)throw new Error("invalid Legendre symbol result");return s?1:o?0:-1}function Ta(e,t){t!==void 0&&ee(t);let n=t!==void 0?t:e.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}var Gn=class{ORDER;BITS;BYTES;isLE;ZERO=we;ONE=ye;_lengths;_sqrt;_mod;constructor(t,n={}){if(t<=we)throw new Error("invalid field: expected ORDER > 0, got "+t);let r;this.isLE=!1,n!=null&&typeof n=="object"&&(typeof n.BITS=="number"&&(r=n.BITS),typeof n.sqrt=="function"&&(this.sqrt=n.sqrt),typeof n.isLE=="boolean"&&(this.isLE=n.isLE),n.allowedLengths&&(this._lengths=n.allowedLengths?.slice()),typeof n.modFromBytes=="boolean"&&(this._mod=n.modFromBytes));let{nBitLength:s,nByteLength:o}=Ta(t,r);if(o>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=t,this.BITS=s,this.BYTES=o,this._sqrt=void 0,Object.preventExtensions(this)}create(t){return Pe(t,this.ORDER)}isValid(t){if(typeof t!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof t);return we<=t&&t<this.ORDER}is0(t){return t===we}isValidNot0(t){return!this.is0(t)&&this.isValid(t)}isOdd(t){return(t&ye)===ye}neg(t){return Pe(-t,this.ORDER)}eql(t,n){return t===n}sqr(t){return Pe(t*t,this.ORDER)}add(t,n){return Pe(t+n,this.ORDER)}sub(t,n){return Pe(t-n,this.ORDER)}mul(t,n){return Pe(t*n,this.ORDER)}pow(t,n){return Aa(this,t,n)}div(t,n){return Pe(t*Ho(n,this.ORDER),this.ORDER)}sqrN(t){return t*t}addN(t,n){return t+n}subN(t,n){return t-n}mulN(t,n){return t*n}inv(t){return Ho(t,this.ORDER)}sqrt(t){return this._sqrt||(this._sqrt=Sa(this.ORDER)),this._sqrt(this,t)}toBytes(t){return this.isLE?jn(t,this.BYTES):Zt(t,this.BYTES)}fromBytes(t,n=!1){q(t);let{_lengths:r,BYTES:s,isLE:o,ORDER:i,_mod:a}=this;if(r){if(!r.includes(t.length)||t.length>s)throw new Error("Field.fromBytes: expected "+r+" bytes, got "+t.length);let l=new Uint8Array(s);l.set(t,o?0:l.length-t.length),t=l}if(t.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+t.length);let c=o?zn(t):Xe(t);if(a&&(c=Pe(c,i)),!n&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(t){return Ft(this,t)}cmov(t,n,r){return r?n:t}};function gt(e,t={}){return new Gn(e,t)}function Zo(e){if(typeof e!="bigint")throw new Error("field order must be bigint");let t=e.toString(2).length;return Math.ceil(t/8)}function Yn(e){let t=Zo(e);return t+Math.ceil(t/2)}function Gt(e,t,n=!1){q(e);let r=e.length,s=Zo(t),o=Yn(t);if(r<16||r<o||r>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+r);let i=n?zn(e):Xe(e),a=Pe(i,t-ye)+ye;return n?jn(a,s):Zt(a,s)}var wt=BigInt(0),ot=BigInt(1);function Ut(e,t){let n=t.negate();return e?n:t}function nr(e,t){let n=Ft(e.Fp,t.map(r=>r.Z));return t.map((r,s)=>e.fromAffine(r.toAffine(n[s])))}function Xo(e,t){if(!Number.isSafeInteger(e)||e<=0||e>t)throw new Error("invalid window size, expected [1.."+t+"], got W="+e)}function Qn(e,t){Xo(e,t);let n=Math.ceil(t/e)+1,r=2**(e-1),s=2**e,o=It(e),i=BigInt(e);return{windows:n,windowSize:r,mask:o,maxNumber:s,shiftBy:i}}function Fo(e,t,n){let{windowSize:r,mask:s,maxNumber:o,shiftBy:i}=n,a=Number(e&s),c=e>>i;a>r&&(a-=o,c+=ot);let l=t*r,u=l+Math.abs(a)-1,f=a===0,h=a<0,d=t%2!==0;return{nextN:c,offset:u,isZero:f,isNeg:h,isNegF:d,offsetF:l}}var er=new WeakMap,Yo=new WeakMap;function tr(e){return Yo.get(e)||1}function Go(e){if(e!==wt)throw new Error("invalid wNAF")}var Jt=class{BASE;ZERO;Fn;bits;constructor(t,n){this.BASE=t.BASE,this.ZERO=t.ZERO,this.Fn=t.Fn,this.bits=n}_unsafeLadder(t,n,r=this.ZERO){let s=t;for(;n>wt;)n&ot&&(r=r.add(s)),s=s.double(),n>>=ot;return r}precomputeWindow(t,n){let{windows:r,windowSize:s}=Qn(n,this.bits),o=[],i=t,a=i;for(let c=0;c<r;c++){a=i,o.push(a);for(let l=1;l<s;l++)a=a.add(i),o.push(a);i=a.double()}return o}wNAF(t,n,r){if(!this.Fn.isValid(r))throw new Error("invalid scalar");let s=this.ZERO,o=this.BASE,i=Qn(t,this.bits);for(let a=0;a<i.windows;a++){let{nextN:c,offset:l,isZero:u,isNeg:f,isNegF:h,offsetF:d}=Fo(r,a,i);r=c,u?o=o.add(Ut(h,n[d])):s=s.add(Ut(f,n[l]))}return Go(r),{p:s,f:o}}wNAFUnsafe(t,n,r,s=this.ZERO){let o=Qn(t,this.bits);for(let i=0;i<o.windows&&r!==wt;i++){let{nextN:a,offset:c,isZero:l,isNeg:u}=Fo(r,i,o);if(r=a,!l){let f=n[c];s=s.add(u?f.negate():f)}}return Go(r),s}getPrecomputes(t,n,r){let s=er.get(n);return s||(s=this.precomputeWindow(n,t),t!==1&&(typeof r=="function"&&(s=r(s)),er.set(n,s))),s}cached(t,n,r){let s=tr(t);return this.wNAF(s,this.getPrecomputes(s,t,r),n)}unsafe(t,n,r,s){let o=tr(t);return o===1?this._unsafeLadder(t,n,s):this.wNAFUnsafe(o,this.getPrecomputes(o,t,r),n,s)}createCache(t,n){Xo(n,this.bits),Yo.set(t,n),er.delete(t)}hasCache(t){return tr(t)!==1}};function Qo(e,t,n,r){let s=t,o=e.ZERO,i=e.ZERO;for(;n>wt||r>wt;)n&ot&&(o=o.add(s)),r&ot&&(i=i.add(s)),s=s.double(),n>>=ot,r>>=ot;return{p1:o,p2:i}}function Jo(e,t,n){if(t){if(t.ORDER!==e)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Xn(t),t}else return gt(e,{isLE:n})}function es(e,t,n={},r){if(r===void 0&&(r=e==="edwards"),!t||typeof t!="object")throw new Error(`expected valid ${e} CURVE object`);for(let c of["p","n","h"]){let l=t[c];if(!(typeof l=="bigint"&&l>wt))throw new Error(`CURVE.${c} must be positive bigint`)}let s=Jo(t.p,n.Fp,r),o=Jo(t.n,n.Fn,r),a=["Gx","Gy","a",e==="weierstrass"?"b":"d"];for(let c of a)if(!s.isValid(t[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return t=Object.freeze(Object.assign({},t)),{CURVE:t,Fp:s,Fn:o}}function Xt(e,t){return function(r){let s=e(r);return{secretKey:s,publicKey:t(s)}}}var Yt=class{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(t,n){if(qe(t),q(n,void 0,"key"),this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let r=this.blockLen,s=new Uint8Array(r);s.set(n.length>r?t.create().update(n).digest():n);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=t.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),xe(s)}update(t){return pt(this),this.iHash.update(t),this}digestInto(t){pt(this),q(t,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){let t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||=Object.create(Object.getPrototypeOf(this),{});let{oHash:n,iHash:r,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return t=t,t.finished=s,t.destroyed=o,t.blockLen=i,t.outputLen=a,t.oHash=n._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},_e=(e,t,n)=>new Yt(e,t).update(n).digest();_e.create=(e,t)=>new Yt(e,t);var ts=(e,t)=>(e+(e>=0?t:-t)/ns)/t;function La(e,t,n){let[[r,s],[o,i]]=t,a=ts(i*e,n),c=ts(-s*e,n),l=e-a*r-c*o,u=-a*s-c*i,f=l<Ve,h=u<Ve;f&&(l=-l),h&&(u=-u);let d=It(Math.ceil(Zn(n)/2))+bt;if(l<Ve||l>=d||u<Ve||u>=d)throw new Error("splitScalar (endomorphism): failed, k="+e);return{k1neg:f,k1:l,k2neg:h,k2:u}}function or(e){if(!["compact","recovered","der"].includes(e))throw new Error('Signature format must be "compact", "recovered", or "der"');return e}function rr(e,t){let n={};for(let r of Object.keys(t))n[r]=e[r]===void 0?t[r]:e[r];return Tt(n.lowS,"lowS"),Tt(n.prehash,"prehash"),n.format!==void 0&&or(n.format),n}var sr=class extends Error{constructor(t=""){super(t)}},Ye={Err:sr,_tlv:{encode:(e,t)=>{let{Err:n}=Ye;if(e<0||e>256)throw new n("tlv.encode: wrong tag");if(t.length&1)throw new n("tlv.encode: unpadded data");let r=t.length/2,s=Lt(r);if(s.length/2&128)throw new n("tlv.encode: long form length too big");let o=r>127?Lt(s.length/2|128):"";return Lt(e)+o+s+t},decode(e,t){let{Err:n}=Ye,r=0;if(e<0||e>256)throw new n("tlv.encode: wrong tag");if(t.length<2||t[r++]!==e)throw new n("tlv.decode: wrong tlv");let s=t[r++],o=!!(s&128),i=0;if(!o)i=s;else{let c=s&127;if(!c)throw new n("tlv.decode(long): indefinite length not supported");if(c>4)throw new n("tlv.decode(long): byte length is too big");let l=t.subarray(r,r+c);if(l.length!==c)throw new n("tlv.decode: length bytes not complete");if(l[0]===0)throw new n("tlv.decode(long): zero leftmost byte");for(let u of l)i=i<<8|u;if(r+=c,i<128)throw new n("tlv.decode(long): not minimal encoding")}let a=t.subarray(r,r+i);if(a.length!==i)throw new n("tlv.decode: wrong value length");return{v:a,l:t.subarray(r+i)}}},_int:{encode(e){let{Err:t}=Ye;if(e<Ve)throw new t("integer: negative integers are not allowed");let n=Lt(e);if(Number.parseInt(n[0],16)&8&&(n="00"+n),n.length&1)throw new t("unexpected DER parsing assertion: unpadded hex");return n},decode(e){let{Err:t}=Ye;if(e[0]&128)throw new t("invalid signature integer: negative");if(e[0]===0&&!(e[1]&128))throw new t("invalid signature integer: unnecessary leading zero");return Xe(e)}},toSig(e){let{Err:t,_int:n,_tlv:r}=Ye,s=q(e,void 0,"signature"),{v:o,l:i}=r.decode(48,s);if(i.length)throw new t("invalid signature: left bytes after parsing");let{v:a,l:c}=r.decode(2,o),{v:l,l:u}=r.decode(2,c);if(u.length)throw new t("invalid signature: left bytes after parsing");return{r:n.decode(a),s:n.decode(l)}},hexFromSig(e){let{_tlv:t,_int:n}=Ye,r=t.encode(2,n.encode(e.r)),s=t.encode(2,n.encode(e.s)),o=r+s;return t.encode(48,o)}},Ve=BigInt(0),bt=BigInt(1),ns=BigInt(2),Qt=BigInt(3),Ia=BigInt(4);function rs(e,t={}){let n=es("weierstrass",e,t),{Fp:r,Fn:s}=n,o=n.CURVE,{h:i,n:a}=o;Rt(t,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});let{endo:c}=t;if(c&&(!r.is0(o.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');let l=ss(r,s);function u(){if(!r.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function f(R,x,m){let{x:g,y:E}=x.toAffine(),_=r.toBytes(g);if(Tt(m,"isCompressed"),m){u();let S=!r.isOdd(E);return G(os(S),_)}else return G(Uint8Array.of(4),_,r.toBytes(E))}function h(R){q(R,void 0,"Point");let{publicKey:x,publicKeyUncompressed:m}=l,g=R.length,E=R[0],_=R.subarray(1);if(g===x&&(E===2||E===3)){let S=r.fromBytes(_);if(!r.isValid(S))throw new Error("bad point: is not on curve, wrong x");let v=y(S),k;try{k=r.sqrt(v)}catch(j){let W=j instanceof Error?": "+j.message:"";throw new Error("bad point: is not on curve, sqrt error"+W)}u();let A=r.isOdd(k);return(E&1)===1!==A&&(k=r.neg(k)),{x:S,y:k}}else if(g===m&&E===4){let S=r.BYTES,v=r.fromBytes(_.subarray(0,S)),k=r.fromBytes(_.subarray(S,S*2));if(!w(v,k))throw new Error("bad point: is not on curve");return{x:v,y:k}}else throw new Error(`bad point: got length ${g}, expected compressed=${x} or uncompressed=${m}`)}let d=t.toBytes||f,p=t.fromBytes||h;function y(R){let x=r.sqr(R),m=r.mul(x,R);return r.add(r.add(m,r.mul(R,o.a)),o.b)}function w(R,x){let m=r.sqr(x),g=y(R);return r.eql(m,g)}if(!w(o.Gx,o.Gy))throw new Error("bad curve params: generator point");let b=r.mul(r.pow(o.a,Qt),Ia),B=r.mul(r.sqr(o.b),BigInt(27));if(r.is0(r.add(b,B)))throw new Error("bad curve params: a or b");function U(R,x,m=!1){if(!r.isValid(x)||m&&r.is0(x))throw new Error(`bad point coordinate ${R}`);return x}function P(R){if(!(R instanceof I))throw new Error("Weierstrass Point expected")}function Y(R){if(!c||!c.basises)throw new Error("no endo");return La(R,c.basises,s.ORDER)}let M=Fn((R,x)=>{let{X:m,Y:g,Z:E}=R;if(r.eql(E,r.ONE))return{x:m,y:g};let _=R.is0();x==null&&(x=_?r.ONE:r.inv(E));let S=r.mul(m,x),v=r.mul(g,x),k=r.mul(E,x);if(_)return{x:r.ZERO,y:r.ZERO};if(!r.eql(k,r.ONE))throw new Error("invZ was invalid");return{x:S,y:v}}),z=Fn(R=>{if(R.is0()){if(t.allowInfinityPoint&&!r.is0(R.Y))return;throw new Error("bad point: ZERO")}let{x,y:m}=R.toAffine();if(!r.isValid(x)||!r.isValid(m))throw new Error("bad point: x or y not field elements");if(!w(x,m))throw new Error("bad point: equation left != right");if(!R.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function V(R,x,m,g,E){return m=new I(r.mul(m.X,R),m.Y,m.Z),x=Ut(g,x),m=Ut(E,m),x.add(m)}class I{static BASE=new I(o.Gx,o.Gy,r.ONE);static ZERO=new I(r.ZERO,r.ONE,r.ZERO);static Fp=r;static Fn=s;X;Y;Z;constructor(x,m,g){this.X=U("x",x),this.Y=U("y",m,!0),this.Z=U("z",g),Object.freeze(this)}static CURVE(){return o}static fromAffine(x){let{x:m,y:g}=x||{};if(!x||!r.isValid(m)||!r.isValid(g))throw new Error("invalid affine point");if(x instanceof I)throw new Error("projective point not allowed");return r.is0(m)&&r.is0(g)?I.ZERO:new I(m,g,r.ONE)}static fromBytes(x){let m=I.fromAffine(p(q(x,void 0,"point")));return m.assertValidity(),m}static fromHex(x){return I.fromBytes(C(x))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(x=8,m=!0){return H.createCache(this,x),m||this.multiply(Qt),this}assertValidity(){z(this)}hasEvenY(){let{y:x}=this.toAffine();if(!r.isOdd)throw new Error("Field doesn't support isOdd");return!r.isOdd(x)}equals(x){P(x);let{X:m,Y:g,Z:E}=this,{X:_,Y:S,Z:v}=x,k=r.eql(r.mul(m,v),r.mul(_,E)),A=r.eql(r.mul(g,v),r.mul(S,E));return k&&A}negate(){return new I(this.X,r.neg(this.Y),this.Z)}double(){let{a:x,b:m}=o,g=r.mul(m,Qt),{X:E,Y:_,Z:S}=this,v=r.ZERO,k=r.ZERO,A=r.ZERO,T=r.mul(E,E),j=r.mul(_,_),W=r.mul(S,S),D=r.mul(E,_);return D=r.add(D,D),A=r.mul(E,S),A=r.add(A,A),v=r.mul(x,A),k=r.mul(g,W),k=r.add(v,k),v=r.sub(j,k),k=r.add(j,k),k=r.mul(v,k),v=r.mul(D,v),A=r.mul(g,A),W=r.mul(x,W),D=r.sub(T,W),D=r.mul(x,D),D=r.add(D,A),A=r.add(T,T),T=r.add(A,T),T=r.add(T,W),T=r.mul(T,D),k=r.add(k,T),W=r.mul(_,S),W=r.add(W,W),T=r.mul(W,D),v=r.sub(v,T),A=r.mul(W,j),A=r.add(A,A),A=r.add(A,A),new I(v,k,A)}add(x){P(x);let{X:m,Y:g,Z:E}=this,{X:_,Y:S,Z:v}=x,k=r.ZERO,A=r.ZERO,T=r.ZERO,j=o.a,W=r.mul(o.b,Qt),D=r.mul(m,_),Z=r.mul(g,S),Q=r.mul(E,v),fe=r.add(m,g),F=r.add(_,S);fe=r.mul(fe,F),F=r.add(D,Z),fe=r.sub(fe,F),F=r.add(m,E);let pe=r.add(_,v);return F=r.mul(F,pe),pe=r.add(D,Q),F=r.sub(F,pe),pe=r.add(g,E),k=r.add(S,v),pe=r.mul(pe,k),k=r.add(Z,Q),pe=r.sub(pe,k),T=r.mul(j,F),k=r.mul(W,Q),T=r.add(k,T),k=r.sub(Z,T),T=r.add(Z,T),A=r.mul(k,T),Z=r.add(D,D),Z=r.add(Z,D),Q=r.mul(j,Q),F=r.mul(W,F),Z=r.add(Z,Q),Q=r.sub(D,Q),Q=r.mul(j,Q),F=r.add(F,Q),D=r.mul(Z,F),A=r.add(A,D),D=r.mul(pe,F),k=r.mul(fe,k),k=r.sub(k,D),D=r.mul(fe,Z),T=r.mul(pe,T),T=r.add(T,D),new I(k,A,T)}subtract(x){return this.add(x.negate())}is0(){return this.equals(I.ZERO)}multiply(x){let{endo:m}=t;if(!s.isValidNot0(x))throw new Error("invalid scalar: out of range");let g,E,_=S=>H.cached(this,S,v=>nr(I,v));if(m){let{k1neg:S,k1:v,k2neg:k,k2:A}=Y(x),{p:T,f:j}=_(v),{p:W,f:D}=_(A);E=j.add(D),g=V(m.beta,T,W,S,k)}else{let{p:S,f:v}=_(x);g=S,E=v}return nr(I,[g,E])[0]}multiplyUnsafe(x){let{endo:m}=t,g=this;if(!s.isValid(x))throw new Error("invalid scalar: out of range");if(x===Ve||g.is0())return I.ZERO;if(x===bt)return g;if(H.hasCache(this))return this.multiply(x);if(m){let{k1neg:E,k1:_,k2neg:S,k2:v}=Y(x),{p1:k,p2:A}=Qo(I,g,_,v);return V(m.beta,k,A,E,S)}else return H.unsafe(g,x)}toAffine(x){return M(this,x)}isTorsionFree(){let{isTorsionFree:x}=t;return i===bt?!0:x?x(I,this):H.unsafe(this,a).is0()}clearCofactor(){let{clearCofactor:x}=t;return i===bt?this:x?x(I,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(x=!0){return Tt(x,"isCompressed"),this.assertValidity(),d(I,this,x)}toHex(x=!0){return N(this.toBytes(x))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}let K=s.BITS,H=new Jt(I,t.endo?Math.ceil(K/2):K);return I.BASE.precompute(8),I}function os(e){return Uint8Array.of(e?2:3)}function ss(e,t){return{secretKey:t.BYTES,publicKey:1+e.BYTES,publicKeyUncompressed:1+2*e.BYTES,publicKeyHasPrefix:!0,signature:2*t.BYTES}}function Ra(e,t={}){let{Fn:n}=e,r=t.randomBytes||ae,s=Object.assign(ss(e.Fp,n),{seed:Yn(n.ORDER)});function o(d){try{let p=n.fromBytes(d);return n.isValidNot0(p)}catch{return!1}}function i(d,p){let{publicKey:y,publicKeyUncompressed:w}=s;try{let b=d.length;return p===!0&&b!==y||p===!1&&b!==w?!1:!!e.fromBytes(d)}catch{return!1}}function a(d=r(s.seed)){return Gt(q(d,s.seed,"seed"),n.ORDER)}function c(d,p=!0){return e.BASE.multiply(n.fromBytes(d)).toBytes(p)}function l(d){let{secretKey:p,publicKey:y,publicKeyUncompressed:w}=s;if(!At(d)||"_lengths"in n&&n._lengths||p===y)return;let b=q(d,void 0,"key").length;return b===y||b===w}function u(d,p,y=!0){if(l(d)===!0)throw new Error("first arg must be private key");if(l(p)===!1)throw new Error("second arg must be public key");let w=n.fromBytes(d);return e.fromBytes(p).multiply(w).toBytes(y)}let f={isValidSecretKey:o,isValidPublicKey:i,randomSecretKey:a},h=Xt(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:u,keygen:h,Point:e,utils:f,lengths:s})}function is(e,t,n={}){qe(t),Rt(n,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),n=Object.assign({},n);let r=n.randomBytes||ae,s=n.hmac||((m,g)=>_e(t,m,g)),{Fp:o,Fn:i}=e,{ORDER:a,BITS:c}=i,{keygen:l,getPublicKey:u,getSharedSecret:f,utils:h,lengths:d}=Ra(e,n),p={prehash:!0,lowS:typeof n.lowS=="boolean"?n.lowS:!0,format:"compact",extraEntropy:!1},y=a*ns<o.ORDER;function w(m){let g=a>>bt;return m>g}function b(m,g){if(!i.isValidNot0(g))throw new Error(`invalid signature ${m}: out of range 1..Point.Fn.ORDER`);return g}function B(){if(y)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function U(m,g){or(g);let E=d.signature,_=g==="compact"?E:g==="recovered"?E+1:void 0;return q(m,_)}class P{r;s;recovery;constructor(g,E,_){if(this.r=b("r",g),this.s=b("s",E),_!=null){if(B(),![0,1,2,3].includes(_))throw new Error("invalid recovery id");this.recovery=_}Object.freeze(this)}static fromBytes(g,E=p.format){U(g,E);let _;if(E==="der"){let{r:A,s:T}=Ye.toSig(q(g));return new P(A,T)}E==="recovered"&&(_=g[0],E="compact",g=g.subarray(1));let S=d.signature/2,v=g.subarray(0,S),k=g.subarray(S,S*2);return new P(i.fromBytes(v),i.fromBytes(k),_)}static fromHex(g,E){return this.fromBytes(C(g),E)}assertRecovery(){let{recovery:g}=this;if(g==null)throw new Error("invalid recovery id: must be present");return g}addRecoveryBit(g){return new P(this.r,this.s,g)}recoverPublicKey(g){let{r:E,s:_}=this,S=this.assertRecovery(),v=S===2||S===3?E+a:E;if(!o.isValid(v))throw new Error("invalid recovery id: sig.r+curve.n != R.x");let k=o.toBytes(v),A=e.fromBytes(G(os((S&1)===0),k)),T=i.inv(v),j=M(q(g,void 0,"msgHash")),W=i.create(-j*T),D=i.create(_*T),Z=e.BASE.multiplyUnsafe(W).add(A.multiplyUnsafe(D));if(Z.is0())throw new Error("invalid recovery: point at infinify");return Z.assertValidity(),Z}hasHighS(){return w(this.s)}toBytes(g=p.format){if(or(g),g==="der")return C(Ye.hexFromSig(this));let{r:E,s:_}=this,S=i.toBytes(E),v=i.toBytes(_);return g==="recovered"?(B(),G(Uint8Array.of(this.assertRecovery()),S,v)):G(S,v)}toHex(g){return N(this.toBytes(g))}}let Y=n.bits2int||function(g){if(g.length>8192)throw new Error("input is too large");let E=Xe(g),_=g.length*8-c;return _>0?E>>BigInt(_):E},M=n.bits2int_modN||function(g){return i.create(Y(g))},z=It(c);function V(m){return No("num < 2^"+c,m,Ve,z),i.toBytes(m)}function I(m,g){return q(m,void 0,"message"),g?q(t(m),void 0,"prehashed message"):m}function K(m,g,E){let{lowS:_,prehash:S,extraEntropy:v}=rr(E,p);m=I(m,S);let k=M(m),A=i.fromBytes(g);if(!i.isValidNot0(A))throw new Error("invalid private key");let T=[V(A),V(k)];if(v!=null&&v!==!1){let Z=v===!0?r(d.secretKey):v;T.push(q(Z,void 0,"extraEntropy"))}let j=G(...T),W=k;function D(Z){let Q=Y(Z);if(!i.isValidNot0(Q))return;let fe=i.inv(Q),F=e.BASE.multiply(Q).toAffine(),pe=i.create(F.x);if(pe===Ve)return;let $t=i.create(fe*i.create(W+pe*A));if($t===Ve)return;let _o=(F.x===pe?0:2)|Number(F.y&bt),So=$t;return _&&w($t)&&(So=i.neg($t),_o^=1),new P(pe,So,y?void 0:_o)}return{seed:j,k2sig:D}}function H(m,g,E={}){let{seed:_,k2sig:S}=K(m,g,E);return Mo(t.outputLen,i.BYTES,s)(_,S).toBytes(E.format)}function R(m,g,E,_={}){let{lowS:S,prehash:v,format:k}=rr(_,p);if(E=q(E,void 0,"publicKey"),g=I(g,v),!At(m)){let A=m instanceof P?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+A)}U(m,k);try{let A=P.fromBytes(m,k),T=e.fromBytes(E);if(S&&A.hasHighS())return!1;let{r:j,s:W}=A,D=M(g),Z=i.inv(W),Q=i.create(D*Z),fe=i.create(j*Z),F=e.BASE.multiplyUnsafe(Q).add(T.multiplyUnsafe(fe));return F.is0()?!1:i.create(F.x)===j}catch{return!1}}function x(m,g,E={}){let{prehash:_}=rr(E,p);return g=I(g,_),P.fromBytes(m,"recovered").recoverPublicKey(g).toBytes()}return Object.freeze({keygen:l,getPublicKey:u,getSharedSecret:f,utils:h,lengths:d,Point:e,sign:H,verify:R,recoverPublicKey:x,Signature:P,hash:t})}var nn={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Ua={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Pa=BigInt(0),ir=BigInt(2);function Ca(e){let t=nn.p,n=BigInt(3),r=BigInt(6),s=BigInt(11),o=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),l=e*e*e%t,u=l*l*e%t,f=ve(u,n,t)*u%t,h=ve(f,n,t)*u%t,d=ve(h,ir,t)*l%t,p=ve(d,s,t)*d%t,y=ve(p,o,t)*p%t,w=ve(y,a,t)*y%t,b=ve(w,c,t)*w%t,B=ve(b,a,t)*y%t,U=ve(B,n,t)*u%t,P=ve(U,i,t)*p%t,Y=ve(P,r,t)*l%t,M=ve(Y,ir,t);if(!en.eql(en.sqr(M),e))throw new Error("Cannot find square root");return M}var en=gt(nn.p,{sqrt:Ca}),st=rs(nn,{Fp:en,endo:Ua}),it=is(st,te),as={};function tn(e,...t){let n=as[e];if(n===void 0){let r=te(Oo(e));n=G(r,r),as[e]=n}return te(G(n,...t))}var cr=e=>e.toBytes(!0).slice(1),lr=e=>e%ir===Pa;function ar(e){let{Fn:t,BASE:n}=st,r=t.fromBytes(e),s=n.multiply(r);return{scalar:lr(s.y)?r:t.neg(r),bytes:cr(s)}}function ls(e){let t=en;if(!t.isValidNot0(e))throw new Error("invalid x: Fail if x \u2265 p");let n=t.create(e*e),r=t.create(n*e+BigInt(7)),s=t.sqrt(r);lr(s)||(s=t.neg(s));let o=st.fromAffine({x:e,y:s});return o.assertValidity(),o}var Pt=Xe;function us(...e){return st.Fn.create(Pt(tn("BIP0340/challenge",...e)))}function cs(e){return ar(e).bytes}function Oa(e,t,n=ae(32)){let{Fn:r}=st,s=q(e,void 0,"message"),{bytes:o,scalar:i}=ar(t),a=q(n,32,"auxRand"),c=r.toBytes(i^Pt(tn("BIP0340/aux",a))),l=tn("BIP0340/nonce",c,o,s),{bytes:u,scalar:f}=ar(l),h=us(u,o,s),d=new Uint8Array(64);if(d.set(u,0),d.set(r.toBytes(r.create(f+h*i)),32),!fs(d,s,o))throw new Error("sign: Invalid signature produced");return d}function fs(e,t,n){let{Fp:r,Fn:s,BASE:o}=st,i=q(e,64,"signature"),a=q(t,void 0,"message"),c=q(n,32,"publicKey");try{let l=ls(Pt(c)),u=Pt(i.subarray(0,32));if(!r.isValidNot0(u))return!1;let f=Pt(i.subarray(32,64));if(!s.isValidNot0(f))return!1;let h=us(s.toBytes(u),cr(l),a),d=o.multiplyUnsafe(f).add(l.multiplyUnsafe(s.neg(h))),{x:p,y}=d.toAffine();return!(d.is0()||!lr(y)||p!==u)}catch{return!1}}var Qe=(()=>{let n=(r=ae(48))=>Gt(r,nn.n);return{keygen:Xt(n,cs),getPublicKey:cs,sign:Oa,verify:fs,Point:st,utils:{randomSecretKey:n,taggedHash:tn,lift_x:ls,pointToBytes:cr},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:64,seed:48}}})();function hr(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function Na(e){if(!hr(e))throw new Error("Uint8Array expected")}function ys(e,t){return Array.isArray(t)?t.length===0?!0:e?t.every(n=>typeof n=="string"):t.every(n=>Number.isSafeInteger(n)):!1}function Ma(e){if(typeof e!="function")throw new Error("function expected");return!0}function at(e,t){if(typeof t!="string")throw new Error(`${e}: string expected`);return!0}function pr(e){if(!Number.isSafeInteger(e))throw new Error(`invalid integer: ${e}`)}function ur(e){if(!Array.isArray(e))throw new Error("array expected")}function on(e,t){if(!ys(!0,t))throw new Error(`${e}: array of strings expected`)}function gs(e,t){if(!ys(!1,t))throw new Error(`${e}: array of numbers expected`)}function ws(...e){let t=o=>o,n=(o,i)=>a=>o(i(a)),r=e.map(o=>o.encode).reduceRight(n,t),s=e.map(o=>o.decode).reduce(n,t);return{encode:r,decode:s}}function bs(e){let t=typeof e=="string"?e.split(""):e,n=t.length;on("alphabet",t);let r=new Map(t.map((s,o)=>[s,o]));return{encode:s=>(ur(s),s.map(o=>{if(!Number.isSafeInteger(o)||o<0||o>=n)throw new Error(`alphabet.encode: digit index outside alphabet "${o}". Allowed: ${e}`);return t[o]})),decode:s=>(ur(s),s.map(o=>{at("alphabet.decode",o);let i=r.get(o);if(i===void 0)throw new Error(`Unknown letter: "${o}". Allowed: ${e}`);return i}))}}function ms(e=""){return at("join",e),{encode:t=>(on("join.decode",t),t.join(e)),decode:t=>(at("join.decode",t),t.split(e))}}function Ha(e,t="="){return pr(e),at("padding",t),{encode(n){for(on("padding.encode",n);n.length*e%8;)n.push(t);return n},decode(n){on("padding.decode",n);let r=n.length;if(r*e%8)throw new Error("padding: invalid, string should have whole number of bytes");for(;r>0&&n[r-1]===t;r--)if((r-1)*e%8===0)throw new Error("padding: invalid, string has too much padding");return n.slice(0,r)}}}var xs=(e,t)=>t===0?e:xs(t,e%t),sn=(e,t)=>e+(t-xs(e,t)),rn=(()=>{let e=[];for(let t=0;t<40;t++)e.push(2**t);return e})();function fr(e,t,n,r){if(ur(e),t<=0||t>32)throw new Error(`convertRadix2: wrong from=${t}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(sn(t,n)>32)throw new Error(`convertRadix2: carry overflow from=${t} to=${n} carryBits=${sn(t,n)}`);let s=0,o=0,i=rn[t],a=rn[n]-1,c=[];for(let l of e){if(pr(l),l>=i)throw new Error(`convertRadix2: invalid data word=${l} from=${t}`);if(s=s<<t|l,o+t>32)throw new Error(`convertRadix2: carry overflow pos=${o} from=${t}`);for(o+=t;o>=n;o-=n)c.push((s>>o-n&a)>>>0);let u=rn[o];if(u===void 0)throw new Error("invalid carry");s&=u-1}if(s=s<<n-o&a,!r&&o>=t)throw new Error("Excess padding");if(!r&&s>0)throw new Error(`Non-zero padding: ${s}`);return r&&o>0&&c.push(s>>>0),c}function vs(e,t=!1){if(pr(e),e<=0||e>32)throw new Error("radix2: bits should be in (0..32]");if(sn(8,e)>32||sn(e,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!hr(n))throw new Error("radix2.encode input should be Uint8Array");return fr(Array.from(n),8,e,!t)},decode:n=>(gs("radix2.decode",n),Uint8Array.from(fr(n,e,8,t)))}}function ds(e){return Ma(e),function(...t){try{return e.apply(null,t)}catch{}}}var Da=typeof Uint8Array.from([]).toBase64=="function"&&typeof Uint8Array.fromBase64=="function",Ka=(e,t)=>{at("base64",e);let n=t?/^[A-Za-z0-9=_-]+$/:/^[A-Za-z0-9=+/]+$/,r=t?"base64url":"base64";if(e.length>0&&!n.test(e))throw new Error("invalid base64");return Uint8Array.fromBase64(e,{alphabet:r,lastChunkHandling:"strict"})},be=Da?{encode(e){return Na(e),e.toBase64()},decode(e){return Ka(e,!1)}}:ws(vs(6),bs("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),Ha(6),ms(""));var dr=ws(bs("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),ms("")),hs=[996825010,642813549,513874426,1027748829,705979059];function Ct(e){let t=e>>25,n=(e&33554431)<<5;for(let r=0;r<hs.length;r++)(t>>r&1)===1&&(n^=hs[r]);return n}function ps(e,t,n=1){let r=e.length,s=1;for(let o=0;o<r;o++){let i=e.charCodeAt(o);if(i<33||i>126)throw new Error(`Invalid prefix (${e})`);s=Ct(s)^i>>5}s=Ct(s);for(let o=0;o<r;o++)s=Ct(s)^e.charCodeAt(o)&31;for(let o of t)s=Ct(s)^o;for(let o=0;o<6;o++)s=Ct(s);return s^=n,dr.encode(fr([s%rn[30]],30,5,!1))}function qa(e){let t=e==="bech32"?1:734539939,n=vs(5),r=n.decode,s=n.encode,o=ds(r);function i(f,h,d=90){at("bech32.encode prefix",f),hr(h)&&(h=Array.from(h)),gs("bech32.encode",h);let p=f.length;if(p===0)throw new TypeError(`Invalid prefix length ${p}`);let y=p+7+h.length;if(d!==!1&&y>d)throw new TypeError(`Length ${y} exceeds limit ${d}`);let w=f.toLowerCase(),b=ps(w,h,t);return`${w}1${dr.encode(h)}${b}`}function a(f,h=90){at("bech32.decode input",f);let d=f.length;if(d<8||h!==!1&&d>h)throw new TypeError(`invalid string length: ${d} (${f}). Expected (8..${h})`);let p=f.toLowerCase();if(f!==p&&f!==f.toUpperCase())throw new Error("String must be lowercase or uppercase");let y=p.lastIndexOf("1");if(y===0||y===-1)throw new Error('Letter "1" must be present between prefix and data only');let w=p.slice(0,y),b=p.slice(y+1);if(b.length<6)throw new Error("Data must be at least 6 characters long");let B=dr.decode(b).slice(0,-6),U=ps(w,B,t);if(!b.endsWith(U))throw new Error(`Invalid checksum in ${f}: expected "${U}"`);return{prefix:w,words:B}}let c=ds(a);function l(f){let{prefix:h,words:d}=a(f,!1);return{prefix:h,words:d,bytes:r(d)}}function u(f,h){return i(f,s(h))}return{encode:i,decode:a,encodeFromBytes:u,decodeToBytes:l,decodeUnsafe:c,fromWords:r,fromWordsUnsafe:o,toWords:s}}var me=qa("bech32");function $a(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function an(e){if(typeof e!="boolean")throw new Error(`boolean expected, not ${e}`)}function Ot(e){if(!Number.isSafeInteger(e)||e<0)throw new Error("positive integer expected, got "+e)}function J(e,t,n=""){let r=$a(e),s=e?.length,o=t!==void 0;if(!r||o&&s!==t){let i=n&&`"${n}" `,a=o?` of length ${t}`:"",c=r?`length=${s}`:`type=${typeof e}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return e}function yr(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Es(e,t){J(e,void 0,"output");let n=t.outputLen;if(e.length<n)throw new Error("digestInto() expects output buffer of length at least "+n)}function oe(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function de(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function ks(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}var Va=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function _s(e,t){return e.buffer===t.buffer&&e.byteOffset<t.byteOffset+t.byteLength&&t.byteOffset<e.byteOffset+e.byteLength}function gr(e,t){if(_s(e,t)&&e.byteOffset<t.byteOffset)throw new Error("complex overlap of input and output is not supported")}function Ss(e,t){if(t==null||typeof t!="object")throw new Error("options must be defined");return Object.assign(e,t)}function ct(e,t){if(e.length!==t.length)return!1;let n=0;for(let r=0;r<e.length;r++)n|=e[r]^t[r];return n===0}var Nt=(e,t)=>{function n(r,...s){if(J(r,void 0,"key"),!Va)throw new Error("Non little-endian hardware is not yet supported");if(e.nonceLength!==void 0){let u=s[0];J(u,e.varSizeNonce?void 0:e.nonceLength,"nonce")}let o=e.tagLength;o&&s[1]!==void 0&&J(s[1],void 0,"AAD");let i=t(r,...s),a=(u,f)=>{if(f!==void 0){if(u!==2)throw new Error("cipher output not supported");J(f,void 0,"output")}},c=!1;return{encrypt(u,f){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,J(u),a(i.encrypt.length,f),i.encrypt(u,f)},decrypt(u,f){if(J(u),o&&u.length<o)throw new Error('"ciphertext" expected length bigger than tagLength='+o);return a(i.decrypt.length,f),i.decrypt(u,f)}}}return Object.assign(n,e),n};function mt(e,t,n=!0){if(t===void 0)return new Uint8Array(e);if(t.length!==e)throw new Error('"output" expected Uint8Array of length '+e+", got: "+t.length);if(n&&!lt(t))throw new Error("invalid output, must be aligned");return t}function wr(e,t,n){an(n);let r=new Uint8Array(16),s=ks(r);return s.setBigUint64(0,BigInt(t),n),s.setBigUint64(8,BigInt(e),n),r}function lt(e){return e.byteOffset%4===0}function Se(e){return Uint8Array.from(e)}var ce=16;var za=283;function As(e){if(![16,24,32].includes(e.length))throw new Error('"aes key" expected Uint8Array of length 16/24/32, got length='+e.length)}function Er(e){return e<<1^za&-(e>>7)}function xt(e,t){let n=0;for(;t>0;t>>=1)n^=e&-(t&1),e=Er(e);return n}var xr=(()=>{let e=new Uint8Array(256);for(let n=0,r=1;n<256;n++,r^=Er(r))e[n]=r;let t=new Uint8Array(256);t[0]=99;for(let n=0;n<255;n++){let r=e[255-n];r|=r<<8,t[e[n]]=(r^r>>4^r>>5^r>>6^r>>7^99)&255}return de(e),t})(),ja=xr.map((e,t)=>xr.indexOf(t)),Za=e=>e<<24|e>>>8,br=e=>e<<8|e>>>24;function Ts(e,t){if(e.length!==256)throw new Error("Wrong sbox length");let n=new Uint32Array(256).map((l,u)=>t(e[u])),r=n.map(br),s=r.map(br),o=s.map(br),i=new Uint32Array(256*256),a=new Uint32Array(256*256),c=new Uint16Array(256*256);for(let l=0;l<256;l++)for(let u=0;u<256;u++){let f=l*256+u;i[f]=n[l]^r[u],a[f]=s[l]^o[u],c[f]=e[l]<<8|e[u]}return{sbox:e,sbox2:c,T0:n,T1:r,T2:s,T3:o,T01:i,T23:a}}var kr=Ts(xr,e=>xt(e,3)<<24|e<<16|e<<8|xt(e,2)),Ls=Ts(ja,e=>xt(e,11)<<24|xt(e,13)<<16|xt(e,9)<<8|xt(e,14)),Fa=(()=>{let e=new Uint8Array(16);for(let t=0,n=1;t<16;t++,n=Er(n))e[t]=n;return e})();function _r(e){J(e);let t=e.length;As(e);let{sbox2:n}=kr,r=[];lt(e)||r.push(e=Se(e));let s=oe(e),o=s.length,i=c=>Ne(n,c,c,c,c),a=new Uint32Array(t+28);a.set(s);for(let c=o;c<a.length;c++){let l=a[c-1];c%o===0?l=i(Za(l))^Fa[c/o-1]:o>6&&c%o===4&&(l=i(l)),a[c]=a[c-o]^l}return de(...r),a}function Ga(e){let t=_r(e),n=t.slice(),r=t.length,{sbox2:s}=kr,{T0:o,T1:i,T2:a,T3:c}=Ls;for(let l=0;l<r;l+=4)for(let u=0;u<4;u++)n[l+u]=t[r-l-4+u];de(t);for(let l=4;l<r-4;l++){let u=n[l],f=Ne(s,u,u,u,u);n[l]=o[f&255]^i[f>>>8&255]^a[f>>>16&255]^c[f>>>24]}return n}function et(e,t,n,r,s,o){return e[n<<8&65280|r>>>8&255]^t[s>>>8&65280|o>>>24&255]}function Ne(e,t,n,r,s){return e[t&255|n&65280]|e[r>>>16&255|s>>>16&65280]<<16}function vr(e,t,n,r,s){let{sbox2:o,T01:i,T23:a}=kr,c=0;t^=e[c++],n^=e[c++],r^=e[c++],s^=e[c++];let l=e.length/4-2;for(let p=0;p<l;p++){let y=e[c++]^et(i,a,t,n,r,s),w=e[c++]^et(i,a,n,r,s,t),b=e[c++]^et(i,a,r,s,t,n),B=e[c++]^et(i,a,s,t,n,r);t=y,n=w,r=b,s=B}let u=e[c++]^Ne(o,t,n,r,s),f=e[c++]^Ne(o,n,r,s,t),h=e[c++]^Ne(o,r,s,t,n),d=e[c++]^Ne(o,s,t,n,r);return{s0:u,s1:f,s2:h,s3:d}}function Ja(e,t,n,r,s){let{sbox2:o,T01:i,T23:a}=Ls,c=0;t^=e[c++],n^=e[c++],r^=e[c++],s^=e[c++];let l=e.length/4-2;for(let p=0;p<l;p++){let y=e[c++]^et(i,a,t,s,r,n),w=e[c++]^et(i,a,n,t,s,r),b=e[c++]^et(i,a,r,n,t,s),B=e[c++]^et(i,a,s,r,n,t);t=y,n=w,r=b,s=B}let u=e[c++]^Ne(o,t,s,r,n),f=e[c++]^Ne(o,n,t,s,r),h=e[c++]^Ne(o,r,n,t,s),d=e[c++]^Ne(o,s,r,n,t);return{s0:u,s1:f,s2:h,s3:d}}function Xa(e){if(J(e),e.length%ce!==0)throw new Error("aes-(cbc/ecb).decrypt ciphertext should consist of blocks with size "+ce)}function Ya(e,t,n){J(e);let r=e.length,s=r%ce;if(!t&&s!==0)throw new Error("aec/(cbc-ecb): unpadded plaintext with disabled padding");lt(e)||(e=Se(e));let o=oe(e);if(t){let a=ce-s;a||(a=ce),r=r+a}n=mt(r,n),gr(e,n);let i=oe(n);return{b:o,o:i,out:n}}function Qa(e,t){if(!t)return e;let n=e.length;if(!n)throw new Error("aes/pcks5: empty ciphertext not allowed");let r=e[n-1];if(r<=0||r>16)throw new Error("aes/pcks5: wrong padding");let s=e.subarray(0,-r);for(let o=0;o<r;o++)if(e[n-o-1]!==r)throw new Error("aes/pcks5: wrong padding");return s}function ec(e){let t=new Uint8Array(16),n=oe(t);t.set(e);let r=ce-e.length;for(let s=ce-r;s<ce;s++)t[s]=r;return n}var Sr=Nt({blockSize:16,nonceLength:16},function(t,n,r={}){let s=!r.disablePadding;return{encrypt(o,i){let a=_r(t),{b:c,o:l,out:u}=Ya(o,s,i),f=n,h=[a];lt(f)||h.push(f=Se(f));let d=oe(f),p=d[0],y=d[1],w=d[2],b=d[3],B=0;for(;B+4<=c.length;)p^=c[B+0],y^=c[B+1],w^=c[B+2],b^=c[B+3],{s0:p,s1:y,s2:w,s3:b}=vr(a,p,y,w,b),l[B++]=p,l[B++]=y,l[B++]=w,l[B++]=b;if(s){let U=ec(o.subarray(B*4));p^=U[0],y^=U[1],w^=U[2],b^=U[3],{s0:p,s1:y,s2:w,s3:b}=vr(a,p,y,w,b),l[B++]=p,l[B++]=y,l[B++]=w,l[B++]=b}return de(...h),u},decrypt(o,i){Xa(o);let a=Ga(t),c=n,l=[a];lt(c)||l.push(c=Se(c));let u=oe(c);i=mt(o.length,i),lt(o)||l.push(o=Se(o)),gr(o,i);let f=oe(o),h=oe(i),d=u[0],p=u[1],y=u[2],w=u[3];for(let b=0;b+4<=f.length;){let B=d,U=p,P=y,Y=w;d=f[b+0],p=f[b+1],y=f[b+2],w=f[b+3];let{s0:M,s1:z,s2:V,s3:I}=Ja(a,d,p,y,w);h[b++]=M^B,h[b++]=z^U,h[b++]=V^P,h[b++]=I^Y}return de(...l),Qa(i,s)}}});function tc(e){return e instanceof Uint32Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint32Array"}function mr(e,t){if(J(t,16,"block"),!tc(e))throw new Error("_encryptBlock accepts result of expandKeyLE");let n=oe(t),{s0:r,s1:s,s2:o,s3:i}=vr(e,n[0],n[1],n[2],n[3]);return n[0]=r,n[1]=s,n[2]=o,n[3]=i,t}function Bs(e){let t=0;for(let n=ce-1;n>=0;n--){let r=(e[n]&128)>>>7;e[n]=e[n]<<1|t,t=r}return t&&(e[ce-1]^=135),e}function cn(e,t){if(e.length!==t.length)throw new Error("xorBlock: blocks must have same length");for(let n=0;n<e.length;n++)e[n]=e[n]^t[n];return e}var ln=class{buffer;destroyed;k1;k2;xk;constructor(t){J(t),As(t),this.xk=_r(t),this.buffer=new Uint8Array(0),this.destroyed=!1;let n=new Uint8Array(ce);mr(this.xk,n),this.k1=Bs(n),this.k2=Bs(new Uint8Array(this.k1))}update(t){let{destroyed:n,buffer:r}=this;if(n)throw new Error("CMAC instance was destroyed");J(t);let s=new Uint8Array(r.length+t.length);return s.set(r),s.set(t,r.length),this.buffer=s,this}digest(){if(this.destroyed)throw new Error("CMAC instance was destroyed");let{buffer:t}=this,n=t.length,r=Math.ceil(n/ce),s;r===0?(r=1,s=!1):s=n%ce===0;let o=(r-1)*ce,i=t.subarray(o),a;if(s)a=cn(new Uint8Array(i),this.k1);else{let l=new Uint8Array(ce);l.set(i),l[i.length]=128,a=cn(l,this.k2)}let c=new Uint8Array(ce);for(let l=0;l<r-1;l++){let u=t.subarray(l*ce,(l+1)*ce);cn(c,u),mr(this.xk,c)}return cn(c,a),mr(this.xk,c),de(a),c}destroy(){let{buffer:t,destroyed:n,xk:r,k1:s,k2:o}=this;n||(this.destroyed=!0,de(t,r,s,o))}},nc=(e,t)=>new ln(e).update(t).digest();nc.create=e=>new ln(e);var Rs=e=>Uint8Array.from(e.split(""),t=>t.charCodeAt(0)),rc=Rs("expand 16-byte k"),oc=Rs("expand 32-byte k"),sc=oe(rc),ic=oe(oc);function L(e,t){return e<<t|e>>>32-t}function Br(e){return e.byteOffset%4===0}var un=64,ac=16,Us=2**32-1,Is=Uint32Array.of();function cc(e,t,n,r,s,o,i,a){let c=s.length,l=new Uint8Array(un),u=oe(l),f=Br(s)&&Br(o),h=f?oe(s):Is,d=f?oe(o):Is;for(let p=0;p<c;i++){if(e(t,n,r,u,i,a),i>=Us)throw new Error("arx: counter overflow");let y=Math.min(un,c-p);if(f&&y===un){let w=p/4;if(p%4!==0)throw new Error("arx: invalid block position");for(let b=0,B;b<ac;b++)B=w+b,d[B]=h[B]^u[b];p+=un;continue}for(let w=0,b;w<y;w++)b=p+w,o[b]=s[b]^l[w];p+=y}}function Ar(e,t){let{allowShortKeys:n,extendNonceFn:r,counterLength:s,counterRight:o,rounds:i}=Ss({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t);if(typeof e!="function")throw new Error("core must be a function");return Ot(s),Ot(i),an(o),an(n),(a,c,l,u,f=0)=>{J(a,void 0,"key"),J(c,void 0,"nonce"),J(l,void 0,"data");let h=l.length;if(u===void 0&&(u=new Uint8Array(h)),J(u,void 0,"output"),Ot(f),f<0||f>=Us)throw new Error("arx: counter overflow");if(u.length<h)throw new Error(`arx: output (${u.length}) is shorter than data (${h})`);let d=[],p=a.length,y,w;if(p===32)d.push(y=Se(a)),w=ic;else if(p===16&&n)y=new Uint8Array(32),y.set(a),y.set(a,16),w=sc,d.push(y);else throw J(a,32,"arx key"),new Error("invalid key size");Br(c)||d.push(c=Se(c));let b=oe(y);if(r){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(w,b,oe(c.subarray(0,16)),b),c=c.subarray(16)}let B=16-s;if(B!==c.length)throw new Error(`arx: nonce must be ${B} or 16 bytes`);if(B!==12){let P=new Uint8Array(12);P.set(c,o?0:12-c.length),c=P,d.push(c)}let U=oe(c);return cc(e,w,b,U,l,u,f,i),de(...d),u}}function he(e,t){return e[t++]&255|(e[t++]&255)<<8}var Tr=class{blockLen=16;outputLen=16;buffer=new Uint8Array(16);r=new Uint16Array(10);h=new Uint16Array(10);pad=new Uint16Array(8);pos=0;finished=!1;constructor(t){t=Se(J(t,32,"key"));let n=he(t,0),r=he(t,2),s=he(t,4),o=he(t,6),i=he(t,8),a=he(t,10),c=he(t,12),l=he(t,14);this.r[0]=n&8191,this.r[1]=(n>>>13|r<<3)&8191,this.r[2]=(r>>>10|s<<6)&7939,this.r[3]=(s>>>7|o<<9)&8191,this.r[4]=(o>>>4|i<<12)&255,this.r[5]=i>>>1&8190,this.r[6]=(i>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=he(t,16+2*u)}process(t,n,r=!1){let s=r?0:2048,{h:o,r:i}=this,a=i[0],c=i[1],l=i[2],u=i[3],f=i[4],h=i[5],d=i[6],p=i[7],y=i[8],w=i[9],b=he(t,n+0),B=he(t,n+2),U=he(t,n+4),P=he(t,n+6),Y=he(t,n+8),M=he(t,n+10),z=he(t,n+12),V=he(t,n+14),I=o[0]+(b&8191),K=o[1]+((b>>>13|B<<3)&8191),H=o[2]+((B>>>10|U<<6)&8191),R=o[3]+((U>>>7|P<<9)&8191),x=o[4]+((P>>>4|Y<<12)&8191),m=o[5]+(Y>>>1&8191),g=o[6]+((Y>>>14|M<<2)&8191),E=o[7]+((M>>>11|z<<5)&8191),_=o[8]+((z>>>8|V<<8)&8191),S=o[9]+(V>>>5|s),v=0,k=v+I*a+K*(5*w)+H*(5*y)+R*(5*p)+x*(5*d);v=k>>>13,k&=8191,k+=m*(5*h)+g*(5*f)+E*(5*u)+_*(5*l)+S*(5*c),v+=k>>>13,k&=8191;let A=v+I*c+K*a+H*(5*w)+R*(5*y)+x*(5*p);v=A>>>13,A&=8191,A+=m*(5*d)+g*(5*h)+E*(5*f)+_*(5*u)+S*(5*l),v+=A>>>13,A&=8191;let T=v+I*l+K*c+H*a+R*(5*w)+x*(5*y);v=T>>>13,T&=8191,T+=m*(5*p)+g*(5*d)+E*(5*h)+_*(5*f)+S*(5*u),v+=T>>>13,T&=8191;let j=v+I*u+K*l+H*c+R*a+x*(5*w);v=j>>>13,j&=8191,j+=m*(5*y)+g*(5*p)+E*(5*d)+_*(5*h)+S*(5*f),v+=j>>>13,j&=8191;let W=v+I*f+K*u+H*l+R*c+x*a;v=W>>>13,W&=8191,W+=m*(5*w)+g*(5*y)+E*(5*p)+_*(5*d)+S*(5*h),v+=W>>>13,W&=8191;let D=v+I*h+K*f+H*u+R*l+x*c;v=D>>>13,D&=8191,D+=m*a+g*(5*w)+E*(5*y)+_*(5*p)+S*(5*d),v+=D>>>13,D&=8191;let Z=v+I*d+K*h+H*f+R*u+x*l;v=Z>>>13,Z&=8191,Z+=m*c+g*a+E*(5*w)+_*(5*y)+S*(5*p),v+=Z>>>13,Z&=8191;let Q=v+I*p+K*d+H*h+R*f+x*u;v=Q>>>13,Q&=8191,Q+=m*l+g*c+E*a+_*(5*w)+S*(5*y),v+=Q>>>13,Q&=8191;let fe=v+I*y+K*p+H*d+R*h+x*f;v=fe>>>13,fe&=8191,fe+=m*u+g*l+E*c+_*a+S*(5*w),v+=fe>>>13,fe&=8191;let F=v+I*w+K*y+H*p+R*d+x*h;v=F>>>13,F&=8191,F+=m*f+g*u+E*l+_*c+S*a,v+=F>>>13,F&=8191,v=(v<<2)+v|0,v=v+k|0,k=v&8191,v=v>>>13,A+=v,o[0]=k,o[1]=A,o[2]=T,o[3]=j,o[4]=W,o[5]=D,o[6]=Z,o[7]=Q,o[8]=fe,o[9]=F}finalize(){let{h:t,pad:n}=this,r=new Uint16Array(10),s=t[1]>>>13;t[1]&=8191;for(let a=2;a<10;a++)t[a]+=s,s=t[a]>>>13,t[a]&=8191;t[0]+=s*5,s=t[0]>>>13,t[0]&=8191,t[1]+=s,s=t[1]>>>13,t[1]&=8191,t[2]+=s,r[0]=t[0]+5,s=r[0]>>>13,r[0]&=8191;for(let a=1;a<10;a++)r[a]=t[a]+s,s=r[a]>>>13,r[a]&=8191;r[9]-=8192;let o=(s^1)-1;for(let a=0;a<10;a++)r[a]&=o;o=~o;for(let a=0;a<10;a++)t[a]=t[a]&o|r[a];t[0]=(t[0]|t[1]<<13)&65535,t[1]=(t[1]>>>3|t[2]<<10)&65535,t[2]=(t[2]>>>6|t[3]<<7)&65535,t[3]=(t[3]>>>9|t[4]<<4)&65535,t[4]=(t[4]>>>12|t[5]<<1|t[6]<<14)&65535,t[5]=(t[6]>>>2|t[7]<<11)&65535,t[6]=(t[7]>>>5|t[8]<<8)&65535,t[7]=(t[8]>>>8|t[9]<<5)&65535;let i=t[0]+n[0];t[0]=i&65535;for(let a=1;a<8;a++)i=(t[a]+n[a]|0)+(i>>>16)|0,t[a]=i&65535;de(r)}update(t){yr(this),J(t),t=Se(t);let{buffer:n,blockLen:r}=this,s=t.length;for(let o=0;o<s;){let i=Math.min(r-this.pos,s-o);if(i===r){for(;r<=s-o;o+=r)this.process(t,o);continue}n.set(t.subarray(o,o+i),this.pos),this.pos+=i,o+=i,this.pos===r&&(this.process(n,0,!1),this.pos=0)}return this}destroy(){de(this.h,this.r,this.buffer,this.pad)}digestInto(t){yr(this),Es(t,this),this.finished=!0;let{buffer:n,h:r}=this,{pos:s}=this;if(s){for(n[s++]=1;s<16;s++)n[s]=0;this.process(n,0,!0)}this.finalize();let o=0;for(let i=0;i<8;i++)t[o++]=r[i]>>>0,t[o++]=r[i]>>>8;return t}digest(){let{buffer:t,outputLen:n}=this;this.digestInto(t);let r=t.slice(0,n);return this.destroy(),r}};function lc(e){let t=(r,s)=>e(s).update(r).digest(),n=e(new Uint8Array(32));return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=r=>e(r),t}var Ps=lc(e=>new Tr(e));function Ns(e,t,n,r,s,o=20){let i=e[0],a=e[1],c=e[2],l=e[3],u=t[0],f=t[1],h=t[2],d=t[3],p=t[4],y=t[5],w=t[6],b=t[7],B=s,U=n[0],P=n[1],Y=n[2],M=i,z=a,V=c,I=l,K=u,H=f,R=h,x=d,m=p,g=y,E=w,_=b,S=B,v=U,k=P,A=Y;for(let j=0;j<o;j+=2)M=M+K|0,S=L(S^M,16),m=m+S|0,K=L(K^m,12),M=M+K|0,S=L(S^M,8),m=m+S|0,K=L(K^m,7),z=z+H|0,v=L(v^z,16),g=g+v|0,H=L(H^g,12),z=z+H|0,v=L(v^z,8),g=g+v|0,H=L(H^g,7),V=V+R|0,k=L(k^V,16),E=E+k|0,R=L(R^E,12),V=V+R|0,k=L(k^V,8),E=E+k|0,R=L(R^E,7),I=I+x|0,A=L(A^I,16),_=_+A|0,x=L(x^_,12),I=I+x|0,A=L(A^I,8),_=_+A|0,x=L(x^_,7),M=M+H|0,A=L(A^M,16),E=E+A|0,H=L(H^E,12),M=M+H|0,A=L(A^M,8),E=E+A|0,H=L(H^E,7),z=z+R|0,S=L(S^z,16),_=_+S|0,R=L(R^_,12),z=z+R|0,S=L(S^z,8),_=_+S|0,R=L(R^_,7),V=V+x|0,v=L(v^V,16),m=m+v|0,x=L(x^m,12),V=V+x|0,v=L(v^V,8),m=m+v|0,x=L(x^m,7),I=I+K|0,k=L(k^I,16),g=g+k|0,K=L(K^g,12),I=I+K|0,k=L(k^I,8),g=g+k|0,K=L(K^g,7);let T=0;r[T++]=i+M|0,r[T++]=a+z|0,r[T++]=c+V|0,r[T++]=l+I|0,r[T++]=u+K|0,r[T++]=f+H|0,r[T++]=h+R|0,r[T++]=d+x|0,r[T++]=p+m|0,r[T++]=y+g|0,r[T++]=w+E|0,r[T++]=b+_|0,r[T++]=B+S|0,r[T++]=U+v|0,r[T++]=P+k|0,r[T++]=Y+A|0}function uc(e,t,n,r){let s=e[0],o=e[1],i=e[2],a=e[3],c=t[0],l=t[1],u=t[2],f=t[3],h=t[4],d=t[5],p=t[6],y=t[7],w=n[0],b=n[1],B=n[2],U=n[3];for(let Y=0;Y<20;Y+=2)s=s+c|0,w=L(w^s,16),h=h+w|0,c=L(c^h,12),s=s+c|0,w=L(w^s,8),h=h+w|0,c=L(c^h,7),o=o+l|0,b=L(b^o,16),d=d+b|0,l=L(l^d,12),o=o+l|0,b=L(b^o,8),d=d+b|0,l=L(l^d,7),i=i+u|0,B=L(B^i,16),p=p+B|0,u=L(u^p,12),i=i+u|0,B=L(B^i,8),p=p+B|0,u=L(u^p,7),a=a+f|0,U=L(U^a,16),y=y+U|0,f=L(f^y,12),a=a+f|0,U=L(U^a,8),y=y+U|0,f=L(f^y,7),s=s+l|0,U=L(U^s,16),p=p+U|0,l=L(l^p,12),s=s+l|0,U=L(U^s,8),p=p+U|0,l=L(l^p,7),o=o+u|0,w=L(w^o,16),y=y+w|0,u=L(u^y,12),o=o+u|0,w=L(w^o,8),y=y+w|0,u=L(u^y,7),i=i+f|0,b=L(b^i,16),h=h+b|0,f=L(f^h,12),i=i+f|0,b=L(b^i,8),h=h+b|0,f=L(f^h,7),a=a+c|0,B=L(B^a,16),d=d+B|0,c=L(c^d,12),a=a+c|0,B=L(B^a,8),d=d+B|0,c=L(c^d,7);let P=0;r[P++]=s,r[P++]=o,r[P++]=i,r[P++]=a,r[P++]=w,r[P++]=b,r[P++]=B,r[P++]=U}var ut=Ar(Ns,{counterRight:!1,counterLength:4,allowShortKeys:!1}),fc=Ar(Ns,{counterRight:!1,counterLength:8,extendNonceFn:uc,allowShortKeys:!1});var dc=new Uint8Array(16),Cs=(e,t)=>{e.update(t);let n=t.length%16;n&&e.update(dc.subarray(n))},hc=new Uint8Array(32);function Os(e,t,n,r,s){s!==void 0&&J(s,void 0,"AAD");let o=e(t,n,hc),i=wr(r.length,s?s.length:0,!0),a=Ps.create(o);s&&Cs(a,s),Cs(a,r),a.update(i);let c=a.digest();return de(o,i),c}var Ms=e=>(t,n,r)=>({encrypt(o,i){let a=o.length;i=mt(a+16,i,!1),i.set(o);let c=i.subarray(0,-16);e(t,n,c,c,1);let l=Os(e,t,n,c,r);return i.set(l,a),de(l),i},decrypt(o,i){i=mt(o.length-16,i,!1);let a=o.subarray(0,-16),c=o.subarray(-16),l=Os(e,t,n,a,r);if(!ct(c,l))throw new Error("invalid tag");return i.set(o.subarray(0,-16)),e(t,n,i,i,1),de(l),i}}),_h=Nt({blockSize:64,nonceLength:12,tagLength:16},Ms(ut)),Lr=Nt({blockSize:64,nonceLength:24,tagLength:16},Ms(fc));function fn(e,t,n){return qe(e),n===void 0&&(n=new Uint8Array(e.outputLen)),_e(e,n,t)}var Ir=Uint8Array.of(0),Hs=Uint8Array.of();function dn(e,t,n,r=32){qe(e),ee(r,"length");let s=e.outputLen;if(r>255*s)throw new Error("Length must be <= 255*HashLen");let o=Math.ceil(r/s);n===void 0?n=Hs:q(n,void 0,"info");let i=new Uint8Array(o*s),a=_e.create(e,t),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let u=0;u<o;u++)Ir[0]=u+1,c.update(u===0?Hs:l).update(n).update(Ir).digestInto(l),i.set(l,s*u),a._cloneInto(c);return a.destroy(),c.destroy(),xe(l,Ir),i.slice(0,r)}var pc=Object.defineProperty,X=(e,t)=>{for(var n in t)pc(e,n,{get:t[n],enumerable:!0})},vt=Symbol("verified"),yc=e=>e instanceof Object;function Or(e){if(!yc(e)||typeof e.kind!="number"||typeof e.content!="string"||typeof e.created_at!="number"||typeof e.pubkey!="string"||!e.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(e.tags))return!1;for(let t=0;t<e.tags.length;t++){let n=e.tags[t];if(!Array.isArray(n))return!1;for(let r=0;r<n.length;r++)if(typeof n[r]!="string")return!1}return!0}var gc={};X(gc,{binarySearch:()=>Nr,bytesToHex:()=>N,hexToBytes:()=>C,insertEventIntoAscendingList:()=>mc,insertEventIntoDescendingList:()=>bc,mergeReverseSortedLists:()=>xc,normalizeURL:()=>wc,utf8Decoder:()=>je,utf8Encoder:()=>Be});var je=new TextDecoder("utf-8"),Be=new TextEncoder;function wc(e){try{e.indexOf("://")===-1&&(e="wss://"+e);let t=new URL(e);return t.protocol==="http:"?t.protocol="ws:":t.protocol==="https:"&&(t.protocol="wss:"),t.pathname=t.pathname.replace(/\/+/g,"/"),t.pathname.endsWith("/")&&(t.pathname=t.pathname.slice(0,-1)),(t.port==="80"&&t.protocol==="ws:"||t.port==="443"&&t.protocol==="wss:")&&(t.port=""),t.searchParams.sort(),t.hash="",t.toString()}catch{throw new Error(`Invalid URL: ${e}`)}}function bc(e,t){let[n,r]=Nr(e,s=>t.id===s.id?0:t.created_at===s.created_at?-1:s.created_at-t.created_at);return r||e.splice(n,0,t),e}function mc(e,t){let[n,r]=Nr(e,s=>t.id===s.id?0:t.created_at===s.created_at?-1:t.created_at-s.created_at);return r||e.splice(n,0,t),e}function Nr(e,t){let n=0,r=e.length-1;for(;n<=r;){let s=Math.floor((n+r)/2),o=t(e[s]);if(o===0)return[s,!0];o<0?r=s-1:n=s+1}return[n,!1]}function xc(e,t){let n=new Array(e.length+t.length);n.length=0;let r=0,s=0,o=[];for(;r<e.length&&s<t.length;){let i;if(e[r]?.created_at>t[s]?.created_at?(i=e[r],r++):(i=t[s],s++),n.length>0&&n[n.length-1].created_at===i.created_at){if(o.includes(i.id))continue}else o.length=0;n.push(i),o.push(i.id)}for(;r<e.length;){let i=e[r];if(r++,n.length>0&&n[n.length-1].created_at===i.created_at){if(o.includes(i.id))continue}else o.length=0;n.push(i),o.push(i.id)}for(;s<t.length;){let i=t[s];if(s++,n.length>0&&n[n.length-1].created_at===i.created_at){if(o.includes(i.id))continue}else o.length=0;n.push(i),o.push(i.id)}return n}var vc=class{generateSecretKey(){return Qe.utils.randomSecretKey()}getPublicKey(e){return N(Qe.getPublicKey(e))}finalizeEvent(e,t){let n=e;return n.pubkey=N(Qe.getPublicKey(t)),n.id=pn(n),n.sig=N(Qe.sign(C(pn(n)),t)),n[vt]=!0,n}verifyEvent(e){if(typeof e[vt]=="boolean")return e[vt];let t=pn(e);if(t!==e.id)return e[vt]=!1,!1;try{let n=Qe.verify(C(e.sig),C(t),C(e.pubkey));return e[vt]=n,n}catch{return e[vt]=!1,!1}}};function Ec(e){if(!Or(e))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content])}function pn(e){let t=te(Be.encode(Ec(e)));return N(t)}var wn=new vc,kc=wn.generateSecretKey,Me=wn.getPublicKey,le=wn.finalizeEvent,Mr=wn.verifyEvent,_c={};X(_c,{Application:()=>Nl,BadgeAward:()=>Uc,BadgeDefinition:()=>Ll,BlockedRelaysList:()=>fl,BlossomServerList:()=>bl,BookmarkList:()=>cl,Bookmarksets:()=>Bl,Calendar:()=>Vl,CalendarEventRSVP:()=>Wl,ChannelCreation:()=>js,ChannelHideMessage:()=>Gs,ChannelMessage:()=>Fs,ChannelMetadata:()=>Zs,ChannelMuteUser:()=>Js,ChatMessage:()=>Pc,ClassifiedListing:()=>Dl,ClientAuth:()=>Ys,Comment:()=>$c,CommunitiesList:()=>ll,CommunityDefinition:()=>Fl,CommunityPostApproval:()=>Jc,Contacts:()=>Lc,CreateOrUpdateProduct:()=>Ul,CreateOrUpdateStall:()=>Rl,Curationsets:()=>Al,Date:()=>ql,DirectMessageRelaysList:()=>gl,DraftClassifiedListing:()=>Kl,DraftLong:()=>Cl,Emojisets:()=>Ol,EncryptedDirectMessage:()=>Ic,EventDeletion:()=>Rc,FavoriteRelays:()=>hl,FileMessage:()=>Oc,FileMetadata:()=>qc,FileServerPreference:()=>wl,Followsets:()=>kl,ForumThread:()=>Cc,GenericRepost:()=>$r,Genericlists:()=>_l,GiftWrap:()=>Xs,GroupMetadata:()=>Gl,HTTPAuth:()=>Vr,Handlerinformation:()=>Zl,Handlerrecommendation:()=>jl,Highlights:()=>rl,InterestsList:()=>pl,Interestsets:()=>Il,JobFeedback:()=>Qc,JobRequest:()=>Xc,JobResult:()=>Yc,Label:()=>Gc,LightningPubRPC:()=>xl,LiveChatMessage:()=>Vc,LiveEvent:()=>Ml,LongFormArticle:()=>Pl,Metadata:()=>Ac,Mutelist:()=>sl,NWCWalletInfo:()=>ml,NWCWalletRequest:()=>Qs,NWCWalletResponse:()=>vl,NormalVideo:()=>Mc,NostrConnect:()=>El,OpenTimestamps:()=>Dc,Photo:()=>Nc,Pinlist:()=>il,Poll:()=>Kc,PollResponse:()=>ol,PrivateDirectMessage:()=>zs,ProblemTracker:()=>jc,ProfileBadges:()=>Tl,PublicChatsList:()=>ul,Reaction:()=>qr,RecommendRelay:()=>Tc,RelayList:()=>al,RelayReview:()=>zl,Relaysets:()=>Sl,Report:()=>Zc,Reporting:()=>Fc,Repost:()=>Kr,Seal:()=>Ws,SearchRelaysList:()=>dl,ShortTextNote:()=>Vs,ShortVideo:()=>Hc,Time:()=>$l,UserEmojiList:()=>yl,UserStatuses:()=>Hl,Voice:()=>Wc,VoiceComment:()=>zc,Zap:()=>nl,ZapGoal:()=>el,ZapRequest:()=>tl,classifyKind:()=>Sc,isAddressableKind:()=>Dr,isEphemeralKind:()=>$s,isKind:()=>Bc,isRegularKind:()=>qs,isReplaceableKind:()=>Hr});function qs(e){return e<1e4&&e!==0&&e!==3}function Hr(e){return e===0||e===3||1e4<=e&&e<2e4}function $s(e){return 2e4<=e&&e<3e4}function Dr(e){return 3e4<=e&&e<4e4}function Sc(e){return qs(e)?"regular":Hr(e)?"replaceable":$s(e)?"ephemeral":Dr(e)?"parameterized":"unknown"}function Bc(e,t){let n=t instanceof Array?t:[t];return Or(e)&&n.includes(e.kind)||!1}var Ac=0,Vs=1,Tc=2,Lc=3,Ic=4,Rc=5,Kr=6,qr=7,Uc=8,Pc=9,Cc=11,Ws=13,zs=14,Oc=15,$r=16,Nc=20,Mc=21,Hc=22,js=40,Zs=41,Fs=42,Gs=43,Js=44,Dc=1040,Xs=1059,Kc=1068,qc=1063,$c=1111,Vc=1311,Wc=1222,zc=1244,jc=1971,Zc=1984,Fc=1984,Gc=1985,Jc=4550,Xc=5999,Yc=6999,Qc=7e3,el=9041,tl=9734,nl=9735,rl=9802,ol=1018,sl=1e4,il=10001,al=10002,cl=10003,ll=10004,ul=10005,fl=10006,dl=10007,hl=10012,pl=10015,yl=10030,gl=10050,wl=10096,bl=10063,ml=13194,xl=21e3,Ys=22242,Qs=23194,vl=23195,El=24133,Vr=27235,kl=3e4,_l=30001,Sl=30002,Bl=30003,Al=30004,Tl=30008,Ll=30009,Il=30015,Rl=30017,Ul=30018,Pl=30023,Cl=30024,Ol=30030,Nl=30078,Ml=30311,Hl=30315,Dl=30402,Kl=30403,ql=31922,$l=31923,Vl=31924,Wl=31925,zl=31987,jl=31989,Zl=31990,Fl=34550,Gl=39e3;var Jl={};X(Jl,{getHex64:()=>Wr,getInt:()=>ei,getSubscriptionId:()=>Xl,matchEventId:()=>Yl,matchEventKind:()=>eu,matchEventPubkey:()=>Ql});function Wr(e,t){let n=t.length+3,r=e.indexOf(`"${t}":`)+n,s=e.slice(r).indexOf('"')+r+1;return e.slice(s,s+64)}function ei(e,t){let n=t.length,r=e.indexOf(`"${t}":`)+n+3,s=e.slice(r),o=Math.min(s.indexOf(","),s.indexOf("}"));return parseInt(s.slice(0,o),10)}function Xl(e){let t=e.slice(0,22).indexOf('"EVENT"');if(t===-1)return null;let n=e.slice(t+7+1).indexOf('"');if(n===-1)return null;let r=t+7+1+n,s=e.slice(r+1,80).indexOf('"');if(s===-1)return null;let o=r+1+s;return e.slice(r+1,o)}function Yl(e,t){return t===Wr(e,"id")}function Ql(e,t){return t===Wr(e,"pubkey")}function eu(e,t){return t===ei(e,"kind")}var tu={};X(tu,{makeAuthEvent:()=>nu});function nu(e,t){return{kind:Ys,created_at:Math.floor(Date.now()/1e3),tags:[["relay",e],["challenge",t]],content:""}}var ru;try{ru=WebSocket}catch{}var ou;try{ou=WebSocket}catch{}var Ze={};X(Ze,{BECH32_REGEX:()=>ti,Bech32MaxSize:()=>zr,NostrTypeGuard:()=>su,decode:()=>bn,decodeNostrURI:()=>au,encodeBytes:()=>xn,naddrEncode:()=>hu,neventEncode:()=>du,noteEncode:()=>uu,nprofileEncode:()=>fu,npubEncode:()=>lu,nsecEncode:()=>cu});var su={isNProfile:e=>/^nprofile1[a-z\d]+$/.test(e||""),isNEvent:e=>/^nevent1[a-z\d]+$/.test(e||""),isNAddr:e=>/^naddr1[a-z\d]+$/.test(e||""),isNSec:e=>/^nsec1[a-z\d]{58}$/.test(e||""),isNPub:e=>/^npub1[a-z\d]{58}$/.test(e||""),isNote:e=>/^note1[a-z\d]+$/.test(e||""),isNcryptsec:e=>/^ncryptsec1[a-z\d]+$/.test(e||"")},zr=5e3,ti=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function iu(e){let t=new Uint8Array(4);return t[0]=e>>24&255,t[1]=e>>16&255,t[2]=e>>8&255,t[3]=e&255,t}function au(e){try{return e.startsWith("nostr:")&&(e=e.substring(6)),bn(e)}catch{return{type:"invalid",data:null}}}function bn(e){let{prefix:t,words:n}=me.decode(e,zr),r=new Uint8Array(me.fromWords(n));switch(t){case"nprofile":{let s=Rr(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for nprofile");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:N(s[0][0]),relays:s[1]?s[1].map(o=>je.decode(o)):[]}}}case"nevent":{let s=Rr(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for nevent");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(s[2]&&s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(s[3]&&s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:N(s[0][0]),relays:s[1]?s[1].map(o=>je.decode(o)):[],author:s[2]?.[0]?N(s[2][0]):void 0,kind:s[3]?.[0]?parseInt(N(s[3][0]),16):void 0}}}case"naddr":{let s=Rr(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for naddr");if(!s[2]?.[0])throw new Error("missing TLV 2 for naddr");if(s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!s[3]?.[0])throw new Error("missing TLV 3 for naddr");if(s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:je.decode(s[0][0]),pubkey:N(s[2][0]),kind:parseInt(N(s[3][0]),16),relays:s[1]?s[1].map(o=>je.decode(o)):[]}}}case"nsec":return{type:t,data:r};case"npub":case"note":return{type:t,data:N(r)};default:throw new Error(`unknown prefix ${t}`)}}function Rr(e){let t={},n=e;for(;n.length>0;){let r=n[0],s=n[1],o=n.slice(2,2+s);if(n=n.slice(2+s),o.length<s)throw new Error(`not enough data to read on TLV ${r}`);t[r]=t[r]||[],t[r].push(o)}return t}function cu(e){return xn("nsec",e)}function lu(e){return xn("npub",C(e))}function uu(e){return xn("note",C(e))}function mn(e,t){let n=me.toWords(t);return me.encode(e,n,zr)}function xn(e,t){return mn(e,t)}function fu(e){let t=jr({0:[C(e.pubkey)],1:(e.relays||[]).map(n=>Be.encode(n))});return mn("nprofile",t)}function du(e){let t;e.kind!==void 0&&(t=iu(e.kind));let n=jr({0:[C(e.id)],1:(e.relays||[]).map(r=>Be.encode(r)),2:e.author?[C(e.author)]:[],3:t?[new Uint8Array(t)]:[]});return mn("nevent",n)}function hu(e){let t=new ArrayBuffer(4);new DataView(t).setUint32(0,e.kind,!1);let n=jr({0:[Be.encode(e.identifier)],1:(e.relays||[]).map(r=>Be.encode(r)),2:[C(e.pubkey)],3:[new Uint8Array(t)]});return mn("naddr",n)}function jr(e){let t=[];return Object.entries(e).reverse().forEach(([n,r])=>{r.forEach(s=>{let o=new Uint8Array(s.length+2);o.set([parseInt(n)],0),o.set([s.length],1),o.set(s,2),t.push(o)})}),G(...t)}var vn={};X(vn,{decrypt:()=>pu,encrypt:()=>ni});function ni(e,t,n){let r=e instanceof Uint8Array?e:C(e),s=it.getSharedSecret(r,C("02"+t)),o=ri(s),i=Uint8Array.from(ae(16)),a=Be.encode(n),c=Sr(o,i).encrypt(a),l=be.encode(new Uint8Array(c)),u=be.encode(new Uint8Array(i.buffer));return`${l}?iv=${u}`}function pu(e,t,n){let r=e instanceof Uint8Array?e:C(e),[s,o]=n.split("?iv="),i=it.getSharedSecret(r,C("02"+t)),a=ri(i),c=be.decode(o),l=be.decode(s),u=Sr(a,c).decrypt(l);return je.decode(u)}function ri(e){return e.slice(1,33)}var yu={};X(yu,{NIP05_REGEX:()=>Zr,isNip05:()=>gu,isValid:()=>mu,queryProfile:()=>oi,searchDomain:()=>bu,useFetchImplementation:()=>wu});var Zr=/^(?:([\w.+-]+)@)?([\w_-]+(\.[\w_-]+)+)$/,gu=e=>Zr.test(e||""),En;try{En=fetch}catch{}function wu(e){En=e}async function bu(e,t=""){try{let n=`https://${e}/.well-known/nostr.json?name=${t}`,r=await En(n,{redirect:"manual"});if(r.status!==200)throw Error("Wrong response code");return(await r.json()).names}catch{return{}}}async function oi(e){let t=e.match(Zr);if(!t)return null;let[,n="_",r]=t;try{let s=`https://${r}/.well-known/nostr.json?name=${n}`,o=await En(s,{redirect:"manual"});if(o.status!==200)throw Error("Wrong response code");let i=await o.json(),a=i.names[n];return a?{pubkey:a,relays:i.relays?.[a]}:null}catch{return null}}async function mu(e,t){let n=await oi(t);return n?n.pubkey===e:!1}var xu={};X(xu,{parse:()=>vu});function vu(e){let t={reply:void 0,root:void 0,mentions:[],profiles:[],quotes:[]},n,r;for(let s=e.tags.length-1;s>=0;s--){let o=e.tags[s];if(o[0]==="e"&&o[1]){let[i,a,c,l,u]=o,f={id:a,relays:c?[c]:[],author:u};if(l==="root"){t.root=f;continue}if(l==="reply"){t.reply=f;continue}if(l==="mention"){t.mentions.push(f);continue}n?r=f:n=f,t.mentions.push(f);continue}if(o[0]==="q"&&o[1]){let[i,a,c]=o;t.quotes.push({id:a,relays:c?[c]:[]})}if(o[0]==="p"&&o[1]){t.profiles.push({pubkey:o[1],relays:o[2]?[o[2]]:[]});continue}}return t.root||(t.root=r||n||t.reply),t.reply||(t.reply=n||t.root),[t.reply,t.root].forEach(s=>{if(!s)return;let o=t.mentions.indexOf(s);if(o!==-1&&t.mentions.splice(o,1),s.author){let i=t.profiles.find(a=>a.pubkey===s.author);i&&i.relays&&(s.relays||(s.relays=[]),i.relays.forEach(a=>{s.relays?.indexOf(a)===-1&&s.relays.push(a)}),i.relays=s.relays)}}),t.mentions.forEach(s=>{if(s.author){let o=t.profiles.find(i=>i.pubkey===s.author);o&&o.relays&&(s.relays||(s.relays=[]),o.relays.forEach(i=>{s.relays.indexOf(i)===-1&&s.relays.push(i)}),o.relays=s.relays)}}),t}var Eu={};X(Eu,{fetchRelayInformation:()=>_u,useFetchImplementation:()=>ku});var si;try{si=fetch}catch{}function ku(e){si=e}async function _u(e){return await(await fetch(e.replace("ws://","http://").replace("wss://","https://"),{headers:{Accept:"application/nostr+json"}})).json()}var Su={};X(Su,{getPow:()=>Bu,minePow:()=>Tu});function Bu(e){let t=0;for(let n=0;n<64;n+=8){let r=parseInt(e.substring(n,n+8),16);if(r===0)t+=32;else{t+=Math.clz32(r);break}}return t}function Au(e){let t=0;for(let n=0;n<e.length;n++){let r=e[n];if(r===0)t+=8;else{t+=Math.clz32(r)-24;break}}return t}function Tu(e,t){let n=0,r=e,s=["nonce",n.toString(),t.toString()];for(r.tags.push(s);;){let o=Math.floor(new Date().getTime()/1e3);o!==r.created_at&&(n=0,r.created_at=o),s[1]=(++n).toString();let i=te(Be.encode(JSON.stringify([0,r.pubkey,r.created_at,r.kind,r.tags,r.content])));if(Au(i)>=t){r.id=N(i);break}}return r}var Lu={};X(Lu,{unwrapEvent:()=>Ku,unwrapManyEvents:()=>qu,wrapEvent:()=>bi,wrapManyEvents:()=>Du});var Iu={};X(Iu,{createRumor:()=>pi,createSeal:()=>yi,createWrap:()=>gi,unwrapEvent:()=>Yr,unwrapManyEvents:()=>wi,wrapEvent:()=>gn,wrapManyEvents:()=>Mu});var kt={};X(kt,{decrypt:()=>Xr,encrypt:()=>Jr,getConversationKey:()=>Fr,v2:()=>Ou});var ii=1,ai=65535;function Fr(e,t){let n=it.getSharedSecret(e,C("02"+t)).subarray(1,33);return fn(te,n,Be.encode("nip44-v2"))}function ci(e,t){let n=dn(te,e,t,76);return{chacha_key:n.subarray(0,32),chacha_nonce:n.subarray(32,44),hmac_key:n.subarray(44,76)}}function Gr(e){if(!Number.isSafeInteger(e)||e<1)throw new Error("expected positive integer");if(e<=32)return 32;let t=1<<Math.floor(Math.log2(e-1))+1,n=t<=256?32:t/8;return n*(Math.floor((e-1)/n)+1)}function Ru(e){if(!Number.isSafeInteger(e)||e<ii||e>ai)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");let t=new Uint8Array(2);return new DataView(t.buffer).setUint16(0,e,!1),t}function Uu(e){let t=Be.encode(e),n=t.length,r=Ru(n),s=new Uint8Array(Gr(n)-n);return G(r,t,s)}function Pu(e){let t=new DataView(e.buffer).getUint16(0),n=e.subarray(2,2+t);if(t<ii||t>ai||n.length!==t||e.length!==2+Gr(t))throw new Error("invalid padding");return je.decode(n)}function li(e,t,n){if(n.length!==32)throw new Error("AAD associated data must be 32 bytes");let r=G(n,t);return _e(te,e,r)}function Cu(e){if(typeof e!="string")throw new Error("payload must be a valid string");let t=e.length;if(t<132||t>87472)throw new Error("invalid payload length: "+t);if(e[0]==="#")throw new Error("unknown encryption version");let n;try{n=be.decode(e)}catch(o){throw new Error("invalid base64: "+o.message)}let r=n.length;if(r<99||r>65603)throw new Error("invalid data length: "+r);let s=n[0];if(s!==2)throw new Error("unknown encryption version "+s);return{nonce:n.subarray(1,33),ciphertext:n.subarray(33,-32),mac:n.subarray(-32)}}function Jr(e,t,n=ae(32)){let{chacha_key:r,chacha_nonce:s,hmac_key:o}=ci(t,n),i=Uu(e),a=ut(r,s,i),c=li(o,a,n);return be.encode(G(new Uint8Array([2]),n,a,c))}function Xr(e,t){let{nonce:n,ciphertext:r,mac:s}=Cu(e),{chacha_key:o,chacha_nonce:i,hmac_key:a}=ci(t,n),c=li(a,r,n);if(!ct(c,s))throw new Error("invalid MAC");let l=ut(o,i,r);return Pu(l)}var Ou={utils:{getConversationKey:Fr,calcPaddedLen:Gr},encrypt:Jr,decrypt:Xr},Nu=2880*60,ui=()=>Math.round(Date.now()/1e3),fi=()=>Math.round(ui()-Math.random()*Nu),di=(e,t)=>Fr(e,t),hi=(e,t,n)=>Jr(JSON.stringify(e),di(t,n)),Ds=(e,t)=>JSON.parse(Xr(e.content,di(t,e.pubkey)));function pi(e,t){let n={created_at:ui(),content:"",tags:[],...e,pubkey:Me(t)};return n.id=pn(n),n}function yi(e,t,n){return le({kind:Ws,content:hi(e,t,n),created_at:fi(),tags:[]},t)}function gi(e,t){let n=kc();return le({kind:Xs,content:hi(e,n,t),created_at:fi(),tags:[["p",t]]},n)}function gn(e,t,n){let r=pi(e,t),s=yi(r,t,n);return gi(s,n)}function Mu(e,t,n){if(!n||n.length===0)throw new Error("At least one recipient is required.");let r=Me(t),s=[gn(e,t,r)];return n.forEach(o=>{s.push(gn(e,t,o))}),s}function Yr(e,t){let n=Ds(e,t);return Ds(n,t)}function wi(e,t){let n=[];return e.forEach(r=>{n.push(Yr(r,t))}),n.sort((r,s)=>r.created_at-s.created_at),n}function Hu(e,t,n,r){let s={created_at:Math.ceil(Date.now()/1e3),kind:zs,tags:[],content:t};return(Array.isArray(e)?e:[e]).forEach(({publicKey:i,relayUrl:a})=>{s.tags.push(a?["p",i,a]:["p",i])}),r&&s.tags.push(["e",r.eventId,r.relayUrl||"","reply"]),n&&s.tags.push(["subject",n]),s}function bi(e,t,n,r,s){let o=Hu(t,n,r,s);return gn(o,e,t.publicKey)}function Du(e,t,n,r,s){if(!t||t.length===0)throw new Error("At least one recipient is required.");return[{publicKey:Me(e)},...t].map(i=>bi(e,i,n,r,s))}var Ku=Yr,qu=wi,$u={};X($u,{finishRepostEvent:()=>Vu,getRepostedEvent:()=>Wu,getRepostedEventPointer:()=>mi});function Vu(e,t,n,r){let s,o=[...e.tags??[],["e",t.id,n],["p",t.pubkey]];return t.kind===Vs?s=Kr:(s=$r,o.push(["k",String(t.kind)])),le({kind:s,tags:o,content:e.content===""||t.tags?.find(i=>i[0]==="-")?"":JSON.stringify(t),created_at:e.created_at},r)}function mi(e){if(![Kr,$r].includes(e.kind))return;let t,n;for(let r=e.tags.length-1;r>=0&&(t===void 0||n===void 0);r--){let s=e.tags[r];s.length>=2&&(s[0]==="e"&&t===void 0?t=s:s[0]==="p"&&n===void 0&&(n=s))}if(t!==void 0)return{id:t[1],relays:[t[2],n?.[2]].filter(r=>typeof r=="string"),author:n?.[1]}}function Wu(e,{skipVerification:t}={}){let n=mi(e);if(n===void 0||e.content==="")return;let r;try{r=JSON.parse(e.content)}catch{return}if(r.id===n.id&&!(!t&&!Mr(r)))return r}var zu={};X(zu,{NOSTR_URI_REGEX:()=>Qr,parse:()=>Zu,test:()=>ju});var Qr=new RegExp(`nostr:(${ti.source})`);function ju(e){return typeof e=="string"&&new RegExp(`^${Qr.source}$`).test(e)}function Zu(e){let t=e.match(new RegExp(`^${Qr.source}$`));if(!t)throw new Error(`Invalid Nostr URI: ${e}`);return{uri:t[0],value:t[1],decoded:bn(t[1])}}var Fu={};X(Fu,{finishReactionEvent:()=>Gu,getReactedEventPointer:()=>Ju});function Gu(e,t,n){let r=t.tags.filter(s=>s.length>=2&&(s[0]==="e"||s[0]==="p"));return le({...e,kind:qr,tags:[...e.tags??[],...r,["e",t.id],["p",t.pubkey]],content:e.content??"+"},n)}function Ju(e){if(e.kind!==qr)return;let t,n;for(let r=e.tags.length-1;r>=0&&(t===void 0||n===void 0);r--){let s=e.tags[r];s.length>=2&&(s[0]==="e"&&t===void 0?t=s:s[0]==="p"&&n===void 0&&(n=s))}if(!(t===void 0||n===void 0))return{id:t[1],relays:[t[2],n[2]].filter(r=>r!==void 0),author:n[1]}}var Xu={};X(Xu,{parse:()=>Qu});var Ur=/\W/m,Ks=/[^\w\/] |[^\w\/]$|$|,| /m,Yu=42;function*Qu(e){let t=[];if(typeof e!="string"){for(let o=0;o<e.tags.length;o++){let i=e.tags[o];i[0]==="emoji"&&i.length>=3&&t.push({type:"emoji",shortcode:i[1],url:i[2]})}e=e.content}let n=e.length,r=0,s=0;e:for(;s<n;){let o=e.indexOf(":",s),i=e.indexOf("#",s);if(o===-1&&i===-1)break e;if(o===-1||i>=0&&i<o){if(i===0||e[i-1].match(Ur)){let a=e.slice(i+1,i+Yu).match(Ur),c=a?i+1+a.index:n;yield{type:"text",text:e.slice(r,i)},yield{type:"hashtag",value:e.slice(i+1,c)},s=c,r=s;continue e}s=i+1;continue e}if(e.slice(o-5,o)==="nostr"){let a=e.slice(o+60).match(Ur),c=a?o+60+a.index:n;try{let l,{data:u,type:f}=bn(e.slice(o+1,c));switch(f){case"npub":l={pubkey:u};break;case"note":l={id:u};break;case"nsec":s=c+1;continue;default:l=u}r!==o-5&&(yield{type:"text",text:e.slice(r,o-5)}),yield{type:"reference",pointer:l},s=c,r=s;continue e}catch{s=o+1;continue e}}else if(e.slice(o-5,o)==="https"||e.slice(o-4,o)==="http"){let a=e.slice(o+4).match(Ks),c=a?o+4+a.index:n,l=e[o-1]==="s"?5:4;try{let u=new URL(e.slice(o-l,c));if(u.hostname.indexOf(".")===-1)throw new Error("invalid url");if(r!==o-l&&(yield{type:"text",text:e.slice(r,o-l)}),/\.(png|jpe?g|gif|webp|heic|svg)$/i.test(u.pathname)){yield{type:"image",url:u.toString()},s=c,r=s;continue e}if(/\.(mp4|avi|webm|mkv|mov)$/i.test(u.pathname)){yield{type:"video",url:u.toString()},s=c,r=s;continue e}if(/\.(mp3|aac|ogg|opus|wav|flac)$/i.test(u.pathname)){yield{type:"audio",url:u.toString()},s=c,r=s;continue e}yield{type:"url",url:u.toString()},s=c,r=s;continue e}catch{s=c+1;continue e}}else if(e.slice(o-3,o)==="wss"||e.slice(o-2,o)==="ws"){let a=e.slice(o+4).match(Ks),c=a?o+4+a.index:n,l=e[o-1]==="s"?3:2;try{let u=new URL(e.slice(o-l,c));if(u.hostname.indexOf(".")===-1)throw new Error("invalid ws url");r!==o-l&&(yield{type:"text",text:e.slice(r,o-l)}),yield{type:"relay",url:u.toString()},s=c,r=s;continue e}catch{s=c+1;continue e}}else{for(let a=0;a<t.length;a++){let c=t[a];if(e[o+c.shortcode.length+1]===":"&&e.slice(o+1,o+c.shortcode.length+1)===c.shortcode){r!==o&&(yield{type:"text",text:e.slice(r,o)}),yield c,s=o+c.shortcode.length+2,r=s;continue e}}s=o+1;continue e}}r!==n&&(yield{type:"text",text:e.slice(r)})}var ef={};X(ef,{channelCreateEvent:()=>tf,channelHideMessageEvent:()=>of,channelMessageEvent:()=>rf,channelMetadataEvent:()=>nf,channelMuteUserEvent:()=>sf});var tf=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return le({kind:js,tags:[...e.tags??[]],content:n,created_at:e.created_at},t)},nf=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return le({kind:Zs,tags:[["e",e.channel_create_event_id],...e.tags??[]],content:n,created_at:e.created_at},t)},rf=(e,t)=>{let n=[["e",e.channel_create_event_id,e.relay_url,"root"]];return e.reply_to_channel_message_event_id&&n.push(["e",e.reply_to_channel_message_event_id,e.relay_url,"reply"]),le({kind:Fs,tags:[...n,...e.tags??[]],content:e.content,created_at:e.created_at},t)},of=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return le({kind:Gs,tags:[["e",e.channel_message_event_id],...e.tags??[]],content:n,created_at:e.created_at},t)},sf=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return le({kind:Js,tags:[["p",e.pubkey_to_mute],...e.tags??[]],content:n,created_at:e.created_at},t)},af={};X(af,{EMOJI_SHORTCODE_REGEX:()=>xi,matchAll:()=>cf,regex:()=>eo,replaceAll:()=>lf});var xi=/:(\w+):/,eo=()=>new RegExp(`\\B${xi.source}\\B`,"g");function*cf(e){let t=e.matchAll(eo());for(let n of t)try{let[r,s]=n;yield{shortcode:r,name:s,start:n.index,end:n.index+r.length}}catch{}}function lf(e,t){return e.replaceAll(eo(),(n,r)=>t({shortcode:n,name:r}))}var uf={};X(uf,{useFetchImplementation:()=>ff,validateGithub:()=>df});var to;try{to=fetch}catch{}function ff(e){to=e}async function df(e,t,n){try{return await(await to(`https://gist.github.com/${t}/${n}/raw`)).text()===`Verifying that I control the following Nostr public key: ${e}`}catch{return!1}}var hf={};X(hf,{makeNwcRequestEvent:()=>yf,parseConnectionString:()=>pf});function pf(e){let{host:t,pathname:n,searchParams:r}=new URL(e),s=n||t,o=r.get("relay"),i=r.get("secret");if(!s||!o||!i)throw new Error("invalid connection string");return{pubkey:s,relay:o,secret:i}}async function yf(e,t,n){let s=ni(t,e,JSON.stringify({method:"pay_invoice",params:{invoice:n}})),o={kind:Qs,created_at:Math.round(Date.now()/1e3),content:s,tags:[["p",e]]};return le(o,t)}var gf={};X(gf,{normalizeIdentifier:()=>wf});function wf(e){return e=e.trim().toLowerCase(),e=e.normalize("NFKC"),Array.from(e).map(t=>/\p{Letter}/u.test(t)||/\p{Number}/u.test(t)?t:"-").join("")}var bf={};X(bf,{getSatoshisAmountFromBolt11:()=>_f,getZapEndpoint:()=>xf,makeZapReceipt:()=>kf,makeZapRequest:()=>vf,useFetchImplementation:()=>mf,validateZapRequest:()=>Ef});var no;try{no=fetch}catch{}function mf(e){no=e}async function xf(e){try{let t="",{lud06:n,lud16:r}=JSON.parse(e.content);if(r){let[i,a]=r.split("@");t=new URL(`/.well-known/lnurlp/${i}`,`https://${a}`).toString()}else if(n){let{words:i}=me.decode(n,1e3),a=me.fromWords(i);t=je.decode(a)}else return null;let o=await(await no(t)).json();if(o.allowsNostr&&o.nostrPubkey)return o.callback}catch{}return null}function vf(e){let t={kind:9734,created_at:Math.round(Date.now()/1e3),content:e.comment||"",tags:[["p","pubkey"in e?e.pubkey:e.event.pubkey],["amount",e.amount.toString()],["relays",...e.relays]]};if("event"in e){if(t.tags.push(["e",e.event.id]),Hr(e.event.kind)){let n=["a",`${e.event.kind}:${e.event.pubkey}:`];t.tags.push(n)}else if(Dr(e.event.kind)){let n=e.event.tags.find(([s,o])=>s==="d"&&o);if(!n)throw new Error("d tag not found or is empty");let r=["a",`${e.event.kind}:${e.event.pubkey}:${n[1]}`];t.tags.push(r)}t.tags.push(["k",e.event.kind.toString()])}return t}function Ef(e){let t;try{t=JSON.parse(e)}catch{return"Invalid zap request JSON."}if(!Or(t))return"Zap request is not a valid Nostr event.";if(!Mr(t))return"Invalid signature on zap request.";let n=t.tags.find(([o,i])=>o==="p"&&i);if(!n)return"Zap request doesn't have a 'p' tag.";if(!n[1].match(/^[a-f0-9]{64}$/))return"Zap request 'p' tag is not valid hex.";let r=t.tags.find(([o,i])=>o==="e"&&i);return r&&!r[1].match(/^[a-f0-9]{64}$/)?"Zap request 'e' tag is not valid hex.":t.tags.find(([o,i])=>o==="relays"&&i)?null:"Zap request doesn't have a 'relays' tag."}function kf({zapRequest:e,preimage:t,bolt11:n,paidAt:r}){let s=JSON.parse(e),o=s.tags.filter(([a])=>a==="e"||a==="p"||a==="a"),i={kind:9735,created_at:Math.round(r.getTime()/1e3),content:"",tags:[...o,["P",s.pubkey],["bolt11",n],["description",e]]};return t&&i.tags.push(["preimage",t]),i}function _f(e){if(e.length<50)return 0;e=e.substring(0,50);let t=e.lastIndexOf("1");if(t===-1)return 0;let n=e.substring(0,t);if(!n.startsWith("lnbc"))return 0;let r=n.substring(4);if(r.length<1)return 0;let s=r[r.length-1],o=s.charCodeAt(0)-48,i=o>=0&&o<=9,a=r.length-1;if(i&&a++,a<1)return 0;let c=parseInt(r.substring(0,a));switch(s){case"m":return c*1e5;case"u":return c*100;case"n":return c/10;case"p":return c/1e4;default:return c*1e8}}var Sf={};X(Sf,{Negentropy:()=>Ei,NegentropyStorageVector:()=>Tf,NegentropySync:()=>Lf});var Pr=97,Et=32,vi=16,ft={Skip:0,Fingerprint:1,IdList:2},ze=class{_raw;length;constructor(e){typeof e=="number"?(this._raw=new Uint8Array(e),this.length=0):e instanceof Uint8Array?(this._raw=new Uint8Array(e),this.length=e.length):(this._raw=new Uint8Array(512),this.length=0)}unwrap(){return this._raw.subarray(0,this.length)}get capacity(){return this._raw.byteLength}extend(e){if(e instanceof ze&&(e=e.unwrap()),typeof e.length!="number")throw Error("bad length");let t=e.length+this.length;if(this.capacity<t){let n=this._raw,r=Math.max(this.capacity*2,t);this._raw=new Uint8Array(r),this._raw.set(n)}this._raw.set(e,this.length),this.length+=e.length}shift(){let e=this._raw[0];return this._raw=this._raw.subarray(1),this.length--,e}shiftN(e=1){let t=this._raw.subarray(0,e);return this._raw=this._raw.subarray(e),this.length-=e,t}};function hn(e){let t=0;for(;;){if(e.length===0)throw Error("parse ends prematurely");let n=e.shift();if(t=t<<7|n&127,(n&128)===0)break}return t}function We(e){if(e===0)return new ze(new Uint8Array([0]));let t=[];for(;e!==0;)t.push(e&127),e>>>=7;t.reverse();for(let n=0;n<t.length-1;n++)t[n]|=128;return new ze(new Uint8Array(t))}function Bf(e){return yn(e,1)[0]}function yn(e,t){if(e.length<t)throw Error("parse ends prematurely");return e.shiftN(t)}var Af=class{buf;constructor(){this.setToZero()}setToZero(){this.buf=new Uint8Array(Et)}add(e){let t=0,n=0,r=new DataView(this.buf.buffer),s=new DataView(e.buffer);for(let o=0;o<8;o++){let i=o*4,a=r.getUint32(i,!0),c=s.getUint32(i,!0),l=a;l+=t,l+=c,l>4294967295&&(n=1),r.setUint32(i,l&4294967295,!0),t=n,n=0}}negate(){let e=new DataView(this.buf.buffer);for(let n=0;n<8;n++){let r=n*4;e.setUint32(r,~e.getUint32(r,!0))}let t=new Uint8Array(Et);t[0]=1,this.add(t)}getFingerprint(e){let t=new ze;return t.extend(this.buf),t.extend(We(e)),te(t.unwrap()).subarray(0,vi)}},Tf=class{items;sealed;constructor(){this.items=[],this.sealed=!1}insert(e,t){if(this.sealed)throw Error("already sealed");let n=C(t);if(n.byteLength!==Et)throw Error("bad id size for added item");this.items.push({timestamp:e,id:n})}seal(){if(this.sealed)throw Error("already sealed");this.sealed=!0,this.items.sort(Cr);for(let e=1;e<this.items.length;e++)if(Cr(this.items[e-1],this.items[e])===0)throw Error("duplicate item inserted")}unseal(){this.sealed=!1}size(){return this._checkSealed(),this.items.length}getItem(e){if(this._checkSealed(),e>=this.items.length)throw Error("out of range");return this.items[e]}iterate(e,t,n){this._checkSealed(),this._checkBounds(e,t);for(let r=e;r<t&&n(this.items[r],r);++r);}findLowerBound(e,t,n){return this._checkSealed(),this._checkBounds(e,t),this._binarySearch(this.items,e,t,r=>Cr(r,n)<0)}fingerprint(e,t){let n=new Af;return n.setToZero(),this.iterate(e,t,r=>(n.add(r.id),!0)),n.getFingerprint(t-e)}_checkSealed(){if(!this.sealed)throw Error("not sealed")}_checkBounds(e,t){if(e>t||t>this.items.length)throw Error("bad range")}_binarySearch(e,t,n,r){let s=n-t;for(;s>0;){let o=t,i=Math.floor(s/2);o+=i,r(e[o])?(t=++o,s-=i+1):s=i}return t}},Ei=class{storage;frameSizeLimit;lastTimestampIn;lastTimestampOut;constructor(e,t=6e4){if(t<4096)throw Error("frameSizeLimit too small");this.storage=e,this.frameSizeLimit=t,this.lastTimestampIn=0,this.lastTimestampOut=0}_bound(e,t){return{timestamp:e,id:t||new Uint8Array(0)}}initiate(){let e=new ze;return e.extend(new Uint8Array([Pr])),this.splitRange(0,this.storage.size(),this._bound(Number.MAX_VALUE),e),N(e.unwrap())}reconcile(e,t,n){let r=new ze(C(e));this.lastTimestampIn=this.lastTimestampOut=0;let s=new ze;s.extend(new Uint8Array([Pr]));let o=Bf(r);if(o<96||o>111)throw Error("invalid negentropy protocol version byte");if(o!==Pr)throw Error("unsupported negentropy protocol version requested: "+(o-96));let i=this.storage.size(),a=this._bound(0),c=0,l=!1;for(;r.length!==0;){let u=new ze,f=()=>{l&&(l=!1,u.extend(this.encodeBound(a)),u.extend(We(ft.Skip)))},h=this.decodeBound(r),d=hn(r),p=c,y=this.storage.findLowerBound(c,i,h);if(d===ft.Skip)l=!0;else if(d===ft.Fingerprint){let w=yn(r,vi),b=this.storage.fingerprint(p,y);ki(w,b)!==0?(f(),this.splitRange(p,y,h,u)):l=!0}else if(d===ft.IdList){let w=hn(r),b={};for(let B=0;B<w;B++){let U=yn(r,Et);b[N(U)]=U}if(l=!0,this.storage.iterate(p,y,B=>{let U=B.id,P=N(U);return b[P]?delete b[N(U)]:t?.(P),!0}),n)for(let B of Object.values(b))n(N(B))}else throw Error("unexpected mode");if(this.exceededFrameSizeLimit(s.length+u.length)){let w=this.storage.fingerprint(y,i);s.extend(this.encodeBound(this._bound(Number.MAX_VALUE))),s.extend(We(ft.Fingerprint)),s.extend(w);break}else s.extend(u);c=y,a=h}return s.length===1?null:N(s.unwrap())}splitRange(e,t,n,r){let s=t-e,o=16;if(s<o*2)r.extend(this.encodeBound(n)),r.extend(We(ft.IdList)),r.extend(We(s)),this.storage.iterate(e,t,i=>(r.extend(i.id),!0));else{let i=Math.floor(s/o),a=s%o,c=e;for(let l=0;l<o;l++){let u=i+(l<a?1:0),f=this.storage.fingerprint(c,c+u);c+=u;let h;if(c===t)h=n;else{let d,p;this.storage.iterate(c-1,c+1,(y,w)=>(w===c-1?d=y:p=y,!0)),h=this.getMinimalBound(d,p)}r.extend(this.encodeBound(h)),r.extend(We(ft.Fingerprint)),r.extend(f)}}}exceededFrameSizeLimit(e){return e>this.frameSizeLimit-200}decodeTimestampIn(e){let t=hn(e);return t=t===0?Number.MAX_VALUE:t-1,this.lastTimestampIn===Number.MAX_VALUE||t===Number.MAX_VALUE?(this.lastTimestampIn=Number.MAX_VALUE,Number.MAX_VALUE):(t+=this.lastTimestampIn,this.lastTimestampIn=t,t)}decodeBound(e){let t=this.decodeTimestampIn(e),n=hn(e);if(n>Et)throw Error("bound key too long");let r=yn(e,n);return{timestamp:t,id:r}}encodeTimestampOut(e){if(e===Number.MAX_VALUE)return this.lastTimestampOut=Number.MAX_VALUE,We(0);let t=e;return e-=this.lastTimestampOut,this.lastTimestampOut=t,We(e+1)}encodeBound(e){let t=new ze;return t.extend(this.encodeTimestampOut(e.timestamp)),t.extend(We(e.id.length)),t.extend(e.id),t}getMinimalBound(e,t){if(t.timestamp!==e.timestamp)return this._bound(t.timestamp);{let n=0,r=t.id,s=e.id;for(let o=0;o<Et&&r[o]===s[o];o++)n++;return this._bound(t.timestamp,t.id.subarray(0,n+1))}}};function ki(e,t){for(let n=0;n<e.byteLength;n++){if(e[n]<t[n])return-1;if(e[n]>t[n])return 1}return e.byteLength>t.byteLength?1:e.byteLength<t.byteLength?-1:0}function Cr(e,t){return e.timestamp===t.timestamp?ki(e.id,t.id):e.timestamp-t.timestamp}var Lf=class{relay;storage;neg;filter;subscription;onhave;onneed;constructor(e,t,n,r={}){this.relay=e,this.storage=t,this.neg=new Ei(t),this.onhave=r.onhave,this.onneed=r.onneed,this.filter=n,this.subscription=this.relay.prepareSubscription([{}],{label:r.label||"negentropy"}),this.subscription.oncustom=s=>{switch(s[0]){case"NEG-MSG":{s.length<3;try{let o=this.neg.reconcile(s[2],this.onhave,this.onneed);o?this.relay.send(`["NEG-MSG", "${this.subscription.id}", "${o}"]`):(this.close(),r.onclose?.())}catch(o){r?.onclose?.(`reconcile error: ${o}`)}break}case"NEG-CLOSE":{let o=s[2];r.onclose?.(o);break}case"NEG-ERR":r.onclose?.()}}}async start(){let e=this.neg.initiate();this.relay.send(`["NEG-OPEN","${this.subscription.id}",${JSON.stringify(this.filter)},"${e}"]`)}close(){this.relay.send(`["NEG-CLOSE","${this.subscription.id}"]`),this.subscription.close()}},If={};X(If,{getToken:()=>Rf,hashPayload:()=>ro,unpackEventFromToken:()=>Si,validateEvent:()=>Ri,validateEventKind:()=>Ai,validateEventMethodTag:()=>Li,validateEventPayloadTag:()=>Ii,validateEventTimestamp:()=>Bi,validateEventUrlTag:()=>Ti,validateToken:()=>Uf});var _i="Nostr ";async function Rf(e,t,n,r=!1,s){let o={kind:Vr,tags:[["u",e],["method",t]],created_at:Math.round(new Date().getTime()/1e3),content:""};s&&o.tags.push(["payload",ro(s)]);let i=await n(o);return(r?_i:"")+be.encode(Be.encode(JSON.stringify(i)))}async function Uf(e,t,n){let r=await Si(e).catch(o=>{throw o});return await Ri(r,t,n).catch(o=>{throw o})}async function Si(e){if(!e)throw new Error("Missing token");e=e.replace(_i,"");let t=je.decode(be.decode(e));if(!t||t.length===0||!t.startsWith("{"))throw new Error("Invalid token");return JSON.parse(t)}function Bi(e){return e.created_at?Math.round(new Date().getTime()/1e3)-e.created_at<60:!1}function Ai(e){return e.kind===Vr}function Ti(e,t){let n=e.tags.find(r=>r[0]==="u");return n?n.length>0&&n[1]===t:!1}function Li(e,t){let n=e.tags.find(r=>r[0]==="method");return n?n.length>0&&n[1].toLowerCase()===t.toLowerCase():!1}function ro(e){let t=te(Be.encode(JSON.stringify(e)));return N(t)}function Ii(e,t){let n=e.tags.find(s=>s[0]==="payload");if(!n)return!1;let r=ro(t);return n.length>0&&n[1]===r}async function Ri(e,t,n,r){if(!Mr(e))throw new Error("Invalid nostr event, signature invalid");if(!Ai(e))throw new Error("Invalid nostr event, kind invalid");if(!Bi(e))throw new Error("Invalid nostr event, created_at timestamp invalid");if(!Ti(e,t))throw new Error("Invalid nostr event, url tag invalid");if(!Li(e,n))throw new Error("Invalid nostr event, method tag invalid");if(r&&typeof r=="object"&&Object.keys(r).length>0&&!Ii(e,r))throw new Error("Invalid nostr event, payload tag does not match request body hash");return!0}function Cf(e,t,n,r){qe(e);let s=Wt({dkLen:32,asyncTick:10},r),{c:o,dkLen:i,asyncTick:a}=s;if(ee(o,"c"),ee(i,"dkLen"),ee(a,"asyncTick"),o<1)throw new Error("iterations (c) must be >= 1");let c=Kn(t,"password"),l=Kn(n,"salt"),u=new Uint8Array(i),f=_e.create(e,c),h=f._cloneInto().update(l);return{c:o,dkLen:i,asyncTick:a,DK:u,PRF:f,PRFSalt:h}}function Of(e,t,n,r,s){return e.destroy(),t.destroy(),r&&r.destroy(),xe(s),n}function oo(e,t,n,r){let{c:s,dkLen:o,DK:i,PRF:a,PRFSalt:c}=Cf(e,t,n,r),l,u=new Uint8Array(4),f=yt(u),h=new Uint8Array(a.outputLen);for(let d=1,p=0;p<o;d++,p+=a.outputLen){let y=i.subarray(p,p+a.outputLen);f.setInt32(0,d,!1),(l=c._cloneInto(l)).update(u).digestInto(h),y.set(h.subarray(0,y.length));for(let w=1;w<s;w++){a._cloneInto(l).update(h).digestInto(h);for(let b=0;b<y.length;b++)y[b]^=h[b]}}return Of(a,c,i,l,h)}function Ui(e,t,n,r,s,o){let i=e[t++]^n[r++],a=e[t++]^n[r++],c=e[t++]^n[r++],l=e[t++]^n[r++],u=e[t++]^n[r++],f=e[t++]^n[r++],h=e[t++]^n[r++],d=e[t++]^n[r++],p=e[t++]^n[r++],y=e[t++]^n[r++],w=e[t++]^n[r++],b=e[t++]^n[r++],B=e[t++]^n[r++],U=e[t++]^n[r++],P=e[t++]^n[r++],Y=e[t++]^n[r++],M=i,z=a,V=c,I=l,K=u,H=f,R=h,x=d,m=p,g=y,E=w,_=b,S=B,v=U,k=P,A=Y;for(let T=0;T<8;T+=2)K^=$(M+S|0,7),m^=$(K+M|0,9),S^=$(m+K|0,13),M^=$(S+m|0,18),g^=$(H+z|0,7),v^=$(g+H|0,9),z^=$(v+g|0,13),H^=$(z+v|0,18),k^=$(E+R|0,7),V^=$(k+E|0,9),R^=$(V+k|0,13),E^=$(R+V|0,18),I^=$(A+_|0,7),x^=$(I+A|0,9),_^=$(x+I|0,13),A^=$(_+x|0,18),z^=$(M+I|0,7),V^=$(z+M|0,9),I^=$(V+z|0,13),M^=$(I+V|0,18),R^=$(H+K|0,7),x^=$(R+H|0,9),K^=$(x+R|0,13),H^=$(K+x|0,18),_^=$(E+g|0,7),m^=$(_+E|0,9),g^=$(m+_|0,13),E^=$(g+m|0,18),S^=$(A+k|0,7),v^=$(S+A|0,9),k^=$(v+S|0,13),A^=$(k+v|0,18);s[o++]=i+M|0,s[o++]=a+z|0,s[o++]=c+V|0,s[o++]=l+I|0,s[o++]=u+K|0,s[o++]=f+H|0,s[o++]=h+R|0,s[o++]=d+x|0,s[o++]=p+m|0,s[o++]=y+g|0,s[o++]=w+E|0,s[o++]=b+_|0,s[o++]=B+S|0,s[o++]=U+v|0,s[o++]=P+k|0,s[o++]=Y+A|0}function so(e,t,n,r,s){let o=r+0,i=r+16*s;for(let a=0;a<16;a++)n[i+a]=e[t+(2*s-1)*16+a];for(let a=0;a<s;a++,o+=16,t+=16)Ui(n,i,e,t,n,o),a>0&&(i+=16),Ui(n,o,e,t+=16,n,i)}function Nf(e,t,n){let r=Wt({dkLen:32,asyncTick:10,maxmem:1073742848},n),{N:s,r:o,p:i,dkLen:a,asyncTick:c,maxmem:l,onProgress:u}=r;if(ee(s,"N"),ee(o,"r"),ee(i,"p"),ee(a,"dkLen"),ee(c,"asyncTick"),ee(l,"maxmem"),u!==void 0&&typeof u!="function")throw new Error("progressCb must be a function");let f=128*o,h=f/4,d=Math.pow(2,32);if(s<=1||(s&s-1)!==0||s>d)throw new Error('"N" expected a power of 2, and 2^1 <= N <= 2^32');if(i<1||i>(d-1)*32/f)throw new Error('"p" expected integer 1..((2^32 - 1) * 32) / (128 * r)');if(a<1||a>(d-1)*32)throw new Error('"dkLen" expected integer 1..(2^32 - 1) * 32');if(f*(s+i)>l)throw new Error('"maxmem" limit was hit, expected 128*r*(N+p) <= "maxmem"='+l);let y=oo(te,e,t,{c:1,dkLen:f*i}),w=Vt(y),b=Vt(new Uint8Array(f*s)),B=Vt(new Uint8Array(f)),U=()=>{};if(u){let P=2*s*i,Y=Math.max(Math.floor(P/1e4),1),M=0;U=()=>{M++,u&&(!(M%Y)||M===P)&&u(M/P)}}return{N:s,r:o,p:i,dkLen:a,blockSize32:h,V:b,B32:w,B:y,tmp:B,blockMixCb:U,asyncTick:c}}function Mf(e,t,n,r,s){let o=oo(te,e,n,{c:1,dkLen:t});return xe(n,r,s),o}function io(e,t,n){let{N:r,r:s,p:o,dkLen:i,blockSize32:a,V:c,B32:l,B:u,tmp:f,blockMixCb:h}=Nf(e,t,n);Dn(l);for(let d=0;d<o;d++){let p=a*d;for(let y=0;y<a;y++)c[y]=l[p+y];for(let y=0,w=0;y<r-1;y++)so(c,w,c,w+=a,s),h();so(c,(r-1)*a,l,p,s),h();for(let y=0;y<r;y++){let w=(l[p+a-16]&r-1)>>>0;for(let b=0;b<a;b++)f[b]=l[p+b]^c[w*a+b];so(f,0,l,p,s),h()}}return Dn(l),Mf(e,i,u,c,f)}var Pi=5e3;function Hf(e,t){let n=me.toWords(t);return me.encode(e,n,Pi)}function Df(e,t){return Hf(e,t)}function Ci(e,t,n=16,r=2){let s=ae(16),o=2**n,i=io(t.normalize("NFKC"),s,{N:o,r:8,p:1,dkLen:32}),a=ae(24),c=Uint8Array.from([r]),u=Lr(i,a,c).encrypt(e),f=G(Uint8Array.from([2]),Uint8Array.from([n]),s,a,c,u);return Df("ncryptsec",f)}function Oi(e,t){let{prefix:n,words:r}=me.decode(e,Pi);if(n!=="ncryptsec")throw new Error(`invalid prefix ${n}, expected 'ncryptsec'`);let s=new Uint8Array(me.fromWords(r)),o=s[0];if(o!==2)throw new Error(`invalid version ${o}, expected 0x02`);let a=2**s[1],c=s.slice(2,18),l=s.slice(18,42),u=s[42],f=Uint8Array.from([u]),h=s.slice(43),d=io(t.normalize("NFKC"),c,{N:a,r:8,p:1,dkLen:32});return Lr(d,l,f).decrypt(h)}async function kn(){let e=ae(32),t=Qe.getPublicKey(e);return{privateKey:N(e),publicKey:N(t)}}var _p=new Error("timeout while waiting for mutex to become available"),Sp=new Error("mutex already locked"),Kf=new Error("request for lock canceled"),qf=function(e,t,n,r){function s(o){return o instanceof n?o:new n(function(i){i(o)})}return new(n||(n=Promise))(function(o,i){function a(u){try{l(r.next(u))}catch(f){i(f)}}function c(u){try{l(r.throw(u))}catch(f){i(f)}}function l(u){u.done?o(u.value):s(u.value).then(a,c)}l((r=r.apply(e,t||[])).next())})},ao=class{constructor(t,n=Kf){this._value=t,this._cancelError=n,this._queue=[],this._weightedWaiters=[]}acquire(t=1,n=0){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);return new Promise((r,s)=>{let o={resolve:r,reject:s,weight:t,priority:n},i=Ni(this._queue,a=>n<=a.priority);i===-1&&t<=this._value?this._dispatchItem(o):this._queue.splice(i+1,0,o)})}runExclusive(t){return qf(this,arguments,void 0,function*(n,r=1,s=0){let[o,i]=yield this.acquire(r,s);try{return yield n(o)}finally{i()}})}waitForUnlock(t=1,n=0){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);return this._couldLockImmediately(t,n)?Promise.resolve():new Promise(r=>{this._weightedWaiters[t-1]||(this._weightedWaiters[t-1]=[]),$f(this._weightedWaiters[t-1],{resolve:r,priority:n})})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(t){this._value=t,this._dispatchQueue()}release(t=1){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);this._value+=t,this._dispatchQueue()}cancel(){this._queue.forEach(t=>t.reject(this._cancelError)),this._queue=[]}_dispatchQueue(){for(this._drainUnlockWaiters();this._queue.length>0&&this._queue[0].weight<=this._value;)this._dispatchItem(this._queue.shift()),this._drainUnlockWaiters()}_dispatchItem(t){let n=this._value;this._value-=t.weight,t.resolve([n,this._newReleaser(t.weight)])}_newReleaser(t){let n=!1;return()=>{n||(n=!0,this.release(t))}}_drainUnlockWaiters(){if(this._queue.length===0)for(let t=this._value;t>0;t--){let n=this._weightedWaiters[t-1];n&&(n.forEach(r=>r.resolve()),this._weightedWaiters[t-1]=[])}else{let t=this._queue[0].priority;for(let n=this._value;n>0;n--){let r=this._weightedWaiters[n-1];if(!r)continue;let s=r.findIndex(o=>o.priority<=t);(s===-1?r:r.splice(0,s)).forEach((o=>o.resolve()))}}}_couldLockImmediately(t,n){return(this._queue.length===0||this._queue[0].priority<n)&&t<=this._value}};function $f(e,t){let n=Ni(e,r=>t.priority<=r.priority);e.splice(n+1,0,t)}function Ni(e,t){for(let n=e.length-1;n>=0;n--)if(t(e[n]))return n;return-1}var Vf=function(e,t,n,r){function s(o){return o instanceof n?o:new n(function(i){i(o)})}return new(n||(n=Promise))(function(o,i){function a(u){try{l(r.next(u))}catch(f){i(f)}}function c(u){try{l(r.throw(u))}catch(f){i(f)}}function l(u){u.done?o(u.value):s(u.value).then(a,c)}l((r=r.apply(e,t||[])).next())})},_n=class{constructor(t){this._semaphore=new ao(1,t)}acquire(){return Vf(this,arguments,void 0,function*(t=0){let[,n]=yield this._semaphore.acquire(1,t);return n})}runExclusive(t,n=0){return this._semaphore.runExclusive(()=>t(),1,n)}isLocked(){return this._semaphore.isLocked()}waitForUnlock(t=0){return this._semaphore.waitForUnlock(1,t)}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}};var O=typeof browser<"u"?browser:typeof chrome<"u"?chrome:null;if(!O)throw new Error("browser-polyfill: No extension API namespace found (neither browser nor chrome).");var Ae=typeof browser>"u"&&typeof chrome<"u";function Te(e,t){return(...n)=>{try{let r=t.apply(e,n);if(r&&typeof r.then=="function")return r}catch{}return new Promise((r,s)=>{t.apply(e,[...n,(...o)=>{O.runtime&&O.runtime.lastError?s(new Error(O.runtime.lastError.message)):r(o.length<=1?o[0]:o)}])})}}var re={};re.runtime={sendMessage(...e){return Ae?Te(O.runtime,O.runtime.sendMessage)(...e):O.runtime.sendMessage(...e)},onMessage:O.runtime.onMessage,getURL(e){return O.runtime.getURL(e)},openOptionsPage(){return Ae?Te(O.runtime,O.runtime.openOptionsPage)():O.runtime.openOptionsPage()},get id(){return O.runtime.id}};re.storage={local:{get(...e){return Ae?Te(O.storage.local,O.storage.local.get)(...e):O.storage.local.get(...e)},set(...e){return Ae?Te(O.storage.local,O.storage.local.set)(...e):O.storage.local.set(...e)},clear(...e){return Ae?Te(O.storage.local,O.storage.local.clear)(...e):O.storage.local.clear(...e)},remove(...e){return Ae?Te(O.storage.local,O.storage.local.remove)(...e):O.storage.local.remove(...e)}}};re.tabs={create(...e){return Ae?Te(O.tabs,O.tabs.create)(...e):O.tabs.create(...e)},query(...e){return Ae?Te(O.tabs,O.tabs.query)(...e):O.tabs.query(...e)},remove(...e){return Ae?Te(O.tabs,O.tabs.remove)(...e):O.tabs.remove(...e)},update(...e){return Ae?Te(O.tabs,O.tabs.update)(...e):O.tabs.update(...e)},get(...e){return Ae?Te(O.tabs,O.tabs.get)(...e):O.tabs.get(...e)},getCurrent(...e){return Ae?Te(O.tabs,O.tabs.getCurrent)(...e):O.tabs.getCurrent(...e)}};function Mt(e){let t=new Uint8Array(e),n="";for(let r=0;r<t.length;r++)n+=String.fromCharCode(t[r]);return btoa(n)}function Sn(e){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return n.buffer}async function Mi(e,t){let n=new TextEncoder,r=await crypto.subtle.importKey("raw",n.encode(e),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t instanceof Uint8Array?t:new Uint8Array(t),iterations:6e5,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function Ht(e,t){let n=crypto.getRandomValues(new Uint8Array(16)),r=crypto.getRandomValues(new Uint8Array(12)),s=await Mi(t,n),o=new TextEncoder,i=await crypto.subtle.encrypt({name:"AES-GCM",iv:r},s,o.encode(e));return JSON.stringify({salt:Mt(n),iv:Mt(r),ciphertext:Mt(i)})}async function Bn(e,t){let{salt:n,iv:r,ciphertext:s}=JSON.parse(e),o=new Uint8Array(Sn(n)),i=new Uint8Array(Sn(r)),a=Sn(s),c=await Mi(t,o),l=await crypto.subtle.decrypt({name:"AES-GCM",iv:i},c,a);return new TextDecoder().decode(l)}async function An(e,t){t?typeof t=="string"&&(t=new Uint8Array(Sn(t))):t=crypto.getRandomValues(new Uint8Array(16));let n=new TextEncoder,r=await crypto.subtle.importKey("raw",n.encode(e),"PBKDF2",!1,["deriveBits"]),s=await crypto.subtle.deriveBits({name:"PBKDF2",salt:t,iterations:6e5,hash:"SHA-256"},r,256);return{hash:Mt(s),salt:Mt(t)}}async function Hi(e,t,n){let{hash:r}=await An(e,n);return r===t}var Le=re.storage.local,Rp=[new URL("wss://relay.damus.io"),new URL("wss://relay.primal.net"),new URL("wss://relay.snort.social"),new URL("wss://relay.getalby.com/v1"),new URL("wss://nos.lol"),new URL("wss://brb.io"),new URL("wss://nostr.orangepill.dev")];async function Fe(){return(await Le.get({profiles:[]})).profiles}async function ue(e){return(await Fe())[e]}async function se(){return(await Le.get({profileIndex:0})).profileIndex}async function Tn(e){return(await Le.get(e))[e]}async function Di(e,t){let n=await se();return(await ue(n)).hosts?.[e]?.[t]||"ask"}async function co(e,t,n,r=null){let s=await Fe();r||(r=await se());let o=s[r],i=o.hosts[e]||{};i={...i,[t]:n},o.hosts[e]=i,s[r]=o,await Le.set({profiles:s})}async function lo(){let e=await Le.get({isEncrypted:!1,passwordHash:null,profiles:[]});if(e.isEncrypted)return!0;if(e.passwordHash)return await Le.set({isEncrypted:!0}),!0;for(let t of e.profiles)if(Ge(t.privKey))return await Le.set({isEncrypted:!0}),!0;return!1}async function Wf(e){let{hash:t,salt:n}=await An(e);await Le.set({passwordHash:t,passwordSalt:n,isEncrypted:!0})}async function Ln(e){let t=await Le.get({passwordHash:null,passwordSalt:null});return!t.passwordHash||!t.passwordSalt?!1:Hi(e,t.passwordHash,t.passwordSalt)}async function Ki(e){if(!await Ln(e))throw new Error("Invalid password");let n=await Fe();for(let r=0;r<n.length;r++)n[r].type!=="bunker"&&Ge(n[r].privKey)&&(n[r].privKey=await Bn(n[r].privKey,e));await Le.set({profiles:n,isEncrypted:!1,passwordHash:null,passwordSalt:null})}async function qi(e){let t=await Fe();for(let n=0;n<t.length;n++)t[n].type!=="bunker"&&(Ge(t[n].privKey)||(t[n].privKey=await Ht(t[n].privKey,e)));await Wf(e),await Le.set({profiles:t})}async function $i(e,t){let n=await Fe();for(let o=0;o<n.length;o++){if(n[o].type==="bunker")continue;let i=n[o].privKey;Ge(i)&&(i=await Bn(i,e)),n[o].privKey=await Ht(i,t)}let{hash:r,salt:s}=await An(t);await Le.set({profiles:n,passwordHash:r,passwordSalt:s,isEncrypted:!0})}async function Vi(e,t){return e.type==="bunker"?"":Ge(e.privKey)?Bn(e.privKey,t):e.privKey}function Ge(e){if(typeof e!="string")return!1;try{let t=JSON.parse(e);return!!(t.salt&&t.iv&&t.ciphertext)}catch{return!1}}var ho=(e,t)=>t.some(n=>e instanceof n),Wi,zi;function zf(){return Wi||(Wi=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function jf(){return zi||(zi=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var po=new WeakMap,uo=new WeakMap,In=new WeakMap;function Zf(e){let t=new Promise((n,r)=>{let s=()=>{e.removeEventListener("success",o),e.removeEventListener("error",i)},o=()=>{n(dt(e.result)),s()},i=()=>{r(e.error),s()};e.addEventListener("success",o),e.addEventListener("error",i)});return In.set(t,e),t}function Ff(e){if(po.has(e))return;let t=new Promise((n,r)=>{let s=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",i),e.removeEventListener("abort",i)},o=()=>{n(),s()},i=()=>{r(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",o),e.addEventListener("error",i),e.addEventListener("abort",i)});po.set(e,t)}var yo={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return po.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return dt(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function Gi(e){yo=e(yo)}function Gf(e){return jf().includes(e)?function(...t){return e.apply(go(this),t),dt(this.request)}:function(...t){return dt(e.apply(go(this),t))}}function Jf(e){return typeof e=="function"?Gf(e):(e instanceof IDBTransaction&&Ff(e),ho(e,zf())?new Proxy(e,yo):e)}function dt(e){if(e instanceof IDBRequest)return Zf(e);if(uo.has(e))return uo.get(e);let t=Jf(e);return t!==e&&(uo.set(e,t),In.set(t,e)),t}var go=e=>In.get(e);function Ji(e,t,{blocked:n,upgrade:r,blocking:s,terminated:o}={}){let i=indexedDB.open(e,t),a=dt(i);return r&&i.addEventListener("upgradeneeded",c=>{r(dt(i.result),c.oldVersion,c.newVersion,dt(i.transaction),c)}),n&&i.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),a.then(c=>{o&&c.addEventListener("close",()=>o()),s&&c.addEventListener("versionchange",l=>s(l.oldVersion,l.newVersion,l))}).catch(()=>{}),a}var Xf=["get","getKey","getAll","getAllKeys","count"],Yf=["put","add","delete","clear"],fo=new Map;function ji(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(fo.get(t))return fo.get(t);let n=t.replace(/FromIndex$/,""),r=t!==n,s=Yf.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||Xf.includes(n)))return;let o=async function(i,...a){let c=this.transaction(i,s?"readwrite":"readonly"),l=c.store;return r&&(l=l.index(a.shift())),(await Promise.all([l[n](...a),s&&c.done]))[0]};return fo.set(t,o),o}Gi(e=>({...e,get:(t,n,r)=>ji(t,n)||e.get(t,n,r),has:(t,n)=>!!ji(t,n)||e.has(t,n)}));var Qf=["continue","continuePrimaryKey","advance"],Zi={},wo=new WeakMap,Xi=new WeakMap,ed={get(e,t){if(!Qf.includes(t))return e[t];let n=Zi[t];return n||(n=Zi[t]=function(...r){wo.set(this,Xi.get(this)[t](...r))}),n}};async function*td(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;let n=new Proxy(t,ed);for(Xi.set(n,t),In.set(n,go(t));t;)yield n,t=await(wo.get(n)||t.continue()),wo.delete(n)}function Fi(e,t){return t===Symbol.asyncIterator&&ho(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&ho(e,[IDBIndex,IDBObjectStore])}Gi(e=>({...e,get(t,n,r){return Fi(t,n)?td:e.get(t,n,r)},has(t,n){return Fi(t,n)||e.has(t,n)}}));async function nd(){return await Ji("events",1,{upgrade(e){let t=e.createObjectStore("events",{keyPath:"event.id"});t.createIndex("pubkey","event.pubkey"),t.createIndex("created_at","event.created_at"),t.createIndex("kind","event.kind"),t.createIndex("host","metadata.host")}})}async function Yi(e){return(await nd()).put("events",e)}var rd=new TextDecoder("utf-8"),Qi=new TextEncoder,ea=1,ta=65535;function od(e,t){let n=it.getSharedSecret(e,C("02"+t)).subarray(1,33);return fn(te,n,Qi.encode("nip44-v2"))}function na(e,t){let n=dn(te,e,t,76);return{chacha_key:n.subarray(0,32),chacha_nonce:n.subarray(32,44),hmac_key:n.subarray(44,76)}}function bo(e){if(!Number.isSafeInteger(e)||e<1)throw new Error("expected positive integer");if(e<=32)return 32;let t=1<<Math.floor(Math.log2(e-1))+1,n=t<=256?32:t/8;return n*(Math.floor((e-1)/n)+1)}function sd(e){if(!Number.isSafeInteger(e)||e<ea||e>ta)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");let t=new Uint8Array(2);return new DataView(t.buffer).setUint16(0,e,!1),t}function id(e){let t=Qi.encode(e),n=t.length,r=sd(n),s=new Uint8Array(bo(n)-n);return G(r,t,s)}function ad(e){let t=new DataView(e.buffer).getUint16(0),n=e.subarray(2,2+t);if(t<ea||t>ta||n.length!==t||e.length!==2+bo(t))throw new Error("invalid padding");return rd.decode(n)}function ra(e,t,n){if(n.length!==32)throw new Error("AAD associated data must be 32 bytes");let r=G(n,t);return _e(te,e,r)}function cd(e){if(typeof e!="string")throw new Error("payload must be a valid string");let t=e.length;if(t<132||t>87472)throw new Error("invalid payload length: "+t);if(e[0]==="#")throw new Error("unknown encryption version");let n;try{n=be.decode(e)}catch(o){throw new Error("invalid base64: "+o.message)}let r=n.length;if(r<99||r>65603)throw new Error("invalid data length: "+r);let s=n[0];if(s!==2)throw new Error("unknown encryption version "+s);return{nonce:n.subarray(1,33),ciphertext:n.subarray(33,-32),mac:n.subarray(-32)}}function ld(e,t,n=ae(32)){let{chacha_key:r,chacha_nonce:s,hmac_key:o}=na(t,n),i=id(e),a=ut(r,s,i),c=ra(o,a,n);return be.encode(G(new Uint8Array([2]),n,a,c))}function ud(e,t){let{nonce:n,ciphertext:r,mac:s}=cd(e),{chacha_key:o,chacha_nonce:i,hmac_key:a}=na(t,n),c=ra(a,r,n);if(!ct(c,s))throw new Error("invalid MAC");let l=ut(o,i,r);return ad(l)}var Dt={utils:{getConversationKey:od,calcPaddedLen:bo},encrypt:ld,decrypt:ud};var Kt=re.storage.local,Ee=e=>{},ke=new Map;function oa(e){if(!e.startsWith("bunker://"))throw new Error("Invalid bunker URL: must start with bunker://");let t=new URL(e),n=t.hostname||t.pathname.replace("//","");if(!/^[0-9a-f]{64}$/i.test(n))throw new Error("Invalid bunker URL: pubkey must be 64 hex characters");let r=t.searchParams.getAll("relay");if(r.length===0)throw new Error("Invalid bunker URL: at least one relay is required");for(let o of r)try{let i=new URL(o);if(i.protocol!=="wss:"&&i.protocol!=="ws:")throw new Error(`Invalid relay protocol: ${i.protocol}`)}catch{throw new Error(`Invalid relay URL: ${o}`)}let s=t.searchParams.get("secret")||null;return{remotePubkey:n,relays:r,secret:s}}var qt=class{constructor(t){this.url=t,this.ws=null,this.subscriptions=new Map,this.eoseCallbacks=new Map,this.connected=!1,this.reconnectTimer=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5}connect(){return new Promise((t,n)=>{try{this.ws=new WebSocket(this.url)}catch(s){n(new Error(`Failed to create WebSocket: ${s.message}`));return}let r=setTimeout(()=>{this.ws?.close(),n(new Error(`Connection timeout: ${this.url}`))},1e4);this.ws.onopen=()=>{clearTimeout(r),this.connected=!0,this.reconnectAttempts=0,Ee(`Connected to ${this.url}`),t()},this.ws.onerror=s=>{clearTimeout(r),Ee(`WebSocket error: ${this.url}`),n(new Error(`WebSocket error: ${this.url}`))},this.ws.onclose=()=>{this.connected=!1,Ee(`Disconnected from ${this.url}`),this.scheduleReconnect()},this.ws.onmessage=s=>{try{let o=JSON.parse(s.data);this.handleMessage(o)}catch(o){Ee(`Failed to parse message: ${o.message}`)}}})}handleMessage(t){let[n,r,...s]=t;if(n==="EVENT"&&r&&s[0]){let o=s[0],i=this.subscriptions.get(r);i&&i(o)}else if(n==="EOSE"&&r){let o=this.eoseCallbacks.get(r);o&&(this.eoseCallbacks.delete(r),o())}else n==="OK"||n==="NOTICE"&&Ee(`Relay notice: ${s[0]}`)}subscribe(t,n,r,s=null){if(!this.connected||!this.ws)throw new Error("Not connected");this.subscriptions.set(t,r),s&&this.eoseCallbacks.set(t,s),this.ws.send(JSON.stringify(["REQ",t,...n]))}unsubscribe(t){this.ws&&this.connected&&this.ws.send(JSON.stringify(["CLOSE",t])),this.subscriptions.delete(t),this.eoseCallbacks.delete(t)}publish(t){if(!this.connected||!this.ws)throw new Error("Not connected");this.ws.send(JSON.stringify(["EVENT",t]))}scheduleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){Ee(`Max reconnect attempts reached for ${this.url}`);return}let t=Math.min(1e3*Math.pow(2,this.reconnectAttempts),3e4);this.reconnectAttempts++,this.reconnectTimer=setTimeout(()=>{Ee(`Reconnecting to ${this.url} (attempt ${this.reconnectAttempts})`),this.connect().catch(()=>{})},t)}close(){clearTimeout(this.reconnectTimer),this.maxReconnectAttempts=0,this.subscriptions.clear(),this.eoseCallbacks.clear(),this.ws&&(this.ws.close(),this.ws=null),this.connected=!1}},Rn=class{constructor({remotePubkey:t,relays:n,secret:r}){this.remotePubkey=t,this.relayUrls=n,this.secret=r,this.sessionPrivkey=null,this.sessionPubkey=null,this.conversationKey=null,this.relays=[],this.pendingRequests=new Map,this.connected=!1,this.subId=`nostrkey-${crypto.randomUUID().slice(0,8)}`}async init(){if(this.sessionPrivkey)return;let t=await kn();this.sessionPrivkey=C(t.privateKey),this.sessionPubkey=t.publicKey.hex,this.conversationKey=Dt.utils.getConversationKey(this.sessionPrivkey,this.remotePubkey)}async connect(){await this.init();let t=this.relayUrls.map(s=>{let o=new qt(s);return o.connect().then(()=>(this.relays.push(o),o))}),r=(await Promise.allSettled(t)).filter(s=>s.status==="fulfilled");if(r.length===0)throw new Error("Failed to connect to any relay");Ee(`Connected to ${r.length}/${this.relayUrls.length} relays`);for(let s of this.relays)s.subscribe(this.subId,[{kinds:[24133],"#p":[this.sessionPubkey]}],o=>this.handleResponse(o));this.connected=!0,this.secret?await this.sendRequest("connect",[this.remotePubkey,this.secret]):await this.sendRequest("connect",[this.remotePubkey])}handleResponse(t){if(t.pubkey!==this.remotePubkey){Ee(`Ignoring event from unknown pubkey: ${t.pubkey}`);return}try{let n=Dt.decrypt(t.content,this.conversationKey),r=JSON.parse(n);Ee(`Response: ${r.id} -> ${r.result?"ok":r.error}`);let s=this.pendingRequests.get(r.id);s&&(this.pendingRequests.delete(r.id),r.error?s.reject(new Error(r.error)):s.resolve(r.result))}catch(n){Ee(`Failed to handle response: ${n.message}`)}}async sendRequest(t,n=[]){if(!this.connected&&t!=="connect")throw new Error("Not connected to bunker");let r=crypto.randomUUID(),s=JSON.stringify({id:r,method:t,params:n}),o=Dt.encrypt(s,this.conversationKey),i=le({kind:24133,content:o,tags:[["p",this.remotePubkey]],created_at:Math.floor(Date.now()/1e3)},this.sessionPrivkey);for(let a of this.relays)try{a.publish(i)}catch(c){Ee(`Failed to publish to ${a.url}: ${c.message}`)}return new Promise((a,c)=>{let l=setTimeout(()=>{this.pendingRequests.delete(r),c(new Error(`Request timeout: ${t}`))},3e4);this.pendingRequests.set(r,{resolve:u=>{clearTimeout(l),a(u)},reject:u=>{clearTimeout(l),c(u)}})})}async getPublicKey(){return await this.sendRequest("get_public_key")}async signEvent(t){let n=await this.sendRequest("sign_event",[JSON.stringify(t)]);return JSON.parse(n)}async nip04Encrypt(t,n){return await this.sendRequest("nip04_encrypt",[t,n])}async nip04Decrypt(t,n){return await this.sendRequest("nip04_decrypt",[t,n])}async nip44Encrypt(t,n){return await this.sendRequest("nip44_encrypt",[t,n])}async nip44Decrypt(t,n){return await this.sendRequest("nip44_decrypt",[t,n])}async ping(){return await this.sendRequest("ping")}getSessionInfo(){return{remotePubkey:this.remotePubkey,relayUrls:this.relayUrls,secret:this.secret,sessionPrivkey:N(this.sessionPrivkey),sessionPubkey:this.sessionPubkey}}disconnect(){for(let t of this.relays)t.unsubscribe(this.subId),t.close();this.relays=[],this.pendingRequests.clear(),this.connected=!1,Ee("Disconnected from bunker")}};function dd(e){let t=new Rn({remotePubkey:e.remotePubkey,relays:e.relayUrls,secret:e.secret});return t.sessionPrivkey=C(e.sessionPrivkey),t.sessionPubkey=e.sessionPubkey,t.conversationKey=Dt.utils.getConversationKey(t.sessionPrivkey,t.remotePubkey),t}async function Ie(e){if(ke.has(e)){let s=ke.get(e);if(s.connected)return s;s.disconnect(),ke.delete(e)}let n=(await Kt.get({bunkerSessions:{}})).bunkerSessions?.[e];if(!n)throw new Error("No bunker session configured for this profile");let r=dd(n);return await r.connect(),ke.set(e,r),r}async function sa(e,t){ke.has(e)&&(ke.get(e).disconnect(),ke.delete(e));let n=oa(t),r=new Rn(n);await r.connect();let o=(await Kt.get({bunkerSessions:{}})).bunkerSessions||{};return o[e]=r.getSessionInfo(),await Kt.set({bunkerSessions:o}),ke.set(e,r),r}async function ia(e){ke.has(e)&&(ke.get(e).disconnect(),ke.delete(e));let n=(await Kt.get({bunkerSessions:{}})).bunkerSessions||{};delete n[e],await Kt.set({bunkerSessions:n})}function aa(e){return ke.has(e)&&ke.get(e).connected}function ca(e){try{return oa(e),{valid:!0,error:null}}catch(t){return{valid:!1,error:t.message}}}var Un="nostrkey:",hd="nostrkey";function mo(e,t){return{kind:30078,content:t,tags:[["d",`${Un}${e}`],["client",hd]],created_at:Math.floor(Date.now()/1e3)}}function xo(e,t){return{kind:5,content:"vault document deleted",tags:[["e",e],["a",`30078::${Un}${t}`]],created_at:Math.floor(Date.now()/1e3)}}function la(e){return{kinds:[30078],authors:[e]}}function ua(e){if(e.kind!==30078)return null;let t=e.tags?.find(r=>r[0]==="d");if(!t||!t[1]?.startsWith(Un))return null;let n=t[1].slice(Un.length);return n?{path:n,content:e.content,createdAt:e.created_at,eventId:e.id}:null}var ge=re.storage.local,ne=e=>{},He={},Re={mutex:new _n,release:null,tabId:null};function ie(e,t){t().then(n=>e(n)).catch(n=>{e(void 0)})}var vo=new Map,pd=5,yd=1e4;function gd(e){let t=Date.now(),n=vo.get(e)||[];return n=n.filter(r=>t-r<yd),n.length>=pd?(vo.set(e,n),!0):(n.push(t),vo.set(e,n),!1)}var ht=new Map,Bt=null,Oe=!0,Ce=!1,On=900*1e3,St=null;(async()=>{ne("[STARTUP] Reading persisted state...");let e=await ge.get({autoLockMinutes:15,isEncrypted:!1,passwordHash:null});ne(`[STARTUP] isEncrypted=${e.isEncrypted}, passwordHash=${e.passwordHash?"EXISTS":"null"}, autoLockMinutes=${e.autoLockMinutes}`),On=e.autoLockMinutes*60*1e3,!e.isEncrypted&&e.passwordHash&&(ne("[STARTUP] Self-healing: passwordHash exists but isEncrypted=false \u2192 fixing"),await ge.set({isEncrypted:!0}),e.isEncrypted=!0),Ce=e.isEncrypted,Oe=Ce,ne(`[STARTUP] Final state: encryptionEnabled=${Ce}, locked=${Oe}`)})();function nt(){St&&clearTimeout(St),!Oe&&On>0&&(St=setTimeout(()=>{fa()},On))}function fa(){ht.clear(),Bt=null,Oe=!0,St&&(clearTimeout(St),St=null),ne("Session locked.")}async function Eo(e){if(!await Ln(e))return{success:!1,error:"Invalid password"};let n=await Fe(),r=!1;for(let s=0;s<n.length;s++){if(n[s].type==="bunker")continue;let o=await Vi(n[s],e);if(ht.set(s,o),!n[s].pubKey&&o)try{n[s].pubKey=Me(C(o)),r=!0}catch{}}return r&&await ge.set({profiles:n}),Bt=e,Oe=!1,nt(),ne("Session unlocked."),{success:!0}}async function da(){let e=await lo();return ne(`[checkLockState] isEncrypted()=${e}, locked=${Oe}`),e?Oe:(Oe=!1,!1)}re.runtime.onMessage.addListener((e,t,n)=>{ne(e);let r=crypto.randomUUID(),s;switch(e.kind){case"closePrompt":return Re.release?.(),n(!0),!0;case"allowed":return nt(),ko(e),n(!0),!0;case"denied":return Nn(e),n(!0),!0;case"generatePrivateKey":return(async()=>{try{let o=await bd();n(o)}catch{n(null)}})(),!0;case"savePrivateKey":return nt(),vd(e.payload);case"getNpub":return nt(),(async()=>{try{let o=await kd(e.payload);n(o)}catch{n(null)}})(),!0;case"getNsec":return nt(),(async()=>{try{let o=await Ed(e.payload);n(o)}catch{n(null)}})(),!0;case"calcPubKey":return n(Me(e.payload)),!0;case"npubEncode":return n(Ze.npubEncode(e.payload)),!0;case"copy":return typeof navigator<"u"&&navigator.clipboard?.writeText?navigator.clipboard.writeText(e.payload).then(()=>n(!0)).catch(()=>n(!1)):n(!1),!0;case"isLocked":return(async()=>{try{let o=await da();ne(`[isLocked] Sending response: ${o}`),n(o)}catch(o){ne(`[isLocked] Error: ${o.message}`),n(!1)}})(),!0;case"isEncrypted":return(async()=>{try{let o=await ge.get({isEncrypted:!1,passwordHash:null});ne(`[isEncrypted] storage: isEncrypted=${o.isEncrypted}, passwordHash=${o.passwordHash?"EXISTS":"null"}`),!o.isEncrypted&&o.passwordHash&&(ne("[isEncrypted] Self-healing: passwordHash exists but flag=false"),await ge.set({isEncrypted:!0}),o.isEncrypted=!0),Ce=o.isEncrypted,ne(`[isEncrypted] Sending response: ${Ce}`),n(Ce)}catch(o){ne(`[isEncrypted] Error: ${o.message}`),n(!1)}})(),!0;case"hasEncryptedData":return(async()=>{try{let o=await ge.get({passwordHash:null,profiles:[]}),i=!!o.passwordHash,a=0;if(ne(`[hasEncryptedData] passwordHash=${i}, profiles=${Array.isArray(o.profiles)?o.profiles.length:"not-array"}`),Array.isArray(o.profiles))for(let l=0;l<o.profiles.length;l++){let u=o.profiles[l],f=u.privKey?Ge(u.privKey):!1;ne(`[hasEncryptedData] profile[${l}] name="${u.name}" privKey=${u.privKey?f?"ENCRYPTED":"PLAINTEXT("+u.privKey.substring(0,8)+"...)":"EMPTY"}`),f&&a++}let c=i||a>0;ne(`[hasEncryptedData] Result: found=${c}, hasPasswordHash=${i}, encryptedProfiles=${a}`),c&&!Ce&&(ne("[hasEncryptedData] Self-healing: setting isEncrypted=true, locked=true"),await ge.set({isEncrypted:!0}),Ce=!0,Oe=!0),n({found:c,hasPasswordHash:i,encryptedProfiles:a})}catch{n({found:!1,hasPasswordHash:!1,encryptedProfiles:0})}})(),!0;case"unlock":return ie(n,()=>Eo(e.payload)),!0;case"lock":return fa(),n(!0),!0;case"setPassword":return(async()=>{try{await xd(),await qi(e.payload),Ce=!0;let o=await Eo(e.payload);re.runtime.sendMessage({kind:"passwordStateChanged",hasPassword:!0}).catch(()=>{}),n(o)}catch(o){n({success:!1,error:o.message})}})(),!0;case"changePassword":return(async()=>{try{let{oldPassword:o,newPassword:i}=e.payload;if(!await Ln(o)){n({success:!1,error:"Invalid current password"});return}await $i(o,i);let c=await Eo(i);re.runtime.sendMessage({kind:"passwordStateChanged",hasPassword:!0}).catch(()=>{}),n(c)}catch(o){n({success:!1,error:o.message})}})(),!0;case"removePassword":return(async()=>{try{await Ki(e.payload),ht.clear(),Bt=null,Oe=!1,Ce=!1,re.runtime.sendMessage({kind:"passwordStateChanged",hasPassword:!1}).catch(()=>{}),n({success:!0})}catch(o){n({success:!1,error:o.message})}})(),!0;case"resetAllData":return(async()=>{try{await ge.clear(),ht.clear(),Bt=null,Oe=!1,Ce=!1,await ge.set({profiles:[{name:"Default Nostr Profile",privKey:"",pubKey:""}],profileIndex:0,isEncrypted:!1,passwordHash:null,passwordSalt:null}),re.runtime.sendMessage({kind:"dataReset"}).catch(()=>{}),n({success:!0})}catch(o){n({success:!1,error:o.message})}})(),!0;case"setAutoLockTimeout":return On=e.payload*60*1e3,ge.set({autoLockMinutes:e.payload}),nt(),n(!0),!0;case"getAutoLockTimeout":return ie(n,async()=>{let{autoLockMinutes:o}=await ge.get({autoLockMinutes:15});return o}),!0;case"resetAutoLock":return nt(),n(!0),!0;case"ncryptsec.decrypt":return ie(n,async()=>{try{let{ncryptsec:o,password:i}=e.payload;return{success:!0,hexKey:N(Oi(o,i))}}catch(o){return{success:!1,error:o.message||"Decryption failed"}}}),!0;case"ncryptsec.encrypt":return ie(n,async()=>{try{let{profileIndex:o,password:i}=e.payload,a=await ue(o);if(a?.type==="bunker")return{success:!1,error:"Cannot export bunker profile as ncryptsec"};let c=await Mn(o,a);return{success:!0,ncryptsec:Ci(C(c),i)}}catch(o){return{success:!1,error:o.message||"Encryption failed"}}}),!0;case"getProfileType":return ie(n,async()=>{let o=e.payload??await se();return(await ue(o))?.type||"local"}),!0;case"bunker.connect":return ie(n,async()=>{try{let{profileIndex:o,bunkerUrl:i}=e.payload,c=await(await sa(o,i)).getPublicKey(),l=await Fe();return l[o].remotePubkey=c,l[o].bunkerUrl=i,await ge.set({profiles:l}),{success:!0,remotePubkey:c}}catch(o){return{success:!1,error:o.message}}}),!0;case"bunker.disconnect":return ie(n,async()=>{try{let o=e.payload;return await ia(o),{success:!0}}catch(o){return{success:!1,error:o.message}}}),!0;case"bunker.status":return ie(n,async()=>{let o=e.payload??await se();return{connected:aa(o)}}),!0;case"bunker.ping":return ie(n,async()=>{try{let o=e.payload??await se();return{success:!0,result:await(await Ie(o)).ping()}}catch(o){return{success:!1,error:o.message}}}),!0;case"bunker.validateUrl":return n(ca(e.payload)),!0;case"vault.publish":return ie(n,async()=>{try{let{path:o,content:i}=e.payload,a=await tt(),c=await Pn({pubKey:a,plainText:i}),l=mo(o,c),u=await se(),f=await ue(u),h;if(f.type==="bunker")h=await(await Ie(u)).signEvent(l);else{let d=await De();h=le(l,d)}return await _t("write",async d=>{for(let p of d)try{p.publish(h)}catch{}}),{success:!0,eventId:h.id,createdAt:h.created_at}}catch(o){return{success:!1,error:o.message}}}),!0;case"vault.fetch":return ie(n,async()=>{try{let o=await tt(),i=la(o),a=[];await _t("read",async f=>{let h=f.map(d=>new Promise(p=>{let y=`vault-${crypto.randomUUID().slice(0,8)}`,w=setTimeout(()=>{try{d.unsubscribe(y)}catch{}p()},15e3);d.subscribe(y,[i],b=>{a.push(b)},()=>{clearTimeout(w);try{d.unsubscribe(y)}catch{}p()})}));await Promise.all(h)});let c=new Map;for(let f of a){let h=ua(f);if(!h)continue;let d=c.get(h.path);(!d||h.createdAt>d.createdAt)&&c.set(h.path,{event:f,parsed:h})}let l=[],u=await tt();for(let{event:f,parsed:h}of c.values())try{let d=await Cn({pubKey:u,cipherText:f.content});l.push({path:h.path,content:d,createdAt:h.createdAt,eventId:h.eventId})}catch{}return{success:!0,documents:l}}catch(o){return{success:!1,error:o.message}}}),!0;case"vault.delete":return ie(n,async()=>{try{let{path:o,eventId:i}=e.payload,a=xo(i,o),c=await se(),l=await ue(c),u;if(l.type==="bunker")u=await(await Ie(c)).signEvent(a);else{let f=await De();u=le(a,f)}return await _t("write",async f=>{for(let h of f)try{h.publish(u)}catch{}}),{success:!0}}catch(o){return{success:!1,error:o.message}}}),!0;case"vault.getRelays":return ie(n,async()=>{try{let i=(await Hn()).relays||[],a=i.filter(l=>l.read).map(l=>l.url),c=i.filter(l=>l.write).map(l=>l.url);return{read:a,write:c}}catch{return{read:[],write:[]}}}),!0;case"apikeys.publish":return ie(n,async()=>{try{let{keys:o}=e.payload,i=await tt(),a=JSON.stringify(o),c=await Pn({pubKey:i,plainText:a}),l=mo("vault/api-keys",c),u=await se(),f=await ue(u),h;if(f.type==="bunker")h=await(await Ie(u)).signEvent(l);else{let d=await De();h=le(l,d)}return await _t("write",async d=>{for(let p of d)try{p.publish(h)}catch{}}),{success:!0,eventId:h.id,createdAt:h.created_at}}catch(o){return{success:!1,error:o.message}}}),!0;case"apikeys.fetch":return ie(n,async()=>{try{let o=await tt(),i={kinds:[30078],authors:[o],"#d":["nostrkey:vault/api-keys"]},a=[];await _t("read",async f=>{let h=f.map(d=>new Promise(p=>{let y=`apikeys-${crypto.randomUUID().slice(0,8)}`,w=setTimeout(()=>{try{d.unsubscribe(y)}catch{}p()},15e3);d.subscribe(y,[i],b=>{a.push(b)},()=>{clearTimeout(w);try{d.unsubscribe(y)}catch{}p()})}));await Promise.all(h)});let c=null;for(let f of a)(!c||f.created_at>c.created_at)&&(c=f);if(!c)return{success:!0,keys:null,eventId:null,createdAt:null};let l=await Cn({pubKey:o,cipherText:c.content});return{success:!0,keys:JSON.parse(l),eventId:c.id,createdAt:c.created_at}}catch(o){return{success:!1,error:o.message}}}),!0;case"apikeys.delete":return ie(n,async()=>{try{let{eventId:o}=e.payload,i=xo(o,"vault/api-keys"),a=await se(),c=await ue(a),l;if(c.type==="bunker")l=await(await Ie(a)).signEvent(i);else{let u=await De();l=le(i,u)}return await _t("write",async u=>{for(let f of u)try{f.publish(l)}catch{}}),{success:!0}}catch(o){return{success:!1,error:o.message}}}),!0;case"apikeys.encrypt":return ie(n,async()=>{try{let{plainText:o}=e.payload,i=await tt();return{success:!0,cipherText:await Pn({pubKey:i,plainText:o})}}catch(o){return{success:!1,error:o.message}}}),!0;case"apikeys.decrypt":return ie(n,async()=>{try{let{cipherText:o}=e.payload,i=await tt();return{success:!0,plainText:await Cn({pubKey:i,cipherText:o})}}catch(o){return{success:!1,error:o.message}}}),!0;case"replaceURL":return ie(n,async()=>{let{protocol_handler:o}=await ge.get(["protocol_handler"]);if(!o)return!1;let{url:i}=e.payload,a=i.split("nostr:")[1];if(!a)return!1;try{let{type:c,data:l}=Ze.decode(a),u={raw:a,hrp:c,hex:c==="npub"||c==="note"?l:c==="nprofile"?l.pubkey:c==="nevent"?l.id:c==="naddr"?l.pubkey:a,p_or_e:{npub:"p",note:"e",nprofile:"p",nevent:"e",naddr:"a"}[c]||"",u_or_n:{npub:"u",note:"n",nprofile:"u",nevent:"n",naddr:"n"}[c]||"",relay0:l?.relays?.[0]||"",relay1:l?.relays?.[1]||"",relay2:l?.relays?.[2]||""},f=o;for(let[h,d]of Object.entries(u))f=f.replace(new RegExp(`\\{ *${h} *\\}`,"g"),d);return f}catch{return!1}}),!0;case"getPubKey":case"signEvent":case"nip04.encrypt":case"nip04.decrypt":case"nip44.encrypt":case"nip44.decrypt":case"getRelays":return He[r]=n,md(r,e),setTimeout(()=>{He[r]&&Nn({payload:r,origKind:e.kind,host:e.host}),Re.release?.()},1e4),!0;default:return!1}});async function wd(){if(Re.tabId!==null)try{await re.tabs.get(Re.tabId)}catch{Re.release?.(),Re.tabId=null}}async function bd(){return(await kn()).privateKey}async function md(e,{kind:t,host:n,payload:r}){let s=await se();if(!((await ue(s))?.type==="bunker")&&await da()){let d=He[e];delete He[e],d?.({error:"locked",message:"Extension is locked. Please unlock with your master password."});return}if(gd(n)){let h=He[e];delete He[e],h?.({error:"rate_limited",message:"Too many requests. Please wait."}),ne(`Rate limited: ${n}`);return}nt(),await wd(),Re.release=await Re.mutex.acquire();let a=t==="signEvent"?`signEvent:${r.kind}`:t,c=await Di(n,a);if(c==="allow"){ko({payload:e,origKind:t,event:r,remember:!1,host:n}),Re.release();return}if(c==="deny"){Nn({payload:e,origKind:t,host:n}),Re.release();return}try{let[h]=await re.tabs.query({active:!0,currentWindow:!0});if(h?.id){let d=await re.tabs.sendMessage(h.id,{kind:"showPermissionSheet",host:n,permissionKind:t});if(d){d.allowed?ko({payload:e,origKind:t,event:r,remember:d.remember,host:n}):Nn({payload:e,origKind:t,event:r,remember:d.remember,host:n}),Re.release();return}}}catch(h){ne("Bottom sheet unavailable, falling back to tab:",h.message)}let l=new URLSearchParams({uuid:e,kind:t,host:n,payload:JSON.stringify(r||!1)}),u=await re.tabs.getCurrent(),f=await re.tabs.create({url:re.runtime.getURL(`permission/permission.html?${l.toString()}`),openerTabId:u?.id});return Re.tabId=f.id,!0}function ko({payload:e,origKind:t,event:n,remember:r,host:s}){let o=He[e];if(delete He[e],r){let i=t==="signEvent"?`signEvent:${n.kind}`:t;co(s,i,"allow")}if(o){let i=a=>{ne(`Error in ${t}: ${a.message}`),o({error:"bunker_error",message:a.message})};switch(t){case"getPubKey":tt().then(a=>o(a)).catch(i);break;case"signEvent":_d(n,s).then(a=>o(a)).catch(i);break;case"nip04.encrypt":Sd(n).then(a=>o(a)).catch(i);break;case"nip04.decrypt":Bd(n).then(a=>o(a)).catch(i);break;case"nip44.encrypt":Pn(n).then(a=>o(a)).catch(i);break;case"nip44.decrypt":Cn(n).then(a=>o(a)).catch(i);break;case"getRelays":Ad().then(a=>o(a)).catch(i);break}}}function Nn({origKind:e,host:t,payload:n,remember:r,event:s}){let o=He[n];if(delete He[n],r){let i=e==="signEvent"?`signEvent:${s.kind}`:e;co(t,i,"deny")}return o?.(void 0),!1}async function xd(){let e=await Fe(),t=!1;for(let n=0;n<e.length;n++){let r=e[n];if(r.type!=="bunker"&&!r.pubKey&&!(!r.privKey||Ge(r.privKey)))try{let s=Me(C(r.privKey));e[n].pubKey=s,t=!0}catch{}}t&&await ge.set({profiles:e})}async function vd([e,t]){if((await ue(e))?.type==="bunker")throw new Error("Cannot set private key on a bunker profile");if(typeof t!="string"||t.length===0)throw new Error("Invalid private key: must be a non-empty string");let r;if(t.startsWith("nsec"))try{let a=Ze.decode(t).data;r=N(a)}catch{throw new Error("Invalid nsec key")}else r=t;if(!/^[0-9a-f]{64}$/i.test(r))throw new Error("Invalid private key: must be 64 hex characters or valid nsec");let s=await Tn("profiles");if(!s||e<0||e>=s.length)throw new Error("Invalid profile index");let o=Me(C(r));return s[e].pubKey=o,await lo()&&Bt?(s[e].privKey=await Ht(r,Bt),ht.set(e,r)):s[e].privKey=r,await ge.set({profiles:s}),!0}async function Ed(e){let t=await ue(e);if(t.type==="bunker")return null;let n=await Mn(e,t);return Ze.nsecEncode(C(n))}async function kd(e){let t=await ue(e);if(!t)return null;if(t.type==="bunker")return t.remotePubkey?Ze.npubEncode(t.remotePubkey):null;if(t.pubKey)return Ze.npubEncode(t.pubKey);try{let n=await Mn(e,t);if(!n||typeof n!="string"||n.length!==64)return null;let r=Me(C(n));return Ze.npubEncode(r)}catch{return null}}async function Mn(e,t){if(Ge(t.privKey)){if(ht.has(e))return ht.get(e);throw new Error("Extension is locked \u2014 cannot access private key")}return t.privKey}async function De(){let e=await se(),t=await Hn(),n=await Mn(e,t);return C(n)}async function tt(){let e=await se(),t=await ue(e);if(t.type==="bunker"){if(t.remotePubkey)return t.remotePubkey;let o=await(await Ie(e)).getPublicKey(),i=await Tn("profiles");return i[e].remotePubkey=o,await ge.set({profiles:i}),o}let n=await De();return Me(n)}async function Hn(){let e=await se();return(await Tn("profiles"))[e]}async function _d(e,t){e=JSON.parse(JSON.stringify(e));let n=await se();if((await ue(n)).type==="bunker")e=await(await Ie(n)).signEvent(e);else{let s=await De();e=le(e,s)}return Yi({event:e,metadata:{host:t,signed_at:Math.round(Date.now()/1e3)}}),e}async function Sd({pubKey:e,plainText:t}){let n=await se();if((await ue(n)).type==="bunker")return(await Ie(n)).nip04Encrypt(e,t);let s=await De();return vn.encrypt(s,e,t)}async function Bd({pubKey:e,cipherText:t}){let n=await se();if((await ue(n)).type==="bunker")return(await Ie(n)).nip04Decrypt(e,t);let s=await De();return vn.decrypt(s,e,t)}async function Pn({pubKey:e,plainText:t}){let n=await se();if((await ue(n)).type==="bunker")return(await Ie(n)).nip44Encrypt(e,t);let s=await De(),o=kt.v2.utils.getConversationKey(s,e);return kt.v2.encrypt(t,o)}async function Cn({pubKey:e,cipherText:t}){let n=await se();if((await ue(n)).type==="bunker")return(await Ie(n)).nip44Decrypt(e,t);let s=await De(),o=kt.v2.utils.getConversationKey(s,e);return kt.v2.decrypt(t,o)}async function Ad(){let t=(await Hn()).relays,n={};return t.forEach(r=>{let{url:s,read:o,write:i}=r;n[s]={read:o,write:i}}),n}async function _t(e,t){let s=((await Hn()).relays||[]).filter(a=>e==="read"?a.read:a.write).map(a=>a.url);if(s.length===0)throw new Error("No relays configured");let o=[],i=s.map(async a=>{let c=new qt(a);try{await c.connect(),o.push(c)}catch{}});if(await Promise.allSettled(i),o.length===0)throw new Error("Failed to connect to any relay");try{await t(o)}finally{for(let a of o)a.close()}}})();
/*! Bundled license information:

@noble/hashes/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/utils.js:
@noble/curves/abstract/modular.js:
@noble/curves/abstract/curve.js:
@noble/curves/abstract/weierstrass.js:
@noble/curves/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@scure/base/index.js:
  (*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/ciphers/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)
*/
