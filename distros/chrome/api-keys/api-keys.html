<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script defer src="api-keys.build.js"></script>
        <link rel="stylesheet" href="/options.build.css" />
        <title>API Key Vault</title>
    </head>

    <body class="text-fuchsia-900 p-3.5 lg:p-32" x-data="apiKeyManager" x-cloak>
        <p>
            <a href="/options.html" class="border-none hover:underline"
                >&larr; Back</a
            >
        </p>

        <h1 class="section-header">API Key Vault</h1>
        <p class="text-sm italic">
            Store API keys encrypted to your Nostr key. Synced via NIP-78 relays
            or kept local-only.
        </p>

        <!-- Sync bar -->
        <div class="mt-3 flex items-center gap-2 text-sm flex-wrap">
            <span
                class="inline-block w-3 h-3 rounded-full"
                :class="{
                    'bg-green-500': globalSyncStatus === 'idle',
                    'bg-yellow-500 animate-pulse': globalSyncStatus === 'syncing',
                    'bg-red-500': globalSyncStatus === 'error',
                }"
            ></span>
            <span
                x-text="globalSyncStatus === 'syncing' ? 'Syncing...' : globalSyncStatus === 'error' ? syncError : (syncEnabled ? 'Synced' : 'Local only')"
            ></span>
            <button
                class="button text-xs"
                @click="syncAll"
                :disabled="globalSyncStatus === 'syncing' || !hasRelays || !syncEnabled"
            >
                Sync Now
            </button>
            <label class="flex items-center gap-1 text-xs cursor-pointer">
                <input
                    type="checkbox"
                    class="checkbox"
                    x-model="syncEnabled"
                    @change="toggleSync"
                />
                Relay sync
            </label>
            <span
                class="text-xs text-gray-500"
                x-text="`${keys.length} key${keys.length !== 1 ? 's' : ''}`"
            ></span>
        </div>

        <!-- Key table -->
        <div class="mt-4" x-show="keys.length > 0">
            <table class="w-full text-sm table-auto">
                <thead class="text-left">
                    <tr class="border-b border-fuchsia-200">
                        <th class="p-2">Label</th>
                        <th class="p-2">Secret</th>
                        <th class="p-2 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="key in sortedKeys" :key="key.id">
                        <tr class="border-b border-fuchsia-100 hover:bg-fuchsia-50">
                            <!-- Label cell -->
                            <td class="p-2">
                                <template x-if="editingId === key.id">
                                    <input
                                        x-model="editLabel"
                                        type="text"
                                        class="input text-sm w-full"
                                        autocomplete="off"
                                        @keyup.enter="saveEdit"
                                        @keyup.escape="cancelEdit"
                                    />
                                </template>
                                <template x-if="editingId !== key.id">
                                    <span
                                        class="cursor-pointer hover:underline"
                                        @click="startEdit(key)"
                                        x-text="key.label"
                                    ></span>
                                </template>
                            </td>

                            <!-- Secret cell -->
                            <td class="p-2 font-mono text-xs">
                                <template x-if="editingId === key.id">
                                    <input
                                        x-model="editSecret"
                                        type="text"
                                        class="input text-xs font-mono w-full"
                                        autocomplete="off"
                                        spellcheck="false"
                                        @keyup.enter="saveEdit"
                                        @keyup.escape="cancelEdit"
                                    />
                                </template>
                                <template x-if="editingId !== key.id">
                                    <span
                                        class="cursor-pointer"
                                        @click="revealedId === key.id ? (revealedId = null) : (revealedId = key.id)"
                                        x-text="revealedId === key.id ? key.secret : maskSecret(key.secret)"
                                    ></span>
                                </template>
                            </td>

                            <!-- Actions cell -->
                            <td class="p-2 text-right whitespace-nowrap">
                                <template x-if="editingId === key.id">
                                    <span>
                                        <button class="button text-xs" @click="saveEdit">Save</button>
                                        <button class="button text-xs" @click="cancelEdit">Cancel</button>
                                    </span>
                                </template>
                                <template x-if="editingId !== key.id">
                                    <span>
                                        <button
                                            class="button text-xs"
                                            @click="copySecret(key.id)"
                                            x-text="copiedId === key.id ? 'Copied!' : 'Copy'"
                                        ></button>
                                        <button
                                            class="button text-xs"
                                            @click="deleteKey(key.id)"
                                        >Del</button>
                                    </span>
                                </template>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <div
            x-show="keys.length === 0"
            class="mt-4 text-gray-400 italic text-sm"
        >
            No API keys stored yet.
        </div>

        <!-- Add key form -->
        <div class="mt-4 p-3 border border-fuchsia-200 rounded">
            <h3 class="text-sm font-bold mb-2">Add Key</h3>
            <div class="flex flex-col md:flex-row gap-2">
                <input
                    x-model="newLabel"
                    type="text"
                    class="input text-sm flex-1"
                    placeholder="Label (e.g. OpenAI)"
                    autocomplete="off"
                />
                <input
                    x-model="newSecret"
                    type="text"
                    class="input text-sm font-mono flex-1"
                    placeholder="Secret key"
                    autocomplete="off"
                    spellcheck="false"
                />
                <button
                    class="button text-sm"
                    @click="addKey"
                    :disabled="saving || newLabel.trim().length === 0 || newSecret.trim().length === 0"
                    x-text="saving ? 'Saving...' : 'Save'"
                ></button>
            </div>
        </div>

        <!-- Import / Export -->
        <div class="mt-4 flex gap-2 items-center">
            <button class="button text-sm" @click="exportKeys">Export</button>
            <label class="button text-sm cursor-pointer">
                Import
                <input
                    type="file"
                    accept=".json"
                    class="hidden"
                    @change="importKeys($event)"
                />
            </label>
        </div>

        <!-- Toast -->
        <div
            class="fixed top-0 right-0 bg-fuchsia-800 rounded-md p-4 text-white m-8 drop-shadow-md"
            x-show="toast.length > 0"
            x-transition:enter.opacity.delay.75ms
            x-transition:leave.opacity
            x-cloak
            x-text="toast"
        ></div>
    </body>
</html>
