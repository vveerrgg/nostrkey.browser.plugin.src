(()=>{var a=typeof browser<"u"?browser:typeof chrome<"u"?chrome:null;if(!a)throw new Error("browser-polyfill: No extension API namespace found (neither browser nor chrome).");var y=typeof browser>"u"&&typeof chrome<"u";function f(e,n){return(...r)=>{try{let o=n.apply(e,r);if(o&&typeof o.then=="function")return o}catch{}return new Promise((o,c)=>{n.apply(e,[...r,(...l)=>{a.runtime&&a.runtime.lastError?c(new Error(a.runtime.lastError.message)):o(l.length<=1?l[0]:l)}])})}}var u={};u.runtime={sendMessage(...e){return y?f(a.runtime,a.runtime.sendMessage)(...e):a.runtime.sendMessage(...e)},onMessage:a.runtime.onMessage,getURL(e){return a.runtime.getURL(e)},openOptionsPage(){return y?f(a.runtime,a.runtime.openOptionsPage)():a.runtime.openOptionsPage()},get id(){return a.runtime.id}};u.storage={local:{get(...e){return y?f(a.storage.local,a.storage.local.get)(...e):a.storage.local.get(...e)},set(...e){return y?f(a.storage.local,a.storage.local.set)(...e):a.storage.local.set(...e)},clear(...e){return y?f(a.storage.local,a.storage.local.clear)(...e):a.storage.local.clear(...e)},remove(...e){return y?f(a.storage.local,a.storage.local.remove)(...e):a.storage.local.remove(...e)}}};u.tabs={create(...e){return y?f(a.tabs,a.tabs.create)(...e):a.tabs.create(...e)},query(...e){return y?f(a.tabs,a.tabs.query)(...e):a.tabs.query(...e)},remove(...e){return y?f(a.tabs,a.tabs.remove)(...e):a.tabs.remove(...e)},update(...e){return y?f(a.tabs,a.tabs.update)(...e):a.tabs.update(...e)},get(...e){return y?f(a.tabs,a.tabs.get)(...e):a.tabs.get(...e)},getCurrent(...e){return y?f(a.tabs,a.tabs.getCurrent)(...e):a.tabs.getCurrent(...e)}};var j=u.storage.local,C="apiKeyVault",U={keys:{},syncEnabled:!0,eventId:null,relayCreatedAt:null,syncStatus:"synced"};async function g(){let e=await j.get({[C]:U});return{...U,...e[C]}}async function S(e){await j.set({[C]:e})}async function K(){return g()}async function T(e,n,r){let o=await g(),c=Math.floor(Date.now()/1e3),l=o.keys[e];return o.keys[e]={id:e,label:n,secret:r,createdAt:l?.createdAt||c,updatedAt:c},await S(o),o.keys[e]}async function D(e){let n=await g();delete n.keys[e],await S(n)}async function k(){let e=await g();return Object.values(e.keys).sort((n,r)=>n.label.toLowerCase().localeCompare(r.label.toLowerCase()))}async function N(e){let n=await g();n.syncEnabled=e,await S(n)}async function B(){return(await g()).syncEnabled}async function E(e,n=null,r=null){let o=await g();o.syncStatus=e,n!==null&&(o.eventId=n),r!==null&&(o.relayCreatedAt=r),await S(o)}async function P(){return(await g()).keys}async function v(e){let n=await g();for(let[r,o]of Object.entries(e))n.keys[r]=o;await S(n)}var t={keys:[],newLabel:"",newSecret:"",editingId:null,editLabel:"",editSecret:"",copiedId:null,revealedId:null,syncEnabled:!0,globalSyncStatus:"idle",syncError:"",saving:!1,toast:"",relayInfo:{read:[],write:[]}};function i(e){return document.getElementById(e)}function m(){return t.relayInfo.read.length>0||t.relayInfo.write.length>0}function F(){return[...t.keys].sort((e,n)=>e.label.toLowerCase().localeCompare(n.label.toLowerCase()))}function G(e){return e?e.length<=8?"\u2022".repeat(e.length):e.slice(0,4)+"\u2022".repeat(4)+e.slice(-4):""}function w(e){t.toast=e,d(),setTimeout(()=>{t.toast="",d()},2e3)}function V(e){return e==="idle"?"bg-green-500":e==="syncing"?"bg-yellow-500 animate-pulse":"bg-red-500"}function Y(){return t.globalSyncStatus==="syncing"?"Syncing...":t.globalSyncStatus==="error"?t.syncError:t.syncEnabled?"Synced":"Local only"}function d(){let e=i("sync-dot"),n=i("sync-text"),r=i("sync-btn"),o=i("sync-toggle"),c=i("key-count");e&&(e.className=`inline-block w-3 h-3 rounded-full ${V(t.globalSyncStatus)}`),n&&(n.textContent=Y()),r&&(r.disabled=t.globalSyncStatus==="syncing"||!m()||!t.syncEnabled),o&&(o.checked=t.syncEnabled),c&&(c.textContent=t.keys.length+" key"+(t.keys.length!==1?"s":""));let l=i("key-table-container"),R=i("no-keys"),b=i("key-table-body");if(l&&(l.style.display=t.keys.length>0?"block":"none"),R&&(R.style.display=t.keys.length===0?"block":"none"),b){let _=F();b.innerHTML=_.map(s=>{if(t.editingId===s.id)return`
                    <tr class="border-b border-monokai-bg-lighter hover:bg-monokai-bg-lighter">
                        <td class="p-2">
                            <input
                                type="text"
                                class="input text-sm w-full"
                                autocomplete="off"
                                data-edit-label="${s.id}"
                                value="${J(t.editLabel)}"
                            />
                        </td>
                        <td class="p-2 font-mono text-xs">
                            <input
                                type="text"
                                class="input text-xs font-mono w-full"
                                autocomplete="off"
                                spellcheck="false"
                                data-edit-secret="${s.id}"
                                value="${J(t.editSecret)}"
                            />
                        </td>
                        <td class="p-2 text-right whitespace-nowrap">
                            <button class="button text-xs" data-action="save-edit">Save</button>
                            <button class="button text-xs" data-action="cancel-edit">Cancel</button>
                        </td>
                    </tr>
                `;let p=t.revealedId===s.id?M(s.secret):M(G(s.secret)),H=t.copiedId===s.id?"Copied!":"Copy";return`
                <tr class="border-b border-monokai-bg-lighter hover:bg-monokai-bg-lighter">
                    <td class="p-2">
                        <span class="cursor-pointer hover:underline" data-action="start-edit" data-key-id="${s.id}">${M(s.label)}</span>
                    </td>
                    <td class="p-2 font-mono text-xs">
                        <span class="cursor-pointer" data-action="toggle-reveal" data-key-id="${s.id}">${p}</span>
                    </td>
                    <td class="p-2 text-right whitespace-nowrap">
                        <button class="button text-xs" data-action="copy-secret" data-key-id="${s.id}">${H}</button>
                        <button class="button text-xs" data-action="delete-key" data-key-id="${s.id}">Del</button>
                    </td>
                </tr>
            `}).join(""),b.querySelectorAll('[data-action="start-edit"]').forEach(s=>{s.addEventListener("click",()=>Q(s.dataset.keyId))}),b.querySelectorAll('[data-action="toggle-reveal"]').forEach(s=>{s.addEventListener("click",()=>{t.revealedId=t.revealedId===s.dataset.keyId?null:s.dataset.keyId,d()})}),b.querySelectorAll('[data-action="copy-secret"]').forEach(s=>{s.addEventListener("click",()=>X(s.dataset.keyId))}),b.querySelectorAll('[data-action="delete-key"]').forEach(s=>{s.addEventListener("click",()=>W(s.dataset.keyId))}),b.querySelectorAll('[data-action="save-edit"]').forEach(s=>{s.addEventListener("click",O)}),b.querySelectorAll('[data-action="cancel-edit"]').forEach(s=>{s.addEventListener("click",$)}),b.querySelectorAll("[data-edit-label]").forEach(s=>{s.addEventListener("input",p=>{t.editLabel=p.target.value}),s.addEventListener("keyup",p=>{p.key==="Enter"&&O(),p.key==="Escape"&&$()})}),b.querySelectorAll("[data-edit-secret]").forEach(s=>{s.addEventListener("input",p=>{t.editSecret=p.target.value}),s.addEventListener("keyup",p=>{p.key==="Enter"&&O(),p.key==="Escape"&&$()})})}let x=i("new-label"),L=i("new-secret"),I=i("add-key-btn");x&&document.activeElement!==x&&(x.value=t.newLabel),L&&document.activeElement!==L&&(L.value=t.newSecret),I&&(I.disabled=t.saving||t.newLabel.trim().length===0||t.newSecret.trim().length===0,I.textContent=t.saving?"Saving...":"Save");let A=i("toast");A&&(A.textContent=t.toast,A.style.display=t.toast?"block":"none")}function M(e){let n=document.createElement("div");return n.textContent=e,n.innerHTML}function J(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}async function z(){let e=t.newLabel.trim(),n=t.newSecret.trim();if(!e||!n)return;t.saving=!0,d();let r=crypto.randomUUID();await T(r,e,n),t.keys=await k(),t.newLabel="",t.newSecret="",t.syncEnabled&&m()&&await h(),t.saving=!1,w("Key added")}function Q(e){let n=t.keys.find(r=>r.id===e);n&&(t.editingId=n.id,t.editLabel=n.label,t.editSecret=n.secret,d())}async function O(){if(!t.editingId)return;let e=t.editLabel.trim(),n=t.editSecret.trim();!e||!n||(await T(t.editingId,e,n),t.keys=await k(),t.editingId=null,t.editLabel="",t.editSecret="",t.syncEnabled&&m()&&await h(),w("Key updated"))}function $(){t.editingId=null,t.editLabel="",t.editSecret="",d()}async function W(e){let n=t.keys.find(r=>r.id===e);n&&confirm(`Delete "${n.label}"?`)&&(await D(e),t.keys=await k(),t.syncEnabled&&m()&&await h(),w("Key deleted"))}async function X(e){let n=t.keys.find(r=>r.id===e);n&&(await navigator.clipboard.writeText(n.secret),t.copiedId=e,d(),setTimeout(()=>{t.copiedId=null,d()},2e3),setTimeout(()=>{navigator.clipboard.writeText("").catch(()=>{})},3e4))}async function h(){try{let e=await K(),n=await u.runtime.sendMessage({kind:"apikeys.publish",payload:{keys:e.keys}});return n.success&&await E("synced",n.eventId,n.createdAt),n}catch(e){return await E("local-only"),{success:!1,error:e.message}}}async function q(){t.globalSyncStatus="syncing",t.syncError="",d();try{let e=await u.runtime.sendMessage({kind:"apikeys.fetch"});if(!e.success){t.globalSyncStatus="error",t.syncError=e.error||"Sync failed",d();return}if(e.keys){let n=await K(),r=n.keys;Object.keys(r).length===0?await v(e.keys):(!n.relayCreatedAt||e.createdAt>n.relayCreatedAt)&&await v(e.keys),await E("synced",e.eventId,e.createdAt),t.keys=await k()}t.globalSyncStatus="idle"}catch(e){t.globalSyncStatus="error",t.syncError=e.message||"Sync failed"}d()}async function Z(){await N(t.syncEnabled),t.syncEnabled&&m()&&await q()}async function ee(){let e=await P(),n=JSON.stringify(e,null,2),r=await u.runtime.sendMessage({kind:"apikeys.encrypt",payload:{plainText:n}});if(!r.success){w("Export failed: "+(r.error||"unknown"));return}let o=new Blob([JSON.stringify({encrypted:!0,data:r.cipherText})],{type:"application/json"}),c=URL.createObjectURL(o),l=document.createElement("a");l.href=c,l.download="nostrkey-api-keys-backup.json",l.click(),URL.revokeObjectURL(c),w("Exported")}async function te(e){let n=e.target.files?.[0];if(n){try{let r=await n.text(),o=JSON.parse(r),c;if(o.encrypted&&o.data){let l=await u.runtime.sendMessage({kind:"apikeys.decrypt",payload:{cipherText:o.data}});if(!l.success){w("Decrypt failed: "+(l.error||"unknown"));return}c=JSON.parse(l.plainText)}else c=o;await v(c),t.keys=await k(),t.syncEnabled&&m()&&await h(),w("Imported "+Object.keys(c).length+" keys")}catch(r){w("Import failed: "+r.message)}e.target.value=""}}function ne(){i("sync-btn")?.addEventListener("click",q),i("add-key-btn")?.addEventListener("click",z),i("export-btn")?.addEventListener("click",ee),i("import-file")?.addEventListener("change",te),i("close-btn")?.addEventListener("click",()=>window.close()),i("sync-toggle")?.addEventListener("change",e=>{t.syncEnabled=e.target.checked,Z()}),i("new-label")?.addEventListener("input",e=>{t.newLabel=e.target.value,d()}),i("new-secret")?.addEventListener("input",e=>{t.newSecret=e.target.value,d()})}async function ae(){let e=await u.runtime.sendMessage({kind:"isEncrypted"}),n=i("vault-locked-gate"),r=i("vault-main-content");if(!e){n&&(n.style.display="block"),r&&(r.style.display="none"),i("gate-security-btn")?.addEventListener("click",()=>{let c=u.runtime.getURL("security/security.html");window.open(c,"nostrkey-options")});return}n&&(n.style.display="none"),r&&(r.style.display="block");let o=await u.runtime.sendMessage({kind:"vault.getRelays"});t.relayInfo=o||{read:[],write:[]},t.syncEnabled=await B(),t.keys=await k(),ne(),d(),t.syncEnabled&&m()&&await q()}document.addEventListener("DOMContentLoaded",ae);})();
