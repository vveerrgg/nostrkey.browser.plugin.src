(()=>{var r=typeof browser<"u"?browser:typeof chrome<"u"?chrome:null;if(!r)throw new Error("browser-polyfill: No extension API namespace found (neither browser nor chrome).");var a=typeof browser>"u"&&typeof chrome<"u";function c(e,n){return(...l)=>{try{let d=n.apply(e,l);if(d&&typeof d.then=="function")return d}catch{}return new Promise((d,g)=>{n.apply(e,[...l,(...u)=>{r.runtime&&r.runtime.lastError?g(new Error(r.runtime.lastError.message)):d(u.length<=1?u[0]:u)}])})}}var i={};i.runtime={sendMessage(...e){return a?c(r.runtime,r.runtime.sendMessage)(...e):r.runtime.sendMessage(...e)},onMessage:r.runtime.onMessage,getURL(e){return r.runtime.getURL(e)},openOptionsPage(){return a?c(r.runtime,r.runtime.openOptionsPage)():r.runtime.openOptionsPage()},get id(){return r.runtime.id}};i.storage={local:{get(...e){return a?c(r.storage.local,r.storage.local.get)(...e):r.storage.local.get(...e)},set(...e){return a?c(r.storage.local,r.storage.local.set)(...e):r.storage.local.set(...e)},clear(...e){return a?c(r.storage.local,r.storage.local.clear)(...e):r.storage.local.clear(...e)},remove(...e){return a?c(r.storage.local,r.storage.local.remove)(...e):r.storage.local.remove(...e)}},sync:r.storage?.sync?{get(...e){return a?c(r.storage.sync,r.storage.sync.get)(...e):r.storage.sync.get(...e)},set(...e){return a?c(r.storage.sync,r.storage.sync.set)(...e):r.storage.sync.set(...e)},remove(...e){return a?c(r.storage.sync,r.storage.sync.remove)(...e):r.storage.sync.remove(...e)},clear(...e){return a?c(r.storage.sync,r.storage.sync.clear)(...e):r.storage.sync.clear(...e)},getBytesInUse(...e){return r.storage.sync.getBytesInUse?a?c(r.storage.sync,r.storage.sync.getBytesInUse)(...e):r.storage.sync.getBytesInUse(...e):Promise.resolve(0)}}:null,onChanged:r.storage?.onChanged||null};i.tabs={create(...e){return a?c(r.tabs,r.tabs.create)(...e):r.tabs.create(...e)},query(...e){return a?c(r.tabs,r.tabs.query)(...e):r.tabs.query(...e)},remove(...e){return a?c(r.tabs,r.tabs.remove)(...e):r.tabs.remove(...e)},update(...e){return a?c(r.tabs,r.tabs.update)(...e):r.tabs.update(...e)},get(...e){return a?c(r.tabs,r.tabs.get)(...e):r.tabs.get(...e)},getCurrent(...e){return a?c(r.tabs,r.tabs.getCurrent)(...e):r.tabs.getCurrent(...e)},sendMessage(...e){return a?c(r.tabs,r.tabs.sendMessage)(...e):r.tabs.sendMessage(...e)}};var s={isLocked:!1,hasPassword:!1,unlockError:"",newPassword:"",confirmPassword:"",securityError:"",currentPassword:"",newPasswordChange:"",confirmPasswordChange:"",changeError:"",removePasswordInput:"",removeError:"",pageSuccess:"",autoLockMinutes:15,autolockSuccess:""};function t(e){return document.getElementById(e)}function A(e){if(e.length===0)return 0;if(e.length<8)return 1;let n=2;return e.length>=12&&n++,/[A-Z]/.test(e)&&/[a-z]/.test(e)&&n++,/\d/.test(e)&&n++,/[^A-Za-z0-9]/.test(e)&&n++,Math.min(n,5)}function f(e){s.pageSuccess=e,o(),setTimeout(()=>{s.pageSuccess="",o()},5e3)}function o(){let e=t("locked-view"),n=t("unlocked-view");e&&(e.style.display=s.isLocked?"block":"none"),n&&(n.style.display=s.isLocked?"none":"block");let l=t("unlock-error");l&&(l.textContent=s.unlockError,l.style.display=s.unlockError?"block":"none");let d=t("page-success");d&&(d.textContent=s.pageSuccess,d.style.display=s.pageSuccess?"block":"none");let g=t("security-status");g&&(g.textContent=s.hasPassword?"Master password is active \u2014 keys are encrypted at rest.":"No master password set \u2014 keys are stored unencrypted.");let u=t("set-password-section"),k=t("change-password-section");u&&(u.style.display=s.hasPassword?"none":"block"),k&&(k.style.display=s.hasPassword?"block":"none");let w=t("password-strength");if(w)if(s.newPassword){let M=A(s.newPassword),S=["","Too short","Weak","Fair","Strong","Very strong"],x=["","text-red-500","text-orange-500","text-yellow-600","text-green-600","text-green-700 font-bold"];w.textContent=S[M]||"",w.className=`text-xs mt-1 ${x[M]||""}`,w.style.display="block"}else w.style.display="none";let v=t("set-password-btn");v&&(v.disabled=!(s.newPassword.length>=8&&s.newPassword===s.confirmPassword));let P=t("change-password-btn");P&&(P.disabled=!(s.currentPassword.length>0&&s.newPasswordChange.length>=8&&s.newPasswordChange===s.confirmPasswordChange));let E=t("remove-password-btn");E&&(E.disabled=!s.removePasswordInput);let m=t("security-error");m&&(m.textContent=s.securityError,m.style.display=s.securityError?"block":"none");let y=t("change-error");y&&(y.textContent=s.changeError,y.style.display=s.changeError?"block":"none");let p=t("remove-error");p&&(p.textContent=s.removeError,p.style.display=s.removeError?"block":"none");let b=t("autolock-disabled-msg"),L=t("autolock-controls");b&&(b.style.display=s.hasPassword?"none":"block"),L&&(L.style.display=s.hasPassword?"block":"none");let C=t("autolock-select");C&&(C.value=String(s.autoLockMinutes));let h=t("autolock-success");h&&(h.textContent=s.autolockSuccess,h.style.display=s.autolockSuccess?"block":"none")}async function B(){let e=t("unlock-password")?.value;if(!e){s.unlockError="Please enter your master password.",o();return}try{let n=await i.runtime.sendMessage({kind:"unlock",payload:e});n&&n.success?(s.isLocked=!1,s.unlockError="",t("unlock-password")&&(t("unlock-password").value=""),o()):(s.unlockError=n&&n.error||"Invalid password.",o())}catch(n){s.unlockError=n.message||"Failed to unlock.",o()}}async function F(){if(s.securityError="",s.newPassword.length<8){s.securityError="Password must be at least 8 characters.",o();return}if(s.newPassword!==s.confirmPassword){s.securityError="Passwords do not match.",o();return}try{let e=await i.runtime.sendMessage({kind:"setPassword",payload:s.newPassword});e&&e.success?(s.hasPassword=!0,s.newPassword="",s.confirmPassword="",f("Master password set. Your keys are now encrypted at rest.")):(s.securityError=e&&e.error||"Failed to set password.",o())}catch(e){s.securityError=e.message||"Failed to set password.",o()}}async function T(){if(s.changeError="",!s.currentPassword){s.changeError="Please enter your current password.",o();return}if(s.newPasswordChange.length<8){s.changeError="New password must be at least 8 characters.",o();return}if(s.newPasswordChange!==s.confirmPasswordChange){s.changeError="New passwords do not match.",o();return}try{let e=await i.runtime.sendMessage({kind:"changePassword",payload:{oldPassword:s.currentPassword,newPassword:s.newPasswordChange}});e&&e.success?(s.currentPassword="",s.newPasswordChange="",s.confirmPasswordChange="",f("Master password changed successfully.")):(s.changeError=e&&e.error||"Failed to change password.",o())}catch(e){s.changeError=e.message||"Failed to change password.",o()}}async function D(){if(s.removeError="",!s.removePasswordInput){s.removeError="Please enter your current password.",o();return}if(confirm("This will remove encryption from your private keys. They will be stored as plaintext. Are you sure?"))try{let e=await i.runtime.sendMessage({kind:"removePassword",payload:s.removePasswordInput});e&&e.success?(s.hasPassword=!1,s.removePasswordInput="",f("Master password removed. Keys are now stored unencrypted.")):(s.removeError=e&&e.error||"Failed to remove password.",o())}catch(e){s.removeError=e.message||"Failed to remove password.",o()}}async function N(){try{let e=await i.runtime.sendMessage({kind:"resetAllData"});e&&e.success?(s.hasPassword=!1,s.isLocked=!1,o(),f("Vault deleted. You can now set up a new master password.")):alert("Failed to delete vault: "+(e?.error||"Unknown error"))}catch(e){alert("Failed to delete vault: "+e.message)}}async function U(){let e=t("autolock-select");if(!e)return;let n=parseInt(e.value,10);s.autoLockMinutes=n,await i.runtime.sendMessage({kind:"setAutoLockTimeout",payload:n}),s.autolockSuccess=n===0?"Auto-lock disabled.":`Auto-lock set to ${n} minutes.`,o(),setTimeout(()=>{s.autolockSuccess="",o()},3e3)}function V(){t("close-btn")?.addEventListener("click",()=>window.close()),document.querySelectorAll("form").forEach(e=>{e.addEventListener("submit",n=>n.preventDefault())}),t("unlock-form")?.addEventListener("submit",e=>{e.preventDefault(),B()}),t("new-password")?.addEventListener("input",e=>{s.newPassword=e.target.value,o()}),t("confirm-password")?.addEventListener("input",e=>{s.confirmPassword=e.target.value,o()}),t("set-password-btn")?.addEventListener("click",F),t("current-password")?.addEventListener("input",e=>{s.currentPassword=e.target.value,o()}),t("new-password-change")?.addEventListener("input",e=>{s.newPasswordChange=e.target.value,o()}),t("confirm-password-change")?.addEventListener("input",e=>{s.confirmPasswordChange=e.target.value,o()}),t("change-password-btn")?.addEventListener("click",T),t("remove-password")?.addEventListener("input",e=>{s.removePasswordInput=e.target.value,o()}),t("remove-password-btn")?.addEventListener("click",D),t("autolock-select")?.addEventListener("change",U),t("show-delete-confirm-btn")?.addEventListener("click",()=>{t("delete-confirm-dialog")?.classList.remove("hidden"),t("show-delete-confirm-btn").style.display="none"}),t("cancel-delete-btn")?.addEventListener("click",()=>{t("delete-confirm-dialog")?.classList.add("hidden"),t("show-delete-confirm-btn").style.display="inline-block"}),t("confirm-delete-btn")?.addEventListener("click",N)}async function O(){s.hasPassword=!!await i.runtime.sendMessage({kind:"isEncrypted"}),s.isLocked=!!await i.runtime.sendMessage({kind:"isLocked"}),s.autoLockMinutes=await i.runtime.sendMessage({kind:"getAutoLockTimeout"})??15,V(),o();let e=window.location.hash.replace("#","");if(e){let n=document.getElementById(e);n&&n.tagName==="DETAILS"&&(n.open=!0)}else{let n=document.getElementById("master-password");n&&(n.open=!0)}}document.addEventListener("DOMContentLoaded",O);})();
