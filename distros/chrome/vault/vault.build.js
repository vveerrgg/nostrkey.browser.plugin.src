(()=>{var n=typeof browser<"u"?browser:typeof chrome<"u"?chrome:null;if(!n)throw new Error("browser-polyfill: No extension API namespace found (neither browser nor chrome).");var l=typeof browser>"u"&&typeof chrome<"u";function d(e,o){return(...r)=>{try{let i=o.apply(e,r);if(i&&typeof i.then=="function")return i}catch{}return new Promise((i,s)=>{o.apply(e,[...r,(...y)=>{n.runtime&&n.runtime.lastError?s(new Error(n.runtime.lastError.message)):i(y.length<=1?y[0]:y)}])})}}var u={};u.runtime={sendMessage(...e){return l?d(n.runtime,n.runtime.sendMessage)(...e):n.runtime.sendMessage(...e)},onMessage:n.runtime.onMessage,getURL(e){return n.runtime.getURL(e)},openOptionsPage(){return l?d(n.runtime,n.runtime.openOptionsPage)():n.runtime.openOptionsPage()},get id(){return n.runtime.id}};u.storage={local:{get(...e){return l?d(n.storage.local,n.storage.local.get)(...e):n.storage.local.get(...e)},set(...e){return l?d(n.storage.local,n.storage.local.set)(...e):n.storage.local.set(...e)},clear(...e){return l?d(n.storage.local,n.storage.local.clear)(...e):n.storage.local.clear(...e)},remove(...e){return l?d(n.storage.local,n.storage.local.remove)(...e):n.storage.local.remove(...e)}}};u.tabs={create(...e){return l?d(n.tabs,n.tabs.create)(...e):n.tabs.create(...e)},query(...e){return l?d(n.tabs,n.tabs.query)(...e):n.tabs.query(...e)},remove(...e){return l?d(n.tabs,n.tabs.remove)(...e):n.tabs.remove(...e)},update(...e){return l?d(n.tabs,n.tabs.update)(...e):n.tabs.update(...e)},get(...e){return l?d(n.tabs,n.tabs.get)(...e):n.tabs.get(...e)},getCurrent(...e){return l?d(n.tabs,n.tabs.getCurrent)(...e):n.tabs.getCurrent(...e)}};var A=u.storage.local,E="vaultDocs";async function m(){return(await A.get({[E]:{}}))[E]||{}}async function P(e){await A.set({[E]:e})}async function N(){return m()}async function k(e){return(await m())[e]||null}async function g(e,o,r,i=null,s=null){let y=await m();return y[e]={path:e,content:o,updatedAt:Math.floor(Date.now()/1e3),syncStatus:r,eventId:i,relayCreatedAt:s},await P(y),y[e]}async function w(e){let o=await m();delete o[e],await P(o)}async function p(){let e=await m();return Object.values(e).sort((o,r)=>r.updatedAt-o.updatedAt)}async function $(e,o,r=null,i=null){let s=await m();return s[e]?(s[e].syncStatus=o,r!==null&&(s[e].eventId=r),i!==null&&(s[e].relayCreatedAt=i),await P(s),s[e]):null}var t={documents:[],searchQuery:"",selectedPath:null,editorTitle:"",editorContent:"",pristineTitle:"",pristineContent:"",globalSyncStatus:"idle",syncError:"",saving:!1,isNew:!1,toast:"",relayInfo:{read:[],write:[]}};function a(e){return document.getElementById(e)}function O(){return t.relayInfo.read.length>0||t.relayInfo.write.length>0}function q(){if(!t.searchQuery)return t.documents;let e=t.searchQuery.toLowerCase();return t.documents.filter(o=>o.path.toLowerCase().includes(e))}function Q(){return t.editorContent!==t.pristineContent||t.editorTitle!==t.pristineTitle}function b(e){t.toast=e,c(),setTimeout(()=>{t.toast="",c()},2e3)}function B(e){return e==="idle"?"bg-green-500":e==="syncing"?"bg-yellow-500 animate-pulse":"bg-red-500"}function _(){return t.globalSyncStatus==="syncing"?"Syncing...":t.globalSyncStatus==="error"?t.syncError:"Synced"}function U(e){return e==="synced"?"bg-green-500":e==="local-only"?"bg-yellow-500":"bg-red-500"}function c(){let e=a("sync-dot"),o=a("sync-text"),r=a("sync-btn"),i=a("doc-count");e&&(e.className=`inline-block w-3 h-3 rounded-full ${B(t.globalSyncStatus)}`),o&&(o.textContent=_()),r&&(r.disabled=t.globalSyncStatus==="syncing"||!O()),i&&(i.textContent=t.documents.length+" doc"+(t.documents.length!==1?"s":""));let s=a("file-list"),y=a("no-documents"),T=q();s&&(s.innerHTML=T.map(f=>`
            <div
                class="p-2 cursor-pointer rounded text-sm border border-transparent hover:border-monokai-accent ${t.selectedPath===f.path?"bg-monokai-bg-lighter border-monokai-accent":""}"
                data-doc-path="${f.path}"
            >
                <div class="font-bold truncate">${f.path}</div>
                <div class="flex items-center gap-1 text-xs text-gray-500">
                    <span class="inline-block w-2 h-2 rounded-full ${U(f.syncStatus)}"></span>
                    <span>${f.syncStatus}</span>
                </div>
            </div>
        `).join(""),s.querySelectorAll("[data-doc-path]").forEach(f=>{f.addEventListener("click",()=>V(f.dataset.docPath))})),y&&(y.style.display=T.length===0?"block":"none");let L=a("editor-panel"),D=a("editor-empty"),h=t.selectedPath!==null||t.isNew;if(L&&(L.style.display=h?"block":"none"),D&&(D.style.display=h?"none":"block"),h){let f=a("editor-title"),x=a("editor-content"),S=a("save-doc-btn"),I=a("delete-doc-btn"),M=a("dirty-label");f&&(f.value=t.editorTitle),x&&(x.value=t.editorContent),S&&(S.disabled=t.saving||t.editorTitle.trim().length===0,S.textContent=t.saving?"Saving...":"Save"),I&&(I.style.display=t.selectedPath!==null&&!t.isNew?"inline-block":"none"),M&&(M.style.display=Q()?"inline":"none")}let v=a("search-input");v&&document.activeElement!==v&&(v.value=t.searchQuery);let C=a("toast");C&&(C.textContent=t.toast,C.style.display=t.toast?"block":"none")}function j(){t.isNew=!0,t.selectedPath=null,t.editorTitle="",t.editorContent="",t.pristineTitle="",t.pristineContent="",c()}async function V(e){let o=await k(e);o&&(t.isNew=!1,t.selectedPath=e,t.editorTitle=o.path,t.editorContent=o.content,t.pristineTitle=o.path,t.pristineContent=o.content,c())}async function F(){let e=t.editorTitle.trim();if(e){t.saving=!0,c();try{let o=await u.runtime.sendMessage({kind:"vault.publish",payload:{path:e,content:t.editorContent}});o.success?(t.selectedPath&&t.selectedPath!==e&&await w(t.selectedPath),await g(e,t.editorContent,"synced",o.eventId,o.createdAt),t.selectedPath=e,t.isNew=!1,t.pristineTitle=e,t.pristineContent=t.editorContent,t.documents=await p(),b("Saved")):(await g(e,t.editorContent,"local-only"),t.selectedPath&&t.selectedPath!==e&&await w(t.selectedPath),t.selectedPath=e,t.isNew=!1,t.pristineTitle=e,t.pristineContent=t.editorContent,t.documents=await p(),b("Saved locally (relay error: "+(o.error||"unknown")+")"))}catch{await g(t.editorTitle.trim(),t.editorContent,"local-only"),t.selectedPath=t.editorTitle.trim(),t.isNew=!1,t.pristineTitle=t.editorTitle,t.pristineContent=t.editorContent,t.documents=await p(),b("Saved locally (offline)")}t.saving=!1,c()}}async function G(){if(!t.selectedPath||!confirm(`Delete "${t.selectedPath}"?`))return;let e=await k(t.selectedPath);if(e?.eventId)try{await u.runtime.sendMessage({kind:"vault.delete",payload:{path:t.selectedPath,eventId:e.eventId}})}catch{}await w(t.selectedPath),t.selectedPath=null,t.isNew=!1,t.editorTitle="",t.editorContent="",t.pristineTitle="",t.pristineContent="",t.documents=await p(),b("Deleted"),c()}async function R(){t.globalSyncStatus="syncing",t.syncError="",c();try{let e=await u.runtime.sendMessage({kind:"vault.fetch"});if(!e.success){t.globalSyncStatus="error",t.syncError=e.error||"Sync failed",c();return}let o=await N();for(let r of e.documents){let i=o[r.path];i?i.syncStatus==="local-only"?i.content!==r.content&&await $(r.path,"conflict",r.eventId,r.createdAt):(!i.relayCreatedAt||r.createdAt>i.relayCreatedAt)&&(await g(r.path,r.content,"synced",r.eventId,r.createdAt),t.selectedPath===r.path&&(t.editorContent=r.content,t.pristineContent=r.content)):await g(r.path,r.content,"synced",r.eventId,r.createdAt)}t.documents=await p(),t.globalSyncStatus="idle"}catch(e){t.globalSyncStatus="error",t.syncError=e.message||"Sync failed"}c()}function H(){a("new-doc-btn")?.addEventListener("click",j),a("sync-btn")?.addEventListener("click",R),a("save-doc-btn")?.addEventListener("click",F),a("delete-doc-btn")?.addEventListener("click",G),a("search-input")?.addEventListener("input",e=>{t.searchQuery=e.target.value,c()}),a("editor-title")?.addEventListener("input",e=>{t.editorTitle=e.target.value,c()}),a("editor-content")?.addEventListener("input",e=>{t.editorContent=e.target.value,c()}),a("close-btn")?.addEventListener("click",()=>window.close())}async function K(){let e=await u.runtime.sendMessage({kind:"isEncrypted"}),o=a("vault-locked-gate"),r=a("vault-main-content");if(!e){o&&(o.style.display="block"),r&&(r.style.display="none"),a("gate-security-btn")?.addEventListener("click",()=>{let s=u.runtime.getURL("security/security.html");window.open(s,"nostrkey-options")});return}o&&(o.style.display="none"),r&&(r.style.display="block");let i=await u.runtime.sendMessage({kind:"vault.getRelays"});t.relayInfo=i||{read:[],write:[]},t.documents=await p(),H(),c(),O()&&await R()}document.addEventListener("DOMContentLoaded",K);})();
