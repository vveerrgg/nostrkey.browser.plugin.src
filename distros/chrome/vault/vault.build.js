(()=>{var n=typeof browser<"u"?browser:typeof chrome<"u"?chrome:null;if(!n)throw new Error("browser-polyfill: No extension API namespace found (neither browser nor chrome).");var u=typeof browser>"u"&&typeof chrome<"u";function d(e,o){return(...r)=>{try{let s=o.apply(e,r);if(s&&typeof s.then=="function")return s}catch{}return new Promise((s,i)=>{o.apply(e,[...r,(...c)=>{n.runtime&&n.runtime.lastError?i(new Error(n.runtime.lastError.message)):s(c.length<=1?c[0]:c)}])})}}var l={};l.runtime={sendMessage(...e){return u?d(n.runtime,n.runtime.sendMessage)(...e):n.runtime.sendMessage(...e)},onMessage:n.runtime.onMessage,getURL(e){return n.runtime.getURL(e)},openOptionsPage(){return u?d(n.runtime,n.runtime.openOptionsPage)():n.runtime.openOptionsPage()},get id(){return n.runtime.id}};l.storage={local:{get(...e){return u?d(n.storage.local,n.storage.local.get)(...e):n.storage.local.get(...e)},set(...e){return u?d(n.storage.local,n.storage.local.set)(...e):n.storage.local.set(...e)},clear(...e){return u?d(n.storage.local,n.storage.local.clear)(...e):n.storage.local.clear(...e)},remove(...e){return u?d(n.storage.local,n.storage.local.remove)(...e):n.storage.local.remove(...e)}},sync:n.storage?.sync?{get(...e){return u?d(n.storage.sync,n.storage.sync.get)(...e):n.storage.sync.get(...e)},set(...e){return u?d(n.storage.sync,n.storage.sync.set)(...e):n.storage.sync.set(...e)},remove(...e){return u?d(n.storage.sync,n.storage.sync.remove)(...e):n.storage.sync.remove(...e)},clear(...e){return u?d(n.storage.sync,n.storage.sync.clear)(...e):n.storage.sync.clear(...e)},getBytesInUse(...e){return n.storage.sync.getBytesInUse?u?d(n.storage.sync,n.storage.sync.getBytesInUse)(...e):n.storage.sync.getBytesInUse(...e):Promise.resolve(0)}}:null,onChanged:n.storage?.onChanged||null};l.tabs={create(...e){return u?d(n.tabs,n.tabs.create)(...e):n.tabs.create(...e)},query(...e){return u?d(n.tabs,n.tabs.query)(...e):n.tabs.query(...e)},remove(...e){return u?d(n.tabs,n.tabs.remove)(...e):n.tabs.remove(...e)},update(...e){return u?d(n.tabs,n.tabs.update)(...e):n.tabs.update(...e)},get(...e){return u?d(n.tabs,n.tabs.get)(...e):n.tabs.get(...e)},getCurrent(...e){return u?d(n.tabs,n.tabs.getCurrent)(...e):n.tabs.getCurrent(...e)},sendMessage(...e){return u?d(n.tabs,n.tabs.sendMessage)(...e):n.tabs.sendMessage(...e)}};var Y=102400,j=8192,z=512,Q="_chunk:",V="_sync_meta",M="platformSyncEnabled";var v={P1_PROFILES:1,P2_SETTINGS:2,P3_APIKEYS:3,P4_VAULT:4},$=l.storage.local,k=null;function q(e,o){let r=[];for(let i=0;i<o.length;i+=j-100)r.push(o.slice(i,i+j-100));if(r.length===1)return[{key:e,value:o}];let s=[];for(let i=0;i<r.length;i++)s.push({key:`${Q}${e}:${i}`,value:r[i]});return s.push({key:e,value:JSON.stringify({__chunked:!0,count:r.length})}),s}async function G(){let e=await $.get(null),o=[];if(e.profiles){let s=e.profiles.map(c=>{let{hosts:g,...b}=c;return b}),i=JSON.stringify(s);o.push({key:"profiles",jsonString:i,priority:v.P1_PROFILES,size:i.length})}if(e.profileIndex!=null){let s=JSON.stringify(e.profileIndex);o.push({key:"profileIndex",jsonString:s,priority:v.P1_PROFILES,size:s.length})}if(e.isEncrypted!=null){let s=JSON.stringify(e.isEncrypted);o.push({key:"isEncrypted",jsonString:s,priority:v.P1_PROFILES,size:s.length})}let r=["autoLockMinutes","version","protocol_handler",M];for(let s of r)if(e[s]!=null){let i=JSON.stringify(e[s]);o.push({key:s,jsonString:i,priority:v.P2_SETTINGS,size:i.length})}for(let s of Object.keys(e))if(s.startsWith("feature:")){let i=JSON.stringify(e[s]);o.push({key:s,jsonString:i,priority:v.P2_SETTINGS,size:i.length})}if(e.apiKeyVault){let s=JSON.stringify(e.apiKeyVault);o.push({key:"apiKeyVault",jsonString:s,priority:v.P3_APIKEYS,size:s.length})}if(e.vaultDocs&&typeof e.vaultDocs=="object"){let s=Object.values(e.vaultDocs).sort((i,c)=>(c.updatedAt||0)-(i.updatedAt||0));for(let i of s){let c=`vaultDoc:${i.path}`,g=JSON.stringify(i);o.push({key:c,jsonString:g,priority:v.P4_VAULT,size:g.length})}}return o}async function W(){if(!(!l.storage.sync||!await H()))try{let o=await G();o.sort((m,y)=>m.priority-y.priority);let r=0,s=0,i={},c=[],g=!1;for(let m of o){if(g)break;let y=q(m.key,m.jsonString),S=0;for(let p of y)S+=p.key.length+(typeof p.value=="string"?p.value.length:JSON.stringify(p.value).length);if((r+S>Y-500||s+y.length>z-5)&&!(m.priority<=v.P3_APIKEYS)){g=!0;break}for(let p of y)i[p.key]=p.value,c.push(p.key);r+=S,s+=y.length}let b={lastWrittenAt:Date.now(),keys:c};i[V]=JSON.stringify(b),await l.storage.sync.set(i);try{let m=await l.storage.sync.get(null),y=Object.keys(m).filter(S=>S!==V&&!c.includes(S));y.length>0&&await l.storage.sync.remove(y)}catch{}}catch{}}function R(){l.storage.sync&&(k&&clearTimeout(k),k=setTimeout(()=>{k=null,W()},2e3))}async function H(){return(await $.get({[M]:!0}))[M]}var J=l.storage.local,_="vaultDocs";async function E(){return(await J.get({[_]:{}}))[_]||{}}async function O(e){await J.set({[_]:e}),R()}async function B(){return E()}async function N(e){return(await E())[e]||null}async function P(e,o,r,s=null,i=null){let c=await E(),g=c[e];return c[e]={path:e,content:o,updatedAt:Math.floor(Date.now()/1e3),syncStatus:r,eventId:s,relayCreatedAt:i,profileScope:g?.profileScope??null},await O(c),c[e]}async function C(e){let o=await E();delete o[e],await O(o)}async function w(){let e=await E();return Object.values(e).sort((o,r)=>r.updatedAt-o.updatedAt)}async function D(e,o,r=null,s=null){let i=await E();return i[e]?(i[e].syncStatus=o,r!==null&&(i[e].eventId=r),s!==null&&(i[e].relayCreatedAt=s),await O(i),i[e]):null}var t={documents:[],searchQuery:"",selectedPath:null,editorTitle:"",editorContent:"",pristineTitle:"",pristineContent:"",globalSyncStatus:"idle",syncError:"",saving:!1,isNew:!1,toast:"",relayInfo:{read:[],write:[]}};function a(e){return document.getElementById(e)}function F(){return t.relayInfo.read.length>0||t.relayInfo.write.length>0}function X(){if(!t.searchQuery)return t.documents;let e=t.searchQuery.toLowerCase();return t.documents.filter(o=>o.path.toLowerCase().includes(e))}function Z(){return t.editorContent!==t.pristineContent||t.editorTitle!==t.pristineTitle}function I(e){t.toast=e,f(),setTimeout(()=>{t.toast="",f()},2e3)}function ee(e){return e==="idle"?"bg-green-500":e==="syncing"?"bg-yellow-500 animate-pulse":"bg-red-500"}function te(){return t.globalSyncStatus==="syncing"?"Syncing...":t.globalSyncStatus==="error"?t.syncError:"Synced"}function ne(e){return e==="synced"?"bg-green-500":e==="local-only"?"bg-yellow-500":"bg-red-500"}function f(){let e=a("sync-dot"),o=a("sync-text"),r=a("sync-btn"),s=a("doc-count");e&&(e.className=`inline-block w-3 h-3 rounded-full ${ee(t.globalSyncStatus)}`),o&&(o.textContent=te()),r&&(r.disabled=t.globalSyncStatus==="syncing"||!F()),s&&(s.textContent=t.documents.length+" doc"+(t.documents.length!==1?"s":""));let i=a("file-list"),c=a("no-documents"),g=X();i&&(i.innerHTML=g.map(h=>`
            <div
                class="doc-item ${t.selectedPath===h.path?"selected":""}"
                data-doc-path="${h.path}"
            >
                <div class="font-bold text-sm truncate" style="color:#f8f8f2;">${h.path}</div>
                <div class="doc-sync flex items-center gap-1">
                    <span class="inline-block w-2 h-2 rounded-full ${ne(h.syncStatus)}"></span>
                    <span>${h.syncStatus}</span>
                </div>
            </div>
        `).join(""),i.querySelectorAll("[data-doc-path]").forEach(h=>{h.addEventListener("click",()=>oe(h.dataset.docPath))})),c&&(c.style.display=g.length===0?"block":"none");let b=a("editor-panel"),m=a("editor-empty"),y=t.selectedPath!==null||t.isNew;if(b&&(b.style.display=y?"block":"none"),m&&(m.style.display=y?"none":"block"),y){let h=a("editor-title"),x=a("editor-content"),T=a("save-doc-btn"),A=a("delete-doc-btn"),K=a("dirty-label");h&&(h.value=t.editorTitle),x&&(x.value=t.editorContent),T&&(T.disabled=t.saving||t.editorTitle.trim().length===0,T.textContent=t.saving?"Saving...":"Save"),A&&(A.style.display=t.selectedPath!==null&&!t.isNew?"inline-block":"none"),K&&(K.style.display=Z()?"inline":"none")}let S=a("search-input");S&&document.activeElement!==S&&(S.value=t.searchQuery);let p=a("toast");p&&(p.textContent=t.toast,p.style.display=t.toast?"block":"none")}function se(){t.isNew=!0,t.selectedPath=null,t.editorTitle="",t.editorContent="",t.pristineTitle="",t.pristineContent="",f()}async function oe(e){let o=await N(e);o&&(t.isNew=!1,t.selectedPath=e,t.editorTitle=o.path,t.editorContent=o.content,t.pristineTitle=o.path,t.pristineContent=o.content,f())}async function re(){let e=t.editorTitle.trim();if(e){t.saving=!0,f();try{let o=await l.runtime.sendMessage({kind:"vault.publish",payload:{path:e,content:t.editorContent}});o.success?(t.selectedPath&&t.selectedPath!==e&&await C(t.selectedPath),await P(e,t.editorContent,"synced",o.eventId,o.createdAt),t.selectedPath=e,t.isNew=!1,t.pristineTitle=e,t.pristineContent=t.editorContent,t.documents=await w(),I("Saved")):(await P(e,t.editorContent,"local-only"),t.selectedPath&&t.selectedPath!==e&&await C(t.selectedPath),t.selectedPath=e,t.isNew=!1,t.pristineTitle=e,t.pristineContent=t.editorContent,t.documents=await w(),I("Saved locally (relay error: "+(o.error||"unknown")+")"))}catch{await P(t.editorTitle.trim(),t.editorContent,"local-only"),t.selectedPath=t.editorTitle.trim(),t.isNew=!1,t.pristineTitle=t.editorTitle,t.pristineContent=t.editorContent,t.documents=await w(),I("Saved locally (offline)")}t.saving=!1,f()}}async function ie(){if(!t.selectedPath||!confirm(`Delete "${t.selectedPath}"?`))return;let e=await N(t.selectedPath);if(e?.eventId)try{await l.runtime.sendMessage({kind:"vault.delete",payload:{path:t.selectedPath,eventId:e.eventId}})}catch{}await C(t.selectedPath),t.selectedPath=null,t.isNew=!1,t.editorTitle="",t.editorContent="",t.pristineTitle="",t.pristineContent="",t.documents=await w(),I("Deleted"),f()}async function U(){t.globalSyncStatus="syncing",t.syncError="",f();try{let e=await l.runtime.sendMessage({kind:"vault.fetch"});if(!e.success){t.globalSyncStatus="error",t.syncError=e.error||"Sync failed",f();return}let o=await B();for(let r of e.documents){let s=o[r.path];s?s.syncStatus==="local-only"?s.content!==r.content&&await D(r.path,"conflict",r.eventId,r.createdAt):(!s.relayCreatedAt||r.createdAt>s.relayCreatedAt)&&(await P(r.path,r.content,"synced",r.eventId,r.createdAt),t.selectedPath===r.path&&(t.editorContent=r.content,t.pristineContent=r.content)):await P(r.path,r.content,"synced",r.eventId,r.createdAt)}t.documents=await w(),t.globalSyncStatus="idle"}catch(e){t.globalSyncStatus="error",t.syncError=e.message||"Sync failed"}f()}function ae(){a("new-doc-btn")?.addEventListener("click",se),a("sync-btn")?.addEventListener("click",U),a("save-doc-btn")?.addEventListener("click",re),a("delete-doc-btn")?.addEventListener("click",ie),a("search-input")?.addEventListener("input",e=>{t.searchQuery=e.target.value,f()}),a("editor-title")?.addEventListener("input",e=>{t.editorTitle=e.target.value,f()}),a("editor-content")?.addEventListener("input",e=>{t.editorContent=e.target.value,f()}),a("close-btn")?.addEventListener("click",()=>window.close())}async function ce(){let e=await l.runtime.sendMessage({kind:"isEncrypted"}),o=a("vault-locked-gate"),r=a("vault-main-content");if(!e){o&&(o.style.display="block"),r&&(r.style.display="none"),a("gate-security-btn")?.addEventListener("click",()=>{let s=l.runtime.getURL("security/security.html");window.open(s,"nostrkey-options")});return}o&&(o.style.display="none"),r&&(r.style.display="block");try{let s=await l.runtime.sendMessage({kind:"vault.getRelays"});t.relayInfo=s||{read:[],write:[]}}catch{t.relayInfo={read:[],write:[]}}try{t.documents=await w()}catch{t.documents=[]}if(ae(),f(),F())try{await U()}catch{}}document.addEventListener("DOMContentLoaded",ce);})();
